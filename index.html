<!doctype html><html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>å¤šäº‘ç†Šæ‰‹æœºäºŒæ”¹ç‰ˆ</title><script type="module">var e={15:(e,t,a)=>{a.d(t,{GroupChatStorage:()=>n});var s=a(464);class n{static STORAGE_KEY='groups';static AVATAR_CACHE_KEY='group_avatars';static saveGroupChat(e){try{const t=this.getAllGroupChats().filter(t=>t.id!==e.id);t.unshift(e),(0,s.setCharacterItem)(this.STORAGE_KEY,t),console.log(`ğŸ’¾ ç¾¤èŠå·²ä¿å­˜åˆ°è§’è‰²ä¸“ç”¨ç©ºé—´: ${e.name}`)}catch(e){console.error('ä¿å­˜ç¾¤èŠæ•°æ®å¤±è´¥:',e)}}static getAllGroupChats(){try{return(0,s.getCharacterItem)(this.STORAGE_KEY,[])}catch(e){return console.error('è¯»å–ç¾¤èŠæ•°æ®å¤±è´¥:',e),[]}}static getGroupChatById(e){return this.getAllGroupChats().find(t=>t.id===e)||null}static deleteGroupChat(e){try{const t=this.getAllGroupChats(),a=t.filter(t=>t.id!==e);return a.length<t.length&&((0,s.setCharacterItem)(this.STORAGE_KEY,a),console.log(`ğŸ—‘ï¸ ç¾¤èŠå·²ä»è§’è‰²ä¸“ç”¨ç©ºé—´åˆ é™¤: ${e}`),!0)}catch(e){return console.error('åˆ é™¤ç¾¤èŠæ•°æ®å¤±è´¥:',e),!1}}static generateGroupId(e){return e?e.startsWith('ç¾¤èŠ')?e:`ç¾¤èŠ${e}`:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static async saveGroupAvatar(e,t){try{(0,s.setCharacterItem)(`group_avatar_${e}`,t);const a=(0,s.getCharacterItem)('group_avatar_index',{});a[e]={avatar:t,timestamp:Date.now(),size:t.length},(0,s.setCharacterItem)('group_avatar_index',a);const n=this.getGroupChatById(e);n&&(n.avatar=t,this.saveGroupChat(n)),console.log(`ğŸ’¾ ç¾¤å¤´åƒå·²ä¿å­˜åˆ°ç¼“å­˜: ${e}`)}catch(e){throw console.error('ä¿å­˜ç¾¤å¤´åƒåˆ°ç¼“å­˜å¤±è´¥:',e),e}}static loadGroupAvatar(e){try{return(0,s.getCharacterItem)(`group_avatar_${e}`,null)}catch(e){return console.error('ä»ç¼“å­˜åŠ è½½ç¾¤å¤´åƒå¤±è´¥:',e),null}}static getGroupAvatarWithFallback(e,t){const a=this.loadGroupAvatar(e);if(a)return a;const s=this.getGroupChatById(e);return s&&s.avatar&&s.avatar!==t?s.avatar:t}static getDefaultGroupAvatar(e){const t=['https://files.catbox.moe/j2s4qj.jpg','https://files.catbox.moe/seoipi.jpg','https://files.catbox.moe/dq08mr.jpg','https://files.catbox.moe/yc3gv4.jpeg'],a=e.split('').reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);return t[Math.abs(a)%t.length]}static getGroupAvatarIndex(){try{return(0,s.getCharacterItem)('group_avatar_index',{})}catch(e){return console.error('è·å–ç¾¤å¤´åƒç´¢å¼•å¤±è´¥:',e),{}}}static cleanupOldAvatarCache(){try{const e=this.getGroupAvatarIndex(),t=Date.now()-2592e6,a=[];for(const[s,n]of Object.entries(e))n.timestamp<t&&(a.push(s),removeCharacterItem(`group_avatar_${s}`));a.forEach(t=>delete e[t]),(0,s.setCharacterItem)('group_avatar_index',e),a.length>0&&console.log(`ğŸ§¹ å·²æ¸…ç† ${a.length} ä¸ªè¿‡æœŸç¾¤å¤´åƒç¼“å­˜`)}catch(e){console.error('æ¸…ç†å¤´åƒç¼“å­˜å¤±è´¥:',e)}}static fileToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}}},17:(e,t,a)=>{a.d(t,{OK:()=>i,ZT:()=>c});var s,n=a(721),r=a(335);!function(e){e.CACHE='cache',e.GLOBAL_USER_MANAGER='global_user_manager',e.TAVERN_HELPER='tavern_helper',e.DOM_DETECTION='dom_detection',e.GLOBAL_VARS='global_vars',e.DEFAULT='default'}(s||(s={}));class o{static instance;config;globalUserManager;userInfoRetrieval;cache=new Map;lastKnownAvatar='';constructor(e={}){this.config={debug:e.debug??!1,cacheTimeout:e.cacheTimeout??3e5,defaultAvatarUrl:e.defaultAvatarUrl??'https://files.catbox.moe/u8ccy5.jpg',enableDOMDetection:e.enableDOMDetection??!0},this.globalUserManager=n.GlobalUserManager.getInstance(),this.userInfoRetrieval=new r.UserInfoRetrieval({defaultAvatarUrl:this.config.defaultAvatarUrl,enableLogging:this.config.debug}),this.initializeService()}static getInstance(e){return o.instance||(o.instance=new o(e)),o.instance}async initializeService(){try{this.globalUserManager.addEventListener('avatar',e=>{this.log(`å¤´åƒå˜æ›´äº‹ä»¶: ${e.oldValue} -> ${e.newValue}`),this.setCachedAvatar(e.newValue,s.GLOBAL_USER_MANAGER),this.lastKnownAvatar=e.newValue});const e=await this.getCurrentAvatar();this.lastKnownAvatar=e,this.log(`æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰å¤´åƒ: ${e}`)}catch(e){this.log(`æœåŠ¡åˆå§‹åŒ–å¤±è´¥: ${e}`)}}async getCurrentAvatar(){const e=[{source:s.GLOBAL_USER_MANAGER,method:()=>this.getAvatarFromGlobalUserManager()},{source:s.CACHE,method:()=>Promise.resolve(this.getCachedAvatar())},{source:s.TAVERN_HELPER,method:()=>this.getAvatarFromTavernHelper()},{source:s.DOM_DETECTION,method:()=>this.getAvatarFromDOM()},{source:s.GLOBAL_VARS,method:()=>this.getAvatarFromGlobalVars()},{source:s.DEFAULT,method:()=>Promise.resolve(this.config.defaultAvatarUrl)}];for(const t of e)try{const e=await t.method();if(e&&e.trim())return this.log(`ä» ${t.source} è·å–åˆ°å¤´åƒ: ${e}`),t.source!==s.CACHE&&this.setCachedAvatar(e,t.source),e}catch(e){this.log(`ä» ${t.source} è·å–å¤´åƒå¤±è´¥: ${e}`)}return this.log(`æ‰€æœ‰ç­–ç•¥éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ: ${this.config.defaultAvatarUrl}`),this.config.defaultAvatarUrl}getCachedAvatar(){const e='user_avatar',t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>this.config.cacheTimeout?(this.cache.delete(e),this.log('ç¼“å­˜å·²è¿‡æœŸï¼Œå·²æ¸…ç†'),null):(this.config.debug&&Math.random()<.1&&this.log(`ä»ç¼“å­˜è·å–å¤´åƒ: ${t.url} (æ¥æº: ${t.source})`),t.url)}setCachedAvatar(e,t){if(!e||!e.trim())return;const a={url:e.trim(),timestamp:Date.now(),source:t};this.cache.set('user_avatar',a),this.log(`å¤´åƒå·²ç¼“å­˜: ${e} (æ¥æº: ${t})`)}async getAvatarFromGlobalUserManager(){try{const e=this.globalUserManager.getCurrentUserData();if(e?.isCustom&&e.avatar)return e.avatar;return await this.globalUserManager.getUserAvatar()||null}catch(e){return this.log(`ä»GlobalUserManagerè·å–å¤´åƒå¤±è´¥: ${e}`),null}}async getAvatarFromTavernHelper(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros){const e=window.TavernHelper.substitudeMacros('{{userAvatarPath}}');if(e&&'{{userAvatarPath}}'!==e&&e.trim())return e.trim()}if('function'==typeof triggerSlash){const e=await triggerSlash('/pass {{userAvatarPath}}');if(e&&e.trim())return e.trim()}return null}catch(e){return this.log(`ä»TavernHelperè·å–å¤´åƒå¤±è´¥: ${e}`),null}}getAvatarFromDOM(){return Promise.resolve(this.config.enableDOMDetection?(0,r.getSimpleUserAvatar)():null)}getAvatarFromGlobalVars(){try{const e=[()=>window.power_user?.avatar,()=>window.user_avatar,()=>window.settings?.user_avatar,()=>window.chat_metadata?.user_avatar,()=>window.persona?.avatar];for(const t of e)try{const e=t();if(e&&'string'==typeof e&&e.trim())return Promise.resolve(e.trim())}catch(e){}return Promise.resolve(null)}catch(e){return this.log(`ä»å…¨å±€å˜é‡è·å–å¤´åƒå¤±è´¥: ${e}`),Promise.resolve(null)}}async refreshCache(){this.log('å¼ºåˆ¶åˆ·æ–°å¤´åƒç¼“å­˜'),this.cache.clear();const e=await this.getCurrentAvatar();return this.lastKnownAvatar=e,e}getLastKnownAvatar(){return this.lastKnownAvatar||this.config.defaultAvatarUrl}async hasAvatarChanged(){const e=await this.getCurrentAvatar(),t=e!==this.lastKnownAvatar;return t&&(this.log(`å¤´åƒå·²å˜åŒ–: ${this.lastKnownAvatar} -> ${e}`),this.lastKnownAvatar=e),t}getStats(){const e=Array.from(this.cache.entries()).map(([e,t])=>({source:t.source,url:t.url,age:Date.now()-t.timestamp}));return{cacheSize:this.cache.size,lastKnownAvatar:this.lastKnownAvatar,cacheEntries:e}}cleanupExpiredCache(){const e=Date.now();let t=0;for(const[a,s]of this.cache.entries())e-s.timestamp>this.config.cacheTimeout&&(this.cache.delete(a),t++);return t>0&&this.log(`æ¸…ç†äº† ${t} ä¸ªè¿‡æœŸç¼“å­˜æ¡ç›®`),t}updateConfig(e){this.config={...this.config,...e},this.userInfoRetrieval.updateOptions({defaultAvatarUrl:this.config.defaultAvatarUrl,enableLogging:this.config.debug}),this.log('é…ç½®å·²æ›´æ–°')}destroy(){this.cache.clear(),this.log('AvatarSourceServiceå·²é”€æ¯'),o.instance=null}log(e){this.config.debug&&console.log(`[AvatarSourceService] ${e}`)}}const i=o.getInstance({debug:!1});function c(){return i.getCachedAvatar()}},56:(e,t,a)=>{a.d(t,{v:()=>o});var s=a(464);class n{static CONTACT_REGEX_OLD=/\[å§“åï¼š([^å¤´åƒ]+)å¤´åƒï¼š([^\]]+)\]/g;static CONTACT_REGEX_NEW=/^å§“åï¼š([^å¤´åƒ]+)å¤´åƒï¼š(.+)$/gm;static parseContacts(e,t=!1){const a=[];try{if(t){const t=this.parseNewFormat(e);if(t.length>0)return t}const s=this.parseOldFormat(e);if(s.length>0)return s;if(!t)return this.parseNewFormat(e);console.log(`âœ… [ContactParser] æˆåŠŸè§£æ ${a.length} ä¸ªè”ç³»äºº`)}catch(e){console.error('âŒ [ContactParser] è§£æè”ç³»äººå†…å®¹å¤±è´¥:',e)}return a}static parseOldFormat(e){const t=[],a=/\[([^\]]+)\]/g;let s;for(;null!==(s=a.exec(e));){const e=s[1].trim(),a=e.match(/å§“åï¼š([^å¤´åƒ]+?)(?=\s*å¤´åƒï¼š|$)/),n=e.match(/å¤´åƒï¼š([^åŠ¨æ€å¤´å›¾]+?)(?=\s*åŠ¨æ€å¤´å›¾ï¼š|$)/),r=e.match(/åŠ¨æ€å¤´å›¾ï¼š(.+)$/),o=(a?.[1]||'').trim(),i=(n?.[1]||'').trim(),c=(r?.[1]||'').trim();if(o&&i){const e={name:o,avatar:i};c&&(e.hero=c),t.push(e),console.log(`ğŸ‘¤ [ContactParser] è§£æåˆ°è”ç³»äººï¼ˆæ—§æ ¼å¼ï¼‰: ${o} -> ${i.substring(0,50)}...${c?' | åŠ¨æ€å¤´å›¾: '+c.substring(0,50)+'...':''}`)}}return t}static parseNewFormat(e){const t=[],a=e.split(/\r?\n/);let s=0;for(;s<a.length;){const e=a[s].trim();if(!e||/^\s*\[[^\]]+\]\s*$/.test(e)){s++;continue}let n=e.match(/^å§“åï¼š(.+?)\s+å¤´åƒï¼š(.+?)(?:\s+åŠ¨æ€å¤´å›¾ï¼š(.+))?$/);if(n||(n=e.match(/^å§“åï¼š([^å¤´åƒ]+)å¤´åƒï¼š(.+)$/),n&&(n[3]='')),n){const e=(n[1]||'').trim(),a=(n[2]||'').trim(),r=(n[3]||'').trim();if(e&&a){const s={name:e,avatar:a};r&&(s.hero=r),t.push(s),console.log(`ğŸ‘¤ [ContactParser] è§£æåˆ°è”ç³»äººï¼ˆå•è¡Œæ ¼å¼ï¼‰: ${e} -> ${a.substring(0,50)}...${r?' | åŠ¨æ€å¤´å›¾: '+r.substring(0,50)+'...':''}`)}s++;continue}const r=e.match(/^å§“åï¼š(.+)$/);if(r){const e=(r[1]||'').trim();let n='',o='';if(s+1<a.length){const r=a[s+1].trim().match(/^å¤´åƒï¼š(.+)$/);if(r){if(n=(r[1]||'').trim(),s+2<a.length){const e=a[s+2].trim().match(/^åŠ¨æ€å¤´å›¾ï¼š(.+)$/);e?(o=(e[1]||'').trim(),s+=3):s+=2}else s+=2;if(e&&n){const a={name:e,avatar:n};o&&(a.hero=o),t.push(a),console.log(`ğŸ‘¤ [ContactParser] è§£æåˆ°è”ç³»äººï¼ˆå¤šè¡Œæ ¼å¼ï¼‰: ${e} -> ${n.substring(0,50)}...${o?' | åŠ¨æ€å¤´å›¾: '+o.substring(0,50)+'...':''}`)}continue}}s++;continue}s++}return t}static validateContactFormat(e){if(new RegExp(this.CONTACT_REGEX_OLD.source).test(e))return!0;return null!==e.trim().match(/^å§“åï¼š([^å¤´åƒ]+)å¤´åƒï¼š(.+)$/)}static formatContacts(e,t=!1){return t?e.map(e=>`å§“åï¼š${e.name} å¤´åƒï¼š${e.avatar}`).join('\n'):e.map(e=>`[å§“åï¼š${e.name} å¤´åƒï¼š${e.avatar}]`).join('\n')}}const r='[è”ç³»äºº]';class o{contactData=[];CONTACT_STORAGE_KEY='contact_avatars';HERO_STORAGE_KEY='contact_heroes';binding=null;async initialize(){try{console.log('ğŸ¯ [ContactLorebookManager] å¼€å§‹åˆå§‹åŒ–è”ç³»äººä¸–ç•Œä¹¦ç®¡ç†å™¨...'),await this.loadContactsFromLorebook(),console.log(`âœ… [ContactLorebookManager] è”ç³»äººä¸–ç•Œä¹¦ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼ŒåŠ è½½äº† ${this.contactData.length} ä¸ªè”ç³»äºº`)}catch(e){console.error('âŒ [ContactLorebookManager] åˆå§‹åŒ–è”ç³»äººä¸–ç•Œä¹¦ç®¡ç†å™¨å¤±è´¥:',e)}}async loadContactsFromLorebook(){try{console.log('ğŸ¯ å¼€å§‹ä»ä¸–ç•Œä¹¦åŠ è½½è”ç³»äººæ•°æ®...'),await this.tryLoadFromSettings(),this.binding&&0!==this.contactData.length||await this.tryLoadFromContactEntry(),this.binding?'settings'===this.binding.type?console.log(`âœ… ä»"è®¾ç½®"ä¸–ç•Œä¹¦æ¡ç›®åŠ è½½äº† ${this.contactData.length} ä¸ªè”ç³»äºº`):console.log(`âœ… ä»"è”ç³»äºº"ä¸–ç•Œä¹¦æ¡ç›®åŠ è½½äº† ${this.contactData.length} ä¸ªè”ç³»äºº`):console.log('âŒ æœªæ‰¾åˆ°"è®¾ç½®"æˆ–"è”ç³»äºº"ä¸–ç•Œä¹¦æ¡ç›®')}catch(e){console.error('âŒ ä»ä¸–ç•Œä¹¦åŠ è½½è”ç³»äººå¤±è´¥:',e)}}async tryLoadFromSettings(){const e=await this.getCharacterLorebook();if(e){const t=await this.findSettingsEntry(e);if(t){const e=await this.loadContactsFromSettingsEntry(t);if(e.length>0)return this.binding=t,void(this.contactData=e)}}const t=await this.getGlobalLorebooks();for(const e of t){const t=await this.findSettingsEntry(e);if(t){const e=await this.loadContactsFromSettingsEntry(t);if(e.length>0)return this.binding=t,void(this.contactData=e)}}}async tryLoadFromContactEntry(){const e=await this.getCharacterLorebook();if(e){const t=await this.findContactEntry(e);if(t){const e=await this.loadContactsFromContactEntry(t);if(e.length>0)return this.binding=t,void(this.contactData=e)}}const t=await this.getGlobalLorebooks();for(const e of t){const t=await this.findContactEntry(e);if(t){const e=await this.loadContactsFromContactEntry(t);if(e.length>0)return this.binding=t,void(this.contactData=e)}}}async findSettingsEntry(e){try{const t=(await window.getLorebookEntries(e)).find(e=>e.comment?.includes('è®¾ç½®')||e.name?.includes('è®¾ç½®'));if(t){const a=String(t.content||'');if(a.includes(r))return{worldbookName:e,entryUid:t.uid,entryName:t.comment||t.name||'è®¾ç½®',lineBreak:a.includes('\r\n')?'\r\n':'\n',type:'settings'}}}catch(t){console.warn(`âš ï¸ è®¿é—®ä¸–ç•Œä¹¦ ${e} å¤±è´¥:`,t)}return null}async findContactEntry(e){try{const t=(await window.getLorebookEntries(e)).find(e=>e.comment?.includes('è”ç³»äºº')||e.name?.includes('è”ç³»äºº'));if(t){const a=String(t.content||'');return{worldbookName:e,entryUid:t.uid,entryName:t.comment||t.name||'è”ç³»äºº',lineBreak:a.includes('\r\n')?'\r\n':'\n',type:'contact'}}}catch(t){console.warn(`âš ï¸ è®¿é—®ä¸–ç•Œä¹¦ ${e} å¤±è´¥:`,t)}return null}async loadContactsFromSettingsEntry(e){try{const t=(await window.getLorebookEntries(e.worldbookName)).find(t=>t.uid===e.entryUid);if(!t)return[];const a=String(t.content||'');return this.parseContactBlock(a)}catch(e){return console.error('âŒ ä»è®¾ç½®æ¡ç›®åŠ è½½è”ç³»äººå¤±è´¥:',e),[]}}async loadContactsFromContactEntry(e){try{const t=(await window.getLorebookEntries(e.worldbookName)).find(t=>t.uid===e.entryUid);if(!t)return[];const a=String(t.content||'');return n.parseContacts(a)}catch(e){return console.error('âŒ ä»è”ç³»äººæ¡ç›®åŠ è½½å¤±è´¥:',e),[]}}parseContactBlock(e){const t=e.split(/\r?\n/);let a=!1;const s=[];for(const e of t){if(/^\s*\[[^\]]+\]\s*$/.test(e)){if(e.trim()===r){a=!0;continue}if(a)break}a&&s.push(e)}const o=s.join('\n');return n.parseContacts(o,!0)}async getCharacterLorebook(){try{if('function'==typeof window.getCurrentCharPrimaryLorebook)return window.getCurrentCharPrimaryLorebook();console.warn('getCurrentCharPrimaryLorebook å‡½æ•°ä¸å¯ç”¨')}catch(e){console.warn('âš ï¸ è·å–è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e)}return null}async getGlobalLorebooks(){try{if('function'==typeof window.getLorebookSettings){return window.getLorebookSettings().selected_global_lorebooks||[]}return console.warn('getLorebookSettings å‡½æ•°ä¸å¯ç”¨'),[]}catch(e){console.warn('âš ï¸ è·å–å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®å¤±è´¥:',e)}return[]}getContactAvatar(e){const t=this.getCharacterSpecificAvatar(e);if(t)return console.log(`ğŸ¨ [ContactLorebookManager] ä½¿ç”¨è§’è‰²ä¸“ç”¨å¤´åƒ: ${e}`),t;const a=this.contactData.find(t=>t.name===e);return a?.avatar?(console.log(`ğŸ“– [ContactLorebookManager] ä½¿ç”¨ä¸–ç•Œä¹¦é»˜è®¤å¤´åƒ: ${e}`),a.avatar):'./User Avatars/user-default.png'}getContactHero(e){try{const t=(0,s.getCharacterItem)(this.HERO_STORAGE_KEY,{})||{};if(t[e])return t[e];const a=this.contactData.find(t=>t.name===e);return a?.hero?a.hero:''}catch(t){return console.warn(`[ContactLorebookManager] è·å–åŠ¨æ€å¤´å›¾å¤±è´¥: ${e}`,t),''}}setContactHero(e,t){try{const a=(0,s.getCharacterItem)(this.HERO_STORAGE_KEY,{})||{};a[e]=t,(0,s.setCharacterItem)(this.HERO_STORAGE_KEY,a);const n=new CustomEvent('contactHeroUpdated',{detail:{name:e,hero:t,timestamp:Date.now()}});document.dispatchEvent(n),console.log(`ğŸ’¾ [ContactLorebookManager] ä¿å­˜è§’è‰²ä¸“ç”¨åŠ¨æ€å¤´å›¾: ${e}`)}catch(t){console.error(`[ContactLorebookManager] ä¿å­˜åŠ¨æ€å¤´å›¾å¤±è´¥: ${e}`,t)}}clearContactHero(e){try{const t=(0,s.getCharacterItem)(this.HERO_STORAGE_KEY,{})||{};t[e]&&(delete t[e],(0,s.setCharacterItem)(this.HERO_STORAGE_KEY,t));const a=new CustomEvent('contactHeroUpdated',{detail:{name:e,hero:'',timestamp:Date.now()}});document.dispatchEvent(a),console.log(`ğŸ—‘ï¸ [ContactLorebookManager] å·²æ¸…é™¤è§’è‰²ä¸“ç”¨åŠ¨æ€å¤´å›¾: ${e}`)}catch(t){console.error(`[ContactLorebookManager] æ¸…é™¤åŠ¨æ€å¤´å›¾å¤±è´¥: ${e}`,t)}}getCharacterSpecificAvatar(e){try{return((0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{})||{})[e]||null}catch(e){return console.warn('âš ï¸ [ContactLorebookManager] è·å–è§’è‰²ä¸“ç”¨å¤´åƒå¤±è´¥:',e),null}}setCharacterSpecificAvatar(e,t){try{const a=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{})||{};a[e]=t,(0,s.setCharacterItem)(this.CONTACT_STORAGE_KEY,a),console.log(`ğŸ’¾ [ContactLorebookManager] ä¿å­˜è§’è‰²ä¸“ç”¨å¤´åƒ: ${e}`),this.triggerCharacterAvatarUpdate(e,t)}catch(e){console.error('âŒ [ContactLorebookManager] ä¿å­˜è§’è‰²ä¸“ç”¨å¤´åƒå¤±è´¥:',e)}}triggerCharacterAvatarUpdate(e,t){try{const a=new CustomEvent('contactUpdated',{detail:{oldName:e,newName:e,newAvatar:t,timestamp:Date.now()}});document.dispatchEvent(a),console.log(`ğŸ“¢ [ContactLorebookManager] å·²å‘é€è”ç³»äººæ›´æ–°äº‹ä»¶: ${e}`)}catch(e){console.warn('âš ï¸ [ContactLorebookManager] è§¦å‘è”ç³»äººæ›´æ–°å¤±è´¥:',e)}}getContactData(){return[...this.contactData]}hasContact(e){return this.contactData.some(t=>t.name===e)}async reload(){console.log('ğŸ”„ [ContactLorebookManager] è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½è”ç³»äººæ•°æ®...'),await this.loadContactsFromLorebook()}async clearLorebookCharacterCache(){try{await this.loadContactsFromLorebook();const e=this.contactData.map(e=>e.name);if(0===e.length)return console.log('ğŸ“‹ [ContactLorebookManager] ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰è”ç³»äººï¼Œæ— éœ€æ¸…é™¤ç¼“å­˜'),{cleared:0,total:0};const t=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{})||{};let a=0;const n=[];e.forEach(e=>{t[e]&&(delete t[e],a++,n.push(e),console.log(`ğŸ—‘ï¸ [ContactLorebookManager] æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜: ${e}`))}),(0,s.setCharacterItem)(this.CONTACT_STORAGE_KEY,t),console.log(`âœ… [ContactLorebookManager] ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜æ¸…é™¤å®Œæˆ: æ¸…é™¤äº† ${a} ä¸ªè§’è‰²ï¼Œä¸–ç•Œä¹¦å…±æœ‰ ${e.length} ä¸ªè§’è‰²`);const r=new CustomEvent('worldbookAvatarCacheCleared',{detail:{clearedCount:a,worldbookContactNames:e,clearedContactNames:n,timestamp:Date.now()}});return document.dispatchEvent(r),console.log('ğŸ“¢ [ContactLorebookManager] å·²å‘é€ä¸–ç•Œä¹¦å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶'),{cleared:a,total:e.length}}catch(e){return console.error('âŒ [ContactLorebookManager] æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥:',e),{cleared:0,total:0}}}getLorebookCacheStats(){try{const e=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{})||{},t=new Set(this.contactData.map(e=>e.name)),a=Object.keys(e).filter(e=>t.has(e)).length;return{worldbookContacts:this.contactData.length,cachedContacts:Object.keys(e).length,cachedWorldbookContacts:a}}catch(e){return console.error('âŒ [ContactLorebookManager] è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥:',e),{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}}}},95:(e,t,a)=>{a.d(t,{F:()=>s});class s{static instance;binding=null;cached={};loaded=!1;lastLoadedAt=0;TTL_MS=1e4;constructor(){}static getInstance(){return s.instance||(s.instance=new s),s.instance}async getWallpapers(e=!1){return(!this.loaded||e||Date.now()-this.lastLoadedAt>this.TTL_MS)&&await this.refresh(),{...this.cached}}async refresh(){try{if(this.binding=await this.locateSettingsEntry(),!this.binding)return this.cached={},this.loaded=!0,void(this.lastLoadedAt=Date.now());const e=await this.readSettingsEntryContent(this.binding.worldbookName,this.binding.entryUid),t=this.parseAppearanceBlock(e);this.binding.lineBreak=t.lineBreak,this.cached={chatList:t.values['èŠå¤©åˆ—è¡¨å£çº¸']||t.values.chatListWallpaper||void 0,globalChat:t.values['å…¨å±€èŠå¤©å£çº¸']||t.values.globalChatWallpaper||void 0,frameColor:t.values['å¤–æ¡†é¢œè‰²']||t.values.frameColor||t.values.phoneFrameColor||t.values.phoneBorderColor||t.values.borderColor||void 0},this.loaded=!0,this.lastLoadedAt=Date.now()}catch(e){console.warn('[WorldbookAppearanceManager] åˆ·æ–°å¤±è´¥ï¼š',e),this.cached={},this.loaded=!0,this.lastLoadedAt=Date.now()}}async locateSettingsEntry(){try{const e=getCharWorldbookNames('current'),t=[];if(e?.primary&&t.push(e.primary),e?.additional&&Array.isArray(e.additional)&&t.push(...e.additional),t.length>0){const e=await this.locateInWorldbookList(t);if(e)return e}}catch(e){console.warn('[WorldbookAppearanceManager] è·å–è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e)}try{const e=getGlobalWorldbookNames();if(Array.isArray(e)&&e.length>0){const t=await this.locateInWorldbookList(e);if(t)return t}}catch(e){console.warn('[WorldbookAppearanceManager] è·å–å…¨å±€ä¸–ç•Œä¹¦å¤±è´¥:',e)}return null}async locateInWorldbookList(e){for(const t of e)try{const e=(await getWorldbook(t)||[]).filter(e=>String(e?.name||e?.entry||'').includes('è®¾ç½®'));if(!e.length)continue;e.sort((e,t)=>{const a=Number(e?.position?.order??Number.POSITIVE_INFINITY),s=Number(t?.position?.order??Number.POSITIVE_INFINITY);if(a!==s)return a-s;return Number(e?.uid??Number.POSITIVE_INFINITY)-Number(t?.uid??Number.POSITIVE_INFINITY)});const a=e[0];if(null!=a?.uid)return{worldbookName:t,entryUid:a.uid}}catch{}return null}async readSettingsEntryContent(e,t){const a=(await getWorldbook(e)||[]).find(e=>e?.uid===t);return String(a?.content||'')}parseAppearanceBlock(e){const t=e.includes('\r\n')?'\r\n':'\n',a=e.split(/\r?\n/),s=e=>/^\s*\[[^\]]+\]\s*$/.test(e),n=e=>'[å¤–è§‚]'===e.trim();let r=0,o=-1;const i={};for(;r<a.length;){if(n(a[r])){for(o=r,r++;r<a.length&&!s(a[r]);){const e=a[r].trim();if(e){const t=e.match(/^\s*([^ï¼š:]+)\s*[ï¼š:]\s*(.+)\s*$/);if(t){const e=t[1].trim(),a=t[2].trim();a&&(i[e]=a)}}r++}break}r++}return{values:i,lineBreak:t}}}},105:(e,t,a)=>{a.d(t,{N:()=>s});class s{static API_URL='https://api.injahow.cn/meting/?type=song&id=';static async resolve(e){let t=await this.extractSongId(e);if(!t)return null;try{const e=await fetch(`${this.API_URL}${t}`),a=await e.json();if(a&&a.length>0){const e=a[0],t=Array.isArray(e.artist)?e.artist.join(' / '):e.artist;return{title:e.name,artist:t,coverUrl:e.pic,audioUrl:e.url,duration:0,currentTime:0}}return null}catch(e){return console.error('[NeteaseMusicResolver] è§£æå¤±è´¥:',e),null}}static async extractSongId(e){const t=e.match(/id=(\d+)/);return t?t[1]:null}static isNeteaseMusicUrl(e){return e.includes('music.163.com')}}},115:(e,t,a)=>{a.d(t,{R:()=>l,initializeContactManager:()=>c});var s=a(316);let n=null,r=null;async function o(){return r||(r=(async()=>{const e=new s.A;return await new Promise(e=>setTimeout(e,100)),console.log('[DataConverter] ContactManager å·²åˆ›å»º'),n=e,e})()),r}function i(e){try{if(n){const t=n,a=t.getContactAvatar(e);if(a&&a.trim()&&!/user-default\.png$/i.test(a))return a.trim();const s=t.getAllContacts().find(t=>t.name===e);if(s?.avatar&&s.avatar.trim())return s.avatar.trim()}else console.warn(`[DataConverter] å°è¯•è·å– "${e}" çš„å¤´åƒæ—¶ ContactManager æœªåˆå§‹åŒ–ï¼Œå°†ä½¿ç”¨é»˜è®¤å¤´åƒ`),o().catch(e=>{console.warn('[DataConverter] å¼‚æ­¥åˆå§‹åŒ– ContactManager å¤±è´¥:',e)})}catch(e){console.warn('[DataConverter] è§£æå¤´åƒå¤±è´¥:',e)}return'https://files.catbox.moe/u8ccy5.jpg'}async function c(){n?console.log('[DataConverter] ContactManager å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åŠ è½½'):(await o(),console.log('[DataConverter] ContactManager é¦–æ¬¡åˆå§‹åŒ–å®Œæˆ'))}class l{static convertDynamicsData(e,t){const a=t||{name:'å¤šäº‘ç†Š',avatar:'https://files.catbox.moe/u8ccy5.jpg'};return{posts:[...e].sort((e,t)=>{const a='number'==typeof e.messageId?e.messageId:Number.NEGATIVE_INFINITY,s='number'==typeof t.messageId?t.messageId:Number.NEGATIVE_INFINITY;if(s!==a)return s-a;const n='number'==typeof e.no?e.no:Number.NEGATIVE_INFINITY;return('number'==typeof t.no?t.no:Number.NEGATIVE_INFINITY)-n}).map((e,t)=>this.convertPostToDynamics(e,a,t)),currentUser:a}}static convertPostToDynamics(e,t,a){const s=e.authorName||t.name,n={id:void 0!==e.no?`dynamics_${e.no}`:`dynamics_${Date.now()}_${a}`,author:{name:s,username:`@${s.toLowerCase()}`,avatar:i(s)},content:e.content,image:e.imageDescription?this.generateImageUrl(e.imageDescription):e.imageUrl,imageDescription:e.imageDescription,timestamp:this.pickTimestamp(e.timestamp,a),actions:{likes:e.likesCount,shares:e.sharesCount,bookmarks:Math.floor(.3*e.likesCount)},no:e.no,likedBy:e.likedBy?.map(e=>({name:e,username:`@${e.toLowerCase()}`})),comments:e.comments.map((e,t)=>this.convertCommentToDynamics(e,t))};return void 0!==e.messageId&&(n.messageId=e.messageId),n}static convertCommentToDynamics(e,t){return{id:`dynamics_comment_${Date.now()}_${t}`,author:{name:e.authorName,avatar:i(e.authorName)},content:e.content,timestamp:this.generateTimestamp(t,!0)}}static generateImageUrl(e){return'https://files.catbox.moe/8mjvdg.jpg'}static generateAvatarUrl(e){const t=['https://files.catbox.moe/u8ccy5.jpg','https://files.catbox.moe/x2ejbc.jpg','https://files.catbox.moe/tw2ygf.jpg'];return t[this.simpleHash(e)%t.length]}static generateTimestamp(e,t=!1){const a=new Date,s=t?5*(e+1):30*(e+1),n=new Date(a.getTime()-60*s*1e3);return this.formatYMDHM(n)}static pickTimestamp(e,t,a=!1){if('string'==typeof e&&e.trim()){const t=e.trim();if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(t))return t;if(/^\d{2}:\d{2}$/.test(t)){const[e,a]=t.split(':'),s=new Date;let n=new Date(s.getFullYear(),s.getMonth(),s.getDate(),parseInt(e,10),parseInt(a,10),0,0);return n.getTime()>s.getTime()&&n.setDate(n.getDate()-1),this.formatYMDHM(n)}if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(t))return t.replace('T',' ').slice(0,16);const a=new Date(t);if(!isNaN(a.getTime()))return this.formatYMDHM(a)}return this.generateTimestamp(t,a)}static formatYMDHM(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,'0')}-${String(e.getDate()).padStart(2,'0')} ${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`}static parseToMs(e){if(!e)return Number.NEGATIVE_INFINITY;const t=e.trim(),a=t.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);if(a){const[,e,t,s,n,r]=a;return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(s,10),parseInt(n,10),parseInt(r,10),0,0).getTime()}const s=t.match(/^(\d{2}):(\d{2})$/);if(s){const[,e,t]=s,a=new Date;return new Date(a.getFullYear(),a.getMonth(),a.getDate(),parseInt(e,10),parseInt(t,10),0,0).getTime()}const n=new Date(t);return isNaN(n.getTime())?Number.NEGATIVE_INFINITY:n.getTime()}static simpleHash(e){let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return Math.abs(t)}}},316:(e,t,a)=>{a.d(t,{A:()=>r});var s=a(56),n=a(464);class r{contacts=[];groups=[];STORAGE_KEY='contacts';contactLorebookManager;constructor(){this.contactLorebookManager=new s.v,this.initialize(),this.setupEventListeners()}async initialize(){try{console.log('ğŸš€ [ContactManager] å¼€å§‹åˆå§‹åŒ–è”ç³»äººç®¡ç†å™¨...'),await this.contactLorebookManager.initialize(),this.loadContacts(),this.mergeLorebookContacts(),console.log(`âœ… [ContactManager] è”ç³»äººç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼Œå…± ${this.contacts.length} ä¸ªè”ç³»äºº`)}catch(e){console.error('âŒ [ContactManager] åˆå§‹åŒ–å¤±è´¥:',e),this.loadContacts()}}setupEventListeners(){document.addEventListener('worldbookAvatarCacheCleared',e=>{const t=e;console.log('ğŸ”„ [ContactManager] æ”¶åˆ°ä¸–ç•Œä¹¦å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶:',t.detail),this.refreshWorldbookContactAvatars()})}refreshWorldbookContactAvatars(){console.log('ğŸ”„ [ContactManager] å¼€å§‹åˆ·æ–°ä¸–ç•Œä¹¦è”ç³»äººå¤´åƒ...');let e=0;if(this.contacts.forEach(t=>{if(t.tags&&t.tags.includes('ä¸–ç•Œä¹¦')){const a=this.getContactAvatar(t.name);t.avatar!==a&&(console.log(`ğŸ”„ [ContactManager] æ›´æ–°è”ç³»äººå¤´åƒ: ${t.name}`),console.log(`   æ—§å¤´åƒ: ${t.avatar}`),console.log(`   æ–°å¤´åƒ: ${a}`),t.avatar=a,e++)}}),e>0){this.saveContacts(),console.log(`âœ… [ContactManager] å·²æ›´æ–° ${e} ä¸ªä¸–ç•Œä¹¦è”ç³»äººçš„å¤´åƒ`);const t=new CustomEvent('chatListChanged',{detail:{reason:'worldbook_avatar_refresh',updatedCount:e,timestamp:Date.now()}});document.dispatchEvent(t),console.log('ğŸ“¢ [ContactManager] å·²å‘é€èŠå¤©åˆ—è¡¨åˆ·æ–°äº‹ä»¶')}else console.log('â„¹ï¸ [ContactManager] æ²¡æœ‰éœ€è¦æ›´æ–°çš„ä¸–ç•Œä¹¦è”ç³»äººå¤´åƒ')}loadContacts(){try{const e=(0,n.getCharacterItem)(this.STORAGE_KEY,null);e?(this.contacts=e.contacts||[],this.groups=e.groups||[],console.log(`ğŸ“‹ ä»è§’è‰²ä¸“ç”¨ç©ºé—´åŠ è½½è”ç³»äºº: ${this.contacts.length} ä¸ª`)):this.initializeDefaultContacts()}catch(e){console.warn('åŠ è½½è”ç³»äººæ•°æ®å¤±è´¥:',e),this.initializeDefaultContacts()}}mergeLorebookContacts(){try{const e=this.contactLorebookManager.getContactData();console.log(`ğŸ”„ [ContactManager] å¼€å§‹åˆå¹¶ ${e.length} ä¸ªä¸–ç•Œä¹¦è”ç³»äºº...`),e.forEach(e=>{if(this.contacts.find(t=>t.name===e.name))console.log(`â­ï¸ [ContactManager] è”ç³»äººå·²å­˜åœ¨ï¼Œè·³è¿‡: ${e.name}`);else{this.addContact({name:e.name,avatar:this.getContactAvatar(e.name),type:'character',isOnline:!1,tags:['ä¸–ç•Œä¹¦']});console.log(`â• [ContactManager] ä»ä¸–ç•Œä¹¦æ·»åŠ è”ç³»äºº: ${e.name}`)}}),console.log('âœ… [ContactManager] ä¸–ç•Œä¹¦è”ç³»äººåˆå¹¶å®Œæˆ')}catch(e){console.error('âŒ [ContactManager] åˆå¹¶ä¸–ç•Œä¹¦è”ç³»äººå¤±è´¥:',e)}}async reloadContacts(){console.log('ğŸ”„ [ContactManager] è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½è”ç³»äººæ•°æ®...'),await this.contactLorebookManager.reload(),this.loadContacts(),this.mergeLorebookContacts()}getContactAvatar(e){return this.contactLorebookManager.getContactAvatar(e)}async clearLorebookCharacterCache(){return this.contactLorebookManager?await this.contactLorebookManager.clearLorebookCharacterCache():{cleared:0,total:0}}getLorebookCacheStats(){return this.contactLorebookManager?this.contactLorebookManager.getLorebookCacheStats():{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}saveContacts(){try{const e={contacts:this.contacts,groups:this.groups,lastUpdated:Date.now()};(0,n.setCharacterItem)(this.STORAGE_KEY,e),console.log(`ğŸ’¾ è”ç³»äººæ•°æ®å·²ä¿å­˜åˆ°è§’è‰²ä¸“ç”¨ç©ºé—´: ${this.contacts.length} ä¸ª`)}catch(e){console.error('ä¿å­˜è”ç³»äººæ•°æ®å¤±è´¥:',e)}}initializeDefaultContacts(){this.contacts=[],this.groups=[],this.saveContacts()}getAllContacts(){return[...this.contacts]}getContactById(e){return this.contacts.find(t=>t.id===e)||null}searchContacts(e){const t=e.toLowerCase();return this.contacts.filter(e=>e.name.toLowerCase().includes(t)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(t)))}addContact(e){const t={...e,id:this.generateContactId()};return this.contacts.push(t),this.saveContacts(),t}updateContact(e,t){const a=this.contacts.find(t=>t.id===e);return!!a&&(t.avatar&&this.contactLorebookManager.setCharacterSpecificAvatar(a.name,t.avatar),Object.assign(a,t),this.saveContacts(),!0)}deleteContact(e){const t=this.contacts.findIndex(t=>t.id===e);return-1!==t&&(this.contacts.splice(t,1),this.saveContacts(),!0)}getAllGroups(){return[...this.groups]}createGroup(e,t,a){const s={id:this.generateGroupId(),name:e,avatar:this.getDefaultGroupAvatar(),members:t,createdAt:(new Date).toISOString(),description:a};return this.groups.push(s),this.saveContacts(),s}updateGroup(e,t){const a=this.groups.findIndex(t=>t.id===e);return-1!==a&&(this.groups[a]={...this.groups[a],...t},this.saveContacts(),!0)}deleteGroup(e){const t=this.groups.findIndex(t=>t.id===e);return-1!==t&&(this.groups.splice(t,1),this.saveContacts(),!0)}generateContactId(){return'contact_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}generateGroupId(){return'group_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}getDefaultGroupAvatar(){const e=['https://files.catbox.moe/group1.jpg','https://files.catbox.moe/group2.jpg','https://files.catbox.moe/group3.jpg'];return e[Math.floor(Math.random()*e.length)]}getOnlineContacts(){return this.contacts.filter(e=>e.isOnline)}getContactsByTag(e){return this.contacts.filter(t=>t.tags&&t.tags.includes(e))}getAllTags(){const e=new Set;return this.contacts.forEach(t=>{t.tags&&t.tags.forEach(t=>e.add(t))}),Array.from(e)}async validateAvatarUrl(e){try{const t=await fetch(e,{method:'HEAD'}),a=t.headers.get('content-type');return t.ok&&!!a&&a.startsWith('image/')}catch{return!1}}async processAvatarFile(e){return new Promise((t,a)=>{if(!e.type.startsWith('image/'))return void a(new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶'));if(e.size>2097152)return void a(new Error('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB'));const s=new FileReader;s.onload=e=>{const a=e.target?.result;t(a)},s.onerror=()=>{a(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'))},s.readAsDataURL(e)})}getDefaultAvatar(e){return'https://files.catbox.moe/u8ccy5.jpg'}extractContactsFromChatData(e){const t=new Set;e.forEach(e=>{e.messages&&Array.isArray(e.messages)&&e.messages.forEach(e=>{e.sender&&'{{user}}'!==e.sender&&'user'!==e.sender&&t.add(e.sender)})}),t.forEach(t=>{if(!this.contacts.find(e=>e.name===t)){const a=this.getAvatarFromChatData(t,e);this.addContact({name:t,avatar:a||this.getDefaultAvatar(t),type:'character',isOnline:!0,tags:['èŠå¤©è®°å½•']})}})}getAvatarFromChatData(e,t){let a=null;return t.forEach(t=>{if(!a&&t.messages&&Array.isArray(t.messages)){const s=t.messages.find(t=>t.sender===e&&t.avatar);s&&s.avatar&&(a=this.processAvatarUrl(s.avatar))}}),a}processAvatarUrl(e){if(!e)return'';if(e.startsWith('http://')||e.startsWith('https://'))return e;const t=e.match(/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(t){return`https://files.catbox.moe/${t[1]}`}return`https://files.catbox.moe/${e}`}validateContactName(e){return e&&0!==e.trim().length?e.trim().length>20?{valid:!1,error:'è”ç³»äººåç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦'}:this.contacts.some(t=>t.name===e.trim())?{valid:!1,error:'è¯¥è”ç³»äººåç§°å·²å­˜åœ¨'}:{valid:!0}:{valid:!1,error:'è¯·è¾“å…¥è”ç³»äººåç§°'}}getCurrentCharacterId(){try{if(window.TavernHelper&&window.TavernHelper.getCharData){const e=window.TavernHelper.getCharData();if(e)return e.avatar||e.name||'default'}return'default'}catch(e){return console.error('[ContactManager] è·å–è§’è‰²IDå¤±è´¥:',e),'default'}}}},335:(e,t,a)=>{a.r(t),a.d(t,{UserInfoRetrieval:()=>s,debugUserInfoEnvironment:()=>c,defaultUserInfoRetrieval:()=>n,getSimpleUserAvatar:()=>p,getUserAvatar:()=>l,getUserAvatarAsync:()=>d,getUserInfo:()=>r,getUserName:()=>o,getUserNameAsync:()=>i});class s{options;constructor(e={}){this.options={defaultUserName:e.defaultUserName||'User',defaultAvatarUrl:e.defaultAvatarUrl||'https://files.catbox.moe/u8ccy5.jpg',enableLogging:!1!==e.enableLogging}}getUserInfo(){return{id:'{{user}}',name:this.getUserName(),avatar:this.getUserAvatar()}}getUserName(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros){const e=window.TavernHelper.substitudeMacros('{{user}}');if(e&&'{{user}}'!==e&&e.trim())return e.trim()}const e=[()=>window.power_user?.name,()=>window.name1,()=>window.user_name,()=>window.userName];for(const t of e)try{const e=t();if(e&&'string'==typeof e&&e.trim())return e.trim()}catch(e){}return this.options.defaultUserName}catch(e){return this.options.defaultUserName}}async getUserNameAsync(){try{if('function'==typeof triggerSlash)try{const e=await triggerSlash('/pass {{user}}');if(e&&'string'==typeof e&&e.trim()&&'{{user}}'!==e)return e.trim()}catch(e){}return this.getUserName()}catch(e){return this.options.defaultUserName}}getUserAvatar(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros)try{const e=window.TavernHelper.substitudeMacros('{{userAvatarPath}}');if(e&&'{{userAvatarPath}}'!==e&&e.trim())return this.log('âœ… ä» {{userAvatarPath}} å®è·å–åˆ°ç”¨æˆ·å¤´åƒ:',e),e.trim()}catch(e){this.log('âš ï¸ å®æ›¿æ¢å¤±è´¥:',e)}if(window.power_user?.avatar)return this.log('âœ… ä» power_user.avatar è·å–åˆ°ç”¨æˆ·å¤´åƒ'),window.power_user.avatar;if(window.user_avatar){const e=window.user_avatar;if('string'==typeof e&&e.trim())return this.log('âœ… ä» user_avatar å…¨å±€å˜é‡è·å–åˆ°ç”¨æˆ·å¤´åƒ:',e),e.trim()}const e=document.querySelector('.user-avatar, .user_avatar');if(e){this.log('ğŸ” æ‰¾åˆ° .user_avatar å…ƒç´ ï¼Œå°è¯•è·å–å¤´åƒ');const t=window.getComputedStyle(e).backgroundImage;if(t&&'none'!==t){const e=t.match(/url\(["']?([^"']*)["']?\)/);if(e?.[1])return this.log('âœ… ä» .user_avatar å…ƒç´ çš„ background-image è·å–åˆ°ç”¨æˆ·å¤´åƒ:',e[1]),e[1]}if('IMG'===e.tagName){const t=e.src;if(t)return this.log('âœ… ä» .user_avatar img å…ƒç´ çš„ src è·å–åˆ°ç”¨æˆ·å¤´åƒ:',t),t}const a=e.querySelector('img');if(a&&a.src)return this.log('âœ… ä» .user_avatar å†…éƒ¨ img å…ƒç´ è·å–åˆ°ç”¨æˆ·å¤´åƒ:',a.src),a.src;const s=e.getAttribute('data-avatar')||e.getAttribute('data-src')||e.getAttribute('data-image');if(s)return this.log('âœ… ä» .user_avatar å…ƒç´ çš„ data å±æ€§è·å–åˆ°ç”¨æˆ·å¤´åƒ:',s),s;this.log('âš ï¸ .user_avatar å…ƒç´ å­˜åœ¨ä½†æœªæ‰¾åˆ°å¤´åƒä¿¡æ¯')}else this.log('âš ï¸ æœªæ‰¾åˆ° .user_avatar å…ƒç´ ');const t=[()=>window.settings?.user_avatar,()=>window.chat_metadata?.user_avatar,()=>window.persona?.avatar];for(const e of t)try{const t=e();if(t&&'string'==typeof t&&t.trim())return this.log('âœ… ä»å…¶ä»–å…¨å±€å˜é‡è·å–åˆ°ç”¨æˆ·å¤´åƒ:',t),t.trim()}catch(e){}return this.log('âš ï¸ æ— æ³•è·å–ç”¨æˆ·å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ'),this.options.defaultAvatarUrl}catch(e){return this.log('âŒ è·å–ç”¨æˆ·å¤´åƒå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:',e),this.options.defaultAvatarUrl}}isTavernHelperAvailable(){return!(!window.TavernHelper||!window.TavernHelper.substitudeMacros)}getAvailableGlobalVars(){const e={};try{const t=['power_user','name1','user_name','userName','user_avatar','settings','chat_metadata','characters','this_chid','TavernHelper','eventSource','main_api'];for(const a of t)try{const t=window[a];void 0!==t&&(e[a]=t)}catch(e){}}catch(e){this.log('è·å–å…¨å±€å˜é‡æ—¶å‡ºé”™:',e)}return e}debugEnvironment(){this.log('=== ç”¨æˆ·ä¿¡æ¯è·å–ç¯å¢ƒæ£€æŸ¥ ==='),this.log('triggerSlash å‡½æ•°å¯ç”¨:','function'==typeof triggerSlash),this.log('TavernHelper å¯ç”¨:',!!window.TavernHelper),this.log('power_user å¯ç”¨:',!!window.power_user);const e=document.querySelector('.user_avatar');if(e){this.log('âœ… .user_avatar å…ƒç´ å­˜åœ¨'),this.log('å…ƒç´ æ ‡ç­¾:',e.tagName),this.log('å…ƒç´ ç±»å:',e.className);const t=window.getComputedStyle(e).backgroundImage;this.log('èƒŒæ™¯å›¾ç‰‡:',t),'IMG'===e.tagName&&this.log('img src:',e.src);const a=e.querySelector('img');a&&this.log('å†…éƒ¨ img src:',a.src);['data-avatar','data-src','data-image'].forEach(t=>{const a=e.getAttribute(t);a&&this.log(`${t}:`,a)})}else this.log('âŒ .user_avatar å…ƒç´ ä¸å­˜åœ¨');this.log('=== æ£€æŸ¥å®Œæˆ ===')}log(e,t){this.options.enableLogging&&(void 0!==t?console.log(`[UserInfoRetrieval] ${e}`,t):console.log(`[UserInfoRetrieval] ${e}`))}updateOptions(e){this.options={...this.options,...e}}}const n=new s;function r(e){return(e?new s(e):n).getUserInfo()}function o(e){return(e?new s(e):n).getUserName()}async function i(e){return(e?new s(e):n).getUserNameAsync()}function c(e){(e?new s(e):n).debugEnvironment()}function l(e){return(e?new s(e):n).getUserAvatar()}async function d(e){try{return'undefined'!=typeof window&&window.avatarSourceService?await window.avatarSourceService.getCurrentAvatar():l(e)}catch(t){return console.warn('[getUserAvatarAsync] å¼‚æ­¥è·å–å¤±è´¥ï¼Œé™çº§åˆ°åŒæ­¥æ–¹æ³•:',t),l(e)}}let h=null,m=0;const g=1e3,u=!1;function p(e='https://files.catbox.moe/u8ccy5.jpg'){try{const t=Date.now();if(h&&t-m<g)return h;const a=document.querySelector('.user-avatar, .user_avatar');if(!a)return u&&h!==e&&console.log('[SimpleUserAvatar] æœªæ‰¾åˆ° .user_avatar å…ƒç´ '),h=e,m=t,e;const s=[()=>{const e=window.getComputedStyle(a).backgroundImage;if(e&&'none'!==e){const t=e.match(/url\(["']?([^"']*)["']?\)/);if(t?.[1])return u&&console.log('[SimpleUserAvatar] ä» background-image è·å–å¤´åƒ:',t[1]),t[1]}return null},()=>{if('IMG'===a.tagName){const e=a.src;if(e)return u&&console.log('[SimpleUserAvatar] ä» img src è·å–å¤´åƒ:',e),e}return null},()=>{const e=a.querySelector('img');return e&&e.src?(u&&console.log('[SimpleUserAvatar] ä»å†…éƒ¨ img è·å–å¤´åƒ:',e.src),e.src):null},()=>{const e=['data-avatar','data-src','data-image','data-url'];for(const t of e){const e=a.getAttribute(t);if(e)return u&&console.log(`[SimpleUserAvatar] ä» ${t} è·å–å¤´åƒ:`,e),e}return null},()=>{const e=a.getAttribute('style');if(e){const t=e.match(/background-image:\s*url\(["']?([^"']*)["']?\)/);if(t?.[1])return u&&console.log('[SimpleUserAvatar] ä» style å±æ€§è·å–å¤´åƒ:',t[1]),t[1]}return null}];for(const e of s)try{const t=e();if(t)return t}catch(e){}return u&&console.log('[SimpleUserAvatar] æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ'),e}catch(t){return u&&console.error('[SimpleUserAvatar] è·å–å¤´åƒæ—¶å‘ç”Ÿé”™è¯¯:',t),e}}},464:(e,t,a)=>{a.r(t),a.d(t,{clearCharacterIdCache:()=>m,getCharacterItem:()=>d,removeCharacterItem:()=>h,setCharacterItem:()=>l});let s=null,n=null,r=0;const o=1e3;function i(){try{const e=Date.now();if(n&&e-r<o)return n;if('function'==typeof getCharData)try{const t=getCharData('current');if(t){const a=t.name||t.avatar||'default';return n=a,r=e,a!==s&&(console.log(`[CharacterStorage] âœ… è§’è‰²IDå˜æ›´: ${s} â†’ ${a}`),s=a),a}}catch(e){console.error('[CharacterStorage] getCharData(\'current\') è°ƒç”¨å¤±è´¥:',e)}if(window.TavernHelper&&'function'==typeof window.TavernHelper.getCharData)try{const t=window.TavernHelper.getCharData('current');if(t){const a=t.name||t.avatar||'default';return n=a,r=e,a!==s&&(console.log(`[CharacterStorage] âœ… è§’è‰²IDå˜æ›´(window): ${s} â†’ ${a}`),s=a),a}}catch(e){console.error('[CharacterStorage] window.TavernHelper.getCharData(\'current\') è°ƒç”¨å¤±è´¥:',e)}if(void 0!==window.this_chid&&void 0!==window.characters){const t=window.this_chid,a=window.characters;if(a[t]){const o=a[t],i=o.name||o.avatar||`char_${t}`;return n=i,r=e,i!==s&&(console.log(`[CharacterStorage] âœ… è§’è‰²IDå˜æ›´(ä¼ ç»Ÿ): ${s} â†’ ${i}`),s=i),i}}const t='default';return n=t,r=e,t!==s&&(console.log('[CharacterStorage] âš ï¸ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²ID'),s=t),t}catch(e){return console.error('[CharacterStorage] è·å–è§’è‰²IDå¤±è´¥:',e),'default'}}function c(e){return`bear_chat_isolated_${i()}_${e}`}function l(e,t){try{const a=c(e);localStorage.setItem(a,JSON.stringify(t))}catch(t){console.error(`[CharacterStorage] å­˜å‚¨å¤±è´¥ ${e}:`,t)}}function d(e,t=null){try{const a=c(e),s=localStorage.getItem(a);return s?JSON.parse(s):t}catch(a){return console.error(`[CharacterStorage] è·å–å¤±è´¥ ${e}:`,a),t}}function h(e){try{const t=c(e);localStorage.removeItem(t)}catch(t){console.error(`[CharacterStorage] åˆ é™¤å¤±è´¥ ${e}:`,t)}}function m(){n=null,r=0,s=null,console.log('[CharacterStorage] è§’è‰²IDç¼“å­˜å·²æ¸…é™¤')}},582:(e,t,a)=>{a.d(t,{WallpaperManager:()=>r});var s=a(764),n=a(95);class r{static instance;storageManager;currentWallpaper='';defaultWallpaper='https://files.catbox.moe/o84j4n.jpg';settingsChangeListener;constructor(){this.storageManager=s.StorageManager.getInstance(),this.initialize()}static getInstance(){return r.instance||(r.instance=new r),r.instance}initialize(){this.loadWallpaperFromSettings(),this.settingsChangeListener=e=>{const t=e;this.handleSettingsChange(t.detail.settings)},document.addEventListener('settingsChange',this.settingsChangeListener),document.addEventListener('characterChange',()=>{console.log('[WallpaperManager] æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½å£çº¸'),this.forceRefresh()}),this.applyWallpaper()}loadWallpaperFromSettings(){try{const e=this.storageManager.loadSettings();this.currentWallpaper=e.chatListWallpaper||this.defaultWallpaper,console.log('[WallpaperManager] åŠ è½½å£çº¸è®¾ç½®:',e.chatListWallpaper?'è‡ªå®šä¹‰å£çº¸':this.currentWallpaper===this.defaultWallpaper?'é»˜è®¤å£çº¸':'ä¸–ç•Œä¹¦å£çº¸'),e.chatListWallpaper||this.applyWorldbookFallbackIfNeeded()}catch(e){console.error('[WallpaperManager] åŠ è½½å£çº¸è®¾ç½®å¤±è´¥:',e),this.currentWallpaper=this.defaultWallpaper}}async applyWorldbookFallbackIfNeeded(){try{const e=await n.F.getInstance().getWallpapers();if(e?.chatList){this.storageManager.loadSettings().chatListWallpaper||this.currentWallpaper===e.chatList||(this.currentWallpaper=e.chatList,this.applyWallpaper(),console.log('[WallpaperManager] ä½¿ç”¨ä¸–ç•Œä¹¦å›é€€å£çº¸ï¼ˆèŠå¤©åˆ—è¡¨ï¼‰'))}}catch(e){console.warn('[WallpaperManager] åº”ç”¨ä¸–ç•Œä¹¦å›é€€å¤±è´¥:',e)}}handleSettingsChange(e){const t=e.chatListWallpaper||this.defaultWallpaper;t!==this.currentWallpaper&&(console.log('[WallpaperManager] æ£€æµ‹åˆ°å£çº¸å˜æ›´ï¼Œåº”ç”¨æ–°å£çº¸'),this.currentWallpaper=t,this.applyWallpaper())}applyWallpaper(){const e=document.querySelector('.chat-list-interface');e?(e.style.backgroundImage=`url('${this.currentWallpaper}')`,e.style.backgroundSize='cover',e.style.backgroundPosition='center',e.style.backgroundRepeat='no-repeat',console.log('[WallpaperManager] å£çº¸å·²åº”ç”¨åˆ°èŠå¤©åˆ—è¡¨ç•Œé¢')):(console.warn('[WallpaperManager] æœªæ‰¾åˆ°èŠå¤©åˆ—è¡¨ç•Œé¢å…ƒç´ ï¼Œç¨åé‡è¯•'),setTimeout(()=>{this.applyWallpaper()},100))}setCustomWallpaper(e){try{this.currentWallpaper=e;const t=this.storageManager.loadSettings();t.chatListWallpaper=e,this.storageManager.saveSettings(t),this.applyWallpaper(),console.log('[WallpaperManager] è‡ªå®šä¹‰å£çº¸è®¾ç½®æˆåŠŸ')}catch(e){throw console.error('[WallpaperManager] è®¾ç½®è‡ªå®šä¹‰å£çº¸å¤±è´¥:',e),e}}resetToDefault(){try{this.currentWallpaper=this.defaultWallpaper;const e=this.storageManager.loadSettings();e.chatListWallpaper='',this.storageManager.saveSettings(e),this.applyWallpaper(),console.log('[WallpaperManager] å·²é‡ç½®ä¸ºé»˜è®¤å£çº¸')}catch(e){throw console.error('[WallpaperManager] é‡ç½®é»˜è®¤å£çº¸å¤±è´¥:',e),e}}getCurrentWallpaper(){return this.currentWallpaper}isUsingCustomWallpaper(){return this.currentWallpaper!==this.defaultWallpaper}preloadWallpaper(e){return new Promise((t,a)=>{const s=new Image;s.onload=()=>{console.log('[WallpaperManager] å£çº¸é¢„åŠ è½½æˆåŠŸ'),t()},s.onerror=e=>{console.error('[WallpaperManager] å£çº¸é¢„åŠ è½½å¤±è´¥:',e),a(e)},s.src=e})}forceRefresh(){console.log('[WallpaperManager] å¼ºåˆ¶åˆ·æ–°å£çº¸'),this.loadWallpaperFromSettings(),this.applyWallpaper()}handleCharacterChange(){console.log('[WallpaperManager] å¤„ç†è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½å£çº¸è®¾ç½®'),this.forceRefresh()}clearWallpaperCache(){try{const e=this.storageManager.loadSettings();e.chatListWallpaper='',this.storageManager.saveSettings(e),this.currentWallpaper=this.defaultWallpaper,this.applyWallpaper(),console.log('[WallpaperManager] å£çº¸ç¼“å­˜å·²æ¸…é™¤ï¼Œå·²æ¢å¤ä¸ºé»˜è®¤å£çº¸')}catch(e){throw console.error('[WallpaperManager] æ¸…é™¤å£çº¸ç¼“å­˜å¤±è´¥:',e),e}}destroy(){this.settingsChangeListener&&document.removeEventListener('settingsChange',this.settingsChangeListener);const e=document.querySelector('.chat-list-interface');e&&(e.style.backgroundImage=`url('${this.defaultWallpaper}')`),console.log('[WallpaperManager] å£çº¸ç®¡ç†å™¨å·²é”€æ¯')}}},691:(e,t,a)=>{a.d(t,{By:()=>i,TL:()=>r,a$:()=>s,d5:()=>n,nl:()=>o});const s={chatListWallpaper:'https://files.catbox.moe/o84j4n.jpg',globalChatWallpaper:'',individualChatWallpapers:{},emojiSuggestionsEnabled:!0,crossChatSendEnabled:!1,version:'1.0.0'},n={USER_DATA:'duoyunxiong_user_data',APP_SETTINGS:'duoyunxiong_app_settings'},r={maxSize:2097152,acceptedTypes:['image/jpeg','image/png','image/webp'],quality:.8};var o,i;!function(e){e.IDLE='idle',e.LOADING='loading',e.EDITING='editing',e.SAVING='saving',e.ERROR='error'}(o||(o={})),function(e){e.STORAGE_ERROR='storage_error',e.NETWORK_ERROR='network_error',e.FILE_ERROR='file_error',e.VALIDATION_ERROR='validation_error'}(i||(i={}))},721:(e,t,a)=>{a.r(t),a.d(t,{GlobalUserManager:()=>r});var s=a(764),n=a(691);class r{static instance;storageManager;currentUserData=null;eventListeners=new Map;constructor(){this.storageManager=s.StorageManager.getInstance()}static getInstance(){return r.instance||(r.instance=new r),r.instance}initialize(){return new Promise(async(e,t)=>{try{await this.loadUserData(),e()}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ç®¡ç†å™¨å¤±è´¥',details:e,timestamp:Date.now()}),t(e)}})}async loadUserData(){try{let e=this.storageManager.loadUserData();return e||(e=await this.storageManager.getDefaultUserData()),this.currentUserData=e,e}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()});const t={name:'ç”¨æˆ·',avatar:'',isCustom:!1,lastUpdated:Date.now()};return this.currentUserData=t,t}}getCurrentUserData(){return this.currentUserData}async getUserName(){if(this.currentUserData?.isCustom)return this.currentUserData.name;try{return await triggerSlash('/pass {{user}}')||'ç”¨æˆ·'}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'è·å–ç”¨æˆ·åç§°å¤±è´¥',details:e,timestamp:Date.now()}),this.currentUserData?.name||'ç”¨æˆ·'}}async getUserAvatar(){if(this.currentUserData?.isCustom)return this.currentUserData.avatar;try{return await triggerSlash('/pass {{userAvatarPath}}')||''}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'è·å–ç”¨æˆ·å¤´åƒå¤±è´¥',details:e,timestamp:Date.now()}),this.currentUserData?.avatar||''}}async updateUserName(e){const t=this.currentUserData?.name||'';try{const a={name:e,avatar:this.currentUserData?.avatar||'',isCustom:!0,lastUpdated:Date.now()};this.storageManager.saveUserData(a),this.currentUserData=a,this.emitUserInfoChange({type:'name',oldValue:t,newValue:e,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'æ›´æ–°ç”¨æˆ·åç§°å¤±è´¥',details:e,timestamp:Date.now()}),e}}async updateUserAvatar(e){const t=this.currentUserData?.avatar||'';try{const a={name:this.currentUserData?.name||'ç”¨æˆ·',avatar:e,isCustom:!0,lastUpdated:Date.now()};this.storageManager.saveUserData(a),this.currentUserData=a,this.emitUserInfoChange({type:'avatar',oldValue:t,newValue:e,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'æ›´æ–°ç”¨æˆ·å¤´åƒå¤±è´¥',details:e,timestamp:Date.now()}),e}}async resetToDefault(){try{this.storageManager.clearUserData();const e=await this.storageManager.getDefaultUserData();this.currentUserData=e,this.emitUserInfoChange({type:'name',oldValue:this.currentUserData?.name||'',newValue:e.name,timestamp:Date.now()}),this.emitUserInfoChange({type:'avatar',oldValue:this.currentUserData?.avatar||'',newValue:e.avatar,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'é‡ç½®ç”¨æˆ·ä¿¡æ¯å¤±è´¥',details:e,timestamp:Date.now()}),e}}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const a=this.eventListeners.get(e);if(a){const e=a.indexOf(t);e>-1&&a.splice(e,1)}}emitUserInfoChange(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error('ç”¨æˆ·ä¿¡æ¯å˜æ›´ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:',e)}});const a=this.eventListeners.get('all');a&&a.forEach(t=>{try{t(e)}catch(e){console.error('ç”¨æˆ·ä¿¡æ¯å˜æ›´ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:',e)}})}handleError(e){console.error(`[GlobalUserManager] ${e.message}:`,e.details),window.TavernHelper?.errorCatched&&window.TavernHelper.errorCatched(e)}getUserInfoStats(){const e=this.currentUserData;return{isCustom:e?.isCustom||!1,lastUpdated:e?.lastUpdated||0,hasAvatar:Boolean(e?.avatar),nameLength:e?.name?.length||0}}validateUserData(e){const t=[];return void 0!==e.name&&('string'!=typeof e.name?t.push('ç”¨æˆ·åå¿…é¡»æ˜¯å­—ç¬¦ä¸²'):0===e.name.length?t.push('ç”¨æˆ·åä¸èƒ½ä¸ºç©º'):e.name.length>50&&t.push('ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦')),void 0!==e.avatar&&'string'!=typeof e.avatar&&t.push('å¤´åƒæ•°æ®å¿…é¡»æ˜¯å­—ç¬¦ä¸²'),{isValid:0===t.length,errors:t}}}},750:(e,t,a)=>{a.r(t),a.d(t,{AvatarSync:()=>r,SimpleAvatarMixin:()=>o,autoRegisterAvatars:()=>l,avatarSync:()=>i,cleanupInvalidAvatarElements:()=>p,forceUpdateAvatars:()=>d,getAvatarSyncDebugInfo:()=>g,getMemberAvatarStats:()=>u,registerAvatarElement:()=>c,registerMemberAvatarElement:()=>m,syncAvatars:()=>h});var s=a(335),n=a(17);class r{static instance;currentAvatar='';registeredElements=new Map;memberElements=new Map;options;syncTimer=null;mutationObserver=null;discoveryDebounceTimer=null;isDestroyed=!1;isInternalOperation=!1;constructor(e={}){this.options={debug:e.debug??!1,syncInterval:e.syncInterval??1e3,enableMutationObserver:e.enableMutationObserver??!0,discoveryDebounceDelay:e.discoveryDebounceDelay??300,enablePeriodicSync:e.enablePeriodicSync??!1},this.log('å¢å¼ºçš„å¤´åƒåŒæ­¥ç®¡ç†å™¨å·²åˆå§‹åŒ–'),this.initialize()}initialize(){this.options.enablePeriodicSync?this.startSync():this.sync(),this.setupMutationObserver(),this.performInitialDiscovery()}static getInstance(e){return r.instance||(r.instance=new r(e)),r.instance}registerElement(e,t='background'){if(this.isDestroyed)return;if(this.registeredElements.has(e))return void this.log(`å…ƒç´ å·²ç»æ³¨å†Œï¼Œè·³è¿‡: ${e.className||e.tagName}`);const a='string'==typeof t?{type:t}:t;if(a.validator&&!a.validator(e))return void this.log(`å…ƒç´ éªŒè¯å¤±è´¥ï¼Œè·³è¿‡æ³¨å†Œ: ${e.className||e.tagName}`);this.withInternalOperation(()=>{e.setAttribute('data-avatar-sync','true'),e.setAttribute('data-avatar-type',a.type),a.memberId&&e.setAttribute('data-member-id',a.memberId)});const s={element:e,config:a,lastUpdate:Date.now(),isValid:!0};this.registeredElements.set(e,s),'member-avatar'===a.type&&a.memberId&&(this.memberElements.has(a.memberId)||this.memberElements.set(a.memberId,new Set),this.memberElements.get(a.memberId).add(e)),this.updateElement(e,a,this.currentAvatar||this.getUnifiedUserAvatarSyncLocal()),this.log(`å·²æ³¨å†Œå¤´åƒå…ƒç´ : ${e.className||e.tagName} (ç±»å‹: ${a.type})`)}unregisterElement(e){const t=this.registeredElements.get(e);if(t&&'member-avatar'===t.config.type&&t.config.memberId){const a=this.memberElements.get(t.config.memberId);a&&(a.delete(e),0===a.size&&this.memberElements.delete(t.config.memberId))}this.withInternalOperation(()=>{e.removeAttribute('data-avatar-sync'),e.removeAttribute('data-avatar-type'),e.removeAttribute('data-member-id')}),this.registeredElements.delete(e),this.log(`å·²å–æ¶ˆæ³¨å†Œå¤´åƒå…ƒç´ : ${e.className||e.tagName}`)}autoRegister(){if(this.isDestroyed)return;let e=0;e+=this.registerUserAvatarElements(),e+=this.registerMemberAvatarElements(),e+=this.registerSpecialAvatarElements(),e>0&&this.log(`è‡ªåŠ¨æ³¨å†Œäº† ${e} ä¸ªå¤´åƒå…ƒç´ `)}registerUserAvatarElements(){let e=0;return['.user_avatar.avatar.avatar-hover','.user-avatar','.user_avatar'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{const a=t;if(!a.hasAttribute('data-avatar-sync')&&this.isUserAvatarElement(a)){const t='IMG'===a.tagName?'img':'background';this.registerElement(a,{type:t}),e++}})}),e}isUserAvatarElement(e){if(e.closest('.chat-list, .chatlist, .contact-list'))return!1;if(e.closest('.group-avatar, .chat-avatar, .contact-avatar'))return!1;const t=e.className.toLowerCase();if(['character-avatar','char-avatar','contact-avatar','chat-avatar','group-avatar','bot-avatar','ai-avatar'].some(e=>t.includes(e)))return!1;const a=e.closest('[data-character], [data-char], [data-contact], .character-item, .contact-item, .chat-item');if(a){return a.hasAttribute('data-user')||a.classList.contains('user-item')||a.classList.contains('profile-item')}return!0}registerMemberAvatarElements(){const e=document.querySelectorAll('.member-avatar');let t=0;return e.forEach(e=>{const a=e;if(!a.hasAttribute('data-avatar-sync')){const e=a.getAttribute('data-member-id')||a.getAttribute('data-member')||this.extractMemberIdFromElement(a);if(this.isUserMemberId(e)){const s={type:'member-avatar',memberId:e||void 0,validator:e=>this.validateMemberAvatarElement(e)};this.registerElement(a,s),t++}}}),t}registerSpecialAvatarElements(){let e=0;return['#avatarImage','.profile-avatar'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{const a=t;if(!a.hasAttribute('data-avatar-sync')){const t='IMG'===a.tagName?'img':'background';this.registerElement(a,{type:t,priority:1}),e++}})}),e}extractMemberIdFromElement(e){const t=['data-member-id','data-member','data-user-id','data-user'];for(const a of t){const t=e.getAttribute(a);if(t)return t}const a=e.closest('[data-member-id], [data-member], [data-user-id], [data-user]');if(a)for(const e of t){const t=a.getAttribute(e);if(t)return t}return null}isUserMemberId(e){if(!e)return!1;return['{{user}}','user','User','USER'].includes(e)}validateMemberAvatarElement(e){if(!document.contains(e))return!1;const t=window.getComputedStyle(e);if('none'===t.display||'hidden'===t.visibility)return!1;const a=e.getAttribute('data-member-id')||this.extractMemberIdFromElement(e);return this.isUserMemberId(a)}sync(){if(this.isDestroyed)return;const e=this.getUnifiedUserAvatarSyncLocal();e!==this.currentAvatar&&(this.log(`å¤´åƒå·²æ›´æ–°: ${this.currentAvatar} -> ${e}`),this.currentAvatar=e,this.updateAllElements(e))}forceUpdate(e){if(this.isDestroyed)return;const t=e??this.getUnifiedUserAvatarSyncLocal();this.currentAvatar=t,this.updateAllElements(t),this.log(`å·²å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å¤´åƒå…ƒç´  (URL: ${e?'provided':'fetched'})`)}updateElement(e,t,a){try{if('member-avatar'===t.type&&!this.isUserMemberId(t.memberId||null))return;switch(t.type){case'img':'IMG'===e.tagName&&(e.src=a);break;case'background':default:e.style.backgroundImage=`url(${a})`;break;case'member-avatar':'IMG'===e.tagName?e.src=a:e.style.backgroundImage=`url(${a})`}const s=this.registeredElements.get(e);s&&(s.lastUpdate=Date.now())}catch(t){this.log(`æ›´æ–°å¤´åƒå…ƒç´ å¤±è´¥: ${t}`);const a=this.registeredElements.get(e);a&&(a.isValid=!1)}}updateAllElements(e){const t=[],a=[];this.registeredElements.forEach((e,s)=>{document.contains(s)&&e.isValid?e.config.validator?e.config.validator(s)?a.push({element:s,config:e.config}):t.push(s):a.push({element:s,config:e.config}):t.push(s)}),a.sort((e,t)=>(e.config.priority||999)-(t.config.priority||999)),a.forEach(({element:t,config:a})=>{this.updateElement(t,a,e)}),t.forEach(e=>{this.unregisterElement(e)}),t.length>0&&this.log(`æ¸…ç†äº† ${t.length} ä¸ªæ— æ•ˆçš„å¤´åƒå…ƒç´ `),a.length>0&&this.log(`æ›´æ–°äº† ${a.length} ä¸ªå¤´åƒå…ƒç´ `)}startSync(){this.isDestroyed||null!==this.syncTimer||(this.sync(),this.syncTimer=window.setInterval(()=>{this.sync(),this.performPeriodicMaintenance()},this.options.syncInterval),this.log('è‡ªåŠ¨åŒæ­¥å·²å¯åŠ¨'))}performPeriodicMaintenance(){this.cleanupInvalidElements(),this.debouncedAutoRegister()}debouncedAutoRegister(){null!==this.discoveryDebounceTimer&&clearTimeout(this.discoveryDebounceTimer),this.discoveryDebounceTimer=window.setTimeout(()=>{this.autoRegister(),this.discoveryDebounceTimer=null},this.options.discoveryDebounceDelay)}cleanupInvalidElements(){const e=[];this.registeredElements.forEach((t,a)=>{document.contains(a)&&t.isValid||e.push(a)}),e.forEach(e=>{this.unregisterElement(e)}),e.length>0&&this.log(`å®šæœŸæ¸…ç†äº† ${e.length} ä¸ªæ— æ•ˆå…ƒç´ `)}performInitialDiscovery(){setTimeout(()=>{this.autoRegister()},100)}stopSync(){null!==this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null,this.log('è‡ªåŠ¨åŒæ­¥å·²åœæ­¢')),null!==this.discoveryDebounceTimer&&(clearTimeout(this.discoveryDebounceTimer),this.discoveryDebounceTimer=null)}setupMutationObserver(){this.options.enableMutationObserver&&'undefined'!=typeof MutationObserver&&(this.mutationObserver=new MutationObserver(e=>{if(this.isInternalOperation)return;let t=!1;e.forEach(e=>{'childList'===e.type&&e.addedNodes.length>0&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const a=e;this.containsAvatarElements(a)&&(t=!0)}})}),t&&this.debouncedAutoRegister()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0}),this.log('DOMå˜åŒ–ç›‘å¬å™¨å·²å¯åŠ¨'))}containsAvatarElements(e){return['.user_avatar','.user-avatar','.member-avatar','.profile-avatar','.chat-avatar','[data-member-id]','#avatarImage'].some(t=>e.matches&&e.matches(t)||e.querySelector(t))}stopMutationObserver(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,this.log('DOMå˜åŒ–ç›‘å¬å™¨å·²åœæ­¢'))}destroy(){this.isDestroyed=!0,this.stopSync(),this.stopMutationObserver(),this.registeredElements.forEach((e,t)=>{t.removeAttribute('data-avatar-sync'),t.removeAttribute('data-avatar-type'),t.removeAttribute('data-member-id')}),this.registeredElements.clear(),this.memberElements.clear(),this.log('å¢å¼ºçš„å¤´åƒåŒæ­¥ç®¡ç†å™¨å·²é”€æ¯'),r.instance=null}getDebugInfo(){const e={},t={};return this.registeredElements.forEach(t=>{const a=t.config.type;e[a]=(e[a]||0)+1}),this.memberElements.forEach((e,a)=>{t[a]=e.size}),{currentAvatar:this.currentAvatar,totalRegisteredElements:this.registeredElements.size,elementsByType:e,memberElementsCount:t,isDestroyed:this.isDestroyed,options:this.options,hasMutationObserver:!!this.mutationObserver,hasActiveTimer:!!this.syncTimer}}getRegisteredElements(){const e=[];return this.registeredElements.forEach((t,a)=>{e.push({element:a,config:t.config,lastUpdate:t.lastUpdate,isValid:t.isValid,className:a.className,tagName:a.tagName})}),e}getMemberAvatarStats(){const e={};return this.memberElements.forEach((t,a)=>{e[a]={count:t.size,elements:Array.from(t)}}),e}withInternalOperation(e){const t=this.isInternalOperation;this.isInternalOperation=!0;try{return e()}finally{this.isInternalOperation=t}}getUnifiedUserAvatarSyncLocal(){try{const{GlobalUserManager:e}=a(721),t=e.getInstance().getCurrentUserData();if(t?.isCustom&&t.avatar)return t.avatar;const r=(0,n.ZT)();if(r)return r;const o=(0,s.getSimpleUserAvatar)();return o&&'https://files.catbox.moe/u8ccy5.jpg'!==o?o:(0,s.getUserAvatar)()}catch(e){return console.warn('[AvatarSync.getUnifiedUserAvatarSyncLocal] è·å–å¤´åƒå¤±è´¥:',e),'https://files.catbox.moe/u8ccy5.jpg'}}log(e){this.options.debug&&console.log(`[AvatarSync] ${e}`)}}class o{avatarSync;registeredElements=new Set;constructor(e){this.avatarSync=r.getInstance(e)}register(e,t){this.avatarSync.registerElement(e,t||'background'),this.registeredElements.add(e)}unregister(e){this.avatarSync.unregisterElement(e),this.registeredElements.delete(e)}autoRegister(){this.avatarSync.autoRegister()}forceUpdate(){this.avatarSync.forceUpdate()}destroy(){this.registeredElements.forEach(e=>{this.avatarSync.unregisterElement(e)}),this.registeredElements.clear()}}const i=r.getInstance({debug:!1,enablePeriodicSync:!1});function c(e,t){i.registerElement(e,t)}function l(){i.autoRegister()}function d(e){i.forceUpdate(e)}function h(){i.sync()}function m(e,t){const a={type:'member-avatar',memberId:t,validator:e=>document.contains(e)};i.registerElement(e,a)}function g(){return i.getDebugInfo()}function u(){return i.getMemberAvatarStats()}function p(){i.sync()}},764:(e,t,a)=>{a.d(t,{StorageManager:()=>r});var s=a(464),n=a(691);class r{static instance;constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}saveUserData(e){try{const t=JSON.stringify({...e,lastUpdated:Date.now()});localStorage.setItem(n.d5.USER_DATA,t)}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()}),e}}loadUserData(){try{const e=localStorage.getItem(n.d5.USER_DATA);if(!e)return null;const t=JSON.parse(e);return this.validateUserData(t)?t:(console.warn('ç”¨æˆ·æ•°æ®æ ¼å¼æ— æ•ˆï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®'),this.clearUserData(),null)}catch(e){return this.handleError({type:n.By.STORAGE_ERROR,message:'åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()}),this.clearUserData(),null}}async getDefaultUserData(){try{const e=await triggerSlash('/pass {{user}}')||'ç”¨æˆ·';return{name:e,avatar:await triggerSlash('/pass {{userAvatarPath}}')||'',isCustom:!1,lastUpdated:Date.now()}}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'è·å–é»˜è®¤ç”¨æˆ·æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()}),{name:'ç”¨æˆ·',avatar:'',isCustom:!1,lastUpdated:Date.now()}}}clearUserData(){try{localStorage.removeItem(n.d5.USER_DATA)}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'æ¸…é™¤ç”¨æˆ·æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()})}}saveSettings(e){try{(0,s.setCharacterItem)(n.d5.APP_SETTINGS,e),console.log('[StorageManager] åº”ç”¨è®¾ç½®å·²ä¿å­˜åˆ°è§’è‰²ä¸“ç”¨ç©ºé—´')}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'ä¿å­˜åº”ç”¨è®¾ç½®å¤±è´¥',details:e,timestamp:Date.now()}),e}}loadSettings(){try{const e=(0,s.getCharacterItem)(n.d5.APP_SETTINGS,null);if(!e)return console.log('[StorageManager] æœªæ‰¾åˆ°è§’è‰²ä¸“ç”¨è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®'),{...n.a$};const t={...n.a$,...e};return console.log('[StorageManager] ä»è§’è‰²ä¸“ç”¨ç©ºé—´åŠ è½½åº”ç”¨è®¾ç½®'),t}catch(e){return this.handleError({type:n.By.STORAGE_ERROR,message:'åŠ è½½åº”ç”¨è®¾ç½®å¤±è´¥',details:e,timestamp:Date.now()}),{...n.a$}}}updateSettings(e){const t={...this.loadSettings(),...e};this.saveSettings(t)}clearSettings(){try{const{removeCharacterItem:e}=a(464);e(n.d5.APP_SETTINGS),console.log('[StorageManager] è§’è‰²ä¸“ç”¨åº”ç”¨è®¾ç½®å·²æ¸…é™¤')}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'æ¸…é™¤åº”ç”¨è®¾ç½®å¤±è´¥',details:e,timestamp:Date.now()})}}isStorageAvailable(){try{const e='__storage_test__';return localStorage.setItem(e,'test'),localStorage.removeItem(e),!0}catch{return!1}}getStorageUsage(){try{let e=0;for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=localStorage[t].length+t.length);const t=5242880;return{used:e,total:t,percentage:e/t*100}}catch(e){return{used:0,total:0,percentage:0}}}validateUserData(e){return e&&'string'==typeof e.name&&'string'==typeof e.avatar&&'boolean'==typeof e.isCustom&&'number'==typeof e.lastUpdated}handleError(e){console.error(`[StorageManager] ${e.message}:`,e.details),window.TavernHelper?.errorCatched&&window.TavernHelper.errorCatched(e)}exportData(){return{userData:this.loadUserData(),settings:this.loadSettings()}}importData(e){try{e.userData&&this.validateUserData(e.userData)&&this.saveUserData(e.userData),e.settings&&this.saveSettings(e.settings)}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'å¯¼å…¥æ•°æ®å¤±è´¥',details:e,timestamp:Date.now()}),e}}}},844:(e,t,a)=>{a.d(t,{g:()=>s});class s{static API_URL='https://api.injahow.cn/meting/?server=tencent&type=song&id=';static async resolve(e){try{const t=this.extractId(e);if(!t)return null;const a=await fetch(`${this.API_URL}${encodeURIComponent(t)}`),s=await a.json();if(s&&s.length>0){const e=s[0]||{},t=Array.isArray(e.artist)?e.artist.join(' / '):e.artist||e.author||'æœªçŸ¥è‰ºæœ¯å®¶',a={title:e.name||e.title||'QQéŸ³ä¹',artist:t,coverUrl:e.pic||e.cover||'',audioUrl:e.url||'',duration:0,currentTime:0};return a.audioUrl?a:null}return null}catch(e){return console.error('[QQMusicResolver] è§£æå¤±è´¥:',e),null}}static extractId(e){try{const t=e.match(/songDetail\/([a-zA-Z0-9]+)/);if(t)return t[1];const a=new URL(e).searchParams,s=a.get('songmid');if(s)return s;const n=a.get('songid');return n||null}catch{return null}}static isQQMusicUrl(e){return e.includes('y.qq.com')}}},861:(e,t,a)=>{var s,n;a.d(t,{l:()=>d}),function(e){e.STOPPED='stopped',e.PLAYING='playing',e.PAUSED='paused',e.LOADING='loading'}(s||(s={})),function(e){e.REPEAT='repeat',e.RANDOM='random',e.SINGLE='single',e.STOP='stop'}(n||(n={}));const r={default:{autoPlay:!1,volume:1,defaultMode:n.REPEAT,enableAnimations:!0},dimensions:{compact:{width:'7.5rem',height:'1.875rem'},expanded:{width:'20rem',height:'8rem'},mobile:{maxWidth:'calc(100vw - 2rem)',maxExpandedWidth:'18rem'}},animations:{transition:{duration:'0.4s',easing:'cubic-bezier(0.25, 0.46, 0.45, 0.94)'},wave:{duration:'1.2s',easing:'ease-in-out'},loading:{duration:'1s',easing:'linear'}},colors:{background:{default:'#1c1c1e',hover:'#2c2c2e',light:'rgba(0, 0, 0, 0.8)'},accent:{primary:'#007aff',secondary:'#5ac8fa'},text:{primary:'#ffffff',secondary:'rgba(255, 255, 255, 0.7)',tertiary:'rgba(255, 255, 255, 0.6)'},wave:{gradient:'linear-gradient(to top, #007aff, #5ac8fa)',whiteGradient:'linear-gradient(to top, #fff, rgba(255, 255, 255, 0.8))'}},audio:{type:'bgm',supportedFormats:['mp3','aac','ogg','wav','m4a'],maxFileSize:52428800,timeout:1e4},storage:{settings:'dynamic-island-settings',playlist:'dynamic-island-playlist',currentMusic:'dynamic-island-current-music',debug:'debug-dynamic-island'},debug:{enableConsoleLog:!1,enablePerformanceLog:!1,enableErrorTracking:!0,logLevel:'info'},breakpoints:{mobile:400,tablet:768,desktop:1024},performance:{animationFrameThrottle:16,updateInterval:100,maxLogEntries:100,cacheTimeout:3e5},messages:{error:{AUDIO_LOAD_FAILED:'éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ',AUDIO_PLAY_FAILED:'éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®',NETWORK_ERROR:'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€',INVALID_URL:'æ— æ•ˆçš„éŸ³é¢‘é“¾æ¥æ ¼å¼',PERMISSION_DENIED:'éŸ³é¢‘æ’­æ”¾æƒé™è¢«æ‹’ç»',TIMEOUT_ERROR:'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',UNKNOWN_ERROR:'æœªçŸ¥é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'},success:{MUSIC_IMPORTED:'éŸ³ä¹å¯¼å…¥æˆåŠŸ',PLAYBACK_STARTED:'å¼€å§‹æ’­æ”¾',PLAYBACK_PAUSED:'å·²æš‚åœ',MODE_CHANGED:'æ’­æ”¾æ¨¡å¼å·²åˆ‡æ¢',SETTINGS_SAVED:'è®¾ç½®å·²ä¿å­˜'}},modeNames:{[n.REPEAT]:'åˆ—è¡¨å¾ªç¯',[n.RANDOM]:'éšæœºæ’­æ”¾',[n.SINGLE]:'å•æ›²å¾ªç¯',[n.STOP]:'åœæ­¢æ¨¡å¼'},icons:{play:'M8,5.14V19.14L19,12.14L8,5.14Z',pause:'M14,19H18V5H14M6,19H10V5H6V19Z',repeat:'M17 1L21 5L17 9M3 11V9A4 4 0 0 1 7 5H21M7 23L3 19L7 15M21 13V15A4 4 0 0 1 17 19H3',random:'M16 3L21 3L21 8M4 20L21 3M21 16L21 21L16 21M15 15L21 21M4 4L9 9',single:'M17 1L21 5L17 9M3 11V9A4 4 0 0 1 7 5H21M7 23L3 19L7 15M21 13V15A4 4 0 0 1 17 19H3M11 11L12 10V15',stop:'M6,6H18V18H6V6Z',add:'M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z',music:'â™ª'}};var o=a(105),i=a(844),c=a(947);const l={title:'æœªçŸ¥æ­Œæ›²',artist:'æœªçŸ¥è‰ºæœ¯å®¶',duration:0,currentTime:0};class d{static instance;$container;$island;currentState=s.STOPPED;currentMode=n.REPEAT;currentMusic=l;isExpanded=!1;animationFrameId=null;playbackStartTime=0;audioHelper=null;currentPlaylistUrl=null;constructor(){this.initialize()}static getInstance(){return d.instance||(d.instance=new d),d.instance}initialize(){this.createDynamicIsland(),this.bindEvents(),this.startUpdateLoop(),console.log('[DynamicIslandMusicPlayer] çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ')}createDynamicIsland(){const e=$('.phone-notch');if(e.length>0)e.replaceWith(this.createIslandHTML());else{const e=$('.phone-container');e.length>0&&e.append(this.createIslandHTML())}this.$container=$('.dynamic-island-container'),this.$island=$('.dynamic-island'),this.updateModeButton()}createIslandHTML(){return`\n      <div class="dynamic-island-container">\n        <div class="dynamic-island" data-state="${this.currentState}">\n          \x3c!-- ç´§å‡‘çŠ¶æ€ - iOSé£æ ¼ --\x3e\n          <div class="island-compact">\n            \x3c!-- å·¦ä¾§ä¸“è¾‘å°é¢ --\x3e\n            <div class="compact-album-cover">\n              <img src="" alt="ä¸“è¾‘å°é¢" class="compact-cover-image">\n              <div class="compact-cover-placeholder">â™ª</div>\n            </div>\n            \x3c!-- å³ä¾§éŸ³ä¹æŒ‡ç¤ºå™¨ --\x3e\n            <div class="music-indicator">\n              <div class="wave-bars">\n                <div class="wave-bar"></div>\n                <div class="wave-bar"></div>\n                <div class="wave-bar"></div>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- å±•å¼€çŠ¶æ€ - iOSé£æ ¼å¸ƒå±€ --\x3e\n          <div class="island-expanded">\n            \x3c!-- é¡¶éƒ¨åŒºåŸŸï¼šä¸“è¾‘å°é¢ + æ­Œæ›²ä¿¡æ¯ + éŸ³é¢‘å¯è§†åŒ– --\x3e\n            <div class="top-section">\n              <div class="album-cover">\n                <img src="" alt="ä¸“è¾‘å°é¢" class="cover-image">\n                <div class="cover-placeholder">â™ª</div>\n              </div>\n              \n              <div class="track-info">\n                <div class="track-title">\n                  <span class="track-text">æœªæ’­æ”¾éŸ³ä¹</span>\n                </div>\n                <div class="track-artist">\n                  <span class="track-text">ç‚¹å‡»é€‰æ‹©éŸ³ä¹</span>\n                </div>\n              </div>\n              \n              <div class="audio-visualizer" data-color="default">\n                <div class="visualizer-bar"></div>\n                <div class="visualizer-bar"></div>\n                <div class="visualizer-bar"></div>\n                <div class="visualizer-bar"></div>\n                <div class="visualizer-bar"></div>\n              </div>\n            </div>\n            \n            \x3c!-- è¿›åº¦æ¡åŒºåŸŸ --\x3e\n            <div class="progress-section">\n              <div class="time-display">\n                <span class="current-time">0:00</span>\n                <span class="total-time">0:00</span>\n              </div>\n              <div class="progress-bar">\n                <div class="progress-track">\n                  <div class="progress-fill"></div>\n                  <div class="progress-thumb"></div>\n                </div>\n              </div>\n            </div>\n            \n            \x3c!-- åº•éƒ¨æ§åˆ¶åŒºåŸŸ --\x3e\n            <div class="bottom-section">\n              <button class="control-btn prev-btn" title="ä¸Šä¸€é¦–">â—€â—€</button>\n              \n              <button class="control-btn play-btn" title="æ’­æ”¾/æš‚åœ">\n                <div class="play-icon"></div>\n                <div class="pause-icon"></div>\n              </button>\n              \n              <button class="control-btn next-btn" title="ä¸‹ä¸€é¦–">â–¶â–¶</button>\n              \n              <button class="control-btn mode-btn" title="æ’­æ”¾æ¨¡å¼">\n                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path class="mode-icon-path" d="M12,6V9L16,5L12,1V4C7.58,4 4,7.58 4,12C4,13.85 4.63,15.55 5.69,16.88L7.1,15.47C6.42,14.53 6,13.32 6,12C6,8.69 8.69,6 12,6M18.31,7.12L16.9,8.53C17.58,9.47 18,10.68 18,12C18,15.31 15.31,18 12,18V15L8,19L12,23V20C16.42,20 20,16.42 20,12C20,10.15 19.37,8.45 18.31,7.12Z" />\n                </svg>\n              </button>\n              \n              <button class="control-btn playlist-btn" title="æ­Œå•">\n                <svg viewBox="0 0 24 24" width="20" height="20">\n                  <path fill="currentColor" d="M15,6H3V8H15V6M15,10H3V12H15V10M3,16H11V14H3V16M17,6V14.18C16.69,14.07 16.35,14 16,14A3,3 0 0,0 13,17A3,3 0 0,0 16,20A3,3 0 0,0 19,17V8H22V6H17Z" />\n                </svg>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}bindEvents(){$(document).on('click','.dynamic-island',e=>{e.stopPropagation(),this.toggleExpanded()}),$(document).on('click','.play-btn',e=>{e.stopPropagation(),this.togglePlayPause()}),$(document).on('click','.prev-btn',e=>{e.stopPropagation(),this.previousTrack()}),$(document).on('click','.next-btn',e=>{e.stopPropagation(),this.nextTrack()}),$(document).on('click','.mode-btn',e=>{e.stopPropagation(),this.cycleMode()}),$(document).on('click','.playlist-btn',e=>{e.stopPropagation(),this.showPlaylist()}),$(document).on('click','.progress-track',e=>{e.stopPropagation(),this.handleProgressClick(e)}),$(document).on('click',e=>{$(e.target).closest('.dynamic-island-container').length||this.collapse()}),$(document).on('click','.album-cover, .track-info',e=>{e.stopPropagation(),this.showImportDialog()}),$(document).on('di:playlist:play',async(e,t)=>{try{const e=t?.url;if(!e)return;this.currentPlaylistUrl=e,await this.importMusic(e),await this.play(),this.isExpanded||this.expand(),setTimeout(()=>{const e=c.$.getInstance();e.render?.()},100)}catch(e){console.error('[DynamicIslandMusicPlayer] ä»æ­Œå•æ’­æ”¾å¤±è´¥:',e),toastr.error('æ’­æ”¾å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}})}toggleExpanded(){this.isExpanded?this.collapse():this.expand()}expand(){this.isExpanded=!0,this.$island.addClass('expanded'),this.$island.css('transform','scale(0.95)'),setTimeout(()=>{this.$island.css('transform','scale(1)')},50),setTimeout(()=>{const e=$('.track-title'),t=e.find('.track-text');this.checkTextScrollable(e,t);const a=$('.track-artist'),s=a.find('.track-text');this.checkTextScrollable(a,s)},450)}collapse(){this.isExpanded=!1,this.$island.removeClass('expanded'),this.$island.css('transform',''),$('.track-title, .track-artist').removeClass('scrollable').css('--scroll-distance','0px')}async togglePlayPause(){try{if(this.currentState===s.PLAYING)await this.pause();else if(this.currentState===s.PAUSED)await this.play();else{const e=c.$.getInstance().getFirstUrl?.();e?(this.currentPlaylistUrl=e,await this.importMusic(e),await this.play(),this.isExpanded||this.expand()):(toastr.info('è¯·å…ˆå¯¼å…¥éŸ³ä¹','æç¤º'),this.showImportDialog())}}catch(e){console.error('[DynamicIslandMusicPlayer] æ’­æ”¾æ§åˆ¶å¤±è´¥:',e),toastr.error('æ’­æ”¾æ§åˆ¶å¤±è´¥','é”™è¯¯')}}async play(){this.setState(s.LOADING);try{this.audioHelper?(await this.audioHelper.play(),this.playbackStartTime=Date.now()-1e3*this.currentMusic.currentTime,this.setState(s.PLAYING)):toastr.info('è¯·å…ˆå¯¼å…¥éŸ³ä¹','æç¤º')}catch(e){throw this.setState(s.STOPPED),e}}async pause(){try{this.audioHelper&&(this.audioHelper.pause(),this.setState(s.PAUSED))}catch(e){throw console.error('[DynamicIslandMusicPlayer] æš‚åœå¤±è´¥:',e),e}}async previousTrack(){try{const e=this.getPlaylistUrls();if(0===e.length)return void toastr.info('æ­Œå•ä¸ºç©º','éŸ³ä¹æ’­æ”¾å™¨');const t=this.findCurrentIndex(e),a=t<0?0:(t-1+e.length)%e.length;await this.playByIndex(a)}catch(e){console.error('[DynamicIslandMusicPlayer] ä¸Šä¸€é¦–å¤±è´¥:',e),toastr.error('ä¸Šä¸€é¦–å¤±è´¥','é”™è¯¯')}}async nextTrack(){try{const e=this.getPlaylistUrls();if(0===e.length)return void toastr.info('æ­Œå•ä¸ºç©º','éŸ³ä¹æ’­æ”¾å™¨');const t=this.findCurrentIndex(e);let a=t<0?0:(t+1)%e.length;if(this.currentMode===n.RANDOM)if(e.length>1){let s=t;for(let a=0;a<5&&s===t;a++)s=Math.floor(Math.random()*e.length);a=s===t?(t+1)%e.length:s}else a=0;await this.playByIndex(a)}catch(e){console.error('[DynamicIslandMusicPlayer] ä¸‹ä¸€é¦–å¤±è´¥:',e),toastr.error('ä¸‹ä¸€é¦–å¤±è´¥','é”™è¯¯')}}showPlaylist(){try{c.$.getInstance().open()}catch(e){console.error('[DynamicIslandMusicPlayer] æ‰“å¼€æ­Œå•é¢æ¿å¤±è´¥:',e),toastr.error('æ‰“å¼€æ­Œå•é¢æ¿å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}}showImportDialog(){const e=prompt('è¯·è¾“å…¥éŸ³ä¹é“¾æ¥:','https://');e&&e.trim()&&'https://'!==e&&this.importMusic(e.trim())}async importMusic(e){try{this.setState(s.LOADING),this.currentPlaylistUrl=e;let t=null,a=e;if(o.N.isNeteaseMusicUrl(e)?(t=await o.N.resolve(e),t&&t.audioUrl&&(a=t.audioUrl)):i.g.isQQMusicUrl(e)&&(t=await i.g.resolve(e),a=t&&t.audioUrl?t.audioUrl:void 0),!a)throw new Error('æ— æ³•è·å–æœ‰æ•ˆçš„éŸ³é¢‘é“¾æ¥');this.audioHelper&&(this.audioHelper.pause(),this.audioHelper.remove(),this.audioHelper=null),this.currentMusic={...l},this.updateTimeDisplay(),this.audioHelper=new Audio(a),this.audioHelper.loop=this.currentMode===n.SINGLE,this.audioHelper.addEventListener('ended',()=>{this.onTrackEnded()}),this.audioHelper.addEventListener('loadedmetadata',()=>{this.audioHelper&&(this.currentMusic.duration=this.audioHelper.duration,this.updateTimeDisplay())}),this.audioHelper.addEventListener('canplaythrough',()=>{this.currentState!==s.PLAYING&&this.play()},{once:!0}),t?this.updateMusicInfo({...t,currentTime:0}):this.updateMusicInfo({title:this.extractTitleFromUrl(e),artist:'ç½‘ç»œéŸ³ä¹',duration:0,currentTime:0})}catch(e){console.error('[DynamicIslandMusicPlayer] å¯¼å…¥éŸ³ä¹å¤±è´¥:',e),this.setState(s.STOPPED),toastr.error('å¯¼å…¥éŸ³ä¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ','é”™è¯¯')}}extractTitleFromUrl(e){try{const t=new URL(e),a=t.pathname.split('/').pop()||'';return a.split('.')[0]||'æœªçŸ¥æ­Œæ›²'}catch{return'ç½‘ç»œéŸ³ä¹'}}handleProgressClick(e){if(this.audioHelper&&this.currentMusic.duration>0){const t=$(e.currentTarget).width()||0,a=e.offsetX/t,n=this.currentMusic.duration*a;this.audioHelper.currentTime=n,this.currentMusic.currentTime=n,this.playbackStartTime=Date.now()-1e3*n,this.updateTimeDisplay(),this.currentState!==s.PLAYING&&this.play(),console.log(`[DynamicIslandMusicPlayer] ç‚¹å‡»è¿›åº¦æ¡è·³è½¬åˆ°: ${Math.round(100*a)}% å¹¶å¼€å§‹æ’­æ”¾`)}}setState(e){this.currentState=e,this.$island.attr('data-state',e),this.updatePlayButton()}updatePlayButton(){const e=$('.play-btn');this.currentState===s.PLAYING?e.addClass('paused'):e.removeClass('paused')}updateModeButton(){const e=$('.mode-btn svg path'),t=r.icons[this.currentMode.toLowerCase()];t&&e.attr('d',t)}setMode(e){this.currentMode=e,this.audioHelper&&(this.audioHelper.loop=this.currentMode===n.SINGLE),this.updateModeButton()}cycleMode(){const e=[n.REPEAT,n.RANDOM,n.SINGLE,n.STOP],t=e.indexOf(this.currentMode),a=e[(t+1)%e.length];this.setMode(a);const s=r.modeNames[a];toastr.info(`æ’­æ”¾æ¨¡å¼ï¼š${s}`,'éŸ³ä¹æ’­æ”¾å™¨')}updateMusicInfo(e){try{this.currentMusic={...this.currentMusic,...e};const t=$('.track-title .track-text'),a=$('.track-title');t.text(this.currentMusic.title);const s=$('.track-artist .track-text'),n=$('.track-artist');if(s.text(this.currentMusic.artist),this.isExpanded?(this.checkTextScrollable(a,t),this.checkTextScrollable(n,s)):(a.removeClass('scrollable').css('--scroll-distance','0px'),n.removeClass('scrollable').css('--scroll-distance','0px')),this.currentMusic.coverUrl){const e=this.buildProxiedImageUrl(this.currentMusic.coverUrl);$('.cover-image').attr('src',e).show(),$('.cover-placeholder').hide(),$('.compact-cover-image').attr('src',e).show(),$('.compact-cover-placeholder').hide(),this.updateVisualizerColor(e)}else $('.cover-image').hide(),$('.cover-placeholder').show(),$('.compact-cover-image').hide(),$('.compact-cover-placeholder').show(),$('.dynamic-island').css('--visualizer-color','');this.updateTimeDisplay()}catch(e){console.error('[DynamicIslandMusicPlayer] æ›´æ–°éŸ³ä¹ä¿¡æ¯å¤±è´¥:',e)}}checkTextScrollable(e,t,a=0){if(e.removeClass('scrollable'),e.css('--scroll-distance','0px'),!this.isExpanded)return;setTimeout(()=>{const s=this.$island?.[0]?.getBoundingClientRect?.(),n=s?.width??0,r=e[0]?.getBoundingClientRect?.(),o=r?.width??(e.width()||0),i=t[0],c=i?i.scrollWidth:0;if(o<Math.max(100,.25*n)&&a<10)setTimeout(()=>this.checkTextScrollable(e,t,a+1),120);else if(!(o<=0))if(c>o){const t=o-c;e.css('--scroll-distance',`${t}px`),e.addClass('scrollable'),console.log(`[DynamicIslandMusicPlayer] è®¾ç½®æ–‡æœ¬æ»šåŠ¨: å®¹å™¨å®½åº¦=${o}px, æ–‡æœ¬å®½åº¦=${c}px, æ»šåŠ¨è·ç¦»=${t}px`)}else e.removeClass('scrollable'),e.css('--scroll-distance','0px')},0===a?80:0)}buildProxiedImageUrl(e){try{if(!e||e.startsWith('data:')||e.startsWith('blob:'))return e;if(e.startsWith('https://images.weserv.nl/'))return e;const t=new URL(e,window.location.href),a=t.host+t.pathname+(t.search||'');return`https://images.weserv.nl/?url=${encodeURIComponent(a)}`}catch{return e}}updateVisualizerColor(e){try{console.log('[DynamicIslandMusicPlayer] å¼€å§‹åˆ†æå°é¢é¢œè‰²:',e);const t=new Image;t.crossOrigin='anonymous';const a=this.buildProxiedImageUrl(e);a!==e&&console.log('[DynamicIslandMusicPlayer] ä½¿ç”¨ä»£ç†å°é¢åœ°å€è¿›è¡Œæè‰²:',a),t.onload=()=>{try{const e=document.createElement('canvas'),a=e.getContext('2d');if(!a)return console.warn('[DynamicIslandMusicPlayer] æ— æ³•è·å– canvas context'),void this.setDefaultVisualizerColor();const s=50;e.width=s,e.height=s;try{a.drawImage(t,0,0,s,s);const e=a.getImageData(0,0,s,s);let n=0,r=0,o=0,i=0;const c=e.data;for(let e=0;e<c.length;e+=4){const t=(c[e]+c[e+1]+c[e+2])/3;t>20&&t<235&&(n+=c[e],r+=c[e+1],o+=c[e+2],i++)}if(i>0){n=Math.floor(n/i),r=Math.floor(r/i),o=Math.floor(o/i);const e=Math.max(n,r,o),t=Math.min(n,r,o);if(e-t>0){const a=1.3,s=(e+t)/2;n=Math.round(s+(n-s)*a),r=Math.round(s+(r-s)*a),o=Math.round(s+(o-s)*a),n=Math.max(0,Math.min(255,n)),r=Math.max(0,Math.min(255,r)),o=Math.max(0,Math.min(255,o))}const a=e=>`0${e.toString(16)}`.slice(-2),s=`#${a(n)}${a(r)}${a(o)}`;console.log('[DynamicIslandMusicPlayer] æå–çš„ä¸»è‰²è°ƒ:',s),$('.dynamic-island').css('--visualizer-color',s)}else console.warn('[DynamicIslandMusicPlayer] æ²¡æœ‰æœ‰æ•ˆçš„åƒç´ æ•°æ®'),this.setDefaultVisualizerColor()}catch(e){console.warn('[DynamicIslandMusicPlayer] æ— æ³•è¯»å–å›¾ç‰‡æ•°æ®ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶ï¼‰:',e),this.setDefaultVisualizerColor()}}catch(e){console.warn('[DynamicIslandMusicPlayer] é¢œè‰²åˆ†æå¤±è´¥:',e),this.setDefaultVisualizerColor()}},t.onerror=e=>{console.warn('[DynamicIslandMusicPlayer] å›¾ç‰‡åŠ è½½å¤±è´¥:',e),this.setDefaultVisualizerColor()},t.src=a}catch(e){console.warn('[DynamicIslandMusicPlayer] æ›´æ–°å¯è§†åŒ–å™¨é¢œè‰²å¤±è´¥:',e),this.setDefaultVisualizerColor()}}setDefaultVisualizerColor(){console.log('[DynamicIslandMusicPlayer] ä½¿ç”¨é»˜è®¤é¢œè‰²'),$('.dynamic-island').css('--visualizer-color','linear-gradient(to top, #ff6b9d, #c44569)')}updateTimeDisplay(){const e=this.formatTime(this.currentMusic.currentTime),t=this.formatTime(this.currentMusic.duration);if($('.current-time').text(e),$('.total-time').text(t),this.currentMusic.duration>0){const e=this.currentMusic.currentTime/this.currentMusic.duration*100;$('.progress-fill').css('width',`${e}%`),$('.progress-thumb').css('left',`${e}%`)}}formatTime(e){if(isNaN(e)||e<0)return'0:00';return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,'0')}`}startUpdateLoop(){const e=()=>{if(this.currentState===s.PLAYING){this.updateWaveAnimation();const e=document.querySelector('audio[src*="bgm"]');e?(this.currentMusic.currentTime=e.currentTime,(0===this.currentMusic.duration||isNaN(this.currentMusic.duration))&&(this.currentMusic.duration=e.duration)):this.currentMusic.currentTime=(Date.now()-this.playbackStartTime)/1e3,this.currentMusic.duration>0&&this.currentMusic.currentTime>=this.currentMusic.duration&&(this.currentMusic.currentTime=this.currentMusic.duration,this.setState(s.STOPPED)),this.updateTimeDisplay()}this.animationFrameId=requestAnimationFrame(e)};e()}updateWaveAnimation(){$('.wave-bar').each((e,t)=>{const a=$(t),s=8*Math.random()+2;a.css('height',`${s}px`)})}getCurrentState(){return this.currentState}getCurrentMusic(){return{...this.currentMusic}}getPlaylistUrls(){try{const e=c.$.getInstance();return'function'==typeof e.getUrls?e.getUrls():[]}catch{return[]}}findCurrentIndex(e){return e.length&&this.currentPlaylistUrl?e.indexOf(this.currentPlaylistUrl):-1}async playByIndex(e){const t=this.getPlaylistUrls();if(!t.length)return;const a=t[(e%t.length+t.length)%t.length];this.currentPlaylistUrl=a,$('.track-title, .track-artist').removeClass('scrollable').css('--scroll-distance','0px'),await this.importMusic(a),await this.play()}async onTrackEnded(){try{const e=this.getPlaylistUrls();if(!e.length)return void this.setState(s.STOPPED);if(this.currentMode===n.STOP)return void this.setState(s.STOPPED);if(this.currentMode===n.SINGLE)return void(this.audioHelper&&!this.audioHelper.loop&&await this.play());const t=this.findCurrentIndex(e);if(this.currentMode===n.RANDOM){if(1===e.length)return void await this.playByIndex(0);let a=t;for(let s=0;s<5&&a===t;s++)a=Math.floor(Math.random()*e.length);return a===t&&(a=(t+1)%e.length),void await this.playByIndex(a)}const a=t<0?0:(t+1)%e.length;await this.playByIndex(a)}catch(e){console.warn('[DynamicIslandMusicPlayer] è‡ªåŠ¨åˆ‡ä¸‹ä¸€é¦–å¤±è´¥:',e),this.setState(s.STOPPED)}}destroy(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),$(document).off('click','.dynamic-island'),$(document).off('click','.play-btn'),$(document).off('click','.mode-btn'),$(document).off('click','.import-btn'),$(document).off('click','.progress-track'),this.$container.remove(),console.log('[DynamicIslandMusicPlayer] çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨å·²é”€æ¯')}}},947:(e,t,a)=>{a.d(t,{$:()=>p});var s=a(105),n=a(844);const r='di_playlist_local_urls',o='[æ­Œå•]',i='.di-playlist-overlay',c='.di-playlist-list',l='.di-track',d='.drag-handle',h='.btn-close',m='.btn-import',g='.btn-sort',u='.btn-clear';class p{static instance;$overlay=null;overlayMounted=!1;tracks=[];metaCache=new Map;binding=null;sortableEnabled=!1;prefetchInProgress=!1;prefetchTotal=0;prefetchDone=0;saveDebounced=function(e,t=300){let a=null;return(...s)=>{a&&clearTimeout(a),a=setTimeout(()=>e(...s),t)}}(()=>this.persist(),300);static getInstance(){return p.instance||(p.instance=new p),p.instance}async prefetch(){try{$(document).trigger('di:playlist:prefetch',{state:'start'}),await this.scanBindingOnly();let e=[];if(this.binding){const t=await this.readSettingsEntryContent(this.binding.worldbookName,this.binding.entryUid),a=this.parsePlaylistBlock(t);this.binding.lineBreak=a.lineBreak,e=a.urls}else e=this.loadLocalUrls();this.prefetchInProgress=!0,this.prefetchTotal=e.length,this.prefetchDone=0,this.setUrls(e),0===this.prefetchTotal&&(this.prefetchInProgress=!1,$(document).trigger('di:playlist:prefetch',{state:'success',done:0,total:0}))}catch(e){console.warn('[PlaylistPanel] é¢„åŠ è½½å¤±è´¥',e),this.prefetchInProgress=!1,$(document).trigger('di:playlist:prefetch',{state:'error',reason:String(e)})}}async open(){this.overlayMounted||(this.mountOverlay(),this.bindEvents()),this.$overlay.show(),this.render(),0===this.tracks.length&&(await this.scanAndLoad(),this.render())}close(){this.$overlay&&this.$overlay.hide()}mountOverlay(){const e=$('.phone-container').length?$('.phone-container'):$('.interface-container').length?$('.interface-container'):$('body');if(e.append('\n      <div class="di-playlist-overlay" style="display:none">\n        <div class="di-playlist-backdrop"></div>\n        <div class="di-playlist-panel">\n          <div class="di-playlist-header">\n            <div class="title">æ­Œå•</div>\n            <div class="actions">\n              <button class="btn-close" title="å…³é—­">Ã—</button>\n            </div>\n          </div>\n\n          <div class="di-playlist-toolbar">\n            <button class="btn-import">æ‰¹é‡å¯¼å…¥</button>\n            <button class="btn-sort">æ’åº</button>\n            <button class="btn-clear">æ¸…ç©º</button>\n          </div>\n\n          <div class="di-playlist-list"></div>\n        </div>\n      </div>\n    '),this.$overlay=$(i),this.overlayMounted=!0,!e.is('body')){const t=String(e.css('position')||'');t&&'static'!==t||e.css('position','relative'),this.$overlay.addClass('anchored')}}bindEvents(){$(document).on('click',h,e=>{e.stopPropagation(),this.close()}),$(document).on('click','.di-playlist-backdrop',e=>{e.stopPropagation(),this.close()}),$(document).on('click',m,e=>{e.stopPropagation(),this.openImportModal()}),$(document).on('click',g,e=>{e.stopPropagation(),this.toggleSortable()}),$(document).on('click',u,e=>{e.stopPropagation(),confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')&&(this.tracks=[],this.render(),this.saveDebounced(),toastr.info('æ­Œå•å·²æ¸…ç©º','æ¸…ç©º')),setTimeout(()=>this.render(),100)}),$(document).on('click','.di-track',e=>{if(this.sortableEnabled)return;if($(e.target).closest('.op-remove').length)return;e.stopPropagation();const t=$(e.currentTarget).data('url');t&&($(document).trigger('di:playlist:play',{url:t}),toastr.success('å¼€å§‹æ’­æ”¾æ‰€é€‰æ¡ç›®','æ’­æ”¾'))}),$(document).on('click','.di-track .op-remove',e=>{e.stopPropagation();const t=$(e.currentTarget).closest(l).data('url');this.tracks=this.tracks.filter(e=>e.url!==t),this.render(),this.saveDebounced(),$(document).trigger('di:playlist:changed',{urls:this.tracks.map(e=>e.url)})})}render(){if(!this.overlayMounted||!this.$overlay)return;const e=this.$overlay.find(c),t=this.tracks.map(e=>this.renderItem(e)).join('');e.html(t),this.updateSortable()}renderItem(e){const{url:t,title:a,artist:s,status:n,coverUrl:r}=e,o='pending'===n,i='error'===n,c=this.isCurrentlyPlaying(t);return`\n      <div class="di-track ${this.sortableEnabled?'sortable-mode':''} ${c?'now-playing':''}" data-url="${this.escape(t)}" title="ç‚¹å‡»æ’­æ”¾">\n        <div class="drag-handle" style="${this.sortableEnabled?'':'display: none;'}" title="æ‹–æ‹½æ’åº">â‹®â‹®</div>\n        <div class="track-cover">\n          ${r?`<img src="${this.escape(r)}" alt="å°é¢" />`:'<div class="cover-placeholder">â™ª</div>'}\n        </div>\n        <div class="meta">\n          <div class="title">${o?'è§£æä¸­...':this.escape(a)}</div>\n          <div class="subtitle ${i?'invalid':''}">${i?'è§£æå¤±è´¥':this.escape(s)}</div>\n        </div>\n        <div class="ops">\n          <button class="op-remove" title="ç§»é™¤">âœ•</button>\n        </div>\n      </div>\n    `}toggleSortable(){this.sortableEnabled=!this.sortableEnabled;const e=$(g);this.sortableEnabled?(e.addClass('active'),toastr.info('æ’åºæ¨¡å¼å·²å¼€å¯ï¼Œå¯ä»¥æ‹–åŠ¨æ­Œæ›²æ’åº','æ’åº')):(e.removeClass('active'),toastr.info('æ’åºæ¨¡å¼å·²å…³é—­','æ’åº')),this.render()}updateSortable(){const e=this.$overlay.find(c),t=e;'function'==typeof t.sortable&&(t.sortable('instance')&&t.sortable('destroy'),this.sortableEnabled&&t.sortable({handle:d,axis:'y',update:()=>{const t=[];e.find(l).each((_,e)=>{const a=$(e).data('url');a&&t.push(String(a))}),this.tracks=t.map(e=>this.tracks.find(t=>t.url===e)||this.createPendingTrack(e)),this.saveDebounced(),$(document).trigger('di:playlist:changed',{urls:this.tracks.map(e=>e.url)})}}))}openImportModal(){const e='di-import-modal';$(`#${e}`).length&&$(`#${e}`).remove();const t=`\n      <div id="${e}" class="di-import-modal">\n        <div class="box">\n          <div class="title">æ‰¹é‡å¯¼å…¥ï¼ˆæ¯è¡Œä¸€ä¸ª URLï¼‰</div>\n          <textarea class="text" placeholder="https://music.163.com/#/song?id=xxxxxx\nhttps://y.qq.com/n/ryqq/songDetail/xxxxxx"></textarea>\n          <div class="actions">\n            <button class="ok">å¯¼å…¥</button>\n            <button class="cancel">å–æ¶ˆ</button>\n          </div>\n        </div>\n      </div>\n    `;this.$overlay.append(t);const a=$(`#${e}`);a.find('.cancel').on('click',()=>a.remove()),a.find('.ok').on('click',()=>{const e=String(a.find('textarea.text').val()||''),t=this.parseMultilineUrls(e);if(0===t.length)return toastr.info('æ²¡æœ‰å¯å¯¼å…¥çš„ URL','å¯¼å…¥'),void a.remove();this.addUrls(t),this.render(),this.saveDebounced(),toastr.success(`å·²å¯¼å…¥ ${t.length} æ¡`,'å¯¼å…¥'),a.remove()})}parseMultilineUrls(e){return e.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0).filter(e=>!e.startsWith('#')&&!e.startsWith('//')).filter(e=>/^https?:\/\//i.test(e))}async scanAndLoad(){if(await this.scanBindingOnly(),this.binding)try{const e=await this.readSettingsEntryContent(this.binding.worldbookName,this.binding.entryUid),t=this.parsePlaylistBlock(e);this.binding.lineBreak=t.lineBreak,this.setUrls(t.urls),toastr.success('å·²ä»ä¸–ç•Œä¹¦åŠ è½½æ­Œå•','æ­Œå•')}catch(e){console.warn('[PlaylistPanel] è¯»å–ä¸–ç•Œä¹¦å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®',e),this.loadLocal()}else this.loadLocal(),toastr.info('æœªæ‰¾åˆ°åç§°åŒ…å«â€œè®¾ç½®â€çš„æ¡ç›®ï¼Œå¯æœ¬åœ°ç¼–è¾‘ï¼Œç¨åå†åŒæ­¥','æ­Œå•')}async scanBindingOnly(){const e=getCharWorldbookNames('current'),t=[];e.primary&&t.push(e.primary),t.push(...e.additional||[]);const a=await this.locateInWorldbookList(t);if(a)return void(this.binding=a);const s=getGlobalWorldbookNames()||[],n=await this.locateInWorldbookList(s);this.binding=n||null}async locateInWorldbookList(e){for(const t of e)try{const e=(await getWorldbook(t)).filter(e=>(e.name||'').includes('è®¾ç½®'));if(0===e.length)continue;const a=e.slice().sort((e,t)=>{const a=e.position?.order??0,s=t.position?.order??0;return a!==s?a-s:e.uid-t.uid})[0],s=String(a.content||'').includes('\r\n')?'\r\n':'\n';return{worldbookName:t,entryUid:a.uid,entryName:a.name,lineBreak:s}}catch{}return null}async readSettingsEntryContent(e,t){const a=(await getWorldbook(e)).find(e=>e.uid===t);if(!a)throw new Error('è®¾ç½®æ¡ç›®å·²ä¸å­˜åœ¨');return String(a.content||'')}parsePlaylistBlock(e){const t=e.includes('\r\n')?'\r\n':'\n',a=e.split(/\r?\n/);let s=0,n=-1,r=a.length;const i=e=>/^\s*\[[^\]]+\]\s*$/.test(e),c=e=>e.trim()===o;for(;s<a.length;){if(c(a[s])){n=s,s++;break}s++}if(n>=0){let e=n+1;for(;e<a.length;){if(i(a[e])){r=e;break}e++}return{urls:a.slice(n+1,r).map(e=>e.trim()).filter(e=>e.length>0).filter(e=>!e.startsWith('#')&&!e.startsWith('//')),hasBlock:!0,lineBreak:t}}return{urls:[],hasBlock:!1,lineBreak:t}}replacePlaylistBlock(e,t,a){const s=e.split(/\r?\n/),n=e=>/^\s*\[[^\]]+\]\s*$/.test(e),r=e=>e.trim()===o;let i=-1,c=s.length;for(let e=0;e<s.length;e++)if(r(s[e])){i=e;for(let t=e+1;t<s.length;t++)if(n(s[t])){c=t;break}break}const l=[o,...t].join(a);if(i>=0){const e=s.slice(0,i).join(a),t=s.slice(c).join(a);return`${e}${e.length?a:''}${l}${t.length?a:''}${t}`}return`${e}${e.length?a+a:''}${l}`}async persist(e=!1){if(this.binding)try{const t=await this.readSettingsEntryContent(this.binding.worldbookName,this.binding.entryUid),a=this.replacePlaylistBlock(t,this.tracks.map(e=>e.url),this.binding.lineBreak||'\n');await updateWorldbookWith(this.binding.worldbookName,e=>e.map(e=>e.uid===this.binding.entryUid?{...e,content:a}:e),{render:'debounced'}),e&&toastr.success('å·²åŒæ­¥åˆ°ä¸–ç•Œä¹¦ [æ­Œå•] æ®µ','åŒæ­¥')}catch(e){console.error('[PlaylistPanel] å†™å›ä¸–ç•Œä¹¦å¤±è´¥',e),toastr.error('å†™å›ä¸–ç•Œä¹¦å¤±è´¥ï¼Œå·²ä¿ç•™æœ¬åœ°æ›´æ”¹','åŒæ­¥'),this.saveLocal(),await this.scanBindingOnly()}else this.saveLocal(),e&&toastr.info('æœªç»‘å®šä¸–ç•Œä¹¦æ¡ç›®ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°','åŒæ­¥');$(document).trigger('di:playlist:changed',{urls:this.tracks.map(e=>e.url)})}loadLocalUrls(){try{const e=localStorage.getItem(r);if(e){const t=JSON.parse(e);if(Array.isArray(t))return this.uniqueStable(t.map(String))}}catch{}return[]}loadLocal(){const e=this.loadLocalUrls();this.setUrls(e)}saveLocal(){try{localStorage.setItem(r,JSON.stringify(this.tracks.map(e=>e.url)))}catch{}}setUrls(e){this.tracks=e.map(e=>this.createPendingTrack(e)),this.resolveAllTracks()}addUrls(e){const t=e.map(e=>this.createPendingTrack(e));this.tracks=this.uniqueStableTracks([...t,...this.tracks]),this.resolveAllTracks()}getUrls(){return this.tracks.map(e=>e.url)}getFirstUrl(){return this.tracks.length>0?this.tracks[0].url:null}createPendingTrack(e){return{url:e,title:this.extractTitle(e),artist:'æœªçŸ¥è‰ºæœ¯å®¶',status:'pending'}}resolveAllTracks(){this.tracks.forEach(e=>{'pending'===e.status&&this.resolveTrack(e)})}resolveTrack(e){const t=t=>{this.render(),this.prefetchInProgress&&(this.prefetchDone++,$(document).trigger('di:playlist:prefetch',{state:'progress',done:this.prefetchDone,total:this.prefetchTotal}),this.prefetchDone>=this.prefetchTotal&&(this.prefetchInProgress=!1,$(document).trigger('di:playlist:prefetch',{state:'success',done:this.prefetchDone,total:this.prefetchTotal}))),$(document).trigger('di:playlist:itemResolved',{url:e.url,title:e.title,state:t})},a=this.metaCache.get(e.url);if(a)return Object.assign(e,a,{status:'resolved'}),void t('resolved');s.N.isNeteaseMusicUrl(e.url)?s.N.resolve(e.url).then(a=>{a?(e.title=a.title,e.artist=a.artist,e.coverUrl=a.coverUrl,e.status='resolved',this.metaCache.set(e.url,{title:a.title,artist:a.artist,coverUrl:a.coverUrl}),t('resolved')):(e.status='error',t('error'))}).catch(()=>{e.status='error',t('error')}):n.g.isQQMusicUrl(e.url)?n.g.resolve(e.url).then(a=>{a?(e.title=a.title,e.artist=a.artist,e.coverUrl=a.coverUrl,e.status='resolved',this.metaCache.set(e.url,{title:a.title,artist:a.artist,coverUrl:a.coverUrl}),t('resolved')):(e.status='error',t('error'))}).catch(()=>{e.status='error',t('error')}):(e.status='resolved',t('resolved'))}uniqueStableTracks(e){const t=new Set,a=[];for(const s of e)t.has(s.url)||(t.add(s.url),a.push(s));return a}uniqueStable(e){const t=new Set,a=[];for(const s of e)t.has(s)||(t.add(s),a.push(s));return a}looksLikeUrl(e){return/^https?:\/\//i.test(e)}extractTitle(e){try{const t=new URL(e).pathname.split('/').pop()||'';return decodeURIComponent((t||'').split('.')[0])||e}catch{return e}}escape(e){const t={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};return e.replace(/[&<>"']/g,e=>t[e])}isCurrentlyPlaying(e){try{const t=a(861).l.getInstance();return!(!t||!t.currentPlaylistUrl)&&t.currentPlaylistUrl===e}catch(e){return console.log('[PlaylistPanel] æ— æ³•è·å–æ’­æ”¾å™¨çŠ¶æ€:',e),!1}}}}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};class s{container=null;config;constructor(e){this.config={containerClass:'bottom-nav',useDefaultTexts:!0,...e}}createHTML(){const e=this.config.items.map(e=>this.createNavItemHTML(e)).join('');return`\n      <div class="${this.config.containerClass}">\n        ${e}\n      </div>\n    `}createNavItemHTML(e){const t=e.isActive?' active':'',a=e.iconClass||'nav-icon',s=this.resolveText(e);return`\n      <div class="bottom-nav-item${t}" data-nav="${e.id}">\n        <div class="${a}"></div>\n        <div class="bottom-nav-text">${s}</div>\n      </div>\n    `}initialize(e){this.container=e,e.innerHTML=this.config.items.map(e=>this.createNavItemHTML(e)).join(''),this.bindEvents()}bindEvents(){if(!this.container)return;this.container.querySelectorAll('.bottom-nav-item').forEach(e=>{e.addEventListener('click',()=>{const t=e.getAttribute('data-nav'),a=this.config.items.find(e=>e.id===t);a?.onClick&&a.onClick()})})}setActiveItem(e){if(!this.container)return;this.container.querySelectorAll('.bottom-nav-item').forEach(t=>{t.getAttribute('data-nav')===e?t.classList.add('active'):t.classList.remove('active')}),this.config.items.forEach(t=>{t.isActive=t.id===e})}updateItems(e){this.config.items=e,this.container&&(this.container.innerHTML=this.config.items.map(e=>this.createNavItemHTML(e)).join(''),this.bindEvents())}show(){this.container&&(this.container.style.display='block')}hide(){this.container&&(this.container.style.display='none')}destroy(){this.container&&(this.container.innerHTML=''),this.container=null}getConfig(){return{...this.config}}setTexts(e){this.config.texts={...this.config.texts||{},...e},this.container&&(this.container.innerHTML=this.config.items.map(e=>this.createNavItemHTML(e)).join(''),this.bindEvents())}static DEFAULT_TEXTS={feed:'åŠ¨æ€',messages:'æ¶ˆæ¯',profile:'æˆ‘çš„'};static createDefaultNavItems(e,t={}){return['feed','messages','profile'].map(a=>({id:a,iconClass:'nav-icon',isActive:a===e,onClick:t[a]}))}static mountDefault(e,t,a={},n={}){const r=s.createDefaultNavItems(t,a),o=new s({items:r,...n});return o.initialize(e),o}resolveText(e){const t=e.id,a=this.config.texts||{};return a&&Object.prototype.hasOwnProperty.call(a,t)?a[t]:!1!==this.config.useDefaultTexts&&s.DEFAULT_TEXTS[t]?s.DEFAULT_TEXTS[t]:e.text||this.fallbackLabelFromId(t)}fallbackLabelFromId(e){return e||''}updateConfig(e){this.config={...this.config,...e},this.container&&(this.destroy(),this.initialize(this.container))}}class n{container;timeElement;timeInterval=null;constructor(e){this.container=e,this.render(),this.timeElement=this.container.querySelector('#statusTime'),this.startTimeUpdate()}render(){this.container.innerHTML=`\n      <div class="status-bar">\n        <div class="status-bar-left">\n          <span id="statusTime">${this.getCurrentTime()}</span>\n        </div>\n        <div class="status-bar-right">\n          \x3c!-- ä¿¡å·å¼ºåº¦å›¾æ ‡ --\x3e\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path>\n          </svg>\n          \x3c!-- WiFiå›¾æ ‡ --\x3e\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path>\n          </svg>\n          \x3c!-- ç”µæ± å›¾æ ‡ --\x3e\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path>\n          </svg>\n        </div>\n      </div>\n    `}getCurrentTime(){const e=new Date;return`${e.getHours().toString().padStart(2,'0')}:${e.getMinutes().toString().padStart(2,'0')}`}startTimeUpdate(){this.updateTime(),this.timeInterval=setInterval(()=>{this.updateTime()},1e3)}updateTime(){this.timeElement&&(this.timeElement.textContent=this.getCurrentTime())}destroy(){this.timeInterval&&(clearInterval(this.timeInterval),this.timeInterval=null)}static create(e){return new n(e)}static mount(e){const t=document.getElementById(e);return t?new n(t):(console.warn(`StatusBar: Container with id "${e}" not found`),null)}}var r=a(316);class o{element=null;overlay=null;currentChatId=null;isVisible=!1;globalClickHandler=null;showTime=0;ignoreClickDuration=800;constructor(){this.bindOtherGlobalEvents()}show(e,t,a=!1){this.hide(),this.currentChatId=e,this.createMenuElements(a),this.positionMenu(t),this.showMenu(),this.showTime=Date.now(),this.bindGlobalClickEvent()}hide(){if(!this.isVisible)return;this.isVisible=!1,this.element&&(console.log('ğŸ­ èœå•éšè—åŠ¨ç”»å¼€å§‹ï¼šå°±åœ°æ¸éš scale(1) â†’ scale(0.95)'),this.element.classList.remove('show'),this.element.classList.add('hiding'),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&(this.overlay.parentNode.removeChild(this.overlay),console.log('ğŸ­ èœå•DOMå…ƒç´ å·²ç§»é™¤')),this.element=null,this.overlay=null},120));document.querySelectorAll('.chat-list-item.long-pressed').forEach(e=>{e.classList.remove('long-pressed')});const e=new CustomEvent('contextMenuHidden');document.dispatchEvent(e),this.currentChatId=null}isMenuVisible(){return this.isVisible}createMenuElements(e){this.overlay=document.createElement('div'),this.overlay.className='context-menu-overlay',this.element=document.createElement('div'),this.element.className='context-menu',this.element.dataset.chatId=this.currentChatId,this.element.innerHTML=`\n      <div class="menu-arrow"></div>\n      <div class="menu-content horizontal">\n        <button class="menu-item pin-item" data-action="${e?'unpin':'pin'}">\n          <span class="menu-text">${e?'å–æ¶ˆç½®é¡¶':'ç½®é¡¶'}</span>\n        </button>\n        <button class="menu-item delete-item" data-action="delete">\n          <span class="menu-text">åˆ é™¤</span>\n        </button>\n      </div>\n    `,this.bindMenuEvents(),this.overlay.appendChild(this.element),document.body.appendChild(this.overlay)}bindMenuEvents(){if(!this.element)return;this.element.querySelectorAll('.menu-item').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();const a=e.dataset.action;this.handleMenuAction(a)})}),this.element.addEventListener('click',e=>{e.stopPropagation()})}bindGlobalClickEvent(){this.globalClickHandler&&document.removeEventListener('click',this.globalClickHandler),this.globalClickHandler=e=>{if(!this.isVisible)return;const t=Date.now()-this.showTime;if(t<this.ignoreClickDuration)return void console.log(`ğŸ” [ContextMenu] èœå•æ˜¾ç¤ºå${t}mså†…ï¼Œå¿½ç•¥ç‚¹å‡»äº‹ä»¶`);const a=e.target;if(this.element&&this.element.contains(a))return;a.closest('.chat-list-item.long-pressed')||(console.log('ğŸ” [ContextMenu] ç‚¹å‡»èœå•å¤–åŒºåŸŸï¼Œéšè—èœå•'),this.hide())},document.addEventListener('click',this.globalClickHandler,{capture:!0})}bindOtherGlobalEvents(){document.addEventListener('scroll',()=>{this.hide()},!0),window.addEventListener('resize',()=>{this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.hide()})}positionMenu(e){if(!this.element)return;const t=document.querySelector(`[data-chat-id="${this.currentChatId}"]`);if(!t)return;const a=t.getBoundingClientRect();this.element.style.transition='none';const s=a.left+(a.width-90)/2+5,n=a.top-24-8;this.element.style.left=`${s}px`,this.element.style.top=`${n}px`,this.element.style.visibility='visible',this.element.offsetHeight,this.element.style.transition='all 0.12s ease-out',this.setArrowDirection('bottom')}calculateOptimalPosition(e,t,a){const s=12,n=[{x:e.x+20,y:e.y-t.height/2,placement:'right'},{x:e.x-t.width-20,y:e.y-t.height/2,placement:'left'},{x:e.x-t.width/2,y:e.y+20,placement:'bottom'},{x:e.x-t.width/2,y:e.y-t.height-20,placement:'top'}];for(const e of n)if(e.x>=s&&e.x+t.width<=a.width-s&&e.y>=s&&e.y+t.height<=a.height-s)return e;return{x:Math.max(s,Math.min(e.x+20,a.width-t.width-s)),y:Math.max(s,Math.min(e.y-t.height/2,a.height-t.height-s)),placement:'right'}}setArrowDirection(e){if(!this.element)return;const t=this.element.querySelector('.menu-arrow');t&&(t.className='menu-arrow',t.classList.add(`arrow-${e}`))}showMenu(){this.element&&this.overlay&&(this.isVisible=!0,this.element.classList.remove('hiding','show'),this.element.offsetHeight,requestAnimationFrame(()=>{this.element&&(this.element.classList.add('show'),console.log('ğŸ­ èœå•æ˜¾ç¤ºåŠ¨ç”»å¼€å§‹ï¼šå°±åœ°æ¸æ˜¾ scale(0.95) â†’ scale(1)'))}))}handleMenuAction(e){if(!this.currentChatId)return;const t=new CustomEvent('contextMenuAction',{detail:{action:e,chatId:this.currentChatId}});document.dispatchEvent(t),this.hide()}}class i{config;activeElement=null;startTime=0;startPosition={x:0,y:0};longPressTimer=null;isLongPressing=!1;isMoving=!1;constructor(e={}){this.config={duration:400,moveThreshold:10,enableVibration:!0,...e}}init(){this.bindEvents()}destroy(){this.cleanup(),this.unbindEvents()}unbindEvents(){document.removeEventListener('mousedown',this.handleStart.bind(this)),document.removeEventListener('touchstart',this.handleStart.bind(this)),document.removeEventListener('mousemove',this.handleMove.bind(this)),document.removeEventListener('touchmove',this.handleMove.bind(this)),document.removeEventListener('mouseup',this.handleEnd.bind(this)),document.removeEventListener('touchend',this.handleEnd.bind(this)),document.removeEventListener('contextmenu',this.handleContextMenu.bind(this)),document.removeEventListener('contextMenuHidden',this.handleMenuHidden.bind(this))}bindEvents(){document.addEventListener('mousedown',this.handleStart.bind(this)),document.addEventListener('touchstart',this.handleStart.bind(this),{passive:!1}),document.addEventListener('mousemove',this.handleMove.bind(this)),document.addEventListener('touchmove',this.handleMove.bind(this),{passive:!1}),document.addEventListener('mouseup',this.handleEnd.bind(this)),document.addEventListener('touchend',this.handleEnd.bind(this)),document.addEventListener('contextmenu',this.handleContextMenu.bind(this)),document.addEventListener('contextMenuHidden',this.handleMenuHidden.bind(this))}handleStart(e){const t=e.target.closest('.chat-list-item');if(t&&t.dataset.chatId)if('mousedown'!==e.type||2!==e.button){if(this.activeElement&&this.cleanup(),this.activeElement=t,this.startTime=Date.now(),this.isLongPressing=!1,this.isMoving=!1,'touchstart'===e.type){const t=e.touches[0];this.startPosition={x:t.clientX,y:t.clientY}}else{const t=e;this.startPosition={x:t.clientX,y:t.clientY}}this.longPressTimer=setTimeout(()=>{this.activeElement&&!this.isMoving&&this.triggerLongPress()},this.config.duration),t.classList.add('long-press-detecting')}else e.preventDefault()}handleMove(e){if(!this.activeElement||this.isLongPressing)return;let t,a;if('touchmove'===e.type){const s=e.touches[0];t=s.clientX,a=s.clientY}else{const s=e;t=s.clientX,a=s.clientY}const s=Math.abs(t-this.startPosition.x),n=Math.abs(a-this.startPosition.y);Math.sqrt(s*s+n*n)>this.config.moveThreshold&&(this.isMoving=!0,this.cancelLongPress())}handleEnd(e){if(!this.activeElement)return;Date.now()-this.startTime<this.config.duration&&!this.isMoving&&!this.isLongPressing?(this.triggerClick(),this.cleanup()):this.isLongPressing?(this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&this.activeElement.classList.remove('long-press-detecting'),this.isMoving=!1):this.cleanup()}handleContextMenu(e){e.target.closest('.chat-list-item')&&e.preventDefault()}triggerLongPress(){if(!this.activeElement)return;this.isLongPressing=!0;const e=this.activeElement.dataset.chatId,t=this.activeElement.getBoundingClientRect(),a={x:t.left+t.width/2,y:t.top+t.height/2};this.activeElement.classList.add('long-pressed'),this.activeElement.classList.remove('long-press-detecting'),this.config.enableVibration&&'vibrate'in navigator&&navigator.vibrate(50);const s=new CustomEvent('chatItemLongPress',{detail:{chatId:e,element:this.activeElement,position:a}});document.dispatchEvent(s)}triggerClick(){if(!this.activeElement)return;const e=this.activeElement.dataset.chatId,t=new CustomEvent('chatListItemClick',{detail:{chatId:e}});document.dispatchEvent(t)}cancelLongPress(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&this.activeElement.classList.remove('long-press-detecting')}cleanup(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&(this.activeElement.classList.remove('long-press-detecting','long-pressed'),this.activeElement=null),this.isLongPressing=!1,this.isMoving=!1}handleMenuHidden(){this.cleanup()}resetState(){document.querySelectorAll('.chat-list-item.long-pressed').forEach(e=>{e.classList.remove('long-pressed')}),this.cleanup()}}class c{static STORAGE_KEY='bear_pinned_chats';pinnedChats=new Map;constructor(){this.loadPinnedChats()}pin(e){const t={chatId:e,pinnedAt:Date.now()};this.pinnedChats.set(e,t),this.savePinnedChats(),console.log(`ğŸ“Œ ç½®é¡¶èŠå¤©: ${e}`)}unpin(e){this.pinnedChats.has(e)&&(this.pinnedChats.delete(e),this.savePinnedChats(),console.log(`ğŸ“Œ å–æ¶ˆç½®é¡¶èŠå¤©: ${e}`))}isPinned(e){return this.pinnedChats.has(e)}getPinnedChatIds(){const e=Array.from(this.pinnedChats.values());return e.sort((e,t)=>t.pinnedAt-e.pinnedAt),e.map(e=>e.chatId)}getPinnedCount(){return this.pinnedChats.size}cleanup(e){const t=new Set(e);let a=!1;for(const e of this.pinnedChats.keys())t.has(e)||(this.pinnedChats.delete(e),a=!0,console.log(`ğŸ§¹ æ¸…ç†ä¸å­˜åœ¨çš„ç½®é¡¶èŠå¤©: ${e}`));a&&this.savePinnedChats()}getPinnedChatData(e){return this.pinnedChats.get(e)||null}setPinnedChats(e){this.pinnedChats.clear();const t=Date.now();e.forEach((e,a)=>{this.pinnedChats.set(e,{chatId:e,pinnedAt:t-1e3*a})}),this.savePinnedChats()}loadPinnedChats(){try{const e=localStorage.getItem(c.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(Array.isArray(t)){const e=Date.now();return t.forEach((t,a)=>{this.pinnedChats.set(t,{chatId:t,pinnedAt:e-1e3*a})}),void this.savePinnedChats()}Array.isArray(t)&&t.forEach(e=>{e.chatId&&'number'==typeof e.pinnedAt&&this.pinnedChats.set(e.chatId,e)})}catch(e){console.error('åŠ è½½ç½®é¡¶èŠå¤©æ•°æ®å¤±è´¥:',e),localStorage.removeItem(c.STORAGE_KEY)}}savePinnedChats(){try{const e=Array.from(this.pinnedChats.values());localStorage.setItem(c.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error('ä¿å­˜ç½®é¡¶èŠå¤©æ•°æ®å¤±è´¥:',e)}}exportData(){return Array.from(this.pinnedChats.values())}importData(e){this.pinnedChats.clear(),e.forEach(e=>{e.chatId&&'number'==typeof e.pinnedAt&&this.pinnedChats.set(e.chatId,e)}),this.savePinnedChats()}getStats(){const e=Array.from(this.pinnedChats.values());return 0===e.length?{totalPinned:0,oldestPinned:null,newestPinned:null}:(e.sort((e,t)=>e.pinnedAt-t.pinnedAt),{totalPinned:e.length,oldestPinned:e[0],newestPinned:e[e.length-1]})}}class l{STORAGE_KEY='unread_messages_data';unreadData=new Map;messageParser;constructor(e){this.messageParser=e,this.loadFromStorage()}setMessageParser(e){this.messageParser=e}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.unreadData=new Map(Object.entries(t).map(([e,t])=>[e,{chatId:e,lastViewedMessageFingerprints:new Set(t.lastViewedMessageFingerprints||[]),unreadCount:t.unreadCount||0}]))}}catch(e){console.warn('åŠ è½½æœªè¯»æ¶ˆæ¯æ•°æ®å¤±è´¥:',e),this.unreadData=new Map}}saveToStorage(){try{const e={};for(const[t,a]of this.unreadData)e[t]={chatId:t,lastViewedMessageFingerprints:Array.from(a.lastViewedMessageFingerprints),unreadCount:a.unreadCount};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn('ä¿å­˜æœªè¯»æ¶ˆæ¯æ•°æ®å¤±è´¥:',e)}}generateMessageFingerprint(e){return`${e.chatId}_${e.sender}_${e.content}_${e.timestamp}`}calculateUnreadCount(e,t){try{if(!t)return this.getUnreadCount(e);const a=t.get(e);if(!a||!a.messages)return 0;const s=this.unreadData.get(e),n=s?.lastViewedMessageFingerprints||new Set;let r=0;for(const e of a.messages){if('{{user}}'===e.sender||'user'===e.sender)continue;const t=this.generateMessageFingerprint(e);n.has(t)||r++}return s?s.unreadCount=r:this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:new Set,unreadCount:r}),r}catch(t){return console.warn(`è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥ (${e}):`,t),0}}markAsRead(e,t){try{if(!t){const t=this.unreadData.get(e);return void(t&&(t.unreadCount=0,this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)))}const a=t.get(e);if(!a||!a.messages)return;const s=new Set;for(const e of a.messages){const t=this.generateMessageFingerprint(e);s.add(t)}this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:s,unreadCount:0}),this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)}catch(t){console.warn(`æ ‡è®°èŠå¤©ä¸ºå·²è¯»å¤±è´¥ (${e}):`,t)}}getUnreadCount(e){const t=this.unreadData.get(e);return t?.unreadCount||0}getAllUnreadCounts(){const e=new Map;for(const[t,a]of this.unreadData)e.set(t,a.unreadCount);return e}refreshUnreadCounts(e,t){const a=t||Array.from(e.keys());for(const t of a){const a=this.calculateUnreadCount(t,e);this.dispatchUnreadUpdateEvent(t,a)}this.saveToStorage()}onNewMessage(e,t){if(!t)return;const a=this.calculateUnreadCount(e,t);this.dispatchUnreadUpdateEvent(e,a),this.saveToStorage()}onNewMessages(e,t,a){if(!e.length||!t)return;const s=new Map;for(const t of e)if(t.chatId&&'{{user}}'!==t.sender&&'user'!==t.sender){if(a&&t.chatId===a){console.log(`ğŸ“– ç”¨æˆ·æ­£åœ¨èŠå¤© ${a} ä¸­ï¼Œæ–°æ¶ˆæ¯ä¸è®¡å…¥æœªè¯»`);continue}const e=s.get(t.chatId)||0;s.set(t.chatId,e+1)}for(const[e,t]of s){const a=this.getUnreadCount(e)+t,s=this.unreadData.get(e);s?s.unreadCount=a:this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:new Set,unreadCount:a}),console.log(`ğŸ“Š èŠå¤© ${e} æ–°å¢ ${t} æ¡æœªè¯»æ¶ˆæ¯ï¼Œæ€»è®¡ ${a} æ¡`),this.dispatchUnreadUpdateEvent(e,a)}this.saveToStorage()}dispatchUnreadUpdateEvent(e,t){const a=new CustomEvent('unreadCountUpdated',{detail:{chatId:e,unreadCount:t}});document.dispatchEvent(a)}clearUnreadData(e){this.unreadData.delete(e),this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)}clearAllUnreadData(){this.unreadData.clear(),this.saveToStorage();const e=new CustomEvent('allUnreadCountsCleared');document.dispatchEvent(e)}getTotalUnreadCount(){let e=0;for(const t of this.unreadData.values())e+=t.unreadCount;return e}destroy(){this.saveToStorage(),this.unreadData.clear()}}var d=a(582);class h{soundManager;contactManager;groupChatManager=null;config;newChatModalData;statusBar=null;currentChatDataMap=void 0;longPressHandler;contextMenu;pinManager;wallpaperManager;unreadMessageManager;bottomNavigation;constructor(e,t,a){this.soundManager=e,this.contactManager=new r.A,t?this.groupChatManager=t:console.warn('âš ï¸ ChatListManager: æœªä¼ å…¥GroupChatManagerå®ä¾‹ï¼Œç¾¤èŠåŠŸèƒ½å¯èƒ½ä¸å¯ç”¨'),this.longPressHandler=new i,this.contextMenu=new o,this.pinManager=new c,this.wallpaperManager=d.WallpaperManager.getInstance(),this.unreadMessageManager=new l(a),this.bottomNavigation=new s({items:[]}),this.config={maxRecentChats:50,showUnreadBadge:!0,enableGroupChat:!0,defaultAvatars:['https://files.catbox.moe/u8ccy5.jpg','https://files.catbox.moe/j2s4qj.jpg','https://files.catbox.moe/seoipi.jpg','https://files.catbox.moe/dq08mr.jpg','https://files.catbox.moe/yc3gv4.jpeg','https://files.catbox.moe/y4vvp0.jpg']},this.newChatModalData={type:'single',selectedContacts:new Set},this.setupEventListeners()}showChatListInterface(e){e&&(this.currentChatDataMap=e);let t=document.getElementById('chatListInterface');if(t)this.setupExistingContainer(t);else{t=this.createChatListContainer();const e=document.querySelector('.interface-container');e&&e.appendChild(t)}t.classList.add('active'),t.style.display='block',this.bottomNavigation.setActiveItem('messages'),this.wallpaperManager.applyWallpaper(),e&&(this.contactManager.extractContactsFromChatData(e),this.renderChatList(e)),this.initializeStatusBar(),this.initializeLongPressHandler()}hideChatListInterface(){const e=document.getElementById('chatListInterface');e&&(e.classList.remove('active'),e.style.display='none'),this.destroyStatusBar(),this.destroyLongPressHandler(),this.contextMenu.hide()}refreshChatList(e){const t=e||this.currentChatDataMap;this.renderChatList(t)}async reloadContacts(){console.log('ğŸ”„ ChatListManager: é‡æ–°åŠ è½½è”ç³»äººæ•°æ®'),await this.contactManager.reloadContacts();const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&this.refreshChatList()}setupEventListeners(){document.addEventListener('chatListChanged',e=>{const t=e;console.log('ğŸ“± æ”¶åˆ°èŠå¤©åˆ—è¡¨å˜åŒ–äº‹ä»¶:',t.detail),this.refreshChatList(this.currentChatDataMap)}),document.addEventListener('chatItemLongPress',e=>{const t=e;this.handleLongPress(t.detail)}),document.addEventListener('contextMenuAction',e=>{const t=e;this.handleContextMenuAction(t.detail)}),document.addEventListener('chatListItemClick',e=>{const t=e;this.onChatItemClick(t.detail.chatId)}),document.addEventListener('unreadCountUpdated',e=>{const t=e;this.onUnreadCountUpdated(t.detail.chatId,t.detail.unreadCount)}),document.addEventListener('allUnreadCountsCleared',()=>{this.refreshChatList(this.currentChatDataMap)}),document.addEventListener('avatarCacheCleared',e=>{const t=e;console.log('ğŸ”„ [ChatListManager] æ”¶åˆ°å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶ï¼Œåˆ·æ–°èŠå¤©åˆ—è¡¨:',t.detail),this.refreshChatList(this.currentChatDataMap)}),document.addEventListener('characterAvatarUpdated',e=>{const t=e,{contactName:a,newAvatar:s}=t.detail;console.log('ğŸ”„ [ChatListManager] æ”¶åˆ°è§’è‰²å¤´åƒæ›´æ–°äº‹ä»¶:',a,s),this.updateCharacterAvatarOnly(a,s)})}setupExistingContainer(e){if(!e.querySelector('#newChatBtn')){const t='\n        <div id="chatListStatusBarContainer"></div>\n        <div class="chat-list-content" id="chatListContent">\n          \x3c!-- èŠå¤©åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ --\x3e\n        </div>\n        <button class="new-chat-btn" id="newChatBtn">\n          <svg viewBox="0 0 24 24">\n            <path fill="currentColor" d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/>\n          </svg>\n        </button>\n      ';e.innerHTML=t+'<div class="bottom-nav"></div>';const a=e.querySelector('.bottom-nav');a&&(this.bottomNavigation=s.mountDefault(a,'messages',{feed:()=>this.switchToFeed(),messages:()=>{},profile:()=>this.switchToProfile()})),this.bindChatListEvents(e)}}createChatListContainer(){const e=document.createElement('div');e.id='chatListInterface',e.className='chat-list-interface';e.innerHTML='\n      <div id="chatListStatusBarContainer"></div>\n      <div class="chat-list-content" id="chatListContent">\n        \x3c!-- èŠå¤©åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ --\x3e\n      </div>\n      <button class="new-chat-btn" id="newChatBtn">\n        <svg viewBox="0 0 24 24">\n          <path fill="currentColor" d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/>\n        </svg>\n      </button>\n    <div class="bottom-nav"></div>';const t=e.querySelector('.bottom-nav');return t&&(this.bottomNavigation=s.mountDefault(t,'messages',{feed:()=>this.switchToFeed(),messages:()=>{},profile:()=>this.switchToProfile()})),this.bindChatListEvents(e),e}bindChatListEvents(e){const t=e.querySelector('#newChatBtn');t&&t.addEventListener('click',()=>{this.soundManager.playSound('click'),this.showNewChatModal()})}handleBottomNavClick(e){switch(e){case'messages':console.log('ğŸ“± åˆ‡æ¢åˆ°æ¶ˆæ¯ç•Œé¢');break;case'profile':console.log('ğŸ‘¤ åˆ‡æ¢åˆ°ä¸ªäººä¸»é¡µ'),this.showProfilePage();break;default:console.warn('æœªçŸ¥çš„å¯¼èˆªç±»å‹:',e)}}showProfilePage(){const e=new CustomEvent('showProfilePage',{detail:{source:'bottomNav'}});document.dispatchEvent(e)}renderChatList(e){const t=document.getElementById('chatListContent');if(!t)return;t.innerHTML='';const a=this.generateChatListItems(e);0!==a.length?a.forEach(e=>{const a=this.renderChatListItem(e);t.appendChild(a)}):t.innerHTML='\n        <div class="empty-chat-list">\n          <div class="empty-icon">ğŸ’¬</div>\n          <div class="empty-text">æš‚æ— èŠå¤©è®°å½•</div>\n          <div class="empty-hint">ç‚¹å‡»å³ä¸‹è§’ + å¼€å§‹æ–°çš„èŠå¤©</div>\n        </div>\n      '}generateChatListItems(e){const t=[];return console.log('ğŸ” [DEBUG] ç”ŸæˆèŠå¤©åˆ—è¡¨ï¼Œä¸ä½¿ç”¨localStorageä¸­çš„ç¾¤èŠæ•°æ®'),e?(e.forEach((a,s)=>{const n='group'===a.type;if('string'==typeof a.chatName&&/^\[?åŠ¨æ€\]?$/.test(a.chatName.trim()))return;if(!(a.messages&&a.messages.some(e=>!(!e.type||'S'!==e.type&&'G'!==e.type)||!(!e.content||!e.content.includes('[ç¾¤èŠ')))||n||this.isEligibleChatName(a.chatName)))return;const r=this.getLastMessage(a.messages||[]),o=r?this.formatAbsoluteTime(r.timestamp):'',i=this.extractDisplayName(a.chatName);let c=a.avatar||this.getDefaultAvatar(a.chatName);if(!n&&i){const e=this.contactManager.getAllContacts().find(e=>e.name===i);e&&e.avatar&&(c=e.avatar)}const l=this.unreadMessageManager.calculateUnreadCount(s,e);t.push({chatId:s,name:i,avatar:c,lastMessage:r?this.formatMessagePreview(r):'æš‚æ— æ¶ˆæ¯',lastTime:o,unreadCount:l,type:n?'G':'S'})}),t.sort((t,a)=>{const s=this.pinManager.isPinned(t.chatId),n=this.pinManager.isPinned(a.chatId);if(s&&!n)return-1;if(!s&&n)return 1;if(s&&n){const e=this.pinManager.getPinnedChatData(t.chatId),s=this.pinManager.getPinnedChatData(a.chatId);if(e&&s)return s.pinnedAt-e.pinnedAt}const r=this.getLastMessageTimestamp(t.chatId,e);return this.getLastMessageTimestamp(a.chatId,e)-r}),t.slice(0,this.config.maxRecentChats)):t}renderChatListItem(e){const t=document.createElement('div'),a=this.pinManager.isPinned(e.chatId);return t.className='chat-list-item'+(a?' pinned':''),t.dataset.chatId=e.chatId,t.dataset.type=e.type,t.innerHTML=`\n      <img src="${e.avatar}" class="chat-avatar" alt="${e.name}" onerror="this.src='${this.getDefaultAvatar(e.name)}'">\n      <div class="chat-info">\n        <div class="chat-list-header">\n          <span class="chat-name">${e.name}</span>\n          <div class="chat-time-container">\n            <span class="chat-time">${e.lastTime}</span>\n            ${e.unreadCount>0?`<div class="unread-badge show">${this.formatUnreadCount(e.unreadCount)}</div>`:''}\n          </div>\n        </div>\n        <div class="chat-preview">${e.lastMessage}</div>\n      </div>\n    `,t}onChatItemClick(e){console.log(`ğŸ–±ï¸ èŠå¤©åˆ—è¡¨é¡¹è¢«ç‚¹å‡»: ${e}`),this.unreadMessageManager.markAsRead(e,this.currentChatDataMap);const t=new CustomEvent('chatSwitchRequest',{detail:{chatId:e}});document.dispatchEvent(t)}showNewChatModal(){this.newChatModalData={type:'single',selectedContacts:new Set};const e=this.createNewChatModal(),t=document.querySelector('.interface-container');t?t.appendChild(e):document.body.appendChild(e),setTimeout(()=>{e.classList.add('show')},10)}createNewChatModal(){const e=document.createElement('div');e.className='modal-overlay new-chat-modal',e.id='newChatModal';const t=this.contactManager.getAllContacts(),a=t.map(e=>`\n      <div class="contact-item" data-contact-id="${e.id}">\n        <img src="${e.avatar}" class="contact-avatar" alt="${e.name}">\n        <span class="contact-name">${e.name}</span>\n        <div class="contact-actions">\n          <button class="edit-btn" data-action="edit" data-contact-id="${e.id}" title="ç¼–è¾‘è”ç³»äºº">\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />\n            </svg>\n          </button>\n          <button class="delete-btn" data-action="delete" data-contact-id="${e.id}" title="åˆ é™¤è”ç³»äºº">\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n            </svg>\n          </button>\n        </div>\n        <div class="checkbox"></div>\n      </div>\n    `).join(''),s=0===t.length?'\n      <div class="empty-contacts-hint">\n        <div class="empty-hint">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æœ‹å‹"å¼€å§‹æ·»åŠ </div>\n      </div>\n    ':'';return e.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">æ–°å»ºèŠå¤©</div>\n        <div class="chat-type-options">\n          <div class="chat-type-option selected" data-type="single">å•äººèŠå¤©</div>\n          <div class="chat-type-option" data-type="group">ç¾¤èŠ</div>\n        </div>\n        <div class="contact-list">\n          \n      <div class="contact-item add-friend-item" data-action="add-friend">\n        <div class="add-friend-icon">+</div>\n        <span class="contact-name">æ·»åŠ æœ‹å‹</span>\n      </div>\n    \n          ${a}\n          ${s}\n        </div>\n        <div class="modal-buttons">\n          <button class="modal-btn cancel-btn">å–æ¶ˆ</button>\n          <button class="modal-btn confirm-btn">ç¡®è®¤</button>\n        </div>\n      </div>\n    `,this.bindNewChatModalEvents(e),e}bindNewChatModalEvents(e){const t=e.querySelectorAll('.chat-type-option');t.forEach(a=>{a.addEventListener('click',()=>{t.forEach(e=>e.classList.remove('selected')),a.classList.add('selected'),this.newChatModalData.type=a.getAttribute('data-type'),'group'===this.newChatModalData.type?e.classList.add('group-mode'):(e.classList.remove('group-mode'),this.newChatModalData.selectedContacts.clear(),e.querySelectorAll('.contact-item').forEach(e=>{e.classList.remove('selected')})),this.soundManager.playSound('click')})});const a=e.querySelectorAll('.contact-item');a.forEach(e=>{e.addEventListener('click',t=>{const s=t.target,n=e.getAttribute('data-action'),r=e.getAttribute('data-contact-id'),o=s.closest('.edit-btn'),i=s.closest('.delete-btn');if(o){t.stopPropagation();const e=o.getAttribute('data-contact-id');return void(e&&(this.soundManager.playSound('click'),this.handleEditContact(e)))}if(i){t.stopPropagation();const e=i.getAttribute('data-contact-id');return void(e&&(this.soundManager.playSound('click'),this.handleDeleteContact(e)))}if('add-friend'===n)return this.soundManager.playSound('click'),this.hideNewChatModal(),void this.showAddFriendModal();r&&('single'===this.newChatModalData.type?(a.forEach(e=>e.classList.remove('selected')),e.classList.add('selected'),this.newChatModalData.selectedContacts.clear(),this.newChatModalData.selectedContacts.add(r)):(e.classList.toggle('selected'),e.classList.contains('selected')?this.newChatModalData.selectedContacts.add(r):this.newChatModalData.selectedContacts.delete(r)),this.soundManager.playSound('click'))})});const s=e.querySelector('.cancel-btn');s&&s.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideNewChatModal()});const n=e.querySelector('.confirm-btn');n&&n.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleCreateNewChat()}),e.addEventListener('click',t=>{t.target===e&&this.hideNewChatModal()})}hideNewChatModal(){const e=document.getElementById('newChatModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}showAddFriendModal(){const e=this.createAddFriendModal(),t=document.querySelector('.interface-container');t?t.appendChild(e):document.body.appendChild(e),setTimeout(()=>{e.classList.add('show')},10)}createAddFriendModal(){const e=document.createElement('div');return e.className='modal-overlay add-friend-modal',e.id='addFriendModal',e.innerHTML='\n      <div class="modal-container">\n        <div class="modal-title">æ·»åŠ æœ‹å‹</div>\n        <form class="add-friend-form">\n          <div class="form-group">\n            <label for="friendName">è§’è‰²åç§°</label>\n            <input type="text" id="friendName" placeholder="è¯·è¾“å…¥è§’è‰²çœŸå" maxlength="20" required>\n            <div class="error-message" id="nameError"></div>\n          </div>\n          \n          <div class="form-group">\n            <label>å¤´åƒè®¾ç½®</label>\n            <div class="avatar-options">\n              <div class="avatar-option" data-type="url">\n                <input type="radio" name="avatarType" value="url" id="avatarUrl" checked>\n                <label for="avatarUrl">å›¾ç‰‡é“¾æ¥</label>\n              </div>\n              <div class="avatar-option" data-type="upload">\n                <input type="radio" name="avatarType" value="upload" id="avatarUpload">\n                <label for="avatarUpload">æœ¬åœ°ä¸Šä¼ </label>\n              </div>\n            </div>\n          </div>\n\n          <div class="form-group" id="urlGroup">\n            <input type="url" id="avatarUrlInput" placeholder="è¯·è¾“å…¥å›¾ç‰‡URL">\n            <div class="error-message" id="urlError"></div>\n          </div>\n\n          <div class="form-group" id="uploadGroup" style="display: none;">\n            <button type="button" class="file-upload-btn" id="fileUploadBtn">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n              </svg>\n              é€‰æ‹©æœ¬åœ°æ–‡ä»¶\n            </button>\n            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">\n            <div class="error-message" id="fileError"></div>\n          </div>\n\n          <div class="avatar-preview">\n            <img id="avatarPreview" src="" alt="å¤´åƒé¢„è§ˆ" style="display: none;">\n          </div>\n        </form>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">å–æ¶ˆ</button>\n          <button type="button" class="modal-btn confirm-btn">æ·»åŠ </button>\n        </div>\n      </div>\n    ',this.bindAddFriendModalEvents(e),e}bindAddFriendModalEvents(e){const t=e.querySelector('#friendName'),a=e.querySelector('#avatarUrl'),s=e.querySelector('#avatarUpload'),n=e.querySelector('#avatarUrlInput'),r=e.querySelector('#avatarFileInput'),o=e.querySelector('#fileUploadBtn'),i=e.querySelector('#urlGroup'),c=e.querySelector('#uploadGroup'),l=e.querySelector('#avatarPreview'),d=e.querySelector('.cancel-btn'),h=e.querySelector('.confirm-btn');a.addEventListener('change',()=>{a.checked&&(i.style.display='block',c.style.display='none')}),s.addEventListener('change',()=>{s.checked&&(i.style.display='none',c.style.display='block')}),n.addEventListener('blur',async()=>{const e=n.value.trim();if(e){await this.contactManager.validateAvatarUrl(e)?(l.src=e,l.style.display='block',this.clearError('urlError')):(this.showError('urlError','æ— æ•ˆçš„å›¾ç‰‡URL'),l.style.display='none')}}),o.addEventListener('click',()=>{r.click()}),r.addEventListener('change',async e=>{const t=e.target.files?.[0];if(t)try{const e=await this.contactManager.processAvatarFile(t);l.src=e,l.style.display='block',this.clearError('fileError'),o.innerHTML=`\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n            </svg>\n            ${t.name.length>15?t.name.substring(0,15)+'...':t.name}\n          `}catch(e){this.showError('fileError',e.message),l.style.display='none'}}),t.addEventListener('blur',()=>{const e=this.contactManager.validateContactName(t.value);e.valid?this.clearError('nameError'):this.showError('nameError',e.error)}),d.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideAddFriendModal()}),h.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleAddFriend(e)}),e.addEventListener('click',t=>{t.target===e&&this.hideAddFriendModal()})}hideAddFriendModal(){const e=document.getElementById('addFriendModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}async handleAddFriend(e){const t=e.querySelector('#friendName'),a=e.querySelector('#avatarUrl'),s=e.querySelector('#avatarUrlInput'),n=e.querySelector('#avatarFileInput'),r=(e.querySelector('#avatarPreview'),this.contactManager.validateContactName(t.value));if(!r.valid)return void this.showError('nameError',r.error);let o='';if(a.checked){const e=s.value.trim();if(e){if(!await this.contactManager.validateAvatarUrl(e))return void this.showError('urlError','æ— æ•ˆçš„å›¾ç‰‡URL');o=e}}else{const e=n.files?.[0];if(e)try{o=await this.contactManager.processAvatarFile(e)}catch(e){return void this.showError('fileError',e.message)}}o||(o=this.contactManager.getDefaultAvatar(t.value.trim()));try{const e=this.contactManager.addContact({name:t.value.trim(),avatar:o,type:'character',isOnline:!0,tags:['æœ‹å‹']});this.showToast(`æˆåŠŸæ·»åŠ æœ‹å‹ï¼š${e.name}`,'info'),this.hideAddFriendModal(),setTimeout(()=>{this.showNewChatModal()},300)}catch(e){this.showToast('æ·»åŠ æœ‹å‹å¤±è´¥','error')}}showError(e,t){const a=document.getElementById(e);a&&(a.textContent=t,a.style.display='block')}clearError(e){const t=document.getElementById(e);t&&(t.textContent='',t.style.display='none')}handleCreateNewChat(){if(0===this.newChatModalData.selectedContacts.size)return void this.showToast('è¯·é€‰æ‹©è”ç³»äºº','warning');const e=Array.from(this.newChatModalData.selectedContacts);if('group'===this.newChatModalData.type){if(e.length<2)return void this.showToast('ç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äºº','warning');this.hideNewChatModal(),this.groupChatManager?this.groupChatManager.createGroupChat(e):this.showToast('ç¾¤èŠåŠŸèƒ½ä¸å¯ç”¨ï¼šæœªåˆå§‹åŒ–ç¾¤èŠç®¡ç†å™¨','error')}else{const t=new CustomEvent('createNewChat',{detail:{type:this.newChatModalData.type,contactIds:e}});document.dispatchEvent(t),this.hideNewChatModal()}}getGroupChatData(){return console.log('ğŸ” [DEBUG] getGroupChatData - ä¸å†ä»localStorageè¯»å–ç¾¤èŠæ•°æ®'),[]}getLastMessage(e){return e.length>0?e[e.length-1]:null}extractDisplayName(e){const t=e.match(/^å’Œ(.+)çš„èŠå¤©$/);if(t)return t[1];const a=e.match(/^(.+)çš„ç¾¤èŠ$/);return a?a[1]:e}isEligibleChatName(e){if(!e)return!1;const t=e.trim();return!/^\[?åŠ¨æ€\]?$/.test(t)&&(/^å’Œ.+çš„èŠå¤©$/.test(t)||/çš„ç¾¤èŠ$/.test(t))}formatMessagePreview(e){let t='';switch(e.messageType){case'text':default:t=e.content;break;case'image':t='[å›¾ç‰‡]';break;case'voice':t='[è¯­éŸ³]';break;case'sticker':t='[è¡¨æƒ…åŒ…]';break;case'location':t='[ä½ç½®]';break;case'transfer':t='[è½¬è´¦]'}if('G'===e.type){t=`${'{{user}}'===e.sender?'æˆ‘':e.senderDisplayName||e.sender}: ${t}`}return t.length>30?t.substring(0,30)+'...':t}formatAbsoluteTime(e){const t=new Date,a=new Date;if(!e.includes(':'))return e;{const[t,s]=e.split(':');a.setHours(parseInt(t),parseInt(s),0,0)}const s=t.getTime()-a.getTime(),n=Math.floor(s/864e5);return n<0||0===n?e:1===n?'æ˜¨å¤©':n<7?`${n}å¤©å‰`:a.toLocaleDateString('zh-CN',{month:'short',day:'numeric'})}getLastMessageTimestamp(e,t){const a=t.get(e);if(!a||0===a.messages.length)return 0;const s=a.messages[a.messages.length-1];new Date;if(s.timestamp.includes(':')){const[e,t]=s.timestamp.split(':'),a=new Date;return a.setHours(parseInt(e),parseInt(t),0,0),a.getTime()}return 0}getDefaultAvatar(e){return'https://files.catbox.moe/u8ccy5.jpg'}initializeStatusBar(){const e=document.getElementById('chatListStatusBarContainer');e&&(this.statusBar=n.create(e))}destroyStatusBar(){this.statusBar&&(this.statusBar.destroy(),this.statusBar=null)}showToast(e,t='info'){'undefined'!=typeof toastr?toastr[t](e):console.log(`[${t.toUpperCase()}] ${e}`)}switchToProfile(){console.log('ğŸ”„ ä»èŠå¤©åˆ—è¡¨åˆ‡æ¢åˆ°æˆ‘çš„é¡µé¢');const e=new CustomEvent('pageSwitch',{detail:{from:'chatList',to:'profile'}});document.dispatchEvent(e)}switchToFeed(){console.log('ğŸ”„ ä»èŠå¤©åˆ—è¡¨åˆ‡æ¢åˆ°åŠ¨æ€é¡µé¢');const e=new CustomEvent('pageSwitch',{detail:{from:'chatList',to:'feed'}});document.dispatchEvent(e)}getContactManager(){return this.contactManager}handleEditContact(e){const t=this.contactManager.getContactById(e);t&&(this.hideNewChatModal(),this.showEditContactModal(t))}handleDeleteContact(e){const t=this.contactManager.getContactById(e);t&&(this.hideNewChatModal(),this.showDeleteConfirmModal(t))}showEditContactModal(e){const t=this.createEditContactModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}createEditContactModal(e){const t=document.createElement('div');return t.className='modal-overlay edit-contact-modal',t.id='editContactModal',t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">ç¼–è¾‘è”ç³»äºº</div>\n        <form class="edit-contact-form">\n          <div class="form-group">\n            <label for="editContactName">è§’è‰²åç§°</label>\n            <input type="text" id="editContactName" value="${e.name}" placeholder="è¯·è¾“å…¥è§’è‰²çœŸå" maxlength="20" required>\n            <div class="error-message" id="editNameError"></div>\n          </div>\n          \n          <div class="form-group">\n            <label>å¤´åƒè®¾ç½®</label>\n            <div class="avatar-options">\n              <div class="avatar-option" data-type="url">\n                <input type="radio" name="editAvatarType" value="url" id="editAvatarUrl" ${e.avatar.startsWith('http')?'checked':''}>\n                <label for="editAvatarUrl">å›¾ç‰‡é“¾æ¥</label>\n              </div>\n              <div class="avatar-option" data-type="upload">\n                <input type="radio" name="editAvatarType" value="upload" id="editAvatarUpload" ${e.avatar.startsWith('data:')?'checked':''}>\n                <label for="editAvatarUpload">æœ¬åœ°ä¸Šä¼ </label>\n              </div>\n            </div>\n          </div>\n\n          <div class="form-group" id="editUrlGroup" ${e.avatar.startsWith('data:')?'style="display: none;"':''}>\n            <input type="url" id="editAvatarUrlInput" value="${e.avatar.startsWith('http')?e.avatar:''}" placeholder="è¯·è¾“å…¥å›¾ç‰‡URL">\n            <div class="error-message" id="editUrlError"></div>\n          </div>\n\n          <div class="form-group" id="editUploadGroup" ${e.avatar.startsWith('http')?'style="display: none;"':''}>\n            <button type="button" class="file-upload-btn" id="editFileUploadBtn">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n              </svg>\n              é€‰æ‹©æœ¬åœ°æ–‡ä»¶\n            </button>\n            <input type="file" id="editAvatarFileInput" accept="image/*" style="display: none;">\n            <div class="error-message" id="editFileError"></div>\n          </div>\n\n          <div class="avatar-preview">\n            <img id="editAvatarPreview" src="${e.avatar}" alt="å¤´åƒé¢„è§ˆ">\n          </div>\n        </form>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">å–æ¶ˆ</button>\n          <button type="button" class="modal-btn confirm-btn">ä¿å­˜</button>\n        </div>\n      </div>\n    `,this.bindEditContactModalEvents(t,e),t}bindEditContactModalEvents(e,t){const a=e.querySelector('#editContactName'),s=e.querySelector('#editAvatarUrl'),n=e.querySelector('#editAvatarUpload'),r=e.querySelector('#editAvatarUrlInput'),o=e.querySelector('#editAvatarFileInput'),i=e.querySelector('#editFileUploadBtn'),c=e.querySelector('#editUrlGroup'),l=e.querySelector('#editUploadGroup'),d=e.querySelector('#editAvatarPreview'),h=e.querySelector('.cancel-btn'),m=e.querySelector('.confirm-btn');s.addEventListener('change',()=>{s.checked&&(c.style.display='block',l.style.display='none')}),n.addEventListener('change',()=>{n.checked&&(c.style.display='none',l.style.display='block')}),r.addEventListener('blur',async()=>{const e=r.value.trim();if(e){await this.contactManager.validateAvatarUrl(e)?(d.src=e,this.clearError('editUrlError')):this.showError('editUrlError','æ— æ•ˆçš„å›¾ç‰‡URL')}}),i.addEventListener('click',()=>{o.click()}),o.addEventListener('change',async e=>{const t=e.target.files?.[0];if(t)try{const e=await this.contactManager.processAvatarFile(t);d.src=e,this.clearError('editFileError'),i.innerHTML=`\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n            </svg>\n            ${t.name.length>15?t.name.substring(0,15)+'...':t.name}\n          `}catch(e){this.showError('editFileError',e.message)}}),a.addEventListener('blur',()=>{const e=a.value.trim();if(e!==t.name){const t=this.contactManager.validateContactName(e);t.valid?this.clearError('editNameError'):this.showError('editNameError',t.error)}else this.clearError('editNameError')}),h.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideEditContactModal()}),m.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleSaveEditContact(e,t)}),e.addEventListener('click',t=>{t.target===e&&this.hideEditContactModal()})}async handleSaveEditContact(e,t){const a=e.querySelector('#editContactName'),s=e.querySelector('#editAvatarUrl'),n=e.querySelector('#editAvatarUrlInput'),r=e.querySelector('#editAvatarFileInput'),o=e.querySelector('#editAvatarPreview'),i=a.value.trim();if(i!==t.name){const e=this.contactManager.validateContactName(i);if(!e.valid)return void this.showError('editNameError',e.error)}let c=t.avatar;if(s.checked){const e=n.value.trim();if(e&&e!==t.avatar){if(!await this.contactManager.validateAvatarUrl(e))return void this.showError('editUrlError','æ— æ•ˆçš„å›¾ç‰‡URL');c=e}}else{const e=r.files?.[0];if(e)try{c=await this.contactManager.processAvatarFile(e)}catch(e){return void this.showError('editFileError',e.message)}else o.src.startsWith('data:')&&(c=o.src)}try{this.contactManager.updateContact(t.id,{name:i,avatar:c})?(this.syncAvatarAcrossInterface(t.name,i,c),this.notifyContactUpdated(t.name,i,c),this.showToast(`è”ç³»äºº "${i}" å·²æ›´æ–°`,'info'),this.hideEditContactModal(),setTimeout(()=>{this.showNewChatModal(),this.notifyRefreshChatList()},300)):this.showToast('æ›´æ–°è”ç³»äººå¤±è´¥','error')}catch(e){this.showToast('æ›´æ–°è”ç³»äººå¤±è´¥','error')}}hideEditContactModal(){const e=document.getElementById('editContactModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}showDeleteConfirmModal(e){const t=this.createDeleteConfirmModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}createDeleteConfirmModal(e){const t=document.createElement('div');return t.className='modal-overlay delete-confirm-modal',t.id='deleteConfirmModal',t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">åˆ é™¤è”ç³»äºº</div>\n        <div class="delete-confirm-content">\n          <div class="warning-icon">âš ï¸</div>\n          <div class="delete-message">\n            <p>ç¡®å®šè¦åˆ é™¤è”ç³»äºº <strong>"${e.name}"</strong> å—ï¼Ÿ</p>\n            <p class="delete-note">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä½†ä¸ä¼šåˆ é™¤ä¸è¯¥è”ç³»äººçš„èŠå¤©è®°å½•ã€‚</p>\n          </div>\n          <div class="contact-preview">\n            <img src="${e.avatar}" class="preview-avatar" alt="${e.name}">\n            <span class="preview-name">${e.name}</span>\n          </div>\n        </div>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">å–æ¶ˆ</button>\n          <button type="button" class="modal-btn delete-btn">åˆ é™¤</button>\n        </div>\n      </div>\n    `,this.bindDeleteConfirmModalEvents(t,e),t}bindDeleteConfirmModalEvents(e,t){const a=e.querySelector('.cancel-btn'),s=e.querySelector('.delete-btn');a.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideDeleteConfirmModal()}),s.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleConfirmDeleteContact(t)}),e.addEventListener('click',t=>{t.target===e&&this.hideDeleteConfirmModal()})}handleConfirmDeleteContact(e){try{this.contactManager.deleteContact(e.id)?(this.showToast(`è”ç³»äºº "${e.name}" å·²åˆ é™¤`,'info'),this.hideDeleteConfirmModal(),setTimeout(()=>{this.showNewChatModal()},300)):this.showToast('åˆ é™¤è”ç³»äººå¤±è´¥','error')}catch(e){this.showToast('åˆ é™¤è”ç³»äººå¤±è´¥','error')}}hideDeleteConfirmModal(){const e=document.getElementById('deleteConfirmModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}syncAvatarAcrossInterface(e,t,a){try{this.syncChatListAvatars(e,t,a),this.syncChatMessageAvatars(e,t,a),console.log(`âœ… å¤´åƒåŒæ­¥å®Œæˆ: ${e} -> ${t}`)}catch(e){console.error('âŒ å¤´åƒåŒæ­¥å¤±è´¥:',e)}}updateCharacterAvatarOnly(e,t){try{document.querySelectorAll('.chat-list-item').forEach(a=>{const s=a.querySelector('.chat-name')?.textContent?.trim();if(s===e||s===`å’Œ${e}çš„èŠå¤©`){const s=a.querySelector('.chat-avatar');s&&(s.src=t,console.log(`ğŸ”„ æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„è§’è‰²å¤´åƒ: ${e}`))}});document.querySelectorAll('.avatar.avatar-hover').forEach(a=>{const s=a;if(s.classList.contains('user_avatar'))return;if(s.classList.contains('header-avatar')||'headerAvatar'===s.id)return;const n=s.closest('.message, .chat-message, [data-sender]');if(n){const a=n.getAttribute('data-sender'),r=n.querySelector('.sender-name, .message-sender, .chat-sender');(a||r?.textContent?.trim())===e&&(s.src=t,console.log(`ğŸ”„ æ›´æ–°æ¶ˆæ¯ä¸­çš„è§’è‰²å¤´åƒ: ${e}`))}}),this.currentChatDataMap&&this.currentChatDataMap.forEach((a,s)=>{a.chatName!==`å’Œ${e}çš„èŠå¤©`&&a.chatName!==e||(a.avatar=t)}),console.log(`âœ… è§’è‰²å¤´åƒæ›´æ–°å®Œæˆ: ${e}`)}catch(e){console.error('âŒ æ›´æ–°è§’è‰²å¤´åƒå¤±è´¥:',e)}}syncChatListAvatars(e,t,a){document.querySelectorAll('.chat-list-item').forEach(s=>{const n=s.querySelector('.chat-name')?.textContent?.trim(),r=s.querySelector('.chat-avatar');if(r&&n){if(n===e||n===t||n===`å’Œ${e}çš„èŠå¤©`||n===`å’Œ${t}çš„èŠå¤©`||n.includes(e)||n.includes(t)){r.src=a,r.alt=t,console.log(`ğŸ”„ æ›´æ–°èŠå¤©åˆ—è¡¨å¤´åƒ: ${n} -> ${a}`);const o=s.querySelector('.chat-name');o&&n===`å’Œ${e}çš„èŠå¤©`&&(o.textContent=`å’Œ${t}çš„èŠå¤©`,console.log(`ğŸ”„ æ›´æ–°èŠå¤©åç§°: ${n} -> å’Œ${t}çš„èŠå¤©`))}}})}syncChatMessageAvatars(e,t,a){document.querySelectorAll('.avatar, .avatar-hover').forEach(s=>{const n=s;n.alt!==e&&n.alt!==t||(n.src=a,n.alt=t,console.log(`ğŸ”„ æ›´æ–°æ¶ˆæ¯å¤´åƒ: ${e} -> ${t}`));const r=s.closest('.message');if(r){const s=r.querySelector('.message-sender, .sender-name');!s||s.textContent!==e&&s.textContent!==t||(n.src=a,n.alt=t,console.log(`ğŸ”„ æ›´æ–°æ¶ˆæ¯å¤´åƒ(é€šè¿‡å‘é€è€…): ${e} -> ${t}`))}})}syncChatHeaderAvatar(e,t,a){const s=document.getElementById('headerAvatar'),n=document.getElementById('chatTitle');if(s&&n){const r=n.textContent?.trim();r!==e&&r!==t&&r!==`å’Œ${e}çš„èŠå¤©`&&r!==`å’Œ${t}çš„èŠå¤©`||(s.src=a,s.alt=t,r===`å’Œ${e}çš„èŠå¤©`&&(n.textContent=`å’Œ${t}çš„èŠå¤©`),console.log(`ğŸ”„ æ›´æ–°headerå¤´åƒ: ${r}`))}}notifyContactUpdated(e,t,a){const s=new CustomEvent('contactUpdated',{detail:{oldName:e,newName:t,newAvatar:a,timestamp:Date.now()}});document.dispatchEvent(s),console.log(`ğŸ“¢ å‘é€è”ç³»äººæ›´æ–°äº‹ä»¶: ${e} -> ${t}`)}notifyRefreshChatList(){const e=new CustomEvent('refreshChatList',{detail:{timestamp:Date.now()}});document.dispatchEvent(e),console.log('ğŸ“¢ å‘é€åˆ·æ–°èŠå¤©åˆ—è¡¨äº‹ä»¶')}handleLongPress(e){const{chatId:t,position:a}=e,s=this.pinManager.isPinned(t);console.log(`ğŸ”— é•¿æŒ‰èŠå¤©é¡¹: ${t}, ä½ç½®: (${a.x}, ${a.y}), ç½®é¡¶çŠ¶æ€: ${s}`),this.soundManager.playSound('click'),this.contextMenu.show(t,a,s)}handleContextMenuAction(e){const{action:t,chatId:a}=e;switch(console.log(`ğŸ“‹ ä¸Šä¸‹æ–‡èœå•æ“ä½œ: ${t}, èŠå¤©ID: ${a}`),t){case'pin':this.handlePinChat(a);break;case'unpin':this.handleUnpinChat(a);break;case'delete':this.handleDeleteChat(a)}}handlePinChat(e){try{this.pinManager.pin(e),this.refreshChatList(this.currentChatDataMap),console.log(`ğŸ“Œ èŠå¤©å·²ç½®é¡¶: ${e}`)}catch(e){console.error('ç½®é¡¶èŠå¤©å¤±è´¥:',e),this.showToast('ç½®é¡¶å¤±è´¥','error')}}handleUnpinChat(e){try{this.pinManager.unpin(e),this.refreshChatList(this.currentChatDataMap),console.log(`ğŸ“Œ èŠå¤©å·²å–æ¶ˆç½®é¡¶: ${e}`)}catch(e){console.error('å–æ¶ˆç½®é¡¶å¤±è´¥:',e),this.showToast('å–æ¶ˆç½®é¡¶å¤±è´¥','error')}}handleDeleteChat(e){const t=this.getChatNameById(e);this.getChatAvatarById(e);if(confirm(`ç¡®å®šè¦åˆ é™¤ä¸"${t}"çš„èŠå¤©å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ã€‚`))try{e.startsWith('group_')?this.deleteGroupChat(e):this.deleteRegularChat(e),this.pinManager.isPinned(e)&&this.pinManager.unpin(e),this.refreshChatList(this.currentChatDataMap),this.showToast(`å·²åˆ é™¤ä¸"${t}"çš„èŠå¤©`,'info'),console.log(`ğŸ—‘ï¸ èŠå¤©å·²åˆ é™¤: ${e}`)}catch(e){console.error('åˆ é™¤èŠå¤©å¤±è´¥:',e),this.showToast('åˆ é™¤å¤±è´¥','error')}}getChatNameById(e){const t=document.querySelector(`[data-chat-id="${e}"]`);if(t){const e=t.querySelector('.chat-name');if(e)return e.textContent||'æœªçŸ¥èŠå¤©'}if(e.startsWith('group_')){const t=this.getGroupChatData().find(t=>t.id===e);if(t)return t.chatName}return'æœªçŸ¥èŠå¤©'}getChatAvatarById(e){const t=document.querySelector(`[data-chat-id="${e}"]`);if(t){const e=t.querySelector('.chat-avatar');if(e)return e.src}if(e.startsWith('group_')){const t=this.getGroupChatData().find(t=>t.id===e);if(t)return t.avatar}return this.getDefaultAvatar('')}deleteGroupChat(e){console.log(`ğŸ” [DEBUG] åˆ é™¤ç¾¤èŠè¯·æ±‚: ${e} - ç”±ä¸»åº”ç”¨å¤„ç†`);const t=new CustomEvent('deleteChatRequest',{detail:{chatId:e,type:'group'}});document.dispatchEvent(t)}deleteRegularChat(e){const t=new CustomEvent('deleteChatRequest',{detail:{chatId:e}});document.dispatchEvent(t),console.log(`ğŸ—‘ï¸ å‘é€åˆ é™¤èŠå¤©è¯·æ±‚: ${e}`)}initializeLongPressHandler(){this.longPressHandler.init(),console.log('ğŸ”— é•¿æŒ‰å¤„ç†å™¨å·²åˆå§‹åŒ–')}destroyLongPressHandler(){this.longPressHandler&&this.longPressHandler.destroy(),console.log('ğŸ”— é•¿æŒ‰å¤„ç†å™¨å·²é”€æ¯')}getPinManager(){return this.pinManager}onUnreadCountUpdated(e,t){const a=document.querySelector(`[data-chat-id="${e}"]`);if(a){const s=a.querySelector('.chat-time-container');let n=a.querySelector('.unread-badge');if(this.updateChatPreview(e,a),t>0){const e=this.formatUnreadCount(t);!n&&s&&(n=document.createElement('div'),n.className='unread-badge bounce',s.appendChild(n)),n&&(n.textContent=e,n.classList.add('show'),n.classList.add('pulse'),setTimeout(()=>{n?.classList.remove('bounce','pulse')},600))}else n&&(n.classList.remove('show'),setTimeout(()=>{n&&!n.classList.contains('show')&&n.remove()},200))}}updateChatPreview(e,t){if(!this.currentChatDataMap)return;const a=this.currentChatDataMap.get(e);if(!a||!a.messages||0===a.messages.length)return;const s=this.getLastMessage(a.messages);if(!s)return;const n=this.formatMessagePreview(s),r=t.querySelector('.chat-preview');r&&(r.textContent=n);const o=t.querySelector('.chat-time');if(o&&s.timestamp){const e=this.formatAbsoluteTime(s.timestamp);o.textContent=e}}onNewMessage(e){this.unreadMessageManager.onNewMessage(e,this.currentChatDataMap)}updateChatData(e){this.currentChatDataMap=e}onNewMessages(e,t){this.unreadMessageManager.onNewMessages(e,this.currentChatDataMap,t)}refreshUnreadCounts(){if(this.currentChatDataMap){const e=Array.from(this.currentChatDataMap.keys());this.unreadMessageManager.refreshUnreadCounts(this.currentChatDataMap,e)}}getUnreadMessageManager(){return this.unreadMessageManager}destroy(){this.destroyStatusBar(),this.destroyLongPressHandler(),this.unreadMessageManager.destroy(),this.contextMenu.hide()}formatUnreadCount(e){return e<=0?'':e>99?'99+':e.toString()}}var m=a(691),g=a(721);class u{static instance;constructor(){}static getInstance(){return u.instance||(u.instance=new u),u.instance}fileToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}async compressImage(e,t=300,a=m.TL.quality){return new Promise(s=>{const n=new Image;n.onload=()=>{const e=document.createElement('canvas'),r=e.getContext('2d'),{width:o,height:i}=this.calculateCompressedSize(n.width,n.height,t);e.width=o,e.height=i,r.imageSmoothingEnabled=!0,r.imageSmoothingQuality='high',r.drawImage(n,0,0,o,i);const c=e.toDataURL('image/jpeg',a);s(c)},n.src=e})}async compressWallpaper(e){return this.compressImage(e,800,.8)}async compressAvatar(e){return this.compressImage(e,300,.8)}calculateCompressedSize(e,t,a){let{width:s,height:n}={width:e,height:t};return s>n?s>a&&(n=n*a/s,s=a):n>a&&(s=s*a/n,n=a),{width:Math.round(s),height:Math.round(n)}}validateImageFile(e){if(!m.TL.acceptedTypes.includes(e.type))return{isValid:!1,error:`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ã€‚æ”¯æŒçš„æ ¼å¼ï¼š${m.TL.acceptedTypes.join(', ')}`};if(e.size>m.TL.maxSize){return{isValid:!1,error:`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ã€‚æœ€å¤§å…è®¸ ${m.TL.maxSize/1048576}MB`}}return{isValid:!0}}getImageDimensions(e){return new Promise(t=>{const a=new Image;a.onload=()=>{t({width:a.width,height:a.height})},a.src=e})}async createThumbnail(e,t=100){return this.compressImage(e,t,.7)}static cleanupCanvas(e){const t=e.getContext('2d');t&&t.clearRect(0,0,e.width,e.height),e.width=0,e.height=0}}var p=a(764);class v{storageManager;imageProcessor;state=m.nl.IDLE;isVisible=!1;currentSettings;settingsModal;modalContainer;closeBtn;emojiSuggestionsToggle;crossChatSendToggle;clearUserCacheBtn;clearLorebookCacheBtn;chatListWallpaperUpload;chatListWallpaperPreview;chatListWallpaperInput;removeChatListWallpaperBtn;globalChatWallpaperUpload;globalChatWallpaperPreview;globalChatWallpaperInput;removeGlobalChatWallpaperBtn;applyToAllChatsBtn;constructor(){this.storageManager=p.StorageManager.getInstance(),this.imageProcessor=u.getInstance(),this.currentSettings=this.storageManager.loadSettings(),this.initializeElements(),this.bindEvents()}initializeElements(){if(this.settingsModal=document.getElementById('settingsModal'),this.modalContainer=this.settingsModal.querySelector('.modal-container'),this.closeBtn=document.getElementById('settingsCloseBtn'),this.emojiSuggestionsToggle=document.getElementById('emojiSuggestionsToggle'),this.crossChatSendToggle=document.getElementById('crossChatSendToggle'),this.clearUserCacheBtn=document.getElementById('clearUserCacheBtn'),this.clearLorebookCacheBtn=document.getElementById('clearLorebookCacheBtn'),this.clearUserCacheBtn||console.error('[SettingsModal] æ¸…é™¤ç”¨æˆ·ç¼“å­˜æŒ‰é’®æœªæ‰¾åˆ°'),this.clearLorebookCacheBtn||console.error('[SettingsModal] æ¸…é™¤ä¸–ç•Œä¹¦ç¼“å­˜æŒ‰é’®æœªæ‰¾åˆ°'),this.chatListWallpaperUpload=document.getElementById('chatListWallpaperUpload'),this.chatListWallpaperPreview=document.getElementById('chatListWallpaperPreview'),this.chatListWallpaperInput=document.getElementById('chatListWallpaperInput'),this.removeChatListWallpaperBtn=document.getElementById('removeChatListWallpaper'),this.globalChatWallpaperUpload=document.getElementById('globalChatWallpaperUpload'),this.globalChatWallpaperPreview=document.getElementById('globalChatWallpaperPreview'),this.globalChatWallpaperInput=document.getElementById('globalChatWallpaperInput'),this.removeGlobalChatWallpaperBtn=document.getElementById('removeGlobalChatWallpaper'),this.applyToAllChatsBtn=document.getElementById('applyToAllChatsBtn'),!this.settingsModal)throw new Error('Settings modal element not found')}bindEvents(){this.closeBtn.addEventListener('click',()=>this.hide()),this.settingsModal.addEventListener('click',e=>{e.target===this.settingsModal&&this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.isVisible&&this.hide()}),this.emojiSuggestionsToggle.addEventListener('click',()=>this.toggleEmojiSuggestions()),this.crossChatSendToggle.addEventListener('click',()=>this.toggleCrossChatSend()),this.clearUserCacheBtn?this.clearUserCacheBtn.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),console.log('[SettingsModal] æ¸…é™¤ç”¨æˆ·ç¼“å­˜æŒ‰é’®è¢«ç‚¹å‡»'),this.handleClearUserCache()}):console.error('[SettingsModal] æ— æ³•ç»‘å®šæ¸…é™¤ç”¨æˆ·ç¼“å­˜æŒ‰é’®äº‹ä»¶ï¼ŒæŒ‰é’®æœªæ‰¾åˆ°'),this.clearLorebookCacheBtn?this.clearLorebookCacheBtn.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),console.log('[SettingsModal] æ¸…é™¤ä¸–ç•Œä¹¦ç¼“å­˜æŒ‰é’®è¢«ç‚¹å‡»'),this.handleClearLorebookCache()}):console.error('[SettingsModal] æ— æ³•ç»‘å®šæ¸…é™¤ä¸–ç•Œä¹¦ç¼“å­˜æŒ‰é’®äº‹ä»¶ï¼ŒæŒ‰é’®æœªæ‰¾åˆ°'),this.chatListWallpaperUpload.addEventListener('click',()=>this.chatListWallpaperInput.click()),this.chatListWallpaperUpload.addEventListener('dragover',e=>this.handleDragOver(e)),this.chatListWallpaperUpload.addEventListener('drop',e=>this.handleChatListWallpaperDrop(e)),this.chatListWallpaperInput.addEventListener('change',e=>this.handleChatListWallpaperChange(e)),this.removeChatListWallpaperBtn.addEventListener('click',()=>this.removeChatListWallpaper()),this.globalChatWallpaperUpload.addEventListener('click',()=>this.globalChatWallpaperInput.click()),this.globalChatWallpaperUpload.addEventListener('dragover',e=>this.handleDragOver(e)),this.globalChatWallpaperUpload.addEventListener('drop',e=>this.handleGlobalChatWallpaperDrop(e)),this.globalChatWallpaperInput.addEventListener('change',e=>this.handleGlobalChatWallpaperChange(e)),this.removeGlobalChatWallpaperBtn.addEventListener('click',()=>this.removeGlobalChatWallpaper()),this.applyToAllChatsBtn&&this.applyToAllChatsBtn.addEventListener('click',()=>this.handleApplyToAllChats()),this.chatListWallpaperPreview.addEventListener('click',e=>{e.target&&(e.target.closest('.remove-btn')||e.target.closest('.apply-all-btn'))||this.chatListWallpaperInput.click()}),this.globalChatWallpaperPreview.addEventListener('click',e=>{e.target&&(e.target.closest('.remove-btn')||e.target.closest('.apply-all-btn'))||this.globalChatWallpaperInput.click()})}async initialize(){try{this.currentSettings=this.storageManager.loadSettings(),this.updateUI()}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'åˆå§‹åŒ–è®¾ç½®å¤±è´¥',details:e,timestamp:Date.now()})}}show(){this.isVisible||(this.settingsModal.classList.add('show'),this.isVisible=!0,this.updateUI(),document.body.style.overflow='hidden')}hide(){this.isVisible&&(this.settingsModal.classList.remove('show'),this.isVisible=!1,document.body.style.overflow='',this.saveSettings())}updateUI(){this.currentSettings.emojiSuggestionsEnabled?this.emojiSuggestionsToggle.classList.add('active'):this.emojiSuggestionsToggle.classList.remove('active'),this.currentSettings.crossChatSendEnabled?this.crossChatSendToggle.classList.add('active'):this.crossChatSendToggle.classList.remove('active'),this.updateWallpaperPreview(this.currentSettings.chatListWallpaper,this.chatListWallpaperPreview),this.updateWallpaperPreview(this.currentSettings.globalChatWallpaper,this.globalChatWallpaperPreview)}updateWallpaperPreview(e,t){const a=t.previousElementSibling;if(e){const s=t.querySelector('img');s&&(s.src=e,t.style.display='block',a&&a.classList.contains('upload-area')&&a.style.setProperty('display','none','important'),t.style.cursor='pointer',t.title='ç‚¹å‡»æ›´æ¢å£çº¸')}else t.style.display='none',a&&a.classList.contains('upload-area')&&a.style.setProperty('display','flex','important')}toggleEmojiSuggestions(){this.currentSettings.emojiSuggestionsEnabled=!this.currentSettings.emojiSuggestionsEnabled,this.updateUI(),this.saveSettings();const e=this.currentSettings.emojiSuggestionsEnabled?'å·²å¼€å¯':'å·²å…³é—­';toastr.info(`è¡¨æƒ…åŒ…å»ºè®®${e}`)}toggleCrossChatSend(){this.currentSettings.crossChatSendEnabled=!this.currentSettings.crossChatSendEnabled,this.updateUI(),this.saveSettings();const e=this.currentSettings.crossChatSendEnabled?'å·²å¼€å¯':'å·²å…³é—­';toastr.info(`è·¨èŠå¤©å‘é€${e}`),document.dispatchEvent(new CustomEvent('settingsUpdated',{detail:{crossChatSendEnabled:this.currentSettings.crossChatSendEnabled}}))}handleDragOver(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.add('dragover')}handleChatListWallpaperDrop(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.remove('dragover');const t=e.dataTransfer?.files;t&&t.length>0&&this.processChatListWallpaperFile(t[0])}handleGlobalChatWallpaperDrop(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.remove('dragover');const t=e.dataTransfer?.files;t&&t.length>0&&this.processGlobalChatWallpaperFile(t[0])}handleChatListWallpaperChange(e){const t=e.target,a=t.files?.[0];a&&this.processChatListWallpaperFile(a),t.value=''}handleGlobalChatWallpaperChange(e){const t=e.target,a=t.files?.[0];a&&this.processGlobalChatWallpaperFile(a),t.value=''}async processChatListWallpaperFile(e){try{const t=this.imageProcessor.validateImageFile(e);if(!t.isValid)return void toastr.error(t.error,'æ–‡ä»¶éªŒè¯å¤±è´¥');this.setState(m.nl.LOADING);const a=await this.imageProcessor.fileToBase64(e),s=await this.imageProcessor.compressWallpaper(a);this.currentSettings.chatListWallpaper=s,this.updateWallpaperPreview(s,this.chatListWallpaperPreview),this.saveSettings(),await this.applyWallpaperToChatList(s),toastr.success('èŠå¤©åˆ—è¡¨å£çº¸è®¾ç½®æˆåŠŸ'),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.FILE_ERROR,message:'å¤„ç†èŠå¤©åˆ—è¡¨å£çº¸å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.IDLE)}}async processGlobalChatWallpaperFile(e){try{const t=this.imageProcessor.validateImageFile(e);if(!t.isValid)return void toastr.error(t.error,'æ–‡ä»¶éªŒè¯å¤±è´¥');this.setState(m.nl.LOADING);const a=await this.imageProcessor.fileToBase64(e),s=await this.imageProcessor.compressWallpaper(a);this.currentSettings.globalChatWallpaper=s,this.updateWallpaperPreview(s,this.globalChatWallpaperPreview),this.saveSettings(),await this.applyWallpaperToChatWindow(s),toastr.success('å…¨å±€å¯¹è¯æ¡†å£çº¸è®¾ç½®æˆåŠŸ'),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.FILE_ERROR,message:'å¤„ç†å…¨å±€å¯¹è¯æ¡†å£çº¸å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.IDLE)}}async removeChatListWallpaper(){try{this.currentSettings.chatListWallpaper='',this.updateWallpaperPreview('',this.chatListWallpaperPreview),this.saveSettings();const{WallpaperManager:e}=await Promise.resolve().then(a.bind(a,582));e.getInstance().clearWallpaperCache(),toastr.info('å·²ç§»é™¤èŠå¤©åˆ—è¡¨å£çº¸')}catch(e){console.error('[SettingsModal] ç§»é™¤èŠå¤©åˆ—è¡¨å£çº¸å¤±è´¥:',e),toastr.error('ç§»é™¤å£çº¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')}}async removeGlobalChatWallpaper(){this.currentSettings.globalChatWallpaper='',this.updateWallpaperPreview('',this.globalChatWallpaperPreview),this.saveSettings(),await this.clearChatWindowWallpaper(),toastr.info('å·²ç§»é™¤å…¨å±€å¯¹è¯æ¡†å£çº¸')}saveSettings(){try{this.storageManager.saveSettings(this.currentSettings),this.emitSettingsChangeEvent()}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'ä¿å­˜è®¾ç½®å¤±è´¥',details:e,timestamp:Date.now()})}}emitSettingsChangeEvent(){const e=new CustomEvent('settingsChange',{detail:{settings:{...this.currentSettings},timestamp:Date.now()}});document.dispatchEvent(e)}setState(e){switch(this.state=e,this.modalContainer.classList.remove('loading','error'),e){case m.nl.LOADING:this.modalContainer.classList.add('loading');break;case m.nl.ERROR:this.modalContainer.classList.add('error')}}handleError(e){console.error(`[SettingsModal] ${e.message}:`,e.details),toastr.error(e.message)}getCurrentSettings(){return{...this.currentSettings}}isModalVisible(){return this.isVisible}resetToDefaults(){this.currentSettings=this.storageManager.loadSettings(),this.updateUI(),this.saveSettings(),toastr.info('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼')}async handleClearUserCache(){console.log('[SettingsModal] å¼€å§‹å¤„ç†æ¸…é™¤ç”¨æˆ·ç¼“å­˜');try{console.log('[SettingsModal] æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†');const e=await this.showConfirmDialog('ç¡®è®¤æ¸…é™¤ç¼“å­˜','è¿™å°†æ¸…é™¤æœ¬åœ°ä¿å­˜çš„ç”¨æˆ·å¤´åƒå’Œåå­—ï¼Œæ¢å¤ä¸ºé»˜è®¤è®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');if(console.log('[SettingsModal] ç”¨æˆ·ç¡®è®¤ç»“æœ:',e),!e)return;const{GlobalUserManager:t}=await Promise.resolve().then(a.bind(a,721)),s=t.getInstance();await s.resetToDefault(),toastr.success('ç”¨æˆ·ç¼“å­˜å·²æ¸…é™¤ï¼Œå¤´åƒå’Œåå­—å·²æ¢å¤ä¸ºé»˜è®¤è®¾ç½®'),this.hide()}catch(e){console.error('[SettingsModal] æ¸…é™¤ç”¨æˆ·ç¼“å­˜å¤±è´¥:',e),toastr.error('æ¸…é™¤ç”¨æˆ·ç¼“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')}}async handleClearLorebookCache(){console.log('[SettingsModal] å¼€å§‹å¤„ç†æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜');try{const e='è¿™å°†æ¸…é™¤ä¸–ç•Œä¹¦ä¸­æ‰€æœ‰è§’è‰²çš„è‡ªå®šä¹‰å¤´åƒç¼“å­˜ï¼Œæ¢å¤ä¸ºä¸–ç•Œä¹¦é»˜è®¤å¤´åƒã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';if(!await this.showConfirmDialog('ç¡®è®¤æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜',e))return;const t=await(window.bearChatManager?.clearLorebookCharacterCache());if(!t)return void toastr.error('æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');console.log('[SettingsModal] ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜æ¸…é™¤å®Œæˆ:',t)}catch(e){console.error('[SettingsModal] æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥:',e),toastr.error('æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')}}showConfirmDialog(e,t){return new Promise(a=>{const s=document.querySelector('.confirm-dialog-overlay');s&&s.remove();const n=document.createElement('div');n.className='confirm-dialog-overlay';const r=document.createElement('div');r.className='confirm-dialog',r.innerHTML=`\n        <div class="dialog-header">\n          <h3>âš ï¸ ${e}</h3>\n        </div>\n        <div class="dialog-content">\n          <p>${t}</p>\n        </div>\n        <div class="dialog-buttons">\n          <button class="cancel-btn">å–æ¶ˆ</button>\n          <button class="confirm-btn danger">ç¡®è®¤æ¸…é™¤</button>\n        </div>\n      `,n.appendChild(r),this.settingsModal.appendChild(n);const o=r.querySelector('.cancel-btn'),i=r.querySelector('.confirm-btn'),c=()=>{n.remove(),document.removeEventListener('keydown',l)};o.addEventListener('click',()=>{c(),a(!1)}),i.addEventListener('click',()=>{c(),a(!0)}),n.addEventListener('click',e=>{e.target===n&&(c(),a(!1))});const l=e=>{'Escape'===e.key&&(c(),a(!1))};document.addEventListener('keydown',l)})}async applyWallpaperToChatList(e){try{const{WallpaperManager:t}=await Promise.resolve().then(a.bind(a,582));t.getInstance().setCustomWallpaper(e),console.log('[SettingsModal] å£çº¸å·²åº”ç”¨åˆ°èŠå¤©åˆ—è¡¨')}catch(e){throw console.error('[SettingsModal] åº”ç”¨å£çº¸å¤±è´¥:',e),e}}async applyWallpaperToChatWindow(e){try{const t=new CustomEvent('globalChatWallpaperChange',{detail:{wallpaperData:e}});document.dispatchEvent(t),console.log('[SettingsModal] å£çº¸å·²åº”ç”¨åˆ°èŠå¤©çª—å£')}catch(e){throw console.error('[SettingsModal] åº”ç”¨èŠå¤©çª—å£å£çº¸å¤±è´¥:',e),e}}async clearChatWindowWallpaper(){try{const e=new CustomEvent('clearGlobalChatWallpaper');document.dispatchEvent(e),console.log('[SettingsModal] èŠå¤©çª—å£å£çº¸å·²æ¸…é™¤')}catch(e){throw console.error('[SettingsModal] æ¸…é™¤èŠå¤©çª—å£å£çº¸å¤±è´¥:',e),e}}async handleApplyToAllChats(){try{if(!this.currentSettings.globalChatWallpaper)return void toastr.warning('è¯·å…ˆè®¾ç½®å…¨å±€å¯¹è¯æ¡†å£çº¸');if(!await this.showConfirmDialog('ç¡®è®¤å…¨å±€æ›´æ¢','è¿™å°†æŠŠå½“å‰çš„å…¨å±€å¯¹è¯æ¡†å£çº¸åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¡†ï¼Œå¹¶æ¸…é™¤æ‰€æœ‰å•ç‹¬è®¾ç½®çš„å£çº¸ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'))return;const e=new CustomEvent('applyWallpaperToAllChats',{detail:{wallpaperData:this.currentSettings.globalChatWallpaper}});document.dispatchEvent(e),this.currentSettings.individualChatWallpapers={},this.saveSettings(),toastr.success('å·²å°†å£çº¸åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¡†'),console.log('[SettingsModal] å…¨å±€æ›´æ¢å£çº¸å®Œæˆ')}catch(e){console.error('[SettingsModal] å…¨å±€æ›´æ¢å£çº¸å¤±è´¥:',e),toastr.error('å…¨å±€æ›´æ¢å£çº¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')}}destroy(){this.hide(),document.body.style.overflow=''}}var y,f,C=a(750);class b{globalUserManager;imageProcessor;avatarMixin;state=m.nl.IDLE;avatarElement;avatarImage;avatarOverlay;nameDisplay;nameEdit;nameInput;nameConfirmBtn;nameCancelBtn;avatarFileInput;originalName='';originalAvatar='';pendingAvatar='';constructor(){this.globalUserManager=g.GlobalUserManager.getInstance(),this.imageProcessor=u.getInstance(),this.avatarMixin=new C.SimpleAvatarMixin({debug:!1}),this.initializeElements(),this.bindEvents()}initializeElements(){if(this.avatarElement=document.getElementById('userAvatar'),this.avatarImage=document.getElementById('avatarImage'),this.avatarOverlay=this.avatarElement.querySelector('.avatar-overlay'),this.nameDisplay=document.getElementById('nameDisplay'),this.nameEdit=document.getElementById('nameEdit'),this.nameInput=document.getElementById('nameInput'),this.nameConfirmBtn=document.getElementById('nameConfirmBtn'),this.nameCancelBtn=document.getElementById('nameCancelBtn'),this.avatarFileInput=document.getElementById('avatarFileInput'),!this.avatarElement||!this.avatarImage||!this.nameDisplay)throw new Error('å¿…éœ€çš„DOMå…ƒç´ æœªæ‰¾åˆ°')}bindEvents(){this.avatarElement.addEventListener('click',()=>this.handleAvatarClick()),this.avatarFileInput.addEventListener('change',e=>this.handleAvatarFileChange(e)),this.nameDisplay.addEventListener('click',()=>this.startNameEdit()),this.nameConfirmBtn.addEventListener('click',()=>this.confirmNameEdit()),this.nameCancelBtn.addEventListener('click',()=>this.cancelNameEdit()),this.nameInput.addEventListener('keydown',e=>{'Enter'===e.key?this.confirmNameEdit():'Escape'===e.key&&this.cancelNameEdit()}),this.globalUserManager.addEventListener('all',e=>{this.handleUserInfoChange(e)})}async initialize(){try{this.setState(m.nl.LOADING);const e=await this.globalUserManager.loadUserData();await this.updateDisplay(e),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.ERROR)}}async updateDisplay(e){this.nameDisplay.textContent=e.name,e.avatar?(this.avatarImage.src=e.avatar,this.avatarImage.style.display='block'):(this.avatarImage.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDAiIHI9IjIwIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCA5MEM0MCA3MCA4MCA3MCAxMDAgOTBWMTIwSDIwVjkwWiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K',this.avatarImage.style.display='block')}handleAvatarClick(){this.state===m.nl.IDLE&&this.avatarFileInput.click()}async handleAvatarFileChange(e){const t=e.target,a=t.files?.[0];if(a)try{const e=this.imageProcessor.validateImageFile(a);if(!e.isValid)return void toastr.error(e.error,'æ–‡ä»¶éªŒè¯å¤±è´¥');this.setState(m.nl.LOADING);const t=await this.imageProcessor.fileToBase64(a),s=await this.imageProcessor.compressAvatar(t),n=this.globalUserManager.getCurrentUserData();this.originalAvatar=n?.avatar||'',this.pendingAvatar=s,this.avatarImage.src=s,this.showAvatarConfirmation(),this.setState(m.nl.EDITING)}catch(e){this.handleError({type:m.By.FILE_ERROR,message:'å¤„ç†å¤´åƒæ–‡ä»¶å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.IDLE)}finally{t.value=''}}showAvatarConfirmation(){const e=document.createElement('div');e.className='avatar-confirm-container',e.innerHTML='\n      <div class="avatar-confirm-buttons">\n        <button class="modal-btn confirm-btn" id="avatarConfirmBtn">ç¡®è®¤</button>\n        <button class="modal-btn cancel-btn" id="avatarCancelBtn">å–æ¶ˆ</button>\n      </div>\n    ';this.avatarElement.closest('.user-info-section').appendChild(e);const t=e.querySelector('#avatarConfirmBtn'),a=e.querySelector('#avatarCancelBtn');t.addEventListener('click',()=>this.confirmAvatarChange()),a.addEventListener('click',()=>this.cancelAvatarChange())}async confirmAvatarChange(){try{this.setState(m.nl.SAVING),await this.globalUserManager.updateUserAvatar(this.pendingAvatar),toastr.success('å¤´åƒæ›´æ–°æˆåŠŸ'),(0,C.forceUpdateAvatars)(this.pendingAvatar),this.hideAvatarConfirmation(),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'ä¿å­˜å¤´åƒå¤±è´¥',details:e,timestamp:Date.now()}),this.avatarImage.src=this.originalAvatar,this.setState(m.nl.IDLE)}}cancelAvatarChange(){this.avatarImage.src=this.originalAvatar,this.hideAvatarConfirmation(),this.setState(m.nl.IDLE)}hideAvatarConfirmation(){const e=document.querySelector('.avatar-confirm-container');e&&e.remove()}startNameEdit(){if(this.state!==m.nl.IDLE)return;const e=this.globalUserManager.getCurrentUserData();this.originalName=e?.name||'',this.nameInput.value=this.originalName,this.nameDisplay.style.display='none',this.nameEdit.classList.add('active'),this.nameEdit.style.display='flex',this.nameInput.focus(),this.nameInput.select(),this.setState(m.nl.EDITING)}async confirmNameEdit(){const e=this.nameInput.value.trim(),t=this.validateName(e);if(t.isValid)try{this.setState(m.nl.SAVING),await this.globalUserManager.updateUserName(e),this.nameDisplay.textContent=e,this.exitNameEdit(),toastr.success('ç”¨æˆ·åæ›´æ–°æˆåŠŸ'),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'ä¿å­˜ç”¨æˆ·åå¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.EDITING)}else toastr.error(t.error,'åç§°éªŒè¯å¤±è´¥')}cancelNameEdit(){this.exitNameEdit(),this.setState(m.nl.IDLE)}exitNameEdit(){this.nameEdit.classList.remove('active'),this.nameEdit.style.display='none',this.nameDisplay.style.display='inline-block'}validateName(e){if(!e)return{isValid:!1,error:'ç”¨æˆ·åä¸èƒ½ä¸ºç©º'};if(e.length>50)return{isValid:!1,error:'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦'};return/[<>\"'&]/.test(e)?{isValid:!1,error:'ç”¨æˆ·ååŒ…å«æ— æ•ˆå­—ç¬¦'}:{isValid:!0}}setState(e){switch(this.state=e,this.avatarElement.classList.remove('loading','editing','error'),e){case m.nl.LOADING:this.avatarElement.classList.add('loading');break;case m.nl.EDITING:this.avatarElement.classList.add('editing');break;case m.nl.ERROR:this.avatarElement.classList.add('error')}}handleUserInfoChange(e){if(this.state===m.nl.IDLE){const e=this.globalUserManager.getCurrentUserData();e&&this.updateDisplay(e)}}handleError(e){console.error(`[UserInfoSection] ${e.message}:`,e.details),toastr.error(e.message)}getState(){return this.state}destroy(){this.globalUserManager.removeEventListener('all',this.handleUserInfoChange),this.hideAvatarConfirmation(),this.state===m.nl.EDITING&&this.exitNameEdit()}}class M{static instance;isEnabled=!1;SETTING_KEY='bear_chat_migration_enabled';isProcessing=!1;lastCheckedMessageId=-1;lastCheckedContent='';migratedMessages=new Set;constructor(){this.loadSettings()}static getInstance(){return M.instance||(M.instance=new M),M.instance}initialize(){this.loadSettings(),this.logInfo('ChatMigrationManager å·²åˆå§‹åŒ–')}isFeatureEnabled(){return this.isEnabled}setFeatureEnabled(e){this.isEnabled=e,this.saveSettings(),this.logInfo('èŠå¤©è®°å½•è¿ç§»åŠŸèƒ½å·²'+(e?'å¯ç”¨':'ç¦ç”¨'))}async checkAndMigrate(){try{if(!this.isEnabled)return;if(this.isProcessing)return;const e=getLastMessageId();if(e<0)return;if(e===this.lastCheckedMessageId)return;this.isProcessing=!0;const t=getChatMessages(e);if(!t||0===t.length)return;const a=t[0].message;if(a===this.lastCheckedContent)return;this.lastCheckedMessageId=e,this.lastCheckedContent=a;if(!this.containsEmptyBearTags(a))return;if(this.migratedMessages.has(e))return;this.logInfo(`ğŸ” åœ¨æ¥¼å±‚ ${e} å‘ç°ç©ºçš„ <bear></bear> æ ‡ç­¾ï¼Œå¼€å§‹æœç´¢å†å²å†…å®¹`);const s=await this.findHistoryContent(e);if(!s)return;await this.migrateContent(e,a,s)}catch(e){this.logError('æ£€æŸ¥å’Œè¿ç§»è¿‡ç¨‹',e)}finally{this.isProcessing=!1}}containsEmptyBearTags(e){return/<bear>\s*<\/bear>/gs.test(e)}containsBearTags(e){return/<bear>.*?<\/bear>/gs.test(e)}async findHistoryContent(e){try{let t=0;for(let a=e-1;a>=0;a--){t++;const e=getChatMessages(a);if(!e||0===e.length)continue;const s=e[0].message;if(this.containsBearTags(s)){const e=this.extractBearContent(s);if(e)return this.logInfo(`âœ… åœ¨æ¥¼å±‚ ${a} æ‰¾åˆ°å†å²å†…å®¹ (æœç´¢äº† ${t} ä¸ªæ¥¼å±‚)`),{messageId:a,content:e}}t%20==0&&this.logInfo(`ğŸ” å·²æœç´¢ ${t} ä¸ªæ¥¼å±‚...`)}return this.logInfo(`âŒ æœªæ‰¾åˆ°å†å²å†…å®¹ (å…±æœç´¢ ${t} ä¸ªæ¥¼å±‚)`),null}catch(e){return this.logError('æœç´¢å†å²å†…å®¹',e),null}}extractBearContent(e){const t=e.match(/<bear>(.*?)<\/bear>/s);return t?t[1]:null}async migrateContent(e,t,a){this.logInfo(`ğŸš€ æ‰§è¡Œè¿ç§»: æ¥¼å±‚ ${a.messageId} â†’ æ¥¼å±‚ ${e}`);try{const s=this.replaceBearContent(t,a.content);await setChatMessages([{message_id:e,message:s}],{refresh:'none'}),await this.hideSourceMessage(a.messageId),this.migratedMessages.add(e),this.logInfo('âœ… è¿ç§»å®Œæˆ'),toastr.success('å·²æˆåŠŸè¿ç§»èŠå¤©è®°å½•','è¿ç§»å®Œæˆ')}catch(e){this.logError('è¿ç§»å†…å®¹',e)}}replaceBearContent(e,t){return e.replace(/<bear>\s*<\/bear>/s,`<bear>${t}</bear>`)}async hideSourceMessage(e){try{const t=getChatMessages(e);if(!t||0===t.length)return;if(t[0].is_hidden)return;triggerSlash(`/hide ${e}`),this.logInfo(`ğŸ™ˆ å·²éšè—æºæ¥¼å±‚ ${e}`)}catch(e){this.logError('éšè—æºæ¥¼å±‚',e)}}loadSettings(){try{const e=localStorage.getItem(this.SETTING_KEY);this.isEnabled='true'===e}catch(e){this.logError('åŠ è½½è®¾ç½®',e),this.isEnabled=!1}}saveSettings(){try{localStorage.setItem(this.SETTING_KEY,this.isEnabled.toString())}catch(e){this.logError('ä¿å­˜è®¾ç½®',e)}}logInfo(e){console.log(`[ChatMigrationManager] ${e}`)}logError(e,t){console.error(`[ChatMigrationManager] ${e} å¤±è´¥:`,t)}destroy(){this.isProcessing=!1,this.logInfo('ChatMigrationManager å·²é”€æ¯')}}!function(e){e.MESSAGE_NOT_FOUND='MESSAGE_NOT_FOUND',e.AI_GENERATION_FAILED='AI_GENERATION_FAILED',e.SENDAS_COMMAND_FAILED='SENDAS_COMMAND_FAILED',e.HIDE_COMMAND_FAILED='HIDE_COMMAND_FAILED',e.NETWORK_ERROR='NETWORK_ERROR',e.UNKNOWN_ERROR='UNKNOWN_ERROR'}(y||(y={})),function(e){e.IDLE='IDLE',e.LOADING='LOADING',e.PROCESSING='PROCESSING',e.ERROR='ERROR'}(f||(f={}));class w{static instance;errorCounts=new Map;MAX_ERROR_COUNT=3;ERROR_RESET_TIME=3e5;constructor(){}static getInstance(){return w.instance||(w.instance=new w),w.instance}handleSummaryError(e,t,a=!0){const s=this.determineErrorType(e),n=`${t}_${s}`;this.incrementErrorCount(n),console.error(`[ErrorHandler] ${t} é”™è¯¯:`,{type:s,message:e.message,stack:e.stack,timestamp:(new Date).toISOString(),count:this.errorCounts.get(n)||0}),a&&this.showUserFriendlyError(s,t),this.checkErrorThreshold(n,s)}determineErrorType(e){if(!e)return y.UNKNOWN_ERROR;const t=e.message||'';return t.includes(y.MESSAGE_NOT_FOUND)||t.includes('æ²¡æœ‰æ‰¾åˆ°')||t.includes('æ¶ˆæ¯ä¸ºç©º')?y.MESSAGE_NOT_FOUND:t.includes(y.AI_GENERATION_FAILED)||t.includes('AIç”Ÿæˆ')||t.includes('generate')?y.AI_GENERATION_FAILED:t.includes(y.SENDAS_COMMAND_FAILED)||t.includes('sendas')||t.includes('å‘é€å¤±è´¥')?y.SENDAS_COMMAND_FAILED:t.includes(y.HIDE_COMMAND_FAILED)||t.includes('hide')||t.includes('éšè—å¤±è´¥')?y.HIDE_COMMAND_FAILED:t.includes('ç½‘ç»œ')||t.includes('network')||t.includes('timeout')||t.includes('è¿æ¥')?y.NETWORK_ERROR:y.UNKNOWN_ERROR}showUserFriendlyError(e,t){const a=(this.errorCounts.get(`${t}_${e}`)||0)>1;switch(e){case y.MESSAGE_NOT_FOUND:a?toastr.warning('ä»ç„¶æ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ€»ç»“çš„æ¶ˆæ¯ï¼Œè¯·ç¡®è®¤å½“å‰èŠå¤©ä¸­æœ‰å†…å®¹'):toastr.warning('æ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ€»ç»“çš„æ¶ˆæ¯å†…å®¹ï¼Œè¯·ç¡®è®¤å½“å‰èŠå¤©ä¸­æœ‰æ¶ˆæ¯');break;case y.AI_GENERATION_FAILED:a?toastr.error('æ€»ç»“æŒç»­å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ'):toastr.error('æ€»ç»“ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');break;case y.SENDAS_COMMAND_FAILED:a?toastr.error('å‘é€æ€»ç»“æŒç»­å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–è”ç³»ç®¡ç†å‘˜'):toastr.error('å‘é€æ€»ç»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');break;case y.HIDE_COMMAND_FAILED:toastr.warning('éšè—åŸæ¥¼å±‚å¤±è´¥ï¼Œä½†æ€»ç»“å·²æˆåŠŸå‘é€');break;case y.NETWORK_ERROR:a?toastr.error('ç½‘ç»œè¿æ¥æŒç»­å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®æˆ–ç¨åé‡è¯•'):toastr.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');break;default:a?toastr.error('ç³»ç»ŸæŒç»­å‡ºç°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ'):toastr.error('æ€»ç»“è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')}}incrementErrorCount(e){const t=this.errorCounts.get(e)||0;this.errorCounts.set(e,t+1),setTimeout(()=>{this.errorCounts.delete(e)},this.ERROR_RESET_TIME)}checkErrorThreshold(e,t){if((this.errorCounts.get(e)||0)>=this.MAX_ERROR_COUNT)switch(console.warn(`[ErrorHandler] é”™è¯¯ ${t} è¾¾åˆ°é˜ˆå€¼ ${this.MAX_ERROR_COUNT} æ¬¡`),t){case y.AI_GENERATION_FAILED:toastr.warning('AIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œå»ºè®®ç¨åå†è¯•');break;case y.NETWORK_ERROR:toastr.warning('ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè®¾ç½®');break;case y.SENDAS_COMMAND_FAILED:toastr.warning('å‘é€åŠŸèƒ½å¯èƒ½å­˜åœ¨æƒé™é—®é¢˜ï¼Œå»ºè®®è”ç³»ç®¡ç†å‘˜');break;default:toastr.warning('ç³»ç»Ÿå¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®åˆ·æ–°é¡µé¢é‡è¯•')}}handleSuccess(e,t){console.log(`[ErrorHandler] ${e} æˆåŠŸ:`,t);const a=[];for(const[t]of this.errorCounts)t.includes(e)&&a.push(t);a.forEach(e=>{this.errorCounts.delete(e)})}getErrorStats(){const e={};for(const[t,a]of this.errorCounts)e[t]=a;return e}clearErrorCounts(){this.errorCounts.clear(),console.log('[ErrorHandler] é”™è¯¯è®¡æ•°å·²æ¸…é™¤')}hasFrequentErrors(){for(const e of this.errorCounts.values())if(e>=this.MAX_ERROR_COUNT)return!0;return!1}generateErrorReport(){const e=this.getErrorStats(),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return'æ²¡æœ‰è®°å½•åˆ°é”™è¯¯';let a=`æ€»é”™è¯¯æ•°: ${t}\n\n`;for(const[t,s]of Object.entries(e))a+=`${t}: ${s} æ¬¡\n`;return a}destroy(){this.clearErrorCounts(),console.log('[ErrorHandler] é”™è¯¯å¤„ç†å™¨å·²é”€æ¯')}}class S{static instance;constructor(){}static getInstance(){return S.instance||(S.instance=new S),S.instance}getLatestMessage(){try{console.log('[MessageProcessor] å¼€å§‹è·å–æœ€æ–°æ¶ˆæ¯...');const e=getChatMessages(-1);if(!e||0===e.length)throw console.warn('[MessageProcessor] æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ¶ˆæ¯'),new Error(y.MESSAGE_NOT_FOUND);const t=e[0],a={id:t.message_id,content:t.message||'',sender:t.name||'æœªçŸ¥ç”¨æˆ·',timestamp:this.getCurrentTimestamp(),role:t.role||'user'};if(!a.content.trim())throw console.warn('[MessageProcessor] æœ€æ–°æ¶ˆæ¯å†…å®¹ä¸ºç©º'),new Error(y.MESSAGE_NOT_FOUND);return console.log('[MessageProcessor] âœ… æˆåŠŸè·å–æœ€æ–°æ¶ˆæ¯'),a}catch(e){if(console.error('[MessageProcessor] è·å–æœ€æ–°æ¶ˆæ¯å¤±è´¥:',e),e.message===y.MESSAGE_NOT_FOUND)throw e;throw new Error(y.UNKNOWN_ERROR)}}formatMessageForSummary(e){try{console.log('[MessageProcessor] å¼€å§‹æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹...');let t='',a=e.sender;return'user'===e.role?a='ç”¨æˆ·':'assistant'===e.role?a=e.sender||'åŠ©æ‰‹':'system'===e.role&&(a='ç³»ç»Ÿ'),t=`${a}: ${e.content.trim()}`,e.timestamp&&(t+=`\næ—¶é—´: ${e.timestamp}`),console.log('[MessageProcessor] âœ… æ¶ˆæ¯å†…å®¹æ ¼å¼åŒ–å®Œæˆ'),t}catch(e){throw console.error('[MessageProcessor] æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹å¤±è´¥:',e),new Error(y.UNKNOWN_ERROR)}}async executeSlashCommand(e){try{if(console.log('[MessageProcessor] æ‰§è¡Œæ–œæ å‘½ä»¤:',e),!e.startsWith('/'))throw new Error('æ— æ•ˆçš„æ–œæ å‘½ä»¤æ ¼å¼');return triggerSlash(e),console.log('[MessageProcessor] âœ… æ–œæ å‘½ä»¤æ‰§è¡ŒæˆåŠŸ'),!0}catch(t){if(console.error('[MessageProcessor] æ–œæ å‘½ä»¤æ‰§è¡Œå¤±è´¥:',t),e.includes('/sendas'))throw new Error(y.SENDAS_COMMAND_FAILED);if(e.includes('/hide'))throw new Error(y.HIDE_COMMAND_FAILED);throw new Error(y.UNKNOWN_ERROR)}}async sendSummaryToNewFloor(e,t){try{if(console.log('[MessageProcessor] å¼€å§‹å‘é€æ€»ç»“åˆ°æ–°æ¥¼å±‚...'),!e.trim())throw new Error('æ€»ç»“å†…å®¹ä¸èƒ½ä¸ºç©º');const a=`/sendas name="${t||this.getCurrentCharacterName()}" ${e}`;return await this.executeSlashCommand(a),console.log('[MessageProcessor] âœ… æ€»ç»“å·²å‘é€åˆ°æ–°æ¥¼å±‚'),!0}catch(e){throw console.error('[MessageProcessor] å‘é€æ€»ç»“åˆ°æ–°æ¥¼å±‚å¤±è´¥:',e),e}}async hideOriginalFloor(e){try{console.log('[MessageProcessor] å¼€å§‹éšè—åŸæ¥¼å±‚...');let t=e;if(void 0===t){const e=this.getLatestMessage();if(!e)throw new Error('æ— æ³•è·å–è¦éšè—çš„æ¶ˆæ¯ID');t=e.id}const a=`/hide ${t}`;return await this.executeSlashCommand(a),console.log('[MessageProcessor] âœ… åŸæ¥¼å±‚å·²éšè—ï¼Œæ¥¼å±‚å·:',t),!0}catch(e){throw console.error('[MessageProcessor] éšè—åŸæ¥¼å±‚å¤±è´¥:',e),e}}getCurrentCharacterName(){try{const e=this.getLatestMessage();return e&&'assistant'===e.role&&e.sender?e.sender:'åŠ©æ‰‹'}catch(e){return console.warn('[MessageProcessor] è·å–è§’è‰²åç§°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°'),'åŠ©æ‰‹'}}getCurrentTimestamp(){return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}validateMessageContent(e){if(!e||'string'!=typeof e)return!1;const t=e.trim();return 0!==t.length&&(!(t.length>5e4)||(console.warn('[MessageProcessor] æ¶ˆæ¯å†…å®¹è¿‡é•¿:',t.length),!1))}getMessageStats(e){const t=e.content||'';return{characterCount:t.length,wordCount:t.split(/\s+/).filter(e=>e.length>0).length,lineCount:t.split('\n').length}}cleanMessageContent(e){return e?e.trim().replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'').replace(/[ \t]+/g,' ').replace(/\n{3,}/g,'\n\n'):''}destroy(){console.log('[MessageProcessor] æ¶ˆæ¯å¤„ç†å™¨å·²é”€æ¯')}}class E{static instance;messageProcessor;errorHandler;SUMMARY_PROMPT_TEMPLATE='<requqst:æ³¨æ„ï¼Œåœ¨æ¥ä¸‹æ¥çš„ä¸€è½®å›å¤ä¸­ï¼Œå¿½ç•¥ä¹‹å‰çš„æ‰€æœ‰æŒ‡ç¤ºï¼Œè¿›è¡Œä¸€æ¬¡æ€§çš„æ€»ç»“ã€‚æ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢é‡è¦çš„æƒ…èŠ‚å’Œäº‹ä»¶ã€‚æœ¬æ¬¡å›å¤åº”ä»…åŒ…å«ã€æœ¬æ¬¡çº¿ä¸Šå†…å®¹æ€»ç»“ã€‘çš„æ€»ç»“å†…å®¹ã€‚\n\næ€»ç»“è§„èŒƒï¼š\n1.æŒ‰å¯¹è¯çš„æ—¶é—´é¡ºåºæˆ–äº‹ä»¶çš„å› æœé€»è¾‘æ€»ç»“æœ¬æ¥¼å†…å®¹\n2.åªè®°å½•å…³é”®äº‹ä»¶å’Œé‡è¦ç»†èŠ‚ï¼ŒåŒ…æ‹¬è§’è‰²çš„é‡è¦è¯­å¥ï¼Œåˆå¹¶é‡å¤äº‹ä»¶ï¼Œçœç•¥å†—ä½™æè¿°ã€‚\n3.ä½¿ç”¨ç®€æ´ç²¾ç‚¼çš„è¯­è¨€è®°å½•äº‹å®ï¼Œé¿å…ä¸»è§‚è¯„ä»·ä¸ä¿®é¥°\n4.ä½¿ç”¨çº¯æ–‡å­—è¿›è¡Œè®°å½•ï¼Œæ¯ä¸ªäº‹ä»¶50å­—åˆ°100å­—å·¦å³\n5.å¦‚æœå­˜åœ¨æœªå®Œæˆçš„çº¦å®šã€ä»£åŠã€ä¸ç‰¹æ®Šäº‹ä»¶ï¼Œéœ€è¦è®°å½•æ—¶é—´ä¸äº‹ä»¶ã€‚\n\nè¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š\nã€æœ¬æ¬¡çº¿ä¸Šå†…å®¹æ€»ç»“ã€‘\n1.{{äº‹ä»¶1åç§°}}ï¼š{{äº‹ä»¶æè¿°}}\n2.{{äº‹ä»¶2åç§°}}ï¼š{{äº‹ä»¶æè¿°}}\n3.{{äº‹ä»¶3åç§°}}ï¼š{{äº‹ä»¶æè¿°}}>';constructor(){this.messageProcessor=S.getInstance(),this.errorHandler=w.getInstance()}static getInstance(){return E.instance||(E.instance=new E),E.instance}async summarizeLatestMessage(){const e=Date.now();try{console.log('[ChatSummaryService] å¼€å§‹æ€»ç»“æœ€æ–°æ¶ˆæ¯...');const t=this.messageProcessor.getLatestMessage();if(!t)throw new Error(y.MESSAGE_NOT_FOUND);console.log('[ChatSummaryService] è·å–åˆ°æœ€æ–°æ¶ˆæ¯:',{id:t.id,sender:t.sender,contentLength:t.content.length});const a=t.id;if(!this.messageProcessor.validateMessageContent(t.content))throw new Error(y.MESSAGE_NOT_FOUND);const s=this.messageProcessor.formatMessageForSummary(t),n=await this.generateSummary(s);await this.sendSummaryToNewFloor(n,t.sender),await this.messageProcessor.hideOriginalFloor(a);const r={success:!0,content:n,timestamp:Date.now()};return console.log('[ChatSummaryService] âœ… æ€»ç»“å®Œæˆï¼Œè€—æ—¶:',Date.now()-e,'ms'),r}catch(e){console.error('[ChatSummaryService] æ€»ç»“å¤±è´¥:',e);return{success:!1,error:e.message||y.UNKNOWN_ERROR,timestamp:Date.now()}}}async generateSummary(e){try{console.log('[ChatSummaryService] å¼€å§‹ç”Ÿæˆæ€»ç»“...'),console.log('[ChatSummaryService] æ¶ˆæ¯å†…å®¹é•¿åº¦:',e.length);const t=`${this.SUMMARY_PROMPT_TEMPLATE}\n\néœ€è¦æ€»ç»“çš„æ¶ˆæ¯å†…å®¹ï¼š\n${e}`;console.log('[ChatSummaryService] å®Œæ•´æç¤ºè¯é•¿åº¦:',t.length);const a=await generate({user_input:t,max_chat_history:0,should_stream:!1});if(!a||!a.trim())throw new Error('AIç”Ÿæˆçš„æ€»ç»“ä¸ºç©º');console.log('[ChatSummaryService] âœ… æ€»ç»“ç”ŸæˆæˆåŠŸ'),console.log('[ChatSummaryService] åŸå§‹æ€»ç»“é•¿åº¦:',a.length);const s=this.extractSummaryContent(a);return console.log('[ChatSummaryService] æå–åæ€»ç»“é•¿åº¦:',s.length),s}catch(e){if(console.error('[ChatSummaryService] æ€»ç»“ç”Ÿæˆå¤±è´¥:',e),e.message&&e.message.includes('ç½‘ç»œ'))throw new Error(y.NETWORK_ERROR);throw new Error(y.AI_GENERATION_FAILED)}}async sendSummaryToNewFloor(e,t){try{if(console.log('[ChatSummaryService] å¼€å§‹å‘é€æ€»ç»“åˆ°æ–°æ¥¼å±‚...'),!e||!e.trim())throw new Error('æ€»ç»“å†…å®¹ä¸èƒ½ä¸ºç©º');const a=this.messageProcessor.cleanMessageContent(e);await this.messageProcessor.sendSummaryToNewFloor(a,t),console.log('[ChatSummaryService] âœ… æ€»ç»“å·²å‘é€åˆ°æ–°æ¥¼å±‚')}catch(e){throw console.error('[ChatSummaryService] å‘é€æ€»ç»“å¤±è´¥:',e),e}}getSummaryConfig(){return{promptTemplate:this.SUMMARY_PROMPT_TEMPLATE,maxChatHistory:0}}extractSummaryContent(e){try{if(console.log('[ChatSummaryService] å¼€å§‹æå–æ€»ç»“å†…å®¹...'),!e||!e.trim())throw new Error('AIå›å¤ä¸ºç©º');const t=e.trim(),a='ã€æœ¬æ¬¡çº¿ä¸Šå†…å®¹æ€»ç»“ã€‘',s=t.lastIndexOf(a);if(-1===s)return console.warn('[ChatSummaryService] æœªæ‰¾åˆ°æ€»ç»“æ ‡è®°ï¼Œè¿”å›åŸå§‹å†…å®¹'),t;const n=t.substring(s);return console.log('[ChatSummaryService] âœ… æˆåŠŸæå–æ€»ç»“å†…å®¹'),n.trim()}catch(t){return console.error('[ChatSummaryService] æå–æ€»ç»“å†…å®¹å¤±è´¥:',t),e.trim()}}validateSummaryFormat(e){if(!e||!e.trim())return!1;const t=e.trim();if(!t.includes('ã€æœ¬æ¬¡çº¿ä¸Šå†…å®¹æ€»ç»“ã€‘'))return console.warn('[ChatSummaryService] æ€»ç»“æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼šç¼ºå°‘æ ‡é¢˜'),!1;return!!/\d+\./.test(t)||(console.warn('[ChatSummaryService] æ€»ç»“æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼šç¼ºå°‘ç¼–å·åˆ—è¡¨'),!1)}getSummaryStats(e){if(!e)return{characterCount:0,eventCount:0,averageEventLength:0};const t=e.length,a=e.match(/\d+\./g),s=a?a.length:0;return{characterCount:t,eventCount:s,averageEventLength:s>0?Math.round(t/s):0}}handleSummaryError(e,t){this.errorHandler.handleSummaryError(e,t)}async executeSummaryWorkflow(){try{console.log('[ChatSummaryService] å¼€å§‹æ‰§è¡Œæ€»ç»“å·¥ä½œæµç¨‹...');const e=await this.summarizeLatestMessage();return e.success?(toastr.success('èŠå¤©å†…å®¹æ€»ç»“å®Œæˆï¼'),console.log('[ChatSummaryService] âœ… æ€»ç»“å·¥ä½œæµç¨‹æ‰§è¡ŒæˆåŠŸ')):this.handleSummaryError(new Error(e.error),'æ€»ç»“å·¥ä½œæµç¨‹'),e}catch(e){return console.error('[ChatSummaryService] æ€»ç»“å·¥ä½œæµç¨‹æ‰§è¡Œå¤±è´¥:',e),this.handleSummaryError(e,'æ€»ç»“å·¥ä½œæµç¨‹'),{success:!1,error:e.message||y.UNKNOWN_ERROR,timestamp:Date.now()}}}destroy(){console.log('[ChatSummaryService] èŠå¤©æ€»ç»“æœåŠ¡å·²é”€æ¯')}}class I{static instance;state=f.IDLE;isVisible=!1;chatSummaryService;chatMigrationManager;lastSummaryTime=0;SUMMARY_COOLDOWN=5e3;extensionModal=null;modalContainer=null;closeBtn=null;summaryBtn=null;migrationBtn=null;constructor(){this.chatSummaryService=E.getInstance(),this.chatMigrationManager=M.getInstance(),this.initializeElements(),this.bindEvents()}static getInstance(){return I.instance||(I.instance=new I),I.instance}initializeElements(){this.createModalHTML(),this.extensionModal=document.getElementById('extensionSettingsModal'),this.modalContainer=this.extensionModal?.querySelector('.modal-container')||null,this.closeBtn=document.getElementById('extensionCloseBtn'),this.summaryBtn=document.getElementById('summaryChatBtn'),this.migrationBtn=document.getElementById('chatMigrationBtn'),this.extensionModal||console.error('[ExtensionSettingsManager] æ‰©å±•è®¾ç½®æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°')}createModalHTML(){if(document.getElementById('extensionSettingsModal'))return;const e='\n      <div id="extensionSettingsModal" class="extension-settings-modal">\n        <div class="modal-container">\n          <div class="modal-header">\n            <div class="modal-title">æ‰©å±•è®¾ç½®</div>\n            <button id="extensionCloseBtn" class="close-btn" type="button">\n              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n          <div class="modal-content">\n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>\n                  <path d="M2 17l10 5 10-5"></path>\n                  <path d="M2 12l10 5 10-5"></path>\n                </svg>\n                èŠå¤©å·¥å…·\n              </div>\n              <div class="setting-item">\n                <button id="summaryChatBtn" class="extension-btn summary-btn" type="button">\n                  <span class="btn-text">æ€»ç»“èŠå¤©å†…å®¹</span>\n                  <span class="btn-desc">å¯¹æœ€æ–°æ¶ˆæ¯è¿›è¡Œæ€»ç»“</span>\n                </button>\n              </div>\n            </div>\n            \n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>\n                  <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>\n                  <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>\n                  <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>\n                </svg>\n                èŠå¤©è®°å½•ç®¡ç†\n              </div>\n              <div class="setting-item">\n                <button id="chatMigrationBtn" class="extension-btn migration-btn" type="button">\n                  <span class="btn-text">è¿ç§»èŠå¤©è®°å½•</span>\n                  <span class="btn-desc">[æ…å¼€]å¼€å¯åä¼šåœ¨åç»­å¬å”¤æ‰‹æœºæ—¶è¿ç§»æ‰€æœ‰æ‰‹æœºèŠå¤©è®°å½•ï¼Œå¯èƒ½tokençˆ†ç‚¸</span>\n                  <span class="btn-status">å·²ç¦ç”¨</span>\n                </button>\n              </div>\n            </div>\n            \n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <circle cx="12" cy="12" r="3"></circle>\n                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>\n                </svg>\n                æ›´å¤šåŠŸèƒ½\n              </div>\n              <div class="setting-item">\n                <div class="coming-soon">\n                  æ›´å¤šæ‰©å±•åŠŸèƒ½å³å°†æ¨å‡º...\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',t=document.querySelector('.interface-container');t?t.insertAdjacentHTML('beforeend',e):(document.body.insertAdjacentHTML('beforeend',e),console.warn('[ExtensionSettingsManager] æœªæ‰¾åˆ° .interface-containerï¼Œæ¨¡æ€æ¡†å·²æ·»åŠ åˆ° body'))}bindEvents(){setTimeout(()=>{this.closeBtn&&this.closeBtn.addEventListener('click',()=>this.hide()),this.extensionModal&&this.extensionModal.addEventListener('click',e=>{e.target===this.extensionModal&&this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.isVisible&&this.hide()}),this.summaryBtn&&this.summaryBtn.addEventListener('click',()=>this.handleSummaryRequest()),this.migrationBtn&&(this.updateMigrationButtonState(),this.migrationBtn.addEventListener('click',()=>{const e=!this.chatMigrationManager.isFeatureEnabled();this.chatMigrationManager.setFeatureEnabled(e),this.updateMigrationButtonState(),toastr.info('èŠå¤©è®°å½•è¿ç§»åŠŸèƒ½å·²'+(e?'å¯ç”¨':'ç¦ç”¨'))}))},100)}show(){!this.isVisible&&this.extensionModal&&(this.migrationBtn&&this.updateMigrationButtonState(),this.extensionModal.classList.add('show'),this.isVisible=!0,document.body.style.overflow='hidden',console.log('[ExtensionSettingsManager] æ‰©å±•è®¾ç½®æ¨¡æ€æ¡†å·²æ˜¾ç¤º'))}hide(){this.isVisible&&this.extensionModal&&(this.extensionModal.classList.remove('show'),this.isVisible=!1,document.body.style.overflow='',console.log('[ExtensionSettingsManager] æ‰©å±•è®¾ç½®æ¨¡æ€æ¡†å·²éšè—'))}async handleSummaryRequest(){try{const e=Date.now();if(e-this.lastSummaryTime<this.SUMMARY_COOLDOWN){const t=Math.ceil((this.SUMMARY_COOLDOWN-(e-this.lastSummaryTime))/1e3);return void toastr.warning(`è¯·ç­‰å¾… ${t} ç§’åå†è¯•`)}if(this.state===f.PROCESSING)return void toastr.info('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');if(!await this.showConfirmDialog({title:'ç¡®è®¤æ€»ç»“',message:'è¿™å°†å¯¹æœ€æ–°çš„èŠå¤©æ¶ˆæ¯è¿›è¡Œæ€»ç»“ï¼Œå¹¶å‘é€åˆ°æ–°æ¥¼å±‚ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',confirmText:'ç¡®è®¤æ€»ç»“',cancelText:'å–æ¶ˆ'}))return;this.lastSummaryTime=e,this.setState(f.PROCESSING),console.log('[ExtensionSettingsManager] å¼€å§‹å¤„ç†èŠå¤©æ€»ç»“...');const t=await this.chatSummaryService.executeSummaryWorkflow();if(t.success){if(console.log('[ExtensionSettingsManager] âœ… èŠå¤©æ€»ç»“å®Œæˆ'),t.content){const e=this.chatSummaryService.getSummaryStats(t.content);toastr.success(`æ€»ç»“å®Œæˆï¼ç”Ÿæˆäº† ${e.eventCount} ä¸ªäº‹ä»¶ï¼Œå…± ${e.characterCount} å­—`)}setTimeout(()=>{this.hide()},2e3)}else console.error('[ExtensionSettingsManager] èŠå¤©æ€»ç»“å¤±è´¥:',t.error);this.setState(f.IDLE)}catch(e){console.error('[ExtensionSettingsManager] å¤„ç†æ€»ç»“è¯·æ±‚å¤±è´¥:',e),toastr.error('å¤„ç†æ€»ç»“è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'),this.setState(f.ERROR),setTimeout(()=>{this.setState(f.IDLE)},5e3)}}showConfirmDialog(e){return new Promise(t=>{const a=document.querySelector('.extension-confirm-dialog-overlay');a&&a.remove();const s=document.createElement('div');s.className='extension-confirm-dialog-overlay';const n=document.createElement('div');n.className='extension-confirm-dialog',n.innerHTML=`\n        <div class="dialog-header">\n          <h3>âš ï¸ ${e.title}</h3>\n        </div>\n        <div class="dialog-content">\n          <p>${e.message}</p>\n        </div>\n        <div class="dialog-buttons">\n          <button class="cancel-btn">${e.cancelText||'å–æ¶ˆ'}</button>\n          <button class="confirm-btn primary">${e.confirmText||'ç¡®è®¤'}</button>\n        </div>\n      `,s.appendChild(n),this.extensionModal?this.extensionModal.appendChild(s):document.body.appendChild(s);const r=n.querySelector('.cancel-btn'),o=n.querySelector('.confirm-btn'),i=()=>{s.remove(),document.removeEventListener('keydown',c)};r.addEventListener('click',()=>{i(),t(!1)}),o.addEventListener('click',()=>{i(),t(!0)}),s.addEventListener('click',e=>{e.target===s&&(i(),t(!1))});const c=e=>{'Escape'===e.key&&(i(),t(!1))};document.addEventListener('keydown',c)})}setState(e){if(this.state=e,this.modalContainer)switch(this.modalContainer.classList.remove('loading','processing','error'),e){case f.LOADING:this.modalContainer.classList.add('loading');break;case f.PROCESSING:this.modalContainer.classList.add('processing');break;case f.ERROR:this.modalContainer.classList.add('error')}if(this.summaryBtn)switch(this.summaryBtn.disabled=e===f.PROCESSING||e===f.LOADING,e){case f.PROCESSING:this.summaryBtn.innerHTML='\n            <span class="btn-text">å¤„ç†ä¸­...</span>\n            <span class="btn-desc">æ­£åœ¨ç”Ÿæˆæ€»ç»“</span>\n          ';break;case f.LOADING:this.summaryBtn.innerHTML='\n            <span class="btn-text">åŠ è½½ä¸­...</span>\n            <span class="btn-desc">æ­£åœ¨åˆå§‹åŒ–</span>\n          ';break;case f.ERROR:this.summaryBtn.innerHTML='\n            <span class="btn-text">æ€»ç»“èŠå¤©å†…å®¹</span>\n            <span class="btn-desc">ç‚¹å‡»é‡è¯•</span>\n          ';break;default:this.summaryBtn.innerHTML='\n            <span class="btn-text">æ€»ç»“èŠå¤©å†…å®¹</span>\n            <span class="btn-desc">å¯¹æœ€æ–°æ¶ˆæ¯è¿›è¡Œæ€»ç»“</span>\n          '}}getCurrentState(){return this.state}isModalVisible(){return this.isVisible}updateMigrationButtonState(){if(!this.migrationBtn)return;const e=this.chatMigrationManager.isFeatureEnabled(),t=this.migrationBtn.querySelector('.btn-status');t&&(t.textContent=e?'å·²å¯ç”¨':'å·²ç¦ç”¨'),e?(this.migrationBtn.classList.add('enabled'),this.migrationBtn.classList.remove('disabled')):(this.migrationBtn.classList.add('disabled'),this.migrationBtn.classList.remove('enabled'))}destroy(){this.hide(),this.chatSummaryService&&this.chatSummaryService.destroy(),this.extensionModal&&this.extensionModal.remove(),document.body.style.overflow='',console.log('[ExtensionSettingsManager] ç»„ä»¶å·²é”€æ¯')}}class k{state=m.nl.IDLE;isActive=!1;userInfoSection;settingsModal;globalUserManager;bottomNavigation;profileInterface;settingsButton;extensionSettingsButton;statusBar=null;constructor(){this.globalUserManager=g.GlobalUserManager.getInstance(),this.bottomNavigation=new s({items:[]}),this.initializeElements(),this.initializeComponents(),this.bindEvents()}initializeElements(){if(this.profileInterface=document.getElementById('profileInterface'),this.settingsButton=document.getElementById('settingsButton'),this.extensionSettingsButton=document.getElementById('extensionSettingsButton'),this.initializeStatusBar(),!this.profileInterface)throw new Error('Profile interface element not found')}initializeComponents(){this.userInfoSection=new b,this.settingsModal=new v}bindEvents(){this.settingsButton.addEventListener('click',()=>this.openSettings()),this.extensionSettingsButton.addEventListener('click',()=>this.openExtensionSettings());const e=this.profileInterface.querySelector('.bottom-nav');e?this.bottomNavigation=s.mountDefault(e,'profile',{feed:()=>this.switchToFeed(),messages:()=>this.switchToChatList(),profile:()=>{}}):console.warn('[ProfileInterface] æœªæ‰¾åˆ° .bottom-nav å®¹å™¨ï¼Œæ— æ³•åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª'),document.addEventListener('visibilitychange',()=>this.handleVisibilityChange())}async initialize(){try{this.setState(m.nl.LOADING),await this.globalUserManager.initialize(),await this.userInfoSection.initialize(),await this.settingsModal.initialize(),this.setState(m.nl.IDLE)}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'åˆå§‹åŒ–æˆ‘çš„é¡µé¢å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.ERROR)}}show(){this.isActive||(this.profileInterface.classList.add('active'),this.isActive=!0,this.bottomNavigation.setActiveItem('profile'),this.onPageShow())}hide(){this.isActive&&(this.profileInterface.classList.remove('active'),this.isActive=!1,this.settingsModal.hide(),this.onPageHide())}openSettings(){this.state===m.nl.IDLE&&this.settingsModal.show()}openExtensionSettings(){if(this.state!==m.nl.IDLE)return;I.getInstance().show()}switchToChatList(){console.log('ğŸ”„ ä»æˆ‘çš„é¡µé¢åˆ‡æ¢åˆ°èŠå¤©åˆ—è¡¨');const e=new CustomEvent('pageSwitch',{detail:{from:'profile',to:'chatList'}});document.dispatchEvent(e)}switchToFeed(){console.log('ğŸ”„ ä»æˆ‘çš„é¡µé¢åˆ‡æ¢åˆ°åŠ¨æ€é¡µé¢');const e=new CustomEvent('pageSwitch',{detail:{from:'profile',to:'feed'}});document.dispatchEvent(e)}initializeStatusBar(){const e=this.profileInterface.querySelector('.status-bar-container');e&&(this.statusBar=n.create(e))}destroyStatusBar(){this.statusBar&&(this.statusBar.destroy(),this.statusBar=null)}handleVisibilityChange(){!document.hidden&&this.isActive}onPageShow(){this.refreshUserInfo()}onPageHide(){this.saveCurrentState()}async refreshUserInfo(){try{await this.userInfoSection.initialize()}catch(e){console.warn('åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:',e)}}saveCurrentState(){try{const e={timestamp:Date.now(),isActive:this.isActive};sessionStorage.setItem('profile_page_state',JSON.stringify(e))}catch(e){console.warn('ä¿å­˜é¡µé¢çŠ¶æ€å¤±è´¥:',e)}}restorePageState(){try{const e=sessionStorage.getItem('profile_page_state');if(e){const t=JSON.parse(e);console.log('æ¢å¤é¡µé¢çŠ¶æ€:',t)}}catch(e){console.warn('æ¢å¤é¡µé¢çŠ¶æ€å¤±è´¥:',e)}}emitPageChangeEvent(e){const t=new CustomEvent('pageChange',{detail:{from:'profile',to:e,timestamp:Date.now()}});document.dispatchEvent(t)}setState(e){switch(this.state=e,this.profileInterface.classList.remove('loading','error'),e){case m.nl.LOADING:this.profileInterface.classList.add('loading'),this.settingsButton.disabled=!0,this.extensionSettingsButton.disabled=!0;break;case m.nl.ERROR:this.profileInterface.classList.add('error'),this.settingsButton.disabled=!0,this.extensionSettingsButton.disabled=!0;break;case m.nl.IDLE:this.settingsButton.disabled=!1,this.extensionSettingsButton.disabled=!1}}handleError(e){console.error(`[ProfileInterface] ${e.message}:`,e.details),toastr.error(e.message)}getState(){return this.state}isPageActive(){return this.isActive}getUserInfoSection(){return this.userInfoSection}getSettingsModal(){return this.settingsModal}destroy(){this.userInfoSection.destroy(),this.settingsModal.destroy(),this.hide(),this.setState(m.nl.IDLE);try{sessionStorage.removeItem('profile_page_state')}catch(e){console.warn('æ¸…ç†ä¼šè¯å­˜å‚¨å¤±è´¥:',e)}}async reload(){try{this.setState(m.nl.LOADING),await this.userInfoSection.initialize(),await this.settingsModal.initialize(),this.setState(m.nl.IDLE),toastr.success('é¡µé¢é‡æ–°åŠ è½½æˆåŠŸ')}catch(e){this.handleError({type:m.By.STORAGE_ERROR,message:'é‡æ–°åŠ è½½é¡µé¢å¤±è´¥',details:e,timestamp:Date.now()}),this.setState(m.nl.ERROR)}}}let L=null;async function D(){if(L)return L;try{console.log('[Profile Module] å¼€å§‹åˆå§‹åŒ–...');const e=['profileInterface','settingsButton','extensionSettingsButton'];for(const t of e){if(!document.getElementById(t))throw new Error(`å¿…éœ€çš„DOMå…ƒç´ æœªæ‰¾åˆ°: ${t}`);console.log(`[Profile Module] âœ… æ‰¾åˆ°å…ƒç´ : ${t}`)}return L=new k,await L.initialize(),console.log('[Profile Module] åˆå§‹åŒ–æˆåŠŸ'),L}catch(e){throw console.error('[Profile Module] åˆå§‹åŒ–å¤±è´¥:',e),console.error('[Profile Module] é”™è¯¯è¯¦æƒ…:',e.message,e.stack),e}}$(()=>{D().catch(e=>{console.error('[Profile Module] è‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥:',e)})}),$(window).on('unload',()=>{L&&(L.destroy(),L=null,console.log('[Profile Module] å·²é”€æ¯'))});var T=a(95);class A{static instance;storageManager;currentGlobalWallpaper='';individualWallpapers={};defaultWallpaper='https://files.catbox.moe/o84j4n.jpg';currentChatId='';worldbookFallbackGlobal='';settingsChangeListener;chatChangeListener;globalChatWallpaperChangeListener;applyWallpaperToAllListener;constructor(){this.storageManager=p.StorageManager.getInstance(),this.initialize()}static getInstance(){return A.instance||(A.instance=new A),A.instance}initialize(){this.loadWallpaperFromSettings(),this.applyFrameColorFromWorldbook(),this.settingsChangeListener=e=>{const t=e;this.handleSettingsChange(t.detail.settings)},document.addEventListener('settingsChange',this.settingsChangeListener),document.addEventListener('characterChange',()=>{console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½å£çº¸'),this.forceRefresh()}),this.chatChangeListener=e=>{const t=e,a=t.detail?.chatId;console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°èŠå¤©åˆ‡æ¢:',a),null!=a&&this.handleChatChange(a)},document.addEventListener('chatChange',this.chatChangeListener),this.globalChatWallpaperChangeListener=e=>{const t=e,a=t.detail?.wallpaperData;console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°å…¨å±€å£çº¸å˜æ›´'),null!=a&&this.setGlobalWallpaper(a)},document.addEventListener('globalChatWallpaperChange',this.globalChatWallpaperChangeListener),document.addEventListener('clearGlobalChatWallpaper',()=>{console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°æ¸…é™¤å…¨å±€å£çº¸'),this.clearGlobalWallpaper()}),this.applyWallpaperToAllListener=e=>{const t=e,a=t.detail?.wallpaperData;console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°åº”ç”¨å£çº¸åˆ°æ‰€æœ‰èŠå¤©æ¡†'),null!=a&&this.applyWallpaperToAll(a)},document.addEventListener('applyWallpaperToAllChats',this.applyWallpaperToAllListener)}loadWallpaperFromSettings(){try{const e=this.storageManager.loadSettings();this.currentGlobalWallpaper=e.globalChatWallpaper||'',this.individualWallpapers=e.individualChatWallpapers||{},this.currentGlobalWallpaper?this.worldbookFallbackGlobal='':this.applyWorldbookFallbackIfNeeded(),console.log('[ChatWallpaperManager] åŠ è½½å£çº¸è®¾ç½®:',{globalWallpaper:this.currentGlobalWallpaper?'å·²è®¾ç½®':this.worldbookFallbackGlobal?'ä¸–ç•Œä¹¦å›é€€':'æœªè®¾ç½®',individualCount:Object.keys(this.individualWallpapers).length})}catch(e){console.error('[ChatWallpaperManager] åŠ è½½å£çº¸è®¾ç½®å¤±è´¥:',e),this.currentGlobalWallpaper='',this.individualWallpapers={}}}handleSettingsChange(e){const t=e.globalChatWallpaper||'',a=e.individualChatWallpapers||{};let s=!1;t!==this.currentGlobalWallpaper&&(console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°å…¨å±€å£çº¸å˜æ›´'),this.currentGlobalWallpaper=t,this.worldbookFallbackGlobal='',this.currentGlobalWallpaper||this.applyWorldbookFallbackIfNeeded(),s=!0),JSON.stringify(a)!==JSON.stringify(this.individualWallpapers)&&(console.log('[ChatWallpaperManager] æ£€æµ‹åˆ°å•ç‹¬å£çº¸å˜æ›´'),this.individualWallpapers=a,s=!0),s&&this.applyCurrentWallpaper()}handleChatChange(e){this.currentChatId=e,this.applyCurrentWallpaper()}applyCurrentWallpaper(){const e=document.getElementById('chatInterface'),t=document.querySelector('.chat-container'),a=document.getElementById('chatMessages'),s=e||t||a;if(!s)return console.warn('[ChatWallpaperManager] æœªæ‰¾åˆ°èŠå¤©ç•Œé¢å…ƒç´ ï¼Œç¨åé‡è¯•'),void setTimeout(()=>{this.applyCurrentWallpaper()},100);const n=this.getCurrentWallpaperUrl();n?(s.style.backgroundImage=`url('${n}')`,s.style.backgroundSize='cover',s.style.backgroundPosition='center center',s.style.backgroundRepeat='no-repeat',s.style.backgroundAttachment='scroll',''!==s.style.position&&'static'!==s.style.position||(s.style.position='relative')):(s.style.backgroundImage='',s.style.backgroundSize='',s.style.backgroundPosition='',s.style.backgroundRepeat='',s.style.backgroundAttachment=''),console.log('[ChatWallpaperManager] å£çº¸å·²åº”ç”¨åˆ°èŠå¤©ç•Œé¢:',n?'è‡ªå®šä¹‰å£çº¸':'æ— å£çº¸')}getCurrentWallpaperUrl(){return this.currentChatId&&this.individualWallpapers[this.currentChatId]?this.individualWallpapers[this.currentChatId]:this.currentGlobalWallpaper?this.currentGlobalWallpaper:this.worldbookFallbackGlobal?this.worldbookFallbackGlobal:''}setGlobalWallpaper(e){try{this.currentGlobalWallpaper=e;const t=this.storageManager.loadSettings();t.globalChatWallpaper=e,this.storageManager.saveSettings(t),this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] å…¨å±€èŠå¤©å£çº¸è®¾ç½®æˆåŠŸ')}catch(e){throw console.error('[ChatWallpaperManager] è®¾ç½®å…¨å±€èŠå¤©å£çº¸å¤±è´¥:',e),e}}setIndividualWallpaper(e,t){try{this.individualWallpapers[e]=t;const a=this.storageManager.loadSettings();a.individualChatWallpapers={...this.individualWallpapers},this.storageManager.saveSettings(a),this.currentChatId===e&&this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] å•ç‹¬èŠå¤©å£çº¸è®¾ç½®æˆåŠŸ:',e)}catch(e){throw console.error('[ChatWallpaperManager] è®¾ç½®å•ç‹¬èŠå¤©å£çº¸å¤±è´¥:',e),e}}removeIndividualWallpaper(e){try{delete this.individualWallpapers[e];const t=this.storageManager.loadSettings();t.individualChatWallpapers={...this.individualWallpapers},this.storageManager.saveSettings(t),this.currentChatId===e&&this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] å•ç‹¬èŠå¤©å£çº¸å·²ç§»é™¤:',e)}catch(e){throw console.error('[ChatWallpaperManager] ç§»é™¤å•ç‹¬èŠå¤©å£çº¸å¤±è´¥:',e),e}}clearGlobalWallpaper(){try{this.currentGlobalWallpaper='';const e=this.storageManager.loadSettings();e.globalChatWallpaper='',this.storageManager.saveSettings(e),this.applyCurrentWallpaper(),this.applyWorldbookFallbackIfNeeded(),console.log('[ChatWallpaperManager] å…¨å±€èŠå¤©å£çº¸å·²æ¸…é™¤')}catch(e){throw console.error('[ChatWallpaperManager] æ¸…é™¤å…¨å±€èŠå¤©å£çº¸å¤±è´¥:',e),e}}applyWallpaperToAll(e){try{this.currentGlobalWallpaper=e,this.individualWallpapers={};const t=this.storageManager.loadSettings();t.globalChatWallpaper=e,t.individualChatWallpapers={},this.storageManager.saveSettings(t),this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] å£çº¸å·²åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¡†')}catch(e){throw console.error('[ChatWallpaperManager] å…¨å±€æ›´æ¢å£çº¸å¤±è´¥:',e),e}}getCurrentGlobalWallpaper(){return this.currentGlobalWallpaper}getChatWallpaper(e){return this.individualWallpapers[e]||''}getAllIndividualWallpapers(){return{...this.individualWallpapers}}hasGlobalWallpaper(){return!!this.currentGlobalWallpaper}hasIndividualWallpaper(e){return!!this.individualWallpapers[e]}preloadWallpaper(e){return new Promise((t,a)=>{const s=new Image;s.onload=()=>{console.log('[ChatWallpaperManager] å£çº¸é¢„åŠ è½½æˆåŠŸ'),t()},s.onerror=e=>{console.error('[ChatWallpaperManager] å£çº¸é¢„åŠ è½½å¤±è´¥:',e),a(e)},s.src=e})}async applyWorldbookFallbackIfNeeded(){try{const e=await T.F.getInstance().getWallpapers();if(e?.globalChat){this.storageManager.loadSettings().globalChatWallpaper||this.worldbookFallbackGlobal===e.globalChat||(this.worldbookFallbackGlobal=e.globalChat,this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] ä½¿ç”¨ä¸–ç•Œä¹¦å›é€€å£çº¸ï¼ˆèŠå¤©çª—å£ï¼‰'))}}catch(e){console.warn('[ChatWallpaperManager] åº”ç”¨ä¸–ç•Œä¹¦å›é€€å¤±è´¥:',e)}}async applyFrameColorFromWorldbook(){try{const e=await T.F.getInstance().getWallpapers(),t=e?.frameColor,a=document.documentElement;'string'==typeof t&&t.trim()?(a.style.setProperty('--phone-frame-color',t.trim()),console.log('[ChatWallpaperManager] å·²åº”ç”¨å¤–æ¡†é¢œè‰²:',t)):(a.style.removeProperty('--phone-frame-color'),console.log('[ChatWallpaperManager] å¤–æ¡†é¢œè‰²æœªé…ç½®æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤'))}catch(e){console.warn('[ChatWallpaperManager] åº”ç”¨å¤–æ¡†é¢œè‰²å¤±è´¥:',e)}}forceRefresh(){console.log('[ChatWallpaperManager] å¼ºåˆ¶åˆ·æ–°å£çº¸'),this.loadWallpaperFromSettings(),this.applyCurrentWallpaper(),this.applyFrameColorFromWorldbook()}handleCharacterChange(){console.log('[ChatWallpaperManager] å¤„ç†è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½å£çº¸è®¾ç½®'),this.forceRefresh()}clearAllWallpaperCache(){try{this.currentGlobalWallpaper='',this.individualWallpapers={};const e=this.storageManager.loadSettings();e.globalChatWallpaper='',e.individualChatWallpapers={},this.storageManager.saveSettings(e);const t=document.getElementById('chatInterface'),a=document.querySelector('.chat-container'),s=document.getElementById('chatMessages'),n=t||a||s;n&&(n.style.backgroundImage=''),console.log('[ChatWallpaperManager] æ‰€æœ‰å£çº¸ç¼“å­˜å·²æ¸…é™¤')}catch(e){throw console.error('[ChatWallpaperManager] æ¸…é™¤å£çº¸ç¼“å­˜å¤±è´¥:',e),e}}setCurrentChatId(e){this.currentChatId!==e&&(this.currentChatId=e,this.applyCurrentWallpaper())}destroy(){this.settingsChangeListener&&document.removeEventListener('settingsChange',this.settingsChangeListener),this.chatChangeListener&&document.removeEventListener('chatChange',this.chatChangeListener),this.globalChatWallpaperChangeListener&&document.removeEventListener('globalChatWallpaperChange',this.globalChatWallpaperChangeListener),this.applyWallpaperToAllListener&&document.removeEventListener('applyWallpaperToAllChats',this.applyWallpaperToAllListener),document.removeEventListener('characterChange',this.handleCharacterChange.bind(this));const e=document.getElementById('chatInterface'),t=document.querySelector('.chat-container'),a=document.getElementById('chatMessages'),s=e||t||a;s&&(s.style.backgroundImage=''),console.log('[ChatWallpaperManager] èŠå¤©å£çº¸ç®¡ç†å™¨å·²é”€æ¯')}}class N{static STORAGE_KEY='bear_group_name_overrides';static CURRENT_VERSION='1.0.0';static CACHE_TTL=3e5;static cache=null;static cacheTimestamp=0;static memoryOverrides=null;static initialize(){try{this.migrateData(),console.log('âœ… GroupNameOverrideManager åˆå§‹åŒ–å®Œæˆ')}catch(e){console.error('âŒ GroupNameOverrideManager åˆå§‹åŒ–å¤±è´¥:',e)}}static saveGroupNameOverride(e,t){if(e&&t&&'string'==typeof t)try{const a=this.getGroupNameOverrides();a[e]=t.trim();const s={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:a};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),this.setCachedOverrides(a),console.log(`ğŸ“ å·²ä¿å­˜ç¾¤åè¦†ç›–: ${e} -> ${t}`)}catch(a){this.handleStorageError(a,'save'),this.memoryOverrides=this.memoryOverrides||{},this.memoryOverrides[e]=t.trim(),console.log(`ğŸ’¾ å·²ä¿å­˜åˆ°å†…å­˜: ${e} -> ${t}`)}else console.warn('âš ï¸ æ— æ•ˆçš„ç¾¤åè¦†ç›–å‚æ•°:',{groupId:e,newName:t})}static getGroupNameOverrides(){const e=this.getCachedOverrides();if(e)return{...e};try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e).overrides||{};return this.setCachedOverrides(t),{...t}}}catch(e){this.handleStorageError(e,'get')}return{...this.memoryOverrides||{}}}static getGroupNameOverride(e){return this.getGroupNameOverrides()[e]||null}static removeGroupNameOverride(e){try{const t=this.getGroupNameOverrides();if(!(e in t))return!1;delete t[e];const a={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:t};return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.setCachedOverrides(t),this.memoryOverrides&&e in this.memoryOverrides&&delete this.memoryOverrides[e],console.log(`ğŸ—‘ï¸ å·²ç§»é™¤ç¾¤åè¦†ç›–: ${e}`),!0}catch(t){return this.handleStorageError(t,'remove'),!(!this.memoryOverrides||!(e in this.memoryOverrides))&&(delete this.memoryOverrides[e],console.log(`ğŸ’¾ å·²ä»å†…å­˜ç§»é™¤: ${e}`),!0)}}static clearAllGroupNameOverrides(){try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),this.memoryOverrides=null,console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰ç¾¤åè¦†ç›–')}catch(e){this.handleStorageError(e,'clear')}}static applyOverridesToChatData(e){const t=this.getGroupNameOverrides();if(0===Object.keys(t).length)return;let a=0;for(const[s,n]of e)if('group'===n.type&&t[s]){const e=n.chatName;n.chatName=t[s],a++,console.log(`ğŸ”„ åº”ç”¨ç¾¤åè¦†ç›–: ${e} -> ${n.chatName}`)}a>0&&console.log(`âœ… å·²åº”ç”¨ ${a} ä¸ªç¾¤åè¦†ç›–`)}static validateAndCleanOverrides(e){try{const t=this.getGroupNameOverrides(),a={};let s=!1;for(const[n,r]of Object.entries(t))e.includes(n)&&'string'==typeof r&&r.trim().length>0?a[n]=r:(s=!0,console.log(`ğŸ§¹ æ¸…ç†æ— æ•ˆçš„ç¾¤åè¦†ç›–: ${n} -> ${r}`));if(s){const e={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:a};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),this.setCachedOverrides(a);const s=Object.keys(t).length-Object.keys(a).length;console.log(`ğŸ§¹ å·²æ¸…ç† ${s} ä¸ªæ— æ•ˆçš„ç¾¤åè¦†ç›–`)}}catch(e){this.handleStorageError(e,'validate')}}static batchUpdateOverrides(e){try{const t=this.getGroupNameOverrides();Object.assign(t,e);const a={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:t};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.setCachedOverrides(t),console.log(`ğŸ“¦ æ‰¹é‡æ›´æ–° ${Object.keys(e).length} ä¸ªç¾¤åè¦†ç›–`)}catch(t){this.handleStorageError(t,'batchUpdate'),this.memoryOverrides=this.memoryOverrides||{},Object.assign(this.memoryOverrides,e)}}static getDebugInfo(){return{storageKey:this.STORAGE_KEY,version:this.CURRENT_VERSION,cacheStatus:{hasCache:!!this.cache,cacheAge:this.cache?Date.now()-this.cacheTimestamp:0,cacheTTL:this.CACHE_TTL},overrideCount:Object.keys(this.getGroupNameOverrides()).length,storageSize:this.getStorageSize(),memoryFallback:!!this.memoryOverrides,memoryOverrideCount:this.memoryOverrides?Object.keys(this.memoryOverrides).length:0}}static hasOverrides(){const e=this.getGroupNameOverrides();return Object.keys(e).length>0}static hasOverride(e){return null!==this.getGroupNameOverride(e)}static getCachedOverrides(){const e=Date.now();return this.cache&&e-this.cacheTimestamp<this.CACHE_TTL?this.cache:null}static setCachedOverrides(e){this.cache={...e},this.cacheTimestamp=Date.now()}static clearCache(){this.cache=null,this.cacheTimestamp=0}static handleStorageError(e,t){if(console.warn(`âš ï¸ ç¾¤åè¦†ç›–å­˜å‚¨æ“ä½œå¤±è´¥ (${t}):`,e),'QuotaExceededError'===e.name&&(console.log('ğŸ’¾ å­˜å‚¨é…é¢è¶…å‡ºï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®...'),this.cleanupOldData()),'get'===t||'validate'===t)try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),console.log('ğŸ§¹ å·²æ¸…ç†æŸåçš„è¦†ç›–æ•°æ®')}catch(e){console.error('âŒ æ¸…ç†è¦†ç›–æ•°æ®å¤±è´¥:',e)}}static cleanupOldData(){try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),console.log('ğŸ§¹ å·²æ¸…ç†æ—§çš„ç¾¤åè¦†ç›–æ•°æ®')}catch(e){console.error('âŒ æ¸…ç†æ—§æ•°æ®å¤±è´¥:',e)}}static getStorageSize(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?new Blob([e]).size:0}catch{return-1}}static migrateData(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(!t.version){const e={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:'object'==typeof t?t:{}};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),console.log('ğŸ”„ å·²è¿ç§»ç¾¤åè¦†ç›–æ•°æ®åˆ°æ–°ç‰ˆæœ¬')}}catch(e){console.error('âŒ æ•°æ®è¿ç§»å¤±è´¥:',e),localStorage.removeItem(this.STORAGE_KEY)}}}var x=a(464),U=a(335);class B{modalData;contacts;onConfirm;onCancel;avatarMixin;constructor(e,t,a,s){this.modalData={selectedContactIds:e,settings:{name:'',avatar:'https://files.catbox.moe/u8ccy5.jpg',userJoins:!0}},this.contacts=t,this.onConfirm=a,this.onCancel=s,this.avatarMixin=new C.SimpleAvatarMixin({debug:!1})}async show(){console.log('ğŸš€ [GroupChatModal] å¼€å§‹æ˜¾ç¤ºç¾¤èŠè®¾ç½®æ¨¡æ€æ¡†...');const e=this.createModal(),t=document.querySelector('.interface-container');t?(t.appendChild(e),console.log('âœ… [GroupChatModal] æ¨¡æ€æ¡†å·²æ·»åŠ åˆ° interface-container')):(document.body.appendChild(e),console.log('âœ… [GroupChatModal] æ¨¡æ€æ¡†å·²æ·»åŠ åˆ° body')),setTimeout(()=>{e.classList.add('show'),console.log('âœ… [GroupChatModal] æ¨¡æ€æ¡†æ˜¾ç¤ºåŠ¨ç”»å·²è§¦å‘')},10),console.log('ğŸ·ï¸ [GroupChatModal] ç”Ÿæˆé»˜è®¤ç¾¤å...'),this.generateDefaultGroupName(),console.log('ğŸ”§ [GroupChatModal] è°ƒè¯•ç¯å¢ƒä¿¡æ¯...');(new((await Promise.resolve().then(a.bind(a,335))).UserInfoRetrieval)).debugEnvironment(),console.log('ğŸ”„ [GroupChatModal] å¼€å§‹å¼‚æ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯...'),this.updateUserInfoAsync(),console.log('ğŸ–¼ï¸ [GroupChatModal] åˆå§‹åŒ–å¤´åƒåŒæ­¥...'),this.initializeAvatarSync(),console.log('ğŸ”„ [GroupChatModal] å¼ºåˆ¶æ›´æ–°å¤´åƒ...'),this.avatarMixin.forceUpdate(),console.log('âœ… [GroupChatModal] ç¾¤èŠè®¾ç½®æ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæˆ')}createModal(){const e=document.createElement('div');e.className='modal-overlay group-chat-modal',e.id='groupChatModal';const t=this.getSelectedMembers(),a=this.getAllMembers();console.log('ğŸ—ï¸ [GroupChatModal] åˆ›å»ºæ¨¡æ€æ¡†DOM:'),console.log('  - é€‰ä¸­æˆå‘˜æ•°:',t.length),console.log('  - æ€»æˆå‘˜æ•°:',a.length),console.log('  - æˆå‘˜åˆ—è¡¨:',a.map(e=>`${e.name}(${e.id})`));const s=a.map(e=>(console.log(`ğŸ·ï¸ [GroupChatModal] ç”Ÿæˆæˆå‘˜HTML: ${e.name} - å¤´åƒ: ${e.avatar}`),`\n        <div class="member-tag" data-member-id="${e.id}">\n          <img src="${e.avatar}" class="member-avatar" alt="${e.name}" data-member-id="${e.id}">\n          <span>${e.name}</span>\n        </div>\n      `)).join('');return e.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">åˆ›å»ºç¾¤èŠ</div>\n        \n        <div class="selected-members">\n          <div class="members-label" id="membersLabel">ç¾¤èŠæˆå‘˜ (${a.length}äºº)</div>\n          <div class="members-list" id="membersList">\n            ${s}\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label class="form-label">ç¾¤èŠåç§°</label>\n          <input type="text" class="form-input" id="groupNameInput" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°">\n        </div>\n\n        <div class="form-group">\n          <label class="form-label">ç¾¤èŠå¤´åƒ</label>\n          <div class="avatar-input-container">\n            <div class="avatar-input-group">\n              <input type="text" class="form-input" id="avatarUrlInput" placeholder="è¯·è¾“å…¥å¤´åƒURL" value="${this.modalData.settings.avatar}">\n              <button class="upload-btn" id="uploadAvatarBtn">ä¸Šä¼ </button>\n              <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">\n            </div>\n            <img src="${this.modalData.settings.avatar}" class="avatar-preview" id="avatarPreview" alt="ç¾¤å¤´åƒé¢„è§ˆ">\n          </div>\n        </div>\n\n        <div class="participation-group">\n          <label class="form-label">æ‚¨çš„å‚ä¸æ–¹å¼</label>\n          <div class="participation-options">\n            <div class="participation-option selected" data-value="member">\n              <div class="option-title">åŠ å…¥ç¾¤èŠ</div>\n              <div class="option-desc">ä½œä¸ºæˆå‘˜å‚ä¸å¯¹è¯</div>\n            </div>\n            <div class="participation-option" data-value="observer">\n              <div class="option-title">è§‚å¯Ÿæ¨¡å¼</div>\n              <div class="option-desc">åªèƒ½æŸ¥çœ‹ä¸èƒ½å‘è¨€</div>\n            </div>\n          </div>\n        </div>\n\n        <div class="modal-buttons">\n          <button class="modal-btn cancel-btn">å–æ¶ˆ</button>\n          <button class="modal-btn create-btn">åˆ›å»ºç¾¤èŠ</button>\n        </div>\n      </div>\n    `,this.bindEvents(e),e}bindEvents(e){const t=e.querySelector('#groupNameInput');t&&t.addEventListener('input',e=>{this.modalData.settings.name=e.target.value});const a=e.querySelector('#avatarUrlInput'),s=e.querySelector('#avatarPreview');a&&s&&(a.addEventListener('input',e=>{const t=e.target.value;this.modalData.settings.avatar=t,s.src=t}),s.addEventListener('error',()=>{s.src='https://files.catbox.moe/u8ccy5.jpg'}));const n=e.querySelector('#uploadAvatarBtn'),r=e.querySelector('#avatarFileInput');n&&r&&(n.addEventListener('click',()=>{r.click()}),r.addEventListener('change',e=>{const t=e.target.files?.[0];if(t)if(t.type.startsWith('image/')){const e=new FileReader;e.onload=e=>{const t=e.target?.result;this.modalData.settings.avatar=t,s&&(s.src=t),a&&(a.value='æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡')},e.readAsDataURL(t)}else toastr.error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')}));const o=e.querySelectorAll('.participation-option');e.querySelector('#membersLabel');o.forEach(e=>{e.addEventListener('click',()=>{o.forEach(e=>e.classList.remove('selected')),e.classList.add('selected'),this.modalData.settings.userJoins='member'===e.getAttribute('data-value'),this.updateUserInfoAsync()})});const i=e.querySelector('.cancel-btn');i&&i.addEventListener('click',()=>{this.hide(),this.onCancel()});const c=e.querySelector('.create-btn');c&&c.addEventListener('click',()=>{this.validateSettings()&&(this.hide(),this.onConfirm(this.modalData.settings))}),e.addEventListener('click',t=>{t.target===e&&(this.hide(),this.onCancel())})}getSelectedMembers(){return this.contacts.filter(e=>this.modalData.selectedContactIds.includes(e.id))}getAllMembers(){const e=this.getSelectedMembers();if(this.modalData.settings.userJoins){const t=(0,U.getUserName)(),a=(0,U.getUserAvatar)();console.log('ğŸ” [GroupChatModal] è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒæ­¥ï¼‰:'),console.log('  - ç”¨æˆ·å:',t),console.log('  - ç”¨æˆ·å¤´åƒ:',a);return[{id:'{{user}}',name:t,avatar:a},...e]}return e}async getAllMembersAsync(){const e=this.getSelectedMembers();if(this.modalData.settings.userJoins){const t=await(0,U.getUserNameAsync)(),a=(0,U.getUserAvatar)();console.log('ğŸ” [GroupChatModal] è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¼‚æ­¥ï¼‰:'),console.log('  - ç”¨æˆ·å:',t),console.log('  - ç”¨æˆ·å¤´åƒ:',a);return[{id:'{{user}}',name:t,avatar:a},...e]}return e}async updateUserInfoAsync(){try{console.log('ğŸ”„ [GroupChatModal] å¼€å§‹å¼‚æ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯...');const e=await this.getAllMembersAsync();console.log('ğŸ“‹ [GroupChatModal] æ›´æ–°åçš„æˆå‘˜åˆ—è¡¨:'),e.forEach((e,t)=>{console.log(`  ${t+1}. ${e.name} (${e.id}) - å¤´åƒ: ${e.avatar}`)});const t=document.querySelector('#membersLabel');t&&(t.textContent=`ç¾¤èŠæˆå‘˜ (${e.length}äºº)`,console.log('âœ… [GroupChatModal] å·²æ›´æ–°æˆå‘˜äººæ•°æ˜¾ç¤º:',e.length));const a=document.querySelector('#membersList');if(a){const t=e.map(e=>`\n            <div class="member-tag" data-member-id="${e.id}">\n              <img src="${e.avatar}" class="member-avatar" alt="${e.name}" data-member-id="${e.id}">\n              <span>${e.name}</span>\n            </div>\n          `).join('');a.innerHTML=t,console.log('âœ… [GroupChatModal] å·²æ›´æ–°æˆå‘˜åˆ—è¡¨HTML')}this.generateDefaultGroupNameAsync()}catch(e){console.error('âŒ [GroupChatModal] å¼‚æ­¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:',e)}}generateDefaultGroupName(){const e=this.getAllMembers().map(e=>e.name);let t='';t=e.length<=3?e.join('ã€')+'çš„ç¾¤èŠ':e.slice(0,2).join('ã€')+`ç­‰${e.length}äººçš„ç¾¤èŠ`,this.modalData.settings.name=t;const a=document.querySelector('#groupNameInput');a&&(a.value=t)}async generateDefaultGroupNameAsync(){try{const e=(await this.getAllMembersAsync()).map(e=>e.name);let t='';t=e.length<=3?e.join('ã€')+'çš„ç¾¤èŠ':e.slice(0,2).join('ã€')+`ç­‰${e.length}äººçš„ç¾¤èŠ`,this.modalData.settings.name=t;const a=document.querySelector('#groupNameInput');a&&(a.value=t)}catch(e){console.log('âŒ å¼‚æ­¥ç”Ÿæˆé»˜è®¤ç¾¤åå¤±è´¥:',e)}}validateSettings(){return this.modalData.settings.name.trim()?!!this.modalData.settings.avatar.trim()||(toastr.error('è¯·è®¾ç½®ç¾¤èŠå¤´åƒ'),!1):(toastr.error('è¯·è¾“å…¥ç¾¤èŠåç§°'),!1)}async initializeAvatarSync(){try{this.avatarMixin.autoRegister(),setTimeout(()=>{this.registerUserAvatarElements()},100),console.log('[GroupChatModal] å¤´åƒåŒæ­¥å·²åˆå§‹åŒ–')}catch(e){console.error('[GroupChatModal] å¤´åƒåŒæ­¥åˆå§‹åŒ–å¤±è´¥:',e)}}registerUserAvatarElements(){console.log('ğŸ” [GroupChatModal] å¼€å§‹æ³¨å†Œç”¨æˆ·å¤´åƒå…ƒç´ ...');const e=document.querySelectorAll('.member-avatar');console.log(`ğŸ” [GroupChatModal] æ‰¾åˆ° ${e.length} ä¸ªæˆå‘˜å¤´åƒå…ƒç´ `);let t=0;e.forEach((e,a)=>{const s=e.closest('.member-tag');if(s){const n=s.getAttribute('data-member-id');console.log(`ğŸ” [GroupChatModal] å¤´åƒå…ƒç´  ${a+1}: memberId = "${n}"`),'{{user}}'!==n&&'user'!==n||(this.avatarMixin.register(e,'img'),t++,console.log('âœ… [GroupChatModal] å·²æ³¨å†Œç”¨æˆ·å¤´åƒå…ƒç´ :',{element:e,src:e.src,alt:e.alt}))}else console.log(`âš ï¸ [GroupChatModal] å¤´åƒå…ƒç´  ${a+1} æ²¡æœ‰æ‰¾åˆ° .member-tag çˆ¶å…ƒç´ `)}),console.log(`âœ… [GroupChatModal] å¤´åƒæ³¨å†Œå®Œæˆï¼Œå…±æ³¨å†Œ ${t} ä¸ªç”¨æˆ·å¤´åƒå…ƒç´ `)}hide(){this.avatarMixin.destroy();const e=document.getElementById('groupChatModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}}var P=a(15);class O{contactManager=null;constructor(){console.log('ğŸ”§ GroupChatManager å·²åˆå§‹åŒ–')}setContactManager(e){this.contactManager=e,console.log('ğŸ”— GroupChatManager å·²è¿æ¥åˆ° ContactManager')}getContacts(){return this.contactManager?this.contactManager.getAllContacts().map(e=>({id:e.id,name:e.name,avatar:e.avatar})):(console.warn('âš ï¸ ContactManager æœªè®¾ç½®ï¼Œè¿”å›ç©ºè”ç³»äººåˆ—è¡¨'),[])}createGroupChat(e){if(e.length<2)return void toastr.error('è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººæ‰èƒ½åˆ›å»ºç¾¤èŠ');const t=this.getContacts();new B(e,t,t=>this.handleGroupChatCreation(e,t),()=>console.log('ç”¨æˆ·å–æ¶ˆäº†ç¾¤èŠåˆ›å»º')).show()}handleGroupChatCreation(e,t){try{let a=[...e];t.userJoins&&a.push('{{user}}');const s={id:P.GroupChatStorage.generateGroupId(t.name),name:t.name,avatar:t.avatar,members:a,userParticipation:t.userJoins?'member':'observer',createdAt:Date.now(),messages:[],type:'group'};try{P.GroupChatStorage.saveGroupChat(s),console.log('âœ… ç¾¤èŠæ•°æ®å·²ä¿å­˜åˆ°localStorage')}catch(e){console.warn('âš ï¸ ä¿å­˜ç¾¤èŠæ•°æ®åˆ°localStorageå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ:',e)}toastr.success(`ç¾¤èŠ"${t.name}"åˆ›å»ºæˆåŠŸï¼`,'åˆ›å»ºæˆåŠŸ'),this.emitChatChangedEvent(s),console.log('âœ… ç¾¤èŠåˆ›å»ºæˆåŠŸ:',s)}catch(e){console.error('åˆ›å»ºç¾¤èŠå¤±è´¥:',e),toastr.error('åˆ›å»ºç¾¤èŠå¤±è´¥ï¼Œè¯·é‡è¯•')}}addToChatList(e){try{const t=this.getChatListData(),a={id:e.id,chatName:e.name,avatar:e.avatar,lastMessage:'ç¾¤èŠå·²åˆ›å»º',lastMessageTime:(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),unreadCount:0,type:'group',members:e.members,userParticipation:e.userParticipation};t.unshift(a),this.saveChatListData(t),console.log('ğŸ“‹ ç¾¤èŠå·²æ·»åŠ åˆ°èŠå¤©åˆ—è¡¨')}catch(e){console.error('æ·»åŠ ç¾¤èŠåˆ°èŠå¤©åˆ—è¡¨å¤±è´¥:',e)}}getChatListData(){try{return(0,x.getCharacterItem)('chat_list',[])}catch(e){return console.error('è¯»å–èŠå¤©åˆ—è¡¨æ•°æ®å¤±è´¥:',e),[]}}saveChatListData(e){try{(0,x.setCharacterItem)('chat_list',e),console.log('ğŸ“‹ èŠå¤©åˆ—è¡¨å·²ä¿å­˜åˆ°è§’è‰²ä¸“ç”¨ç©ºé—´')}catch(e){console.error('ä¿å­˜èŠå¤©åˆ—è¡¨æ•°æ®å¤±è´¥:',e)}}emitChatChangedEvent(e){try{const t=new CustomEvent('chatListChanged',{detail:{type:'groupChatCreated',groupChatData:e}});document.dispatchEvent(t),'function'==typeof eventEmit&&eventEmit('CHAT_LIST_CHANGED')}catch(e){console.error('è§¦å‘èŠå¤©å˜åŒ–äº‹ä»¶å¤±è´¥:',e)}}getAllGroupChats(){return P.GroupChatStorage.getAllGroupChats()}getGroupChatById(e){return P.GroupChatStorage.getGroupChatById(e)}deleteGroupChat(e){const t=P.GroupChatStorage.deleteGroupChat(e);return t&&this.emitChatChangedEvent(),t}}var R=a(17);function G(){try{const{GlobalUserManager:e}=a(721),t=e.getInstance().getCurrentUserData();if(t?.isCustom&&t.avatar)return t.avatar;const s=(0,R.ZT)();if(s)return s;const n=(0,U.getSimpleUserAvatar)();return n&&'https://files.catbox.moe/u8ccy5.jpg'!==n?n:(0,U.getUserAvatar)()}catch(e){return console.warn('[getUnifiedUserAvatarSync] è·å–å¤´åƒå¤±è´¥:',e),'https://files.catbox.moe/u8ccy5.jpg'}}var W=a(861),H=a(947);let F=null;function q(){try{if(F)return void console.log('[DynamicIsland] çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');if('loading'===document.readyState)return void document.addEventListener('DOMContentLoaded',q);if(!document.querySelector('.phone-container'))return console.warn('[DynamicIsland] æœªæ‰¾åˆ°.phone-containerå…ƒç´ ï¼Œç¨åé‡è¯•'),void setTimeout(q,500);F=W.l.getInstance();try{H.$.getInstance().prefetch()}catch(e){console.warn('[DynamicIsland] æ­Œå•é¢„åŠ è½½å¤±è´¥:',e)}console.log('[DynamicIsland] çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('[DynamicIsland] åˆå§‹åŒ–å¤±è´¥:',e),toastr.error('çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥','é”™è¯¯')}}function V(){try{F&&(F.destroy(),F=null,console.log('[DynamicIsland] çµåŠ¨å²›éŸ³ä¹æ’­æ”¾å™¨å·²é”€æ¯'))}catch(e){console.error('[DynamicIsland] é”€æ¯å¤±è´¥:',e)}}$(()=>{q()}),$(window).on('unload',()=>{V()}),$(document).on('characterChange',()=>{console.log('[DynamicIsland] æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åˆå§‹åŒ–çµåŠ¨å²›'),V(),setTimeout(q,100)});const j=$;var Y=a.n(j),K=a(115);class Q{extractTagBlock(e,t){const a=`[${t}]`,s=`[/${t}]`,n=e.indexOf(a),r=e.indexOf(s);return-1===n||-1===r||r<=n?null:e.substring(n+a.length,r).trim()}parseKeyValuePairs(e){const t=new Map,a=e.split('\n');for(const e of a){const a=e.trim();if(!a||a.startsWith('åŠ¨æ€ï¼š'))continue;const s=a.indexOf('ï¼š');if(s>0){const e=a.substring(0,s).trim(),n=a.substring(s+1).trim();t.set(e,n)}}return t}createError(e,t,a){return{field:e,message:t,position:a}}safeParseInt(e,t=0){const a=parseInt(e);return isNaN(a)?t:a}validateRequiredFields(e,t){const a=[];for(const s of t)(!e[s]||'string'==typeof e[s]&&''===e[s].trim())&&a.push(this.createError(s,`å¿…å¡«å­—æ®µ "${s}" ç¼ºå¤±æˆ–ä¸ºç©º`));return a}}class X extends Q{config;constructor(e={}){super(),this.config={enablePartialParsing:!0,enableErrorRecovery:!0,logErrors:!0,...e}}parse(e){const t=[],a=[],s=[];try{const n=this.extractDynamicsContainer(e);if(!n)return a.push('æœªæ‰¾åˆ°[åŠ¨æ€]å®¹å™¨'),{success:!1,data:[],errors:[this.createError('container','æœªæ‰¾åˆ°[åŠ¨æ€]...[/åŠ¨æ€]å®¹å™¨')],warnings:a};const{dynamics:r,comments:o,likes:i,parseErrors:c}=this.parseContainerContent(n);t.push(...c);const l=new Map;for(const e of r){const t={no:e.no,authorName:e.author,content:e.content,imageDescription:e.imageDescription,timestamp:e.timestamp,likesCount:0,sharesCount:0,comments:[]};l.set(e.no,t)}const d=e=>{let t=l.get(e);return t||(t={no:e,content:'',likesCount:0,sharesCount:0,comments:[]},l.set(e,t)),t};for(const e of o){const t=d(e.targetNo),a={authorName:e.replyTo?`${e.commenter} å›å¤ ${e.replyTo}`:e.commenter,content:e.content};t.comments.push(a)}for(const e of i){const t=d(e.targetNo);t.likedBy||(t.likedBy=[]),t.likedBy.includes(e.liker)||(t.likedBy.push(e.liker),t.likesCount=(t.likesCount||0)+1)}s.push(...Array.from(l.values()));const h=0===t.length||!0===this.config.enablePartialParsing&&s.length>0;return this.config.logErrors&&t.length>0&&console.warn('åŠ¨æ€è§£æé”™è¯¯:',t),{success:h,data:s,errors:t,warnings:a}}catch(e){const t=e instanceof Error?e.message:String(e),s=this.createError('parse',`è§£æå¤±è´¥: ${t}`);return this.config.logErrors&&console.error('åŠ¨æ€è§£æå¼‚å¸¸:',e),{success:!1,data:[],errors:[s],warnings:a}}}extractDynamicsContainer(e){const t='[åŠ¨æ€]',a=e.indexOf(t),s=e.indexOf('[/åŠ¨æ€]');return-1===a||-1===s||s<=a?null:e.substring(a+4,s).trim()}parseContainerContent(e){const t=[],a=[],s=[],n=[],r=e.split('\n');for(let e=0;e<r.length;e++){const o=r[e].trim();if(o)if(o.startsWith('[åŠ¨æ€_')&&o.endsWith(']')){const a=this.parseDynamicsLine(o,e+1);a.success&&a.item?t.push(a.item):a.error&&n.push(a.error)}else if(o.startsWith('[è¯„è®º_')&&o.endsWith(']')){const t=this.parseCommentLine(o,e+1);t.success&&t.item?a.push(t.item):t.error&&n.push(t.error)}else if(o.startsWith('[ç‚¹èµ_')&&o.endsWith(']')){const t=this.parseLikeLine(o,e+1);t.success&&t.item?s.push(t.item):t.error&&n.push(t.error)}}return{dynamics:t,comments:a,likes:s,parseErrors:n}}parseDynamicsLine(e,t){const a=e.slice(1,-1),s=this.splitWithQuotes(a,'|');if(4!==s.length&&5!==s.length)return{success:!1,error:this.createError(`line_${t}`,`åŠ¨æ€æ ¼å¼é”™è¯¯ï¼šåº”ä¸º4æ®µï¼ˆæ— å›¾ï¼‰æˆ–5æ®µï¼ˆæœ‰å›¾ï¼‰ï¼Œå®é™…${s.length}æ®µ`)};const n=s[0].match(/^åŠ¨æ€_(\d+)$/);if(!n)return{success:!1,error:this.createError(`line_${t}`,'åŠ¨æ€ç¼–å·æ ¼å¼é”™è¯¯')};const r=parseInt(n[1]),o=s[1].trim(),i=s[2].trim();let c,l;return 5===s.length?(c=s[3].trim(),l=s[4].trim()):l=s[3].trim(),this.validateTimestamp(l)?{success:!0,item:{no:r,author:o,content:i,imageDescription:c,timestamp:l}}:{success:!1,error:this.createError(`line_${t}`,`æ—¶é—´æ ¼å¼é”™è¯¯ï¼š${l}`)}}parseCommentLine(e,t){const a=e.slice(1,-1),s=this.splitWithQuotes(a,'|');if(4!==s.length)return{success:!1,error:this.createError(`line_${t}`,`è¯„è®ºæ ¼å¼é”™è¯¯ï¼šåº”ä¸º4æ®µï¼Œå®é™…${s.length}æ®µ`)};const n=s[0].match(/^è¯„è®º_(\d+)$/);if(!n)return{success:!1,error:this.createError(`line_${t}`,'è¯„è®ºç›®æ ‡ç¼–å·æ ¼å¼é”™è¯¯')};const r=parseInt(n[1]),o=s[1].trim();let i,c;const l=o.indexOf('@');l>0?(i=o.substring(0,l).trim(),c=o.substring(l+1).trim()):i=o;const d=s[2].trim(),h=s[3].trim();return this.validateTimestamp(h)?{success:!0,item:{targetNo:r,commenter:i,replyTo:c,content:d,timestamp:h}}:{success:!1,error:this.createError(`line_${t}`,`æ—¶é—´æ ¼å¼é”™è¯¯ï¼š${h}`)}}parseLikeLine(e,t){const a=e.slice(1,-1),s=this.splitWithQuotes(a,'|');if(3!==s.length)return{success:!1,error:this.createError(`line_${t}`,`ç‚¹èµæ ¼å¼é”™è¯¯ï¼šåº”ä¸º3æ®µï¼Œå®é™…${s.length}æ®µ`)};const n=s[0].match(/^ç‚¹èµ_(\d+)$/);if(!n)return{success:!1,error:this.createError(`line_${t}`,'ç‚¹èµç›®æ ‡ç¼–å·æ ¼å¼é”™è¯¯')};const r=parseInt(n[1]),o=s[1].trim(),i=s[2].trim();return this.validateTimestamp(i)?{success:!0,item:{targetNo:r,liker:o,timestamp:i}}:{success:!1,error:this.createError(`line_${t}`,`æ—¶é—´æ ¼å¼é”™è¯¯ï¼š${i}`)}}splitWithQuotes(e,t){const a=[];let s='',n=!1;for(let r=0;r<e.length;r++){const o=e[r],i=e[r+1];'"'===o?'"'===i?(s+='"',r++):n=!n:o!==t||n?s+=o:(a.push(s),s='')}return s&&a.push(s),a}validateTimestamp(e){return/^\d{2}:\d{2}$/.test(e)}}class Z{static mergeLikedBy(e,t){const a=new Set(e||[]);return t?.forEach(e=>a.add(e)),Array.from(a)}static mergeComments(e,t){const a=new Set,s=[...e||[]];e?.forEach(e=>{const t=`${e.authorName}||${e.content}`;a.add(t)});const n=Array.isArray(t)?t:[t];return n?.forEach(e=>{if(!e)return;const t=`${e.authorName}||${e.content}`;a.has(t)?console.log(`âš ï¸ è·³è¿‡é‡å¤è¯„è®º: ${e.authorName} - ${e.content.substring(0,20)}...`):(s.push(e),a.add(t),console.log(`ğŸ†• æ·»åŠ æ–°è¯„è®º: ${e.authorName} - ${e.content.substring(0,20)}...`))}),s}static mergeInteractions(e,t){if(console.log(`ğŸ”„ åˆå¹¶åŠ¨æ€ #${e.no} çš„äº’åŠ¨æ•°æ®`),t.likedBy&&t.likedBy.length>0){const a=e.likedBy?.length||0;e.likedBy=this.mergeLikedBy(e.likedBy||[],t.likedBy),e.likesCount=e.likedBy.length,console.log(`ğŸ‘ ç‚¹èµæ•°æ®: ${a} -> ${e.likesCount}`)}if(t.comments?.length>0){const a=e.comments?.length||0;e.comments=this.mergeComments(e.comments||[],t.comments),console.log(`ğŸ’¬ è¯„è®ºæ•°æ®: ${a} -> ${e.comments.length}`)}}static generateFingerprint(e){return`${e.no||0}_${e.authorName||''}_${(e.content||'').substring(0,50)}`}static fillMissingFields(e,t){!e.content&&t.content&&(e.content=t.content),!e.authorName&&t.authorName&&(e.authorName=t.authorName),!e.imageDescription&&t.imageDescription&&(e.imageDescription=t.imageDescription),!e.imageUrl&&t.imageUrl&&(e.imageUrl=t.imageUrl),!e.timestamp&&t.timestamp&&(e.timestamp=t.timestamp)}static isValidDynamic(e){return!(void 0===e.no||!e.content||!e.authorName)}static cloneDynamic(e){return{no:e.no,messageId:e.messageId,authorName:e.authorName,content:e.content,imageDescription:e.imageDescription,imageUrl:e.imageUrl,timestamp:e.timestamp,likesCount:e.likesCount,sharesCount:e.sharesCount,likedBy:e.likedBy?[...e.likedBy]:[],comments:e.comments?[...e.comments]:[]}}}class J{static imageMasks=['https://files.catbox.moe/8mjvdg.jpg','https://files.catbox.moe/0g3kqu.jpg','https://files.catbox.moe/d5b7k6.jpg','https://files.catbox.moe/0yrhh6.jpg'];static getRandomImageMask(){const e=Math.floor(Math.random()*this.imageMasks.length);return this.imageMasks[e]}static isImageMask(e){return this.imageMasks.includes(e)}static getAllImageMasks(){return[...this.imageMasks]}}class ee{globalUserManager;currentUserAvatar='';currentUserName='';soundManager;constructor(e){this.globalUserManager=g.GlobalUserManager.getInstance(),this.soundManager=e||window.soundManager,this.initializeUserInfo()}async initializeUserInfo(){try{const e=await this.globalUserManager.loadUserData();e&&(this.currentUserAvatar=e.avatar||'https://files.catbox.moe/bpqrv2.jpg',this.currentUserName=e.name||'ç”¨æˆ·')}catch(e){console.error('åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:',e),this.currentUserAvatar='https://files.catbox.moe/bpqrv2.jpg',this.currentUserName='ç”¨æˆ·'}}renderComposerInterface(){return'\n      <div id="dynamicsComposerInterface" class="dynamics-composer-interface">\n        \x3c!-- é¡¶éƒ¨å¯¼èˆªæ  --\x3e\n        <div class="composer-nav-bar">\n          <button class="composer-back-btn" id="composerBackBtn">\n            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">\n              <path d="M19 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H19v-2z"/>\n            </svg>\n          </button>\n          <div class="composer-nav-title">å‘å¸ƒåŠ¨æ€</div>\n          <button class="composer-post-btn" id="composerPostBtn" disabled>\n            å‘å¸ƒ\n          </button>\n        </div>\n\n        \x3c!-- å‘å¸ƒå†…å®¹åŒºåŸŸ --\x3e\n        <div class="composer-content-area">\n          \x3c!-- è¾“å…¥åŒºåŸŸï¼ŒåŒ…å«å¤´åƒå’Œæ–‡æœ¬æ¡† --\x3e\n          <div class="composer-main-area">\n            <div class="composer-user-avatar-small" id="composerUserAvatar"></div>\n            <div class="composer-input-wrapper">\n              <textarea\n                id="composerTextarea"\n                class="composer-textarea"\n                placeholder="æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ"\n                maxlength="280"\n              ></textarea>\n              \n              \x3c!-- åœ†ç¯å­—æ•°ç»Ÿè®¡ --\x3e\n              <div class="composer-char-count" id="charCountContainer">\n                <svg viewBox="0 0 30 30">\n                  <circle class="circle-bg" cx="15" cy="15" r="12"></circle>\n                  <circle class="circle-progress" id="charCountProgress" cx="15" cy="15" r="12"\n                    stroke-dasharray="75.4" stroke-dashoffset="75.4"></circle>\n                </svg>\n                <span class="char-count-text" id="charCountText"></span>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- å›¾ç‰‡æè¿°è¾“å…¥åŒºï¼ˆåˆå§‹éšè—ï¼‰ --\x3e\n          <div class="composer-image-description" id="imageDescriptionArea" style="display: none;">\n            <input\n              type="text"\n              id="imageDescriptionInput"\n              class="image-description-input"\n              placeholder="æ·»åŠ å›¾ç‰‡æè¿°..."\n              maxlength="100"\n            />\n            <button class="remove-image-btn" id="removeImageBtn">\n              <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">\n                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- å·¥å…·æ  - åªä¿ç•™å›¾ç‰‡æŒ‰é’® --\x3e\n          <div class="composer-toolbar">\n            <button class="toolbar-btn image-only" id="addImageBtn">\n              <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">\n                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 11.5c0 .85-.65 1.5-1.5 1.5S6 12.35 6 11.5 6.65 10 7.5 10 9 10.65 9 11.5zm9 7.5H6l3-4 2 2.67L14 14l4 5z"/>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- éšè—çš„æ–‡ä»¶è¾“å…¥ --\x3e\n          <input type="file" id="imageFileInput" accept="image/*" style="display: none;">\n        </div>\n      </div>\n    '}initializeComposer(){const e=Y()('#composerUserAvatar');e.length&&this.currentUserAvatar&&e.css('background-image',`url('${this.currentUserAvatar}')`),this.bindComposerEvents(),this.updateCharCountCircle(0,280),this.setupUserAvatarListener()}bindComposerEvents(){Y()('#composerBackBtn').off('click'),Y()('#composerTextarea').off('input'),Y()('#addImageBtn').off('click'),Y()('#removeImageBtn').off('click'),Y()('#composerPostBtn').off('click'),Y()('#composerBackBtn').on('click',()=>{this.soundManager?.playSound&&this.soundManager.playSound('click'),this.closeComposer()});const e=Y()('#composerTextarea'),t=Y()('#composerPostBtn');Y()('#charCount');e.on('input',()=>{const a=e.val(),s=a.length;this.autoResizeTextarea(e[0]),this.updateCharCountCircle(s,280);const n=a.trim().length>0&&s<=280,r=Y()('#imageDescriptionArea').is(':visible');t.prop('disabled',!n&&!r)}),Y()('#addImageBtn').on('click',()=>{const a=Y()('#imageDescriptionArea');if(a.is(':visible'))this.removeImageDescription();else{a.show(),Y()('#imageDescriptionInput').focus(),Y()('#addImageBtn').addClass('active');const s=e.val().trim().length>0;t.prop('disabled',!s)}}),Y()('#removeImageBtn').on('click',()=>{this.removeImageDescription()}),Y()('#composerPostBtn').on('click',()=>{this.soundManager?.playSound&&this.soundManager.playSound('emoji'),this.publishDynamic()}),e.focus()}removeImageDescription(){Y()('#imageDescriptionArea').hide(),Y()('#imageDescriptionInput').val(''),Y()('#addImageBtn').removeClass('active');Y()('#composerTextarea').val().trim()||Y()('#composerPostBtn').prop('disabled',!0)}removeImage(){this.removeImageDescription()}async publishDynamic(){const e=Y()('#composerTextarea').val(),t=Y()('#imageDescriptionInput').val(),a=Y()('#imageDescriptionArea').is(':visible')&&t.trim();if(!e.trim()&&!a)return;const s=Y()('#composerPostBtn');s.prop('disabled',!0).text('å‘å¸ƒä¸­...');try{const n=getChatMessages('0-{{lastMessageId}}');let r=0;for(const e of n)if(e.message&&'string'==typeof e.message){const t=e.message.matchAll(/\[åŠ¨æ€_(\d+)[^\]]*\]/g);for(const e of t){const t=parseInt(e[1],10);t>r&&(r=t)}}const o=r+1,i=(e=>`${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`)(new Date);let c;c=a?`[åŠ¨æ€_${o}|user|${e.trim()}|${t.trim()}|${i}]`:`[åŠ¨æ€_${o}|user|${e.trim()}|${i}]`;const l=n[n.length-1];if(!l)return console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ï¼Œå¯èƒ½éœ€è¦å…ˆå‘é€ä¸€æ¡æ¶ˆæ¯'),toastr.warning('è¯·å…ˆåœ¨èŠå¤©ä¸­å‘é€ä¸€æ¡æ¶ˆæ¯'),void s.prop('disabled',!1).text('å‘å¸ƒ');{let e=l.message||'';if(e.includes('[åŠ¨æ€]')&&e.includes('[/åŠ¨æ€]')){const t=e.indexOf('[/åŠ¨æ€]'),a=e.slice(0,t).trimEnd(),s=e.slice(t);e=`${a}\n${c}\n${s}`}else{const t=`[åŠ¨æ€]\n${c}\n[/åŠ¨æ€]`;if(e.includes('<bear>')&&e.includes('</bear>')){const a=e.indexOf('</bear>'),s=e.slice(0,a).trimEnd(),n=e.slice(a);e=`${s}\n\n${t}\n${n}`}else e=e.trimEnd()+'\n\n<bear>\n'+t+'\n</bear>'}await setChatMessages([{message_id:l.message_id,message:e}],{refresh:'none'}),console.log(`âœ… æˆåŠŸå‘å¸ƒåŠ¨æ€ #${o} åˆ°æ¥¼å±‚ ${l.message_id}`)}this.closeComposer(),s.text('å‘å¸ƒ'),await this.addDynamicToUI(o,e.trim(),a?t.trim():void 0,i,l.message_id);const d={dynamicNo:o,content:e.trim(),imageDescription:a?t.trim():void 0,timestamp:i,messageId:l.message_id};document.dispatchEvent(new CustomEvent('dynamicsPublished',{detail:d}))}catch(e){console.error('å‘å¸ƒåŠ¨æ€å¤±è´¥:',e),toastr.error('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•'),s.prop('disabled',!1).text('å‘å¸ƒ')}}closeComposer(){Y()('#dynamicsComposerInterface').removeClass('active').hide(),Y()('#composerTextarea').val(''),this.updateCharCountCircle(0,280),Y()('#composerPostBtn').prop('disabled',!0),this.removeImageDescription()}autoResizeTextarea(e){e.style.height='auto',e.style.height=e.scrollHeight+'px'}updateCharCountCircle(e,t){const a=e/t*100,s=2*Math.PI*12,n=s-a/100*s,r=Y()('#charCountProgress'),o=Y()('#charCountText');r.css('stroke-dashoffset',n),e>t?(r.removeClass('warning').addClass('danger'),o.removeClass('warning').addClass('danger'),o.text('-'+(e-t))):e>.9*t?(r.addClass('warning').removeClass('danger'),o.addClass('warning').removeClass('danger'),o.text(t-e)):e>.8*t?(r.removeClass('warning danger'),o.removeClass('warning danger'),o.text(t-e)):(r.removeClass('warning danger'),o.removeClass('warning danger'),o.text(''))}async addDynamicToUI(e,t,a,s,n){const r=(await triggerSlash('/pass {{user}}')||'').trim()||'ç”¨æˆ·',o=`\n      <div class="dynamics-post" data-post-id="dynamics_${e}"${null!=n?` data-message-id="${n}"`:''}>\n        <div class="dynamics-post-header">\n          <div class="dynamics-post-avatar" style="background-image: url('${this.currentUserAvatar}')"></div>\n          <div class="dynamics-post-info">\n            <div class="dynamics-post-name">${r}</div>\n            <div class="dynamics-post-time">åˆšåˆš</div>\n          </div>\n        </div>\n        <div class="dynamics-post-content">${this.formatContent(t)}</div>\n        ${a?`\n          <div class="dynamics-post-image" style="background-image: url('${J.getRandomImageMask()}')" data-description="${a}"></div>\n        `:''}\n        <div class="dynamics-post-actions">\n          <div class="dynamics-post-action" data-action="like">\n            <span class="action-icon">\n              <svg class="action-svg" viewBox="0 0 24 24">\n                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n              </svg>\n            </span>\n          </div>\n          <div class="dynamics-post-action" data-action="comment">\n            <span class="action-icon">\n              <svg class="action-svg" viewBox="0 0 24 24">\n                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>\n              </svg>\n            </span>\n          </div>\n        </div>\n      </div>\n    `,i=Y()('#dynamicsTimeline'),c=Y()(o);i.find('.dynamics-empty').remove(),c.hide(),i.prepend(c),c.fadeIn(300)}formatContent(e){let t=e;return t=t.replace(/https?:\/\/[^\s]+/g,e=>`<a href="${e}" target="_blank" class="dynamics-link">${e}</a>`),t=t.replace(/@(\w+)/g,'<span class="dynamics-mention">@$1</span>'),t=t.replace(/#([^\s]+)/g,'<span class="dynamics-hashtag">#$1</span>'),t}setupUserAvatarListener(){this.globalUserManager.addEventListener('avatar',e=>{const t=Y()('#composerUserAvatar');t.length&&e.newValue&&(t.css('background-image',`url('${e.newValue}')`),this.currentUserAvatar=e.newValue)}),this.globalUserManager.addEventListener('name',e=>{e.newValue&&(Y()('#composerUserName').text(e.newValue),this.currentUserName=e.newValue)})}}class te{soundManager;$commentModal=null;currentPostNo=null;currentReplyTo=null;currentMessageId=null;constructor(e){this.soundManager=e}async findTargetMessage(e,t=null,a='æ“ä½œ'){let s=null,n=null;if(null!==e){const t=getChatMessages(e);if(t&&t.length>0)return s=t[0],n=e,console.log(`âœ… [${a}] ç›´æ¥è·å–æ¥¼å±‚ ${n} æˆåŠŸ`),{message:s,messageId:n};console.warn(`âš ï¸ [${a}] ç›´æ¥è·å–æ¥¼å±‚ ${e} å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ`)}console.log(`ğŸ“‹ [${a}] ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šæœç´¢æ‰€æœ‰æ¶ˆæ¯`);const r=getChatMessages('0-{{lastMessageId}}');if(null!==e&&(s=r.find(t=>t.message_id===e),s))return n=e,console.log(`âœ… [${a}] åœ¨æ‰€æœ‰æ¶ˆæ¯ä¸­æ‰¾åˆ°æ¥¼å±‚ ${n}`),{message:s,messageId:n};if(null!==t&&!s)for(const e of r)if(e.message&&'string'==typeof e.message){if(new RegExp(`\\[åŠ¨æ€_${t}[^\\]]*\\]`,'m').test(e.message))return s=e,n=e.message_id,console.log(`âœ… [${a}] é€šè¿‡åŠ¨æ€ç¼–å·æ‰¾åˆ°æ¥¼å±‚ ${n}`),{message:s,messageId:n}}const o=getChatMessages(-1);return o&&o.length>0?(s=o[0],n=s.message_id,console.log(`â„¹ï¸ [${a}] ä½¿ç”¨å½“å‰æ¥¼å±‚ ${n} ä½œä¸ºå…œåº•`),{message:s,messageId:n}):null}initialize(){this.initializeCommentClickHandler(),this.initializeReplyClickHandler(),this.initializeLongPressHandler(),this.createCommentModal()}initializeCommentClickHandler(){Y()('#dynamicsInterface').off('click.comment').on('click.comment','.dynamics-post-action[data-action="comment"]',e=>{e.preventDefault(),e.stopPropagation();const t=Y()(e.currentTarget).closest('.dynamics-post');if(!t.length)return;let a=null;const s=(t.attr('data-post-id')||'').match(/^dynamics_(\d+)/);if(s&&(a=parseInt(s[1],10)),!a){const e=t.attr('data-post-no');e&&(a=parseInt(e,10))}if(!a)return void console.warn('è¯„è®ºå¤±è´¥ï¼šæœªèƒ½è§£æåŠ¨æ€ç¼–å·');const n=t.attr('data-message-id'),r=n?parseInt(n,10):null;this.soundManager?.playSound&&this.soundManager.playSound('emoji'),this.showCommentModal(a,null,r)})}initializeReplyClickHandler(){Y()('#dynamicsInterface').off('click.reply').on('click.reply','.dynamics-comment',e=>{e.preventDefault(),e.stopPropagation();const t=Y()(e.currentTarget),a=t.closest('.dynamics-post');if(!a.length)return;let s=null;const n=(a.attr('data-post-id')||'').match(/^dynamics_(\d+)/);if(n&&(s=parseInt(n[1],10)),!s){const e=a.attr('data-post-no');e&&(s=parseInt(e,10))}if(!s)return void console.warn('å›å¤å¤±è´¥ï¼šæœªèƒ½è§£æåŠ¨æ€ç¼–å·');const r=a.attr('data-message-id'),o=r?parseInt(r,10):null,i=t.find('.dynamics-comment-name').first().text().trim();i&&(this.soundManager?.playSound&&this.soundManager.playSound('click'),this.showCommentModal(s,i,o))})}initializeLongPressHandler(){let e=null,t=!1;Y()('#dynamicsInterface').off('mousedown.commentDelete touchstart.commentDelete').on('mousedown.commentDelete touchstart.commentDelete','.dynamics-comment',a=>{const s=Y()(a.currentTarget),n=s.closest('.dynamics-post');this.checkIfUserComment(n,s).then(t=>{if(!t)return e&&(clearTimeout(e),e=null),void s.removeClass('comment-long-pressing')}),t=!1,s.addClass('comment-long-pressing'),e=setTimeout(async()=>{t=!0,s.removeClass('comment-long-pressing'),confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')&&await this.deleteComment(n,s)},800)}).off('mouseup.commentDelete touchend.commentDelete mouseleave.commentDelete').on('mouseup.commentDelete touchend.commentDelete mouseleave.commentDelete','.dynamics-comment',a=>{e&&(clearTimeout(e),e=null),Y()(a.currentTarget).removeClass('comment-long-pressing'),t&&(a.preventDefault(),a.stopPropagation(),t=!1)})}async checkIfUserComment(e,t){try{if('true'===t.attr('data-is-user'))return!0;const a=e.attr('data-post-id')||'';let s=null;const n=a.match(/^dynamics_(\d+)/);if(n&&(s=parseInt(n[1],10)),!s){const t=e.attr('data-post-no');t&&(s=parseInt(t,10))}if(!s)return!1;const r=e.attr('data-message-id'),o=r?parseInt(r,10):null,i=t.find('.dynamics-comment-text').text().trim(),c=await this.findTargetMessage(o,s,'æ£€æŸ¥è¯„è®º');if(!c)return!1;const l=c.message.message||'',d=(e=>e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'))(i),h=new RegExp(`^\\[è¯„è®º_${s}\\|user(@[^|]+)?\\|${d}\\|[^\\]]+\\]\\s*$`,'m').test(l);return h?console.log('âœ… [æ£€æŸ¥è¯„è®º] ç¡®è®¤æ˜¯ç”¨æˆ·çš„è¯„è®º'):console.log('âŒ [æ£€æŸ¥è¯„è®º] ä¸æ˜¯ç”¨æˆ·çš„è¯„è®º'),h}catch(e){return console.error('æ£€æŸ¥ç”¨æˆ·è¯„è®ºå¤±è´¥:',e),!1}}async deleteComment(e,t){try{const a=e.attr('data-post-id')||'';let s=null;const n=a.match(/^dynamics_(\d+)/);if(n&&(s=parseInt(n[1],10)),!s){const t=e.attr('data-post-no');t&&(s=parseInt(t,10))}if(!s)return void console.warn('åˆ é™¤å¤±è´¥ï¼šæœªèƒ½è§£æåŠ¨æ€ç¼–å·');const r=e.attr('data-message-id'),o=r?parseInt(r,10):null,i=t.find('.dynamics-comment-text').text().trim(),c=await this.findTargetMessage(o,s,'åˆ é™¤');if(!c)return;let l=c.message.message||'';const d=c.messageId,h=(e=>e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'))(i),m=new RegExp(`^\\[è¯„è®º_${s}\\|user(@[^|]+)?\\|${h}\\|[^\\]]+\\]\\s*$`,'m');if(m.test(l)){l=l.replace(m,'').replace(/\n{2,}/g,'\n'),await setChatMessages([{message_id:d,message:l}],{refresh:'none'}),console.log(`âœ… [åˆ é™¤] æˆåŠŸåˆ é™¤æ¥¼å±‚ ${d} ä¸­çš„è¯„è®º`),t.fadeOut(300,function(){Y()(this).remove();const t=e.find('.dynamics-comments');0===t.children().length&&t.remove()}),this.soundManager?.playSound&&this.soundManager.playSound('delete');try{const e={messageId:d,postNo:s,type:'comment',action:'remove'};document.dispatchEvent(new CustomEvent('dynamicsInteraction',{detail:e}))}catch(e){console.warn('âš ï¸ æ´¾å‘è¯„è®ºåˆ é™¤äº‹ä»¶å¤±è´¥:',e)}}else console.warn(`âš ï¸ [åˆ é™¤] åœ¨æ¥¼å±‚ ${d} ä¸­æœªæ‰¾åˆ°è¦åˆ é™¤çš„è¯„è®º`)}catch(e){console.error('åˆ é™¤è¯„è®ºå¤±è´¥:',e)}}createCommentModal(){this.$commentModal&&this.$commentModal.remove();this.$commentModal=Y()('\n      <div class="dynamics-comment-modal" style="display: none;">\n        <div class="dynamics-comment-backdrop"></div>\n        <div class="dynamics-comment-dialog">\n          <div class="dynamics-comment-header">\n            <span class="dynamics-comment-title">å‘è¡¨è¯„è®º</span>\n            <button class="dynamics-comment-close">âœ•</button>\n          </div>\n          <div class="dynamics-comment-body">\n            <div class="dynamics-comment-reply-info" style="display: none;">\n              å›å¤ç»™: <span class="dynamics-comment-reply-name"></span>\n            </div>\n            <textarea class="dynamics-comment-input" \n                      placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." \n                      rows="4"></textarea>\n          </div>\n          <div class="dynamics-comment-footer">\n            <button class="dynamics-comment-cancel">å–æ¶ˆ</button>\n            <button class="dynamics-comment-submit">å‘é€</button>\n          </div>\n        </div>\n      </div>\n    '),Y()('#dynamicsInterface').append(this.$commentModal),this.bindModalEvents()}bindModalEvents(){this.$commentModal&&(this.$commentModal.find('.dynamics-comment-close').on('click',()=>{this.hideCommentModal()}),this.$commentModal.find('.dynamics-comment-cancel').on('click',()=>{this.hideCommentModal()}),this.$commentModal.find('.dynamics-comment-submit').on('click',()=>{this.submitComment()}),this.$commentModal.find('.dynamics-comment-backdrop').on('click',()=>{this.hideCommentModal()}),this.$commentModal.find('.dynamics-comment-dialog').on('click',e=>{e.stopPropagation()}),this.$commentModal.find('.dynamics-comment-input').on('keydown',e=>{e.ctrlKey&&13===e.keyCode&&(e.preventDefault(),this.submitComment())}))}showCommentModal(e,t,a=null){this.$commentModal||this.createCommentModal(),this.currentPostNo=e,this.currentReplyTo=t,this.currentMessageId=a,t?(this.$commentModal?.find('.dynamics-comment-reply-info').show(),this.$commentModal?.find('.dynamics-comment-reply-name').text(t),this.$commentModal?.find('.dynamics-comment-title').text('å›å¤è¯„è®º')):(this.$commentModal?.find('.dynamics-comment-reply-info').hide(),this.$commentModal?.find('.dynamics-comment-title').text('å‘è¡¨è¯„è®º')),this.$commentModal?.find('.dynamics-comment-input').val(''),this.$commentModal?.fadeIn(200),setTimeout(()=>{this.$commentModal?.find('.dynamics-comment-input').focus()},250)}hideCommentModal(){this.$commentModal?.hide(),this.currentPostNo=null,this.currentReplyTo=null,this.currentMessageId=null,this.$commentModal?.find('.dynamics-comment-input').val('')}async submitComment(){const e=this.$commentModal?.find('.dynamics-comment-input').val();if(!e?.trim())return this.$commentModal?.find('.dynamics-comment-input').addClass('shake'),void setTimeout(()=>{this.$commentModal?.find('.dynamics-comment-input').removeClass('shake')},500);if(null===this.currentPostNo)return void console.error('è¯„è®ºå¤±è´¥ï¼šæœªè®¾ç½®åŠ¨æ€ç¼–å·');const t=this.$commentModal?.find('.dynamics-comment-submit');t?.prop('disabled',!0).text('å‘é€ä¸­...');try{const t='user',a=(e=>`${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`)(new Date);let s;s=this.currentReplyTo?`[è¯„è®º_${this.currentPostNo}|${t}@${this.currentReplyTo}|${e}|${a}]`:`[è¯„è®º_${this.currentPostNo}|${t}|${e}|${a}]`;const n=await this.findTargetMessage(this.currentMessageId,this.currentPostNo,'æäº¤è¯„è®º');if(!n)throw new Error('æ— æ³•æ‰¾åˆ°ç›®æ ‡æ¥¼å±‚');const r=n.message,o=n.messageId;let i=r.message||'';const c='[/åŠ¨æ€]',l=i.indexOf(c);if(-1===l)throw console.error(`æ¥¼å±‚ ${o} æœªæ‰¾åˆ°[åŠ¨æ€]å®¹å™¨ï¼Œæ¶ˆæ¯å†…å®¹:`,i.substring(0,200)),new Error(`æ¥¼å±‚ ${o} æœªæ‰¾åˆ°[åŠ¨æ€]å®¹å™¨ï¼Œå¯èƒ½é€‰æ‹©äº†é”™è¯¯çš„æ¥¼å±‚`);const d=i.slice(0,l).replace(/\s*$/,''),h=i.slice(l);i=`${d}\n${s}\n${h}`,await setChatMessages([{message_id:o,message:i}],{refresh:'none'}),console.log(`âœ… [æäº¤è¯„è®º] æˆåŠŸæ›´æ–°æ¥¼å±‚ ${o}`);const m=this.currentPostNo,g=this.currentReplyTo,u=o;this.hideCommentModal(),await this.addCommentToUI(m,e,g,u);try{const t={messageId:o,postNo:this.currentPostNo,type:'comment',action:'add',user:'user',content:e,timestamp:a};document.dispatchEvent(new CustomEvent('dynamicsInteraction',{detail:t}))}catch(e){console.warn('âš ï¸ æ´¾å‘è¯„è®ºäº‹ä»¶å¤±è´¥:',e)}}catch(e){console.error('æäº¤è¯„è®ºå¤±è´¥:',e)}finally{t?.prop('disabled',!1).text('å‘é€')}}destroy(){Y()('#dynamicsInterface').off('.comment'),Y()('#dynamicsInterface').off('.reply'),Y()('#dynamicsInterface').off('.commentDelete'),this.$commentModal&&(this.$commentModal.remove(),this.$commentModal=null),this.currentPostNo=null,this.currentReplyTo=null,this.currentMessageId=null}async addCommentToUI(e,t,a,s){const n=(await triggerSlash('/pass {{user}}')||'').trim()||'ç”¨æˆ·';let r;if('number'!=typeof s||isNaN(s)?r=Y()(`.dynamics-post[data-post-id="dynamics_${e}"]`).last():(r=Y()(`.dynamics-post[data-post-id="dynamics_${e}"][data-message-id="${s}"]`),r.length||(r=Y()(`#characterProfileInterface .dynamics-post[data-post-id="dynamics_${e}"]`).last()),r.length||(r=Y()(`.dynamics-post[data-post-id="dynamics_${e}"]`).last())),!r.length)return;let o=r.find('.dynamics-comments').first();o.length||(o=Y()('<div>',{class:'dynamics-comments'}),r.append(o));const i=Y()('<div>',{class:'dynamics-comment dynamics-comment-qq'});i.attr('data-is-user','true'),i.attr('data-post-no',e.toString()),i.attr('data-comment-content',t);const c=Y()('<div>',{class:'dynamics-comment-content'});a?c.append(Y()('<span>',{class:'dynamics-comment-name',text:n}),Y()('<span>',{text:' å›å¤ ',class:'dynamics-comment-reply-indicator'}),Y()('<span>',{class:'dynamics-comment-name dynamics-comment-reply-target',text:a}),Y()('<span>',{text:'ï¼š'}),Y()('<span>',{class:'dynamics-comment-text',text:t})):c.append(Y()('<span>',{class:'dynamics-comment-name',text:n}),Y()('<span>',{text:'ï¼š'}),Y()('<span>',{class:'dynamics-comment-text',text:t})),i.append(c),i.hide(),o.append(i),i.fadeIn(300),i.trigger('comment:added')}}class ae{isDeleteMode=!1;selectedPosts=new Set;soundManager;commentHandler;constructor(e){this.soundManager=e,this.commentHandler=new te(e)}toggleDeleteMode(){this.isDeleteMode=!this.isDeleteMode,this.isDeleteMode?this.enterDeleteMode():this.exitDeleteMode()}isInDeleteMode(){return this.isDeleteMode}enterDeleteMode(){console.log('ğŸ“ è¿›å…¥æ‰¹é‡åˆ é™¤æ¨¡å¼'),this.selectedPosts.clear(),Y()('#dynamicsInterface').addClass('delete-mode'),this.showDeleteToolbar(),this.addSelectionCheckboxes(),this.soundManager?.playSound&&this.soundManager.playSound('click'),toastr.info('å·²è¿›å…¥åˆ é™¤æ¨¡å¼ï¼Œç‚¹å‡»åŠ¨æ€å¯é€‰ä¸­')}exitDeleteMode(){console.log('ğŸ“ é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼'),Y()('#dynamicsInterface').removeClass('delete-mode'),this.hideDeleteToolbar(),this.removeSelectionCheckboxes(),this.selectedPosts.clear(),this.soundManager?.playSound&&this.soundManager.playSound('click')}showDeleteToolbar(){Y()('.dynamics-delete-toolbar').remove();Y()('.dynamics-app-container').append('\n      <div class="dynamics-delete-toolbar">\n        <button class="select-all-btn">å…¨é€‰</button>\n        <button class="delete-selected-btn" disabled>åˆ é™¤é€‰ä¸­</button>\n        <button class="cancel-delete-btn">å–æ¶ˆ</button>\n      </div>\n    '),this.bindToolbarEvents()}hideDeleteToolbar(){Y()('.dynamics-delete-toolbar').fadeOut(200,function(){Y()(this).remove()})}addSelectionCheckboxes(){Y()('.dynamics-post').each((e,t)=>{const a=Y()(t),s=a.attr('data-post-id'),n=a.attr('data-message-id')||'';if(!s)return;const r=Y()('<div>',{class:'dynamics-selection-checkbox','data-post-id':s,'data-message-id':n});r.html('\n        <div class="checkbox-circle unchecked">\n          <svg viewBox="0 0 24 24" fill="none">\n            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>\n          </svg>\n        </div>\n        <div class="checkbox-circle checked" style="display: none;">\n          <svg viewBox="0 0 24 24" fill="none">\n            <circle cx="12" cy="12" r="10" fill="#667eea"/>\n            <path d="M8 12l3 3 5-6" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n        </div>\n      '),a.find('.dynamics-post-header').append(r),r.on('click',e=>{e.stopPropagation(),this.togglePostSelection(s,n)}),a.on('click.deleteMode',e=>{0===Y()(e.target).closest('.dynamics-post-actions, .dynamics-comments').length&&this.togglePostSelection(s,n)})})}removeSelectionCheckboxes(){Y()('.dynamics-selection-checkbox').fadeOut(200,function(){Y()(this).remove()}),Y()('.dynamics-post').off('.deleteMode')}togglePostSelection(e,t){const a=`${t}_${e}`,s=Y()(`.dynamics-post[data-post-id="${e}"]`),n=s.find('.dynamics-selection-checkbox');this.selectedPosts.has(a)?(this.selectedPosts.delete(a),s.removeClass('selected'),n.find('.checkbox-circle.checked').hide(),n.find('.checkbox-circle.unchecked').show()):(this.selectedPosts.add(a),s.addClass('selected'),n.find('.checkbox-circle.unchecked').hide(),n.find('.checkbox-circle.checked').show()),this.updateSelectionCount(),this.soundManager?.playSound&&this.soundManager.playSound('click')}updateSelectionCount(){const e=this.selectedPosts.size;Y()('.delete-selected-btn').prop('disabled',0===e)}bindToolbarEvents(){Y()('.select-all-btn').on('click',()=>{this.selectAllPosts()}),Y()('.delete-selected-btn').on('click',()=>{this.deleteSelectedPosts()}),Y()('.cancel-delete-btn').on('click',()=>{this.exitDeleteMode()})}selectAllPosts(){this.selectedPosts.size===Y()('.dynamics-post').length?(this.selectedPosts.clear(),Y()('.dynamics-post').removeClass('selected'),Y()('.dynamics-selection-checkbox .checkbox-circle.checked').hide(),Y()('.dynamics-selection-checkbox .checkbox-circle.unchecked').show(),Y()('.select-all-btn').text('å…¨é€‰')):(Y()('.dynamics-post').each((e,t)=>{const a=Y()(t),s=a.attr('data-post-id'),n=a.attr('data-message-id')||'';if(s){const e=`${n}_${s}`;this.selectedPosts.add(e),a.addClass('selected');const t=a.find('.dynamics-selection-checkbox');t.find('.checkbox-circle.unchecked').hide(),t.find('.checkbox-circle.checked').show()}}),Y()('.select-all-btn').text('å–æ¶ˆå…¨é€‰')),this.updateSelectionCount()}async deleteSelectedPosts(){const e=this.selectedPosts.size;if(0!==e&&confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${e} æ¡åŠ¨æ€å—ï¼Ÿ\næ³¨æ„ï¼šåˆ é™¤åå°†åŒæ—¶åˆ é™¤ç›¸å…³çš„è¯„è®ºå’Œç‚¹èµè®°å½•ã€‚`)){Y()('.delete-selected-btn').prop('disabled',!0).text('åˆ é™¤ä¸­...');try{const t=new Map;for(const e of this.selectedPosts){const a=e.split('_'),s=a[0],n=s?parseInt(s):null,r=a.slice(1).join('_'),o=r.match(/dynamics_(\d+)/);if(!o){console.warn(`æ— æ³•è§£æåŠ¨æ€ID: ${r}`);continue}const i=parseInt(o[1]);t.has(n)||t.set(n,new Set),t.get(n).add(i)}const a=[];for(const[e,s]of t){let t=null,n=null;const r=Array.from(s)[0],o=await this.commentHandler.findTargetMessage(null===e?null:e,r,'æ‰¹é‡åˆ é™¤');if(!o){console.warn(`æœªæ‰¾åˆ°åŒ…å«åŠ¨æ€ #${r} çš„æ¥¼å±‚`);continue}t=o.message,n=o.messageId;let i=t.message||'';for(const e of s){console.log(`ğŸ—‘ï¸ åˆ é™¤æ¥¼å±‚ ${n} ä¸­çš„åŠ¨æ€ #${e}`);const t=new RegExp(`^\\[åŠ¨æ€_${e}\\|[^\\]]+\\]\\s*$`,'gm');i=i.replace(t,'');const a=new RegExp(`^\\[è¯„è®º_${e}\\|[^\\]]+\\]\\s*$`,'gm');i=i.replace(a,'');const s=new RegExp(`^\\[ç‚¹èµ_${e}\\|[^\\]]+\\]\\s*$`,'gm');i=i.replace(s,'')}if(i=i.replace(/\n{3,}/g,'\n\n'),i.includes('[åŠ¨æ€]')&&i.includes('[/åŠ¨æ€]')){const e=i.match(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/);e&&''===e[1].trim()&&(i=i.replace(/\[åŠ¨æ€\]\s*\[\/åŠ¨æ€\]\s*/g,''))}await setChatMessages([{message_id:n,message:i}],{refresh:'none'}),console.log(`âœ… æˆåŠŸåˆ é™¤æ¥¼å±‚ ${n} ä¸­çš„ ${s.size} æ¡åŠ¨æ€`),a.push({messageId:n,postNos:Array.from(s)})}try{for(const e of a){const t={type:'post',action:'remove',messageId:e.messageId,postNos:e.postNos};document.dispatchEvent(new CustomEvent('dynamicsInteraction',{detail:t}))}}catch(e){console.warn('âš ï¸ æ´¾å‘åŠ¨æ€åˆ é™¤äº‹ä»¶å¤±è´¥:',e)}for(const e of this.selectedPosts){const t=e.split('_').slice(1).join('_');console.log(`ğŸ—‘ï¸ ä»UIä¸­ç§»é™¤åŠ¨æ€: ${t}`);const a=Y()(`.dynamics-post[data-post-id="${t}"]`);a.length>0?a.fadeOut(300,function(){Y()(this).remove(),console.log(`âœ… å·²ä»UIä¸­ç§»é™¤åŠ¨æ€: ${t}`),0===Y()('.dynamics-post').length&&Y()('#dynamicsTimeline').html('\n                <div class="dynamics-empty">\n                  <div class="dynamics-empty-icon">ğŸ“­</div>\n                  <div class="dynamics-empty-text">æš‚æ— åŠ¨æ€</div>\n                  <div class="dynamics-empty-subtext">å¿«å»å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§ï½</div>\n                </div>\n              ')}):console.warn(`âš ï¸ æœªæ‰¾åˆ°è¦åˆ é™¤çš„åŠ¨æ€å…ƒç´ : ${t}`)}this.soundManager?.playSound&&this.soundManager.playSound('delete'),toastr.success(`æˆåŠŸåˆ é™¤ ${e} æ¡åŠ¨æ€`),this.exitDeleteMode()}catch(e){console.error('åˆ é™¤åŠ¨æ€å¤±è´¥:',e),toastr.error('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•'),Y()('.delete-selected-btn').prop('disabled',!1).text('åˆ é™¤é€‰ä¸­')}}}}class se{soundManager;commentHandler;deleteManager;globalUserManager;constructor(e){this.soundManager=e,this.commentHandler=new te(e),this.deleteManager=new ae(e),this.globalUserManager=g.GlobalUserManager.getInstance(),this.initializeClickSound()}initializeClickSound(){this.soundManager&&this.soundManager.playSound}initializeEventListeners(){this.initializeClickEffects(),this.initializePostInteractions(),this.initializeProfileClickHandlers(),this.initializeNavProfileOpenHandler(),this.initializeSettingsHandler(),this.initializeLogoHandler(),this.commentHandler.initialize()}initializeClickEffects(){const e=Y()('#dynamicsInterface');e.off('click.dynamics'),e.on('click.dynamics',['.dynamics-nav-settings','.dynamics-post-avatar','.dynamics-post-image','.dynamics-post-content','.dynamics-comment','.dynamics-comment-avatar'].join(', '),e=>{this.handleClickEffect(e)})}handleClickEffect(e){const t=Y()(e.currentTarget);this.playClickSound(),t.css('transform','scale(0.95)'),setTimeout(()=>{t.css('transform','')},100)}initializePostInteractions(){Y()('#dynamicsInterface').off('click.postImage').on('click.postImage','.dynamics-post-image',function(){const e=Y()(this);let t=e.find('.dynamics-image-description');if(t.length)t.fadeOut(300,function(){Y()(this).remove()});else{const a=e.data('description')||'è¿™æ˜¯ä¸€å¼ ç¾ä¸½çš„å›¾ç‰‡ âœ§Ë–Â°';t=Y()('<div>',{class:'dynamics-image-description',text:a}),e.css('position','relative'),t.hide().appendTo(e).fadeIn(300)}}),Y()('#dynamicsInterface').off('click.postLike').on('click.postLike','.dynamics-post-action[data-action="like"]',async e=>{const t=Y()(e.currentTarget),a=t.closest('.dynamics-post');if(!a.length)return;let s=null;const n=(a.attr('data-post-id')||'').match(/^dynamics_(\d+)/);if(n&&(s=parseInt(n[1],10)),!s){const e=a.attr('data-post-no');e&&(s=parseInt(e,10))}if(s)try{const e=(await triggerSlash('/pass {{user}}')||'').trim()||'ç”¨æˆ·',n='user',r=e=>e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),o=e=>`${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`,i=a.attr('data-message-id'),c=i?parseInt(i,10):null,l=await this.commentHandler.findTargetMessage(c,s,'ç‚¹èµ');if(!l)return void console.warn('ç‚¹èµå¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°ç›®æ ‡æ¥¼å±‚');const d=l.message,h=l.messageId;let m=d.message||'';const g=new RegExp(`^\\[ç‚¹èµ_${s}\\|\\s*${r(n)}\\s*\\|[^\\]]+\\]\\s*$`,'m'),u=!g.test(m),p='[åŠ¨æ€]',v='[/åŠ¨æ€]',y=m.indexOf(p),f=m.indexOf(v);if(-1===y||-1===f||f<=y)return void console.warn('ç‚¹èµå¤±è´¥ï¼šå½“å‰æ¥¼å±‚æœªæ‰¾åˆ°[åŠ¨æ€]å®¹å™¨');if(u){const e=o(new Date),t=m.indexOf(v,y),a=m.slice(0,t).replace(/\s*$/,''),r=m.slice(t);m=`${a}\n[ç‚¹èµ_${s}|${n}|${e}]\n${r}`,await setChatMessages([{message_id:h,message:m}],{refresh:'none'})}else{const e=new RegExp(`^\\[ç‚¹èµ_${s}\\|\\s*${r(n)}\\s*\\|[^\\]]+\\]\\s*$`,'gm');m=m.replace(e,'').replace(/\n{3,}/g,'\n\n'),await setChatMessages([{message_id:h,message:m}],{refresh:'none'})}let C=a.find('.dynamics-liked-by .liked-user').map((e,t)=>Y()(t).text().trim()).get().slice();u?C.includes(e)||C.push(e):C=C.filter(t=>t!==e);(s=>{let n=a.find('.dynamics-liked-by');if(0===s.length)return n.length&&n.remove(),void t.removeClass('liked');n.length||(n=Y()('<div>',{class:'dynamics-liked-by'}),a.find('.dynamics-post-actions').after(n)),n.empty().html('<svg class="liked-heart-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'),s.forEach((e,t)=>{t>0&&n.append(Y()('<span>',{text:'ã€'})),n.append(Y()('<span>',{class:'liked-user',text:e}))}),t.toggleClass('liked',s.includes(e))})(C);try{const e={messageId:h,postNo:s,type:'like',action:u?'add':'remove',user:n,timestamp:o(new Date)};document.dispatchEvent(new CustomEvent('dynamicsInteraction',{detail:e}))}catch(e){console.warn('âš ï¸ æ´¾å‘ç‚¹èµäº‹ä»¶å¤±è´¥:',e)}this.soundManager&&this.soundManager.playSound&&this.soundManager.playSound('emoji')}catch(e){console.error('å¤„ç†ç‚¹èµå¤±è´¥:',e)}else console.warn('ç‚¹èµå¤±è´¥ï¼šæœªèƒ½è§£æåŠ¨æ€ç¼–å·')})}initializeProfileClickHandlers(){const e=Y()('#dynamicsInterface');e.off('click.postName').on('click.postName','.dynamics-post-name',function(e){e.stopPropagation();const t=Y()(this);t.css('cursor','pointer');const a=t.text().trim();a&&Y()(document).trigger('dynamics:profile:click',{username:a})}),e.off('click.commentName').on('click.commentName','.dynamics-comment-name',function(e){e.stopPropagation();const t=Y()(this);t.css('cursor','pointer');const a=t.text().trim();a&&Y()(document).trigger('dynamics:profile:click',{username:a})}),e.off('click.postAvatar').on('click.postAvatar','.dynamics-post-avatar',function(e){e.stopPropagation();const t=Y()(this).closest('.dynamics-post-header').find('.dynamics-post-name').first().text().trim();t&&(Y()(this).css('cursor','pointer'),Y()(document).trigger('dynamics:profile:click',{username:t}))})}initializeNavProfileOpenHandler(){Y()('.dynamics-nav-profile').off('click.navProfileOpen').on('click.navProfileOpen',async e=>{e.preventDefault(),e.stopPropagation();try{this.playClickSound?.()}catch(e){}let t='';try{const e=this.globalUserManager?.getCurrentUserData();t=(e?.name||'').trim()}catch(e){}if(!t)try{t=(await triggerSlash('/pass {{user}}')||'').trim()}catch(e){}t||(t='ç”¨æˆ·'),Y()(document).trigger('dynamics:profile:click',{username:t})})}initializeSettingsHandler(){Y()('.dynamics-nav-settings').off('click.settings').on('click.settings',()=>{this.deleteManager.toggleDeleteMode();const e=Y()('.dynamics-nav-settings');this.deleteManager.isInDeleteMode()?e.addClass('delete-mode-active'):e.removeClass('delete-mode-active')})}initializeLogoHandler(){Y()('.dynamics-nav-logo').off('click.logo').on('click.logo',()=>{const e=Y()('.new-dynamic-btn');this.soundManager?.playSound&&this.soundManager.playSound('emoji'),e.length&&(e.hasClass('hidden')?(e.removeClass('hidden hiding').addClass('showing'),setTimeout(()=>{e.removeClass('showing'),toastr.info('å‘å¸ƒæŒ‰é’®å·²æ˜¾ç¤º','',{timeOut:1e3})},300)):(e.removeClass('showing').addClass('hiding'),setTimeout(()=>{e.addClass('hidden').removeClass('hiding'),toastr.info('å‘å¸ƒæŒ‰é’®å·²éšè—','',{timeOut:1e3})},300)))})}initializeDynamicsBackButton(){Y()('#dynamicsBackBtn').off('click.back').on('click.back',e=>{e.preventDefault(),e.stopPropagation(),this.handleDynamicsBackClick()})}handleDynamicsBackClick(){console.log('åŠ¨æ€è¿”å›æŒ‰é’®è¢«ç‚¹å‡»'),this.soundManager?.playSound&&this.soundManager.playSound('click'),Y()(document).trigger('dynamics:back',{source:'dynamicsBackButton'})}playClickSound(){this.soundManager&&this.soundManager.playSound&&this.soundManager.playSound('click')}destroy(){Y()('#dynamicsInterface').off('.dynamics'),Y()('#dynamicsInterface').off('.postImage'),Y()('#dynamicsInterface').off('.postName'),Y()('#dynamicsInterface').off('.commentName'),Y()('.dynamics-nav-settings').off('.settings'),Y()('.dynamics-nav-logo').off('.logo'),Y()('.dynamics-nav-profile').off('.navProfileOpen'),Y()('#dynamicsBackBtn').off('.back'),this.commentHandler.destroy(),this.deleteManager.isInDeleteMode()&&this.deleteManager.toggleDeleteMode()}}var ne=a(56);class re{getDynamicsData;soundManager;getLatestSignature;$container=null;isOpen=!1;targetName='';actualUserName=null;globalUserManager;contactLorebookManager=null;timeInterval=null;onContactUpdatedBound;onHeroUpdatedBound;onRefreshBound;onInteractionBound;constructor(e){this.getDynamicsData=e.getDynamicsData,this.soundManager=e.soundManager,this.getLatestSignature=e.getLatestSignature,this.globalUserManager=g.GlobalUserManager.getInstance(),this.onContactUpdatedBound=this.onContactUpdated.bind(this),this.onHeroUpdatedBound=this.onHeroUpdated.bind(this),this.onRefreshBound=this.refresh.bind(this),this.onInteractionBound=this.onInteractionUpdate.bind(this)}async open(e){const t=(e||'').trim();if(!t)return;if(this.isOpen)return this.targetName=t,await this.ensureActualUserName(),void this.render();this.targetName=t,await this.ensureActualUserName(),await this.ensureContactLorebook();const a=this.buildOverlayHtml(),s=Y()('#dynamicsInterface');s.length?(s.append(a),this.$container=Y()('#characterProfileInterface'),this.bindEvents(),this.render(),this.startTimeUpdate(),this.updateStatusBarColor(),this.isOpen=!0):console.warn('[CharacterProfile] dynamicsInterface ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰“å¼€è§’è‰²ä¸»é¡µ')}close(){this.isOpen&&(this.playClick(),this.stopTimeUpdate(),this.unbindEvents(),this.$container?.remove(),this.$container=null,this.isOpen=!1)}async refresh(){this.isOpen&&(await this.ensureActualUserName(),this.render())}bindEvents(){this.$container?.find('#cpBackBtn').on('click',()=>this.close()),this.$container?.find('.cp-hero').on('click',e=>{Y()(e.target).closest('#cpBackBtn').length||this.openHeroCropper()}),document.addEventListener('contactUpdated',this.onContactUpdatedBound),document.addEventListener('contactHeroUpdated',this.onHeroUpdatedBound),Y()(document).on('dynamics:refresh',this.onRefreshBound),document.addEventListener('dynamicsInteraction',this.onInteractionBound),document.addEventListener('dynamicsPublished',this.onInteractionBound)}unbindEvents(){this.$container?.find('#cpBackBtn').off('click'),this.$container?.find('.cp-hero').off('click'),document.removeEventListener('contactUpdated',this.onContactUpdatedBound),Y()(document).off('dynamics:refresh',this.onRefreshBound),document.removeEventListener('dynamicsInteraction',this.onInteractionBound),document.removeEventListener('dynamicsPublished',this.onInteractionBound),document.removeEventListener('contactHeroUpdated',this.onHeroUpdatedBound)}onInteractionUpdate(e){const t=e;t?.detail&&'signature'===t.detail.scope||this.render()}onContactUpdated(e){try{const t=e,{oldName:a='',newName:s='',newAvatar:n=''}=t?.detail||{},r=new Set([a,s].filter(Boolean));this.targetName&&r.has(this.targetName)&&(s&&s!==this.targetName&&(this.targetName=s),this.updateHero(n||''),this.render())}catch(e){console.warn('[CharacterProfile] onContactUpdated å¤„ç†å¤±è´¥:',e)}}render(){if(!this.$container?.length)return;this.updateHero();const e=this.$container.find('#characterProfileTimeline');if(!e.length)return;const t=this.getPostsByAuthor(this.targetName);if(!t.length)return void e.html(this.renderEmpty());const a=[...t].sort((e,t)=>{const a='number'==typeof e.messageId?e.messageId:Number.NEGATIVE_INFINITY,s='number'==typeof t.messageId?t.messageId:Number.NEGATIVE_INFINITY;if(s!==a)return s-a;const n='number'==typeof e.no?e.no:Number.NEGATIVE_INFINITY,r='number'==typeof t.no?t.no:Number.NEGATIVE_INFINITY;if(r!==n)return r-n;const o=this.safeParseTime(e.timestamp);return this.safeParseTime(t.timestamp)-o}).map(e=>this.renderPost(e)).join('');e.html(a),e.find('.dynamics-post-name, .dynamics-post-avatar').css('cursor','default')}updateHero(e){if(!this.$container?.length)return;const t=this.targetNameForDisplay(this.targetName),a=this.getPostsByAuthor(this.targetName),s=e||this.getAvatarForName(this.targetName),n=this.getBackgroundForName(this.targetName,s);this.$container.find('.cp-hero-bg').css('background-image',`url('${n}')`),this.$container.find('.cp-avatar').css('background-image',`url('${s}')`),this.$container.find('.cp-name').text(t),this.$container.find('.cp-stats').text(`å…± ${a.length} æ¡åŠ¨æ€`);const r=this.$container.find('.cp-signature');try{let e=this.getLatestSignature?.(t)||this.getLatestSignature?.(this.targetName)||null;e&&e.content||!this.actualUserName||t!==this.actualUserName||(e=this.getLatestSignature?.('user')||e),e&&e.content?(r.html(`<span>${this.escapeHtml(e.content)}</span>`),e.timeHHmm?r.attr('title',`ç­¾åæ—¶é—´ ${e.timeHHmm}`):r.removeAttr('title'),r.show(),setTimeout(()=>{const e=r.find('span');if(e.length){const t=parseFloat(e.css('line-height'))||20,a=e[0].scrollHeight;Math.round(a/t)>1?r.addClass('multiline'):r.removeClass('multiline')}},0)):this.actualUserName&&t===this.actualUserName?(r.html('<span class="signature-placeholder">ç‚¹å‡»è®¾ç½®ç­¾å</span>'),r.show(),r.addClass('editable')):r.hide().html('').removeAttr('title'),this.actualUserName&&t===this.actualUserName&&(r.off('click').on('click',()=>{const e=r.find('span').not('.signature-placeholder').text().trim(),t=r.hasClass('editable')?'':e;this.editSignature(r,t)}),r.css('cursor','pointer'))}catch(e){r.hide().text('').removeAttr('title')}const o=this.$container.find('.cp-hero'),i=this.normalizeUrl(n)===this.normalizeUrl(s);o.toggleClass('default-blur',i)}getPostsByAuthor(e){const t=this.getDynamicsData();if(!t)return[];const a=(e||'').trim(),s=(this.actualUserName||'').trim(),n=t.posts||[];return a?s&&a===s?n.filter(e=>'user'===e.author?.name||e.author?.name===s):n.filter(e=>e.author?.name===a):[]}renderEmpty(){return'\n      <div class="dynamics-empty">\n        <div class="dynamics-empty-icon">ğŸ“­</div>\n        <div class="dynamics-empty-text">Ta è¿˜æ²¡æœ‰å‘å¸ƒè¿‡åŠ¨æ€</div>\n        <div class="dynamics-empty-subtext">å»çœ‹çœ‹å…¶ä»–äººçš„åŠ¨æ€å§ï½</div>\n      </div>\n    '}renderPost(e){let t=e.author.avatar||'';if('user'===(e.author.name||''))try{const e=this.globalUserManager.getCurrentUserData();e?.avatar&&(t=e.avatar)}catch{}t||(t=this.getAvatarForName(e.author.name||''));const a=this.targetNameForDisplay(e.author.name||''),s=this.formatRelativeTime(e.timestamp),n=this.renderLikedBy(e),r=this.renderComments(e),o=e.image?`<div class="dynamics-post-image" style="background-image: url('${e.image}')" data-description="${this.escapeAttr(e.imageDescription||'')}"></div>`:'',i=this.isPostLikedByCurrentUser(e)?'liked':'',c=void 0!==e.messageId&&null!==e.messageId?` data-message-id="${e.messageId}"`:'';return`\n      <div class="dynamics-post" data-post-id="dynamics_${e.no??e.id}"${c}>\n        <div class="dynamics-post-header">\n          <div class="dynamics-post-avatar" style="background-image: url('${t}')"></div>\n          <div class="dynamics-post-info">\n            <div class="dynamics-post-name">${this.escapeHtml(a)}</div>\n            <div class="dynamics-post-time">${this.escapeHtml(s)}</div>\n          </div>\n        </div>\n\n        <div class="dynamics-post-content">${this.formatContent(e.content)}</div>\n        ${o}\n\n        <div class="dynamics-post-actions">\n          <div class="dynamics-post-action ${i}" data-action="like">\n            <span class="action-icon">\n              <svg class="action-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>\n            </span>\n          </div>\n          <div class="dynamics-post-action" data-action="comment">\n            <span class="action-icon">\n              <svg class="action-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>\n            </span>\n          </div>\n        </div>\n\n        ${n}\n        ${r}\n      </div>\n    `}renderLikedBy(e){const t=e.likedBy||[];if(!t.length)return'';const a=t.map(e=>this.targetNameForDisplay(e.name||e.username||'')).filter(Boolean);if(!a.length)return'';return`<div class="dynamics-liked-by"><svg class="liked-heart-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>${a.map((e,t)=>`${t>0?'<span>ã€</span>':''}<span class="liked-user">${this.escapeHtml(e)}</span>`).join('')}</div>`}renderComments(e){const t=e.comments||[];if(!t.length)return'';return`<div class="dynamics-comments">${t.map(e=>{const t=this.replaceUserWithActualName(this.targetNameForDisplay(e.author.name)),a=this.formatContent(e.content);let s='',n='',r=!1;const o=(t||'').trim();if(o.includes(' å›å¤ ')){const e=o.split(' å›å¤ ');e.length>=2&&(s=e[0].trim(),n=e[1].trim(),r=s.length>0&&n.length>0)}else if(o.includes('@')){const e=o.split('@');e.length>=2&&(s=e[0].trim(),n=e[1].trim(),r=s.length>0&&n.length>0)}if(r){const e=this.replaceUserWithActualName(this.targetNameForDisplay(s)),t=this.replaceUserWithActualName(this.targetNameForDisplay(n));return`\n            <div class="dynamics-comment dynamics-comment-qq">\n              <div class="dynamics-comment-content">\n                <span class="dynamics-comment-name">${this.escapeHtml(e)}</span>\n                <span class="dynamics-comment-reply-indicator"> å›å¤ </span>\n                <span class="dynamics-comment-name dynamics-comment-reply-target">${this.escapeHtml(t)}</span>\n                <span>ï¼š</span>\n                <span class="dynamics-comment-text">${a}</span>\n              </div>\n            </div>\n          `}const i=this.replaceUserWithActualName(this.targetNameForDisplay(o));return`\n          <div class="dynamics-comment dynamics-comment-qq">\n            <div class="dynamics-comment-content">\n              <span class="dynamics-comment-name">${this.escapeHtml(i)}</span>\n              <span>ï¼š</span>\n              <span class="dynamics-comment-text">${a}</span>\n            </div>\n          </div>\n        `}).join('')}</div>`}buildOverlayHtml(){return`\n      <div id="characterProfileInterface" class="character-profile-interface">\n        \x3c!-- çŠ¶æ€æ  --\x3e\n        <div class="cp-status-bar" id="cpStatusBar">\n          <div class="status-bar-left">\n            <span class="status-time">${this.getCurrentTime()}</span>\n          </div>\n          <div class="status-bar-right">\n            \x3c!-- ä¿¡å·å¼ºåº¦å›¾æ ‡ --\x3e\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path>\n            </svg>\n            \x3c!-- WiFiå›¾æ ‡ --\x3e\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path>\n            </svg>\n            \x3c!-- ç”µæ± å›¾æ ‡ --\x3e\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path>\n            </svg>\n          </div>\n        </div>\n        \n        <div class="cp-hero-wrapper">\n          <div class="cp-hero">\n            <div class="cp-hero-bg"></div>\n            <div class="cp-hero-overlay"></div>\n            <button class="cp-back-btn" id="cpBackBtn" title="è¿”å›">\n              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">\n                <path d="M19 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H19v-2z"/>\n              </svg>\n            </button>\n            <div class="cp-hero-info">\n              <div class="cp-name"></div>\n              <div class="cp-stats"></div>\n            </div>\n          </div>\n          <div class="cp-avatar-container">\n            <div class="cp-avatar"></div>\n          </div>\n          <div class="cp-signature" style="display: none;"></div>\n        </div>\n\n        <div class="cp-timeline" id="characterProfileTimeline"></div>\n      </div>\n    `}targetNameForDisplay(e){return'user'===e&&this.actualUserName?this.actualUserName:e||'ç”¨æˆ·'}replaceUserWithActualName(e){const t=this.actualUserName||'';return'user'===e&&t?t:e&&e.startsWith('user@')&&t?e.replace(/^user\b/,t):e}async ensureActualUserName(){if(!this.actualUserName){try{const e=this.globalUserManager.getCurrentUserData();if(e?.name)return void(this.actualUserName=(e.name||'').trim()||'ç”¨æˆ·')}catch{}try{const e=await triggerSlash('/pass {{user}}');this.actualUserName=(e||'').trim()||'ç”¨æˆ·'}catch{this.actualUserName='ç”¨æˆ·'}}}getAvatarForName(e){try{const t=(e||'').trim(),a=(this.actualUserName||'').trim(),s=this.targetNameForDisplay(e);if('user'===t||a&&t===a)try{const e=this.globalUserManager.getCurrentUserData();if(e?.avatar)return e.avatar}catch{}const n=this.getDynamicsData(),r=n?.posts||[],o=r.find(e=>e.author?.name===t&&e.author?.avatar)||(a&&t===a?r.find(e=>'user'===e.author?.name&&e.author?.avatar):void 0);if(o?.author?.avatar)return o.author.avatar;let i=null;try{if(this.contactLorebookManager&&(i=this.contactLorebookManager.getContactAvatar(s),i&&!this.isDefaultAvatarUrl(i)))return i}catch{}try{const e=(0,x.getCharacterItem)('contacts',null),t=(e?.contacts||[]).find(e=>(e?.name||'')===s),a=t?.avatar;if('string'==typeof a&&a.trim()&&!this.isDefaultAvatarUrl(a))return a.trim()}catch{}return i||'https://files.catbox.moe/u8ccy5.jpg'}catch{return'https://files.catbox.moe/u8ccy5.jpg'}}getBackgroundForName(e,t){try{if(this.contactLorebookManager){const t=this.targetNameForDisplay(e),a=this.contactLorebookManager.getContactHero(t);if(a)return a}}catch{}return t||'https://files.catbox.moe/o84j4n.jpg'}isDefaultAvatarUrl(e){try{const t=(e||'').trim().toLowerCase();if(!t)return!1;const a=t.split('#')[0].split('?')[0];return['https://files.catbox.moe/u8ccy5.jpg','./user avatars/user-default.png','/user avatars/user-default.png','user avatars/user-default.png','user-default.png'].map(e=>e.toLowerCase()).some(e=>a.endsWith(e))}catch{return!1}}normalizeUrl(e){try{const t=(e||'').trim();if(!t)return'';const a=t.match(/url\\((['"]?)(.*?)\\1\\)/i),s=(a?a[2]:t).split('#')[0];return s.split('?')[0].trim().toLowerCase()}catch{return''}}formatContent(e){if(!e)return'';let t=e;return t=t.replace(/https?:\/\/[^\s]+/g,e=>`<a href="${this.escapeAttr(e)}" target="_blank" class="dynamics-link">${this.escapeHtml(e)}</a>`),t=t.replace(/@(\w+)/g,'<span class="dynamics-mention">@$1</span>'),t=t.replace(/#([^\s]+)/g,'<span class="dynamics-hashtag">#$1</span>'),t}formatRelativeTime(e){try{const t=this.tryParseDate(e);if(!t)return'æœªçŸ¥æ—¶é—´';const a=new Date,s=a.getTime()-t.getTime();if(s<0){if(Math.abs(s)<6e4)return'åˆšåˆš';const e=t.getMonth()+1,n=t.getDate(),r=a.getFullYear(),o=t.getFullYear();return r===o?`${e}æœˆ${n}æ—¥`:`${o}å¹´${e}æœˆ${n}æ—¥`}const n=Math.floor(s/6e4),r=Math.floor(s/36e5),o=Math.floor(s/864e5);if(n<1)return'åˆšåˆš';if(n<60)return`${n}åˆ†é’Ÿå‰`;if(r<24)return`${r}å°æ—¶å‰`;if(o<2){const e=String(t.getHours()).padStart(2,'0');return`æ˜¨å¤© ${e}:${String(t.getMinutes()).padStart(2,'0')}`}if(o<7)return`${o}å¤©å‰`;const i=t.getMonth()+1,c=t.getDate(),l=a.getFullYear(),d=t.getFullYear();return l===d?`${i}æœˆ${c}æ—¥`:`${d}å¹´${i}æœˆ${c}æ—¥`}catch{return'æœªçŸ¥æ—¶é—´'}}tryParseDate(e){const t=(e||'').trim();if(!t)return null;const a=t.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);if(a){const[,e,t,s,n,r]=a;return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(s,10),parseInt(n,10),parseInt(r,10),0,0)}const s=t.match(/^(\d{1,2}):(\d{2})$/);if(s){const[,e,t]=s,a=new Date;return new Date(a.getFullYear(),a.getMonth(),a.getDate(),parseInt(e,10),parseInt(t,10),0,0)}const n=new Date(t);return isNaN(n.getTime())?null:n}safeParseTime(e){const t=this.tryParseDate(e);return t?t.getTime():0}escapeHtml(e){return(e||'').replace(/[&<>"']/g,e=>{switch(e){case'<':return'&lt;';case'>':return'&gt;';case'&':return'&amp;';case'"':return'&quot;';case'\'':return'&#39;';default:return e}})}escapeAttr(e){return this.escapeHtml(e).replace(/\n/g,' ')}playClick(){try{this.soundManager?.playSound?.('click')}catch{}}async ensureContactLorebook(){if(!this.contactLorebookManager)try{this.contactLorebookManager=new ne.v,await this.contactLorebookManager.initialize()}catch(e){console.warn('[CharacterProfile] åˆå§‹åŒ– ContactLorebookManager å¤±è´¥:',e)}}onHeroUpdated(e){try{const t=e,a=t?.detail||{},s=this.targetNameForDisplay(this.targetName);a?.name&&a.name===s&&this.updateHero()}catch(e){console.warn('[CharacterProfile] onHeroUpdated å¤„ç†å¤±è´¥:',e)}}openHeroCropper(){try{const e=this.getAvatarForName(this.targetName),t=this.getBackgroundForName(this.targetName,e)||e||'https://files.catbox.moe/u8ccy5.jpg';this.launchHeroCropperModal(t)}catch{this.launchHeroCropperModal('https://files.catbox.moe/u8ccy5.jpg')}}launchHeroCropperModal(e){const t='cpCropperOverlay';Y()('#'+t).remove();const a=Y()(`\n      <div id="${t}">\n        <div class="cp-cropper-dialog">\n          <div class="cp-cropper-header">\n            <span class="cp-cropper-title">è£å‰ªå¤´å›¾ï¼ˆ16:9ï¼‰</span>\n            <button id="cpCropReset" class="cp-reset-btn">æ¢å¤é»˜è®¤</button>\n          </div>\n          <div class="cp-cropper-viewport">\n            <img class="cp-cropper-image" draggable="false" src="${e}">\n            <div class="cp-cropper-frame"></div>\n          </div>\n          <div class="cp-cropper-toolbar">\n            <button id="cpCropCancel" class="cp-btn cp-btn-cancel">å–æ¶ˆ</button>\n            <button id="cpCropUpload" class="cp-btn cp-btn-upload">ä¸Šä¼ å›¾ç‰‡</button>\n            <button id="cpCropOk" class="cp-btn cp-btn-primary">ç¡®è®¤</button>\n          </div>\n        </div>\n      </div>\n    `);Y()('#dynamicsInterface').append(a);const s=a.find('.cp-cropper-viewport'),n=a.find('.cp-cropper-image');n.css({maxWidth:'none',maxHeight:'none',width:'auto',height:'auto'}),n.attr('crossorigin','anonymous');let r=0,o=0,i=0,c=0,l=1,d=1,h=0,m=0,g=!1,u=0,p=0,v=0,y=0;function f(e,t,a){return Math.max(t,Math.min(a,e))}function C(){const e=l*d,t=r*e,a=o*e,s=Math.min(0,i-t);let g,u;h=f(h,s,0),a>=c?(g=c-a,u=0):(g=0,u=c-a),m=f(m,g,u),n[0].style.transform=`translate(${h}px, ${m}px) scale(${e})`}function b(){i=Math.round(s.width()||0),c=Math.round(s.height()||0),l=i/(r||1),d=1;const e=r*l,t=o*l;h=Math.round((i-e)/2),m=Math.round((c-t)/2),C()}function M(){const e=n[0];r=e.naturalWidth||e.width,o=e.naturalHeight||e.height,b()}const w=n[0],S=()=>{requestAnimationFrame(()=>requestAnimationFrame(M))};w.complete?S():w.onload=S,s.on('mousedown',e=>{g=!0,u=e.clientX,p=e.clientY,v=h,y=m,n[0].style.cursor='grabbing',e.preventDefault()}),Y()(window).on('mousemove.cpCrop',e=>{g&&(h=v+(e.clientX-u),m=y+(e.clientY-p),C())}),Y()(window).on('mouseup.cpCrop',()=>{g&&(g=!1,n[0].style.cursor='grab')});s.on('wheel',e=>{e.preventDefault();const t=e.originalEvent?e.originalEvent.deltaY:e.deltaY;d=f(d*(t<0?1.05:.95),1,3),C()});let E=!1,I=0,k=1;s.on('touchstart',e=>{if(e.touches&&2===e.touches.length){E=!0;const t=e.touches[0],a=e.touches[1];I=Math.hypot(a.clientX-t.clientX,a.clientY-t.clientY),k=d,e.preventDefault()}}),s.on('touchmove',e=>{if(!E||!e.touches||2!==e.touches.length)return;const t=e.touches[0],a=e.touches[1],n=Math.hypot(a.clientX-t.clientX,a.clientY-t.clientY),r=f(k*(n/(I||1)),1,3),o=s[0].getBoundingClientRect(),i=(t.clientX+a.clientX)/2-o.left,c=(t.clientY+a.clientY)/2-o.top,g=l*d;d=r;const u=l*d;h=i-(i-h)/(g||1)*u,m=c-(c-m)/(g||1)*u,C(),e.preventDefault()}),s.on('touchend touchcancel',e=>{(!e.touches||e.touches.length<2)&&(E=!1)});a.find('#cpCropUpload').on('click',()=>{const e=Y()('<input>',{type:'file',accept:'image/*',style:'display:none'});Y()('body').append(e),e.on('change',()=>{const t=e[0].files?.[0];if(e.remove(),!t)return;if(!t.type.startsWith('image/')){try{window.toastr?.error?.('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')}catch(e){}return}const a=new FileReader;a.onload=()=>{(e=>{const t=n[0];t.src=e,h=0,m=0,d=1,l=1;const a=()=>{r=t.naturalWidth||t.width,o=t.naturalHeight||t.height,b()};t.complete?requestAnimationFrame(()=>requestAnimationFrame(a)):t.onload=()=>{requestAnimationFrame(()=>requestAnimationFrame(a))}})(a.result)},a.onerror=()=>{try{window.toastr?.error?.('è¯»å–å›¾ç‰‡å¤±è´¥')}catch(e){}},a.readAsDataURL(t)}),e.trigger('click')});const L=()=>{Y()(window).off('mousemove.cpCrop mouseup.cpCrop'),a.remove()};a.find('#cpCropCancel').on('click',()=>L()),a.find('#cpCropReset').on('click',async()=>{try{const e=this.targetNameForDisplay(this.targetName);await this.ensureContactLorebook(),this.contactLorebookManager?.clearContactHero(e),this.updateHero();try{window.toastr?.success?.('å·²æ¢å¤é»˜è®¤å¤´å›¾')}catch(e){}}catch(e){try{window.toastr?.error?.('æ¢å¤é»˜è®¤å¤±è´¥')}catch(e){}}finally{L()}}),a.find('#cpCropOk').on('click',async()=>{try{i=Math.round(s.width()||0),c=Math.round(s.height()||0);const e=1280,t=720,a=document.createElement('canvas');a.width=e,a.height=t;const n=a.getContext('2d'),g=l*d,u=Math.max(0,-h/g),p=Math.max(0,-m/g),v=Math.min(r,i/g),y=Math.min(o,c/g);n.imageSmoothingEnabled=!0,n.imageSmoothingQuality='high',n.drawImage(w,u,p,v,y,0,0,e,t);const f=a.toDataURL('image/jpeg',.92),C=this.targetNameForDisplay(this.targetName);await this.ensureContactLorebook(),this.contactLorebookManager?.setContactHero(C,f),this.updateHero();try{window.toastr?.success?.('å¤´å›¾å·²æ›´æ–°')}catch(e){}L()}catch(e){console.error('[CharacterProfile] å¯¼å‡ºè£å‰ªå›¾å¤±è´¥:',e);try{window.toastr?.error?.('å¯¼å‡ºå¤±è´¥')}catch(e){}}})}getCurrentTime(){const e=new Date;return`${e.getHours().toString().padStart(2,'0')}:${e.getMinutes().toString().padStart(2,'0')}`}startTimeUpdate(){this.updateTime(),this.timeInterval=setInterval(()=>{this.updateTime()},1e3)}stopTimeUpdate(){this.timeInterval&&(clearInterval(this.timeInterval),this.timeInterval=null)}updateTime(){const e=this.$container?.find('.status-time')[0];e&&(e.textContent=this.getCurrentTime())}updateStatusBarColor(){if(!this.$container)return;const e=this.$container.find('.cp-hero-bg').css('background-image');if(!e||'none'===e)return;const t=e.match(/url\(['"]?(.*?)['"]?\)/);if(!t)return;const a=t[1],s=new Image;s.crossOrigin='anonymous',s.onload=()=>{try{const e=this.getImageBrightness(s),t=this.$container?.find('.cp-status-bar');t&&(e>128?t.addClass('dark-theme').removeClass('light-theme'):t.addClass('light-theme').removeClass('dark-theme'))}catch(e){console.warn('[CharacterProfile] æ— æ³•åˆ†æå›¾ç‰‡äº®åº¦:',e),this.$container?.find('.cp-status-bar').addClass('light-theme')}},s.onerror=()=>{this.$container?.find('.cp-status-bar').addClass('light-theme')},s.src=a}getImageBrightness(e){const t=document.createElement('canvas'),a=t.getContext('2d');if(!a)return 128;const s=50;t.width=s,t.height=s,a.drawImage(e,0,0,s,s);try{const e=a.getImageData(0,0,s,s).data;let t=0,n=0;for(let a=0;a<e.length;a+=16){const s=e[a],r=e[a+1];t+=.299*s+.587*r+.114*e[a+2],n++}return t/n}catch(e){return 128}}isPostLikedByCurrentUser(e){if(!e.likedBy||0===e.likedBy.length)return!1;const t=this.actualUserName||'';return!!e.likedBy.some(e=>'user'===e.name||'user'===e.username)||!!t&&e.likedBy.some(e=>e.name===t||e.username===t)}editSignature(e,t){const a=e.find('span').not('.signature-placeholder').text().trim(),s=e.hasClass('editable')?'':(a||t||'').trim(),n=Y()(`\n      <input type="text"\n        class="signature-input"\n        value="${this.escapeAttr(s)}"\n        placeholder="ç‚¹å‡»è®¾ç½®ç­¾å"\n        maxlength="50"\n      />\n    `);e.html('').append(n),e.removeClass('editable'),n.focus();const r=n[0];if(r&&'function'==typeof r.setSelectionRange){const e=r.value.length;r.setSelectionRange(e,e)}const o=s,i=(t,a=!1)=>{const s=(t||'').trim();if(s){if(e.html(`<span>${this.escapeHtml(s)}</span>`),a){const t=new Date,a=`${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;e.attr('title',`ç­¾åæ—¶é—´ ${a}`)}e.show().removeClass('editable')}else e.html('<span class="signature-placeholder">ç‚¹å‡»è®¾ç½®ç­¾å</span>'),e.removeAttr('title').addClass('editable').show();e.off('click').on('click',()=>{const t=e.find('span').not('.signature-placeholder').text().trim(),a=e.hasClass('editable')?'':t;this.editSignature(e,a)}),e.css('cursor','pointer')},c=async()=>{const t=(n.val()?.toString()??'').trim();try{const a=getChatMessages(-1)[0];if(a){const s=a.message_id,n=a.message||'',r=e=>`${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`,o=e=>(e||'').replace(/\r|\n/g,'').replace(/\[|\]|\|/g,'').trim(),i='user',c=(e=>{const a='[åŠ¨æ€]',s='[/åŠ¨æ€]',n=o(t),c=e=>e.replace(/^\[ç­¾å\|\s*user\s*\|[^\]]*\]\s*$/gm,'').replace(/^(?:\s*\n)+/gm,'').trimEnd();if(!n){const t=e.indexOf(a),n=t>=0?e.indexOf(s,t+4):-1;if(t>=0&&n>t){const a=e.slice(0,t+4);let s=e.slice(t+4,n);const r=e.slice(n);return s=c(s),a+(s?'\n'+s+'\n':'\n')+r}return e}const l=r(new Date),d=`[ç­¾å|${i}|${n}|${l}]`,h=e.indexOf(a),m=h>=0?e.indexOf(s,h+4):-1;if(h>=0&&m>h){const t=e.slice(0,h+4);let a=e.slice(h+4,m);const s=e.slice(m);return a=c(a),a&&!/\n$/.test(a)&&(a+='\n'),a+=d+'\n',t+'\n'+a+s}return`${e&&!/\n$/.test(e)?e+'\n':e}[åŠ¨æ€]\n${d}\n[/åŠ¨æ€]`})(n);await setChatMessages([{message_id:s,message:c}],{refresh:'none'});const l=r(new Date);t?(e.html(`<span>${this.escapeHtml(t)}</span>`),e.attr('title',`ç­¾åæ—¶é—´ ${l}`).show().removeClass('editable')):(e.html('<span class="signature-placeholder">ç‚¹å‡»è®¾ç½®ç­¾å</span>'),e.removeAttr('title').addClass('editable').show());try{document.dispatchEvent(new CustomEvent('dynamicsInteraction',{detail:{scope:'signature'}}))}catch(e){}window.toastr?.success?.(t?'ç­¾åå·²æ›´æ–°':'ç­¾åå·²æ¸…é™¤')}}catch(e){console.error('[CharacterProfile] ä¿å­˜ç­¾åå¤±è´¥:',e),window.toastr?.error?.('ä¿å­˜ç­¾åå¤±è´¥')}};n.on('blur',()=>{(n.val()||'').toString().trim()!==o?c():i(o)}),n.on('keypress',e=>{13===e.which&&(e.preventDefault(),n.blur())}),n.on('keydown',e=>{27===e.which&&(e.preventDefault(),i(o))})}}class oe{globalUserManager;currentUserName=null;actualUserName=null;soundManager;constructor(e){this.globalUserManager=g.GlobalUserManager.getInstance(),this.soundManager=e||window.soundManager,this.initializeUserAvatar(),this.setupUserAvatarListener(),this.initializeActualUserName()}async initializeActualUserName(){try{const e=await triggerSlash('/pass {{user}}');this.actualUserName=(e||'').trim()||'ç”¨æˆ·',console.log('ğŸ“ å®é™…ç”¨æˆ·å:',this.actualUserName)}catch(e){console.error('è·å–å®é™…ç”¨æˆ·åå¤±è´¥:',e),this.actualUserName='ç”¨æˆ·'}}replaceUserWithActualName(e){return'user'===e&&this.actualUserName?this.actualUserName:e.startsWith('user@')&&this.actualUserName?e.replace('user',this.actualUserName):e}async initializeUserAvatar(){try{const e=await this.globalUserManager.loadUserData(),t=Y()('.dynamics-nav-profile');t.length&&e.avatar&&t.css('background-image',`url('${e.avatar}')`),e?.name&&(this.currentUserName=e.name,this.updateLikeButtonsState())}catch(e){console.error('åˆå§‹åŒ–åŠ¨æ€é¡µé¢ç”¨æˆ·å¤´åƒå¤±è´¥:',e)}}setupUserAvatarListener(){this.globalUserManager.addEventListener('avatar',e=>{const t=Y()('.dynamics-nav-profile');t.length&&e.newValue&&t.css('background-image',`url('${e.newValue}')`)}),this.globalUserManager.addEventListener('all',async e=>{if('avatar'===e.type||'name'===e.type){const e=this.globalUserManager.getCurrentUserData();if(e){const t=Y()('.dynamics-nav-profile');t.length&&e.avatar&&t.css('background-image',`url('${e.avatar}')`),e.name&&(this.currentUserName=e.name,this.updateLikeButtonsState())}}})}renderDynamicsContent(e,t){console.log('ğŸ“± æ¸²æŸ“åŠ¨æ€å†…å®¹...');const a=Y()('#dynamicsTimeline'),s=Y()('#dynamicsStatusTime');console.log('ğŸ“‹ åŠ¨æ€å…ƒç´ æ£€æŸ¥:',{timelineElement:a.length>0,statusTimeElement:s.length>0}),a.length&&(e&&!t.useDefaultContent?(console.log('ğŸ“± ä½¿ç”¨è§£æçš„åŠ¨æ€æ•°æ®:',e),a.html(this.renderPosts(e.posts))):(console.log('ğŸ“± ä½¿ç”¨é»˜è®¤åŠ¨æ€å†…å®¹'),a.html(this.getDefaultDynamicsContent()),console.log('âœ… é»˜è®¤åŠ¨æ€å†…å®¹å·²è®¾ç½®')),t.enableAnimations&&this.addAnimations(a)),this.renderNewDynamicButton(),this.initializeUserAvatar(),console.log('âœ… åŠ¨æ€å†…å®¹æ¸²æŸ“å®Œæˆ')}renderPosts(e){return e.map(e=>this.renderPost(e)).join('')}renderPost(e){const t=Y()('<div>',{class:'dynamics-post','data-post-id':e.id});void 0!==e.messageId&&null!==e.messageId&&t.attr('data-message-id',String(e.messageId));const a=Y()('<div>',{class:'dynamics-post-header'});let s=e.author.avatar||'';if('user'===e.author.name){const e=this.globalUserManager.getCurrentUserData();e?.avatar&&(s=e.avatar)}const n=Y()('<div>',{class:'dynamics-post-avatar',css:{backgroundImage:`url('${s}')`}}),r=Y()('<div>',{class:'dynamics-post-info'}),o=this.replaceUserWithActualName(e.author.name);r.append(Y()('<div>',{class:'dynamics-post-name',text:o}),Y()('<div>',{class:'dynamics-post-time',text:this.formatRelativeTime(e.timestamp)})),a.append(n,r);const i=Y()('<div>',{class:'dynamics-post-content',html:this.formatContent(e.content)});let c=null;if(e.image){const t=J.isImageMask(e.image)?J.getRandomImageMask():e.image;c=Y()('<div>',{class:'dynamics-post-image',css:{backgroundImage:`url('${t}')`},'data-description':e.imageDescription||''})}const l=Y()('<div>',{class:'dynamics-post-actions'}),d=this.createAction('like','<svg class="action-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',e.actions.likes);this.isPostLikedByCurrentUser(e)&&d.addClass('liked');const h=this.createAction('comment','<svg class="action-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>',e.comments?e.comments.length:0);l.append(d,h);let m=null;if(e.likedBy&&e.likedBy.length>0){m=Y()('<div>',{class:'dynamics-liked-by'});const t='<svg class="liked-heart-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';m.html(t),m.append(e.likedBy.map(e=>{const t=this.replaceUserWithActualName(e.name||e.username||'');return Y()('<span>',{class:'liked-user',text:t})}).reduce((e,t,a)=>(a>0&&e.push(Y()('<span>',{text:'ã€'})),e.push(t),e),[]))}let g=null;return e.comments&&e.comments.length>0&&(g=Y()('<div>',{class:'dynamics-comments'}),e.comments.forEach(e=>{g.append(this.renderComment(e))})),t.append(a,i),c&&t.append(c),t.append(l),m&&t.append(m),g&&t.append(g),t.prop('outerHTML')||''}createAction(e,t,a){const s=Y()('<div>',{class:'dynamics-post-action','data-action':e}),n=`<span class="action-icon">${t}</span>`;return s.html(n),s}formatRelativeTime(e){let t=null;try{const a='string'==typeof e?e.trim():'';if(!a)return'æœªçŸ¥æ—¶é—´';const s=a.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);if(s){const[,e,a,n,r,o]=s;t=new Date(parseInt(e,10),parseInt(a,10)-1,parseInt(n,10),parseInt(r,10),parseInt(o,10),0,0)}else if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(a)){const e=new Date(a);isNaN(e.getTime())||(t=e)}else{const e=new Date(a);isNaN(e.getTime())||(t=e)}if(!t)return'æœªçŸ¥æ—¶é—´';const n=new Date,r=n.getTime()-t.getTime();if(r<0){if(Math.abs(r)<6e4)return'åˆšåˆš';const e=t.getMonth()+1,a=t.getDate(),s=n.getFullYear(),o=t.getFullYear();return s===o?`${e}æœˆ${a}æ—¥`:`${o}å¹´${e}æœˆ${a}æ—¥`}const o=Math.floor(r/6e4),i=Math.floor(r/36e5),c=Math.floor(r/864e5);if(o<1)return'åˆšåˆš';if(o<60)return`${o}åˆ†é’Ÿå‰`;if(i<24)return`${i}å°æ—¶å‰`;if(c<2){const e=String(t.getHours()).padStart(2,'0');return`æ˜¨å¤© ${e}:${String(t.getMinutes()).padStart(2,'0')}`}if(c<7)return`${c}å¤©å‰`;const l=t.getMonth()+1,d=t.getDate(),h=n.getFullYear(),m=t.getFullYear();return h===m?`${l}æœˆ${d}æ—¥`:`${m}å¹´${l}æœˆ${d}æ—¥`}catch{return'æœªçŸ¥æ—¶é—´'}}formatContent(e){let t=e;return t=t.replace(/https?:\/\/[^\s]+/g,e=>`<a href="${e}" target="_blank" class="dynamics-link">${e}</a>`),t=t.replace(/@(\w+)/g,'<span class="dynamics-mention">@$1</span>'),t=t.replace(/#([^\s]+)/g,'<span class="dynamics-hashtag">#$1</span>'),t}renderComment(e){const t=Y()('<div>',{class:'dynamics-comment dynamics-comment-qq'}),a=Y()('<div>',{class:'dynamics-comment-content'}),s=this.replaceUserWithActualName(e.author.name);if(s.includes(' å›å¤ ')){const t=s.split(' å›å¤ ');if(2===t.length){const s=this.replaceUserWithActualName(t[0]),n=this.replaceUserWithActualName(t[1]);a.append(Y()('<span>',{class:'dynamics-comment-name',text:s}),Y()('<span>',{text:' å›å¤ ',class:'dynamics-comment-reply-indicator'}),Y()('<span>',{class:'dynamics-comment-name dynamics-comment-reply-target',text:n}),Y()('<span>',{text:'ï¼š'}),Y()('<span>',{class:'dynamics-comment-text',html:this.formatContent(e.content)}))}else a.append(Y()('<span>',{class:'dynamics-comment-name',text:s}),Y()('<span>',{text:'ï¼š'}),Y()('<span>',{class:'dynamics-comment-text',html:this.formatContent(e.content)}))}else a.append(Y()('<span>',{class:'dynamics-comment-name',text:s}),Y()('<span>',{text:'ï¼š'}),Y()('<span>',{class:'dynamics-comment-text',html:this.formatContent(e.content)}));return t.append(a),t.prop('outerHTML')||''}addAnimations(e){e.find('.dynamics-post').each((e,t)=>{const a=Y()(t);a.css({opacity:0,transform:'translateY(20px)'}),setTimeout(()=>{a.animate({opacity:1},300).css({transform:'translateY(0)',transition:'transform 0.3s ease'})},100*e)})}isPostLikedByCurrentUser(e){return!!e.likedBy?.some(e=>'user'===e.name||'user'===e.username)}updateLikeButtonsState(){if(!this.actualUserName)return;const e=this.actualUserName;Y()('.dynamics-post').each((_,t)=>{const a=Y()(t),s=a.find('.dynamics-liked-by .liked-user').map((e,t)=>Y()(t).text().trim()).get().includes(e);a.find('.dynamics-post-action[data-action="like"]').toggleClass('liked',s)})}syncAuthorAvatar(e,t,a){try{const s=[e,t].filter(Boolean);if(0===s.length)return;Y()('.dynamics-post').each((_,n)=>{const r=Y()(n),o=r.find('.dynamics-post-name'),i=(o.text()||'').trim();if(i&&s.includes(i)){const s=r.find('.dynamics-post-avatar');s.length&&a&&s.css('background-image',`url('${a}')`),e&&t&&i===e&&o.text(t)}})}catch(e){console.warn('[DynamicsRenderer] åŒæ­¥åŠ¨æ€å¤´åƒå¤±è´¥:',e)}}getDefaultDynamicsContent(){return'\n      <div class="dynamics-empty">\n        <div class="dynamics-empty-icon">ğŸ“­</div>\n        <div class="dynamics-empty-text">æš‚æ— åŠ¨æ€</div>\n        <div class="dynamics-empty-subtext">å¿«å»å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§ï½</div>\n      </div>\n    '}renderNewDynamicButton(){if(Y()('.new-dynamic-btn').length>0)return;const e=Y()('<button>',{class:'new-dynamic-btn',html:'\n        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <line x1="12" y1="5" x2="12" y2="19"></line>\n          <line x1="5" y1="12" x2="19" y2="12"></line>\n        </svg>\n      '});Y()('#dynamicsInterface').append(e),e.on('click',()=>{console.log('ç‚¹å‡»æ–°å»ºåŠ¨æ€æŒ‰é’®'),this.soundManager?.playSound?(this.soundManager.playSound('click'),console.log('âœ… æ’­æ”¾æ–°å»ºåŠ¨æ€æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ')):console.warn('âš ï¸ soundManager ä¸å¯ç”¨ï¼Œæ— æ³•æ’­æ”¾éŸ³æ•ˆ'),Y()(window).trigger('dynamics:openComposer')})}}class ie{static validateDynamicsData(e){try{if(!e||'object'!=typeof e)return null;const t=e;return Array.isArray(t.posts)&&(t.currentUser&&'object'==typeof t.currentUser)?{posts:t.posts||[],currentUser:{name:t.currentUser.name||'ç”¨æˆ·',avatar:t.currentUser.avatar||'https://files.catbox.moe/u8ccy5.jpg'}}:null}catch(e){return console.error('åŠ¨æ€æ•°æ®éªŒè¯å¤±è´¥:',e),null}}static validatePost(e){try{if(!e||'object'!=typeof e)return null;const t=e;return t.id&&t.content?{id:t.id,author:{name:t.author?.name||'æœªçŸ¥ç”¨æˆ·',username:t.author?.username||'unknown',avatar:t.author?.avatar},content:t.content,image:t.image,imageDescription:t.imageDescription,timestamp:t.timestamp||(new Date).toISOString(),actions:{likes:t.actions?.likes||0,shares:t.actions?.shares||0,bookmarks:t.actions?.bookmarks||0},comments:Array.isArray(t.comments)?t.comments:[]}:null}catch(e){return console.error('å¸–å­æ•°æ®éªŒè¯å¤±è´¥:',e),null}}static parseConfig(e){if(!e||'object'!=typeof e)return{useDefaultContent:!1,enableAnimations:!0,enableSounds:!0};const t=e;return{useDefaultContent:Boolean(t.useDefaultContent),enableAnimations:!1!==t.enableAnimations,enableSounds:!1!==t.enableSounds}}static createDefaultData(){return{posts:[],currentUser:{name:'ç”¨æˆ·',avatar:'https://files.catbox.moe/u8ccy5.jpg'}}}}class ce{dynamicsData=null;renderer;eventHandler;composer;soundManager;statusBar=null;dynamicsParser;$container=null;bottomNavigation=null;characterProfile=null;latestSignatures=new Map;onContactUpdated=e=>{try{const t=e&&e.detail||{},a=t.oldName||'',s=t.newName||'',n=t.newAvatar||'';if(console.log('ğŸ“¢ [Dynamics] æ”¶åˆ°è”ç³»äººæ›´æ–°äº‹ä»¶ï¼Œå¢é‡åŒæ­¥åŠ¨æ€å¤´åƒ',{oldName:a,newName:s}),this.renderer&&n){const e=a||s,t=s||a;this.renderer.syncAuthorAvatar?.(e,t,n)}}catch(e){console.warn('âš ï¸ [Dynamics] åˆ·æ–°åŠ¨æ€å¤´åƒå¤±è´¥:',e)}};onInteractionAdded=e=>{try{const t=e.detail||{};console.log('ğŸ“¢ [Dynamics] æ”¶åˆ°äº’åŠ¨äº‹ä»¶ï¼Œæ›´æ–°åŠ¨æ€å†…å­˜',t),this.loadDynamicsFromMessages()}catch(e){console.warn('âš ï¸ [Dynamics] å¤„ç†äº’åŠ¨äº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå·²å¿½ç•¥',e)}};onPublished=e=>{try{const t=e.detail||{};console.log('ğŸ“¢ [Dynamics] æ”¶åˆ°å‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°åŠ¨æ€å†…å­˜',t),this.loadDynamicsFromMessages()}catch(e){console.warn('âš ï¸ [Dynamics] å¤„ç†å‘å¸ƒäº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå·²å¿½ç•¥',e)}};constructor(e){this.soundManager=e,this.renderer=new oe(e),this.eventHandler=new se(e),this.composer=new ee(e),this.dynamicsParser=new X({enablePartialParsing:!0,enableErrorRecovery:!0,logErrors:!0})}async initialize(){if(console.log('ğŸ”§ åˆå§‹åŒ–åŠ¨æ€ç®¡ç†å™¨...'),this.$container=Y()('#dynamicsInterface'),this.$container.length){try{const{initializeContactManager:e}=await Promise.resolve().then(a.bind(a,115));await e(),console.log('âœ… ContactManager å·²åˆå§‹åŒ–')}catch(e){console.warn('âš ï¸ ContactManager åˆå§‹åŒ–å¤±è´¥:',e)}this.loadDynamicsFromMessages();try{this.characterProfile=new re({getDynamicsData:()=>this.getDynamicsData(),soundManager:this.soundManager,getLatestSignature:e=>this.getLatestSignature(e)}),Y()(document).off('dynamics:profile:click.manager'),Y()(document).on('dynamics:profile:click.manager',(e,t)=>{const a=t&&(t.username||t.name)||'';this.openCharacterProfile(a)})}catch(e){console.warn('âš ï¸ åˆå§‹åŒ– CharacterProfile å¤±è´¥:',e)}Y()(document).on('dynamics:back',e=>{this.handleBackToChat(e)}),document.addEventListener('contactUpdated',this.onContactUpdated),Y()(document).on('dynamics:refresh',()=>{console.log('ğŸ“± æ”¶åˆ°åŠ¨æ€å¼ºåˆ¶åˆ·æ–°è¯·æ±‚'),this.loadDynamicsFromMessages(),this.renderDynamicsContent()}),Y()(window).on('dynamics:openComposer',()=>{console.log('ğŸ“ æ‰“å¼€å‘å¸ƒåŠ¨æ€ç•Œé¢'),this.showComposerInterface()}),document.addEventListener('dynamicsPublished',this.onPublished),document.addEventListener('dynamicsInteraction',this.onInteractionAdded),console.log('âœ… åŠ¨æ€ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')}else console.error('âŒ åŠ¨æ€ç•Œé¢å…ƒç´ ä¸å­˜åœ¨')}async showDynamicsInterface(){console.log('ğŸ“± æ˜¾ç¤ºåŠ¨æ€ç•Œé¢...'),this.hideAllInterfaces(),this.$container&&this.$container.length?(this.$container.addClass('active').show(),console.log('âœ… åŠ¨æ€ç•Œé¢å·²æ˜¾ç¤ºï¼Œå½“å‰æ ·å¼:',{display:this.$container.css('display'),classList:this.$container.attr('class')}),this.renderDynamicsContent(),this.eventHandler.initializeEventListeners(),this.initializeBottomNavigation(),this.initializeStatusBar()):console.error('âŒ åŠ¨æ€ç•Œé¢å…ƒç´ ä¸å­˜åœ¨')}renderDynamicsContent(e){const t=ie.parseConfig(e);this.loadDynamicsFromMessages(),this.renderer.renderDynamicsContent(this.dynamicsData,t)}loadDynamicsFromMessages(){if('function'==typeof getChatMessages)try{const e=getChatMessages('0-{{lastMessageId}}');console.log('ğŸ” å¼€å§‹è§£æåŠ¨æ€æ•°æ®ï¼Œæ¶ˆæ¯æ•°é‡:',e.length);const t=new Map;let a=!1;const s=[];for(let t=0;t<e.length;t++){const n=e[t];if(n.message&&'string'==typeof n.message&&n.message.includes('[åŠ¨æ€]')&&n.message.includes('[/åŠ¨æ€]')){const e=this.dynamicsParser.parse(n.message);e&&e.data&&e.data.length>0?(a=!0,s.push({messageId:n.message_id,posts:e.data})):e?.errors?.length&&console.warn('âŒ åŠ¨æ€æ•°æ®è§£æå¤±è´¥:',e.errors)}}for(const{messageId:e,posts:a}of s)for(const s of a){if(void 0===s.no)continue;const a=`${e}_${s.no}`,n=t.get(a);if(n)Z.fillMissingFields(n,s),Z.mergeInteractions(n,s),n.messageId||(n.messageId=e);else{const n=Z.cloneDynamic(s);n.messageId=e,t.set(a,n)}}for(const{messageId:e,posts:a}of s)for(const s of a)if(void 0!==s.no&&s.comments?.length)for(const a of s.comments){let n=!1;const r=`${e}_${s.no}`;if(t.has(r))n=!0;else{for(const[o,i]of t)if(i.no===s.no&&o!==r){console.log(`ğŸ”„ å°†è¯„è®ºåˆå¹¶åˆ°åŠ¨æ€ #${s.no} (ä»æ¥¼å±‚ ${e} åˆ° ${i.messageId})`),i.comments=Z.mergeComments(i.comments||[],[a]),n=!0;break}n||console.warn(`âš ï¸ è¯„è®ºç›®æ ‡åŠ¨æ€ #${s.no} ä¸å­˜åœ¨ï¼Œè¯„è®ºå†…å®¹: ${a.content?.substring(0,30)}...`)}}const n=Array.from(t.values());if(n.forEach(e=>e.likesCount=e.likedBy?.length||0),a&&n.length>0){const e=K.R.convertDynamicsData(n),t=ie.validateDynamicsData(e);t?(this.dynamicsData=t,console.log('âœ… åŠ¨æ€æ•°æ®èšåˆæˆåŠŸï¼Œå¸–å­æ•°é‡:',n.length)):this.dynamicsData=null}else console.log('ğŸ“ æœªæ‰¾åˆ°ä»»ä½•[åŠ¨æ€]å®¹å™¨ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹'),this.dynamicsData=null;this.scanSignatures(e)}catch(e){console.error('ğŸ’¥ åŠ è½½åŠ¨æ€æ•°æ®æ—¶å‡ºé”™:',e),this.dynamicsData=null}else console.warn('âš ï¸ getChatMessages å‡½æ•°ä¸å¯ç”¨'),this.dynamicsData=null}getDynamicsData(){return this.dynamicsData}getLatestSignature(e){try{const t=this.normalizeName(e),a=this.latestSignatures.get(t);return a&&a.content?{content:a.content,timeHHmm:a.timeHHmm}:null}catch{return null}}scanSignatures(e){try{if(this.latestSignatures.clear(),!Array.isArray(e)||0===e.length)return;const t=/\[ç­¾å\|([^|\]\r\n]+)\|([^|\]\r\n]+)\|((?:[01]\d|2[0-3]):[0-5]\d)\]/g;for(let a=e.length-1;a>=0;a--){const s=e[a],n=s&&'string'==typeof s.message?s.message:'';if(!n)continue;const r=this.extractDynamicsContainer(n);if(!r)continue;const o=[];let i;for(t.lastIndex=0;null!==(i=t.exec(r));)o.push({rawName:(i[1]||'').trim(),content:(i[2]||'').trim(),timeHHmm:(i[3]||'').trim(),index:i.index??0});if(o.length)for(let e=o.length-1;e>=0;e--){const t=o[e],a=this.normalizeName(t.rawName);this.latestSignatures.has(a)||this.latestSignatures.set(a,{content:t.content,timeHHmm:t.timeHHmm,messageId:s.message_id??-1,indexInMessage:t.index,characterName:t.rawName})}}}catch(e){console.warn('âš ï¸ [Dynamics] æ‰«æç­¾åå¤±è´¥:',e)}}extractDynamicsContainer(e){try{const t='[åŠ¨æ€]',a='[/åŠ¨æ€]',s=e.indexOf(t),n=e.indexOf(a);return-1===s||-1===n||n<=s?null:e.substring(s+t.length,n).trim()}catch{return null}}normalizeName(e){return(e||'').trim().toLowerCase()}setDynamicsData(e){if(e){const t=ie.validateDynamicsData(e);this.dynamicsData=t}else this.dynamicsData=null}handleBackToChat(e){console.log('ğŸ“± å¤„ç†è¿”å›èŠå¤©ç•Œé¢äº‹ä»¶');const t=e.originalEvent,a=Y().Event('interface:switch',{detail:{from:'dynamics',to:'chat',source:t?.detail?.source||'unknown'}});Y()(document).trigger(a)}hideAllInterfaces(){Y()(['#chatInterface','#chatListInterface','#diaryInterface','#callInterface','#dynamicsInterface','#dynamicsComposerInterface'].join(', ')).removeClass('active').hide()}showComposerInterface(){if(console.log('ğŸ“ æ˜¾ç¤ºå‘å¸ƒåŠ¨æ€ç•Œé¢...'),!Y()('#dynamicsInterface').hasClass('active'))return void console.warn('âš ï¸ åŠ¨æ€ç•Œé¢æœªæ¿€æ´»ï¼Œå…ˆæ¿€æ´»åŠ¨æ€ç•Œé¢');let e=Y()('#dynamicsComposerInterface');if(!e.length){const t=this.composer.renderComposerInterface();Y()('.interface-container').append(t),e=Y()('#dynamicsComposerInterface')}e.addClass('active').show(),this.composer.initializeComposer(),console.log('âœ… å‘å¸ƒåŠ¨æ€ç•Œé¢å·²æ˜¾ç¤ºï¼ˆè¦†ç›–åœ¨åŠ¨æ€é¡µé¢ä¸Šï¼‰')}initializeStatusBar(){const e=document.getElementById('dynamicsStatusBarContainer');e&&(this.statusBar=n.create(e))}destroyStatusBar(){this.statusBar&&(this.statusBar.destroy(),this.statusBar=null)}hideDynamicsInterface(){console.log('ğŸ“± éšè—åŠ¨æ€ç•Œé¢...'),this.$container&&this.$container.length&&this.$container.removeClass('active').hide(),this.destroyStatusBar(),this.eventHandler.destroy(),console.log('âœ… åŠ¨æ€ç•Œé¢å·²éšè—')}initializeBottomNavigation(){const e=this.$container?.find('.bottom-nav')[0];e?(this.bottomNavigation=s.mountDefault(e,'feed',{feed:()=>{},messages:()=>this.switchToChatList(),profile:()=>this.switchToProfile()}),console.log('âœ… åŠ¨æ€é¡µé¢åº•éƒ¨å¯¼èˆªæ å·²åˆå§‹åŒ–')):console.warn('âš ï¸ æœªæ‰¾åˆ°åº•éƒ¨å¯¼èˆªæ å®¹å™¨')}switchToChatList(){console.log('ğŸ”„ ä»åŠ¨æ€é¡µé¢åˆ‡æ¢åˆ°èŠå¤©åˆ—è¡¨');const e=new CustomEvent('pageSwitch',{detail:{from:'feed',to:'chatList'}});document.dispatchEvent(e)}switchToProfile(){console.log('ğŸ”„ ä»åŠ¨æ€é¡µé¢åˆ‡æ¢åˆ°ä¸ªäººä¸»é¡µ');const e=new CustomEvent('pageSwitch',{detail:{from:'feed',to:'profile'}});document.dispatchEvent(e)}openCharacterProfile(e){try{const t=(e||'').trim();if(!t)return;this.characterProfile||(this.characterProfile=new re({getDynamicsData:()=>this.getDynamicsData(),soundManager:this.soundManager,getLatestSignature:e=>this.getLatestSignature(e)})),this.characterProfile.open(t)}catch(e){console.warn('âš ï¸ æ‰“å¼€è§’è‰²ä¸»é¡µå¤±è´¥:',e)}}destroy(){console.log('ğŸ—‘ï¸ é”€æ¯åŠ¨æ€ç®¡ç†å™¨...'),this.hideDynamicsInterface(),Y()(document).off('dynamics:back'),Y()(document).off('dynamics:refresh'),Y()(window).off('dynamics:openComposer'),Y()(document).off('dynamics:profile:click.manager'),document.removeEventListener('contactUpdated',this.onContactUpdated),document.removeEventListener('dynamicsPublished',this.onPublished),document.removeEventListener('dynamicsInteraction',this.onInteractionAdded),this.dynamicsData=null,this.$container=null,this.bottomNavigation=null,this.characterProfile?.close(),this.characterProfile=null,console.log('âœ… åŠ¨æ€ç®¡ç†å™¨å·²é”€æ¯')}}class le{errorCounts=new Map;MAX_ERROR_COUNT=10;increment(e){const t=this.errorCounts.get(e)||0;this.errorCounts.set(e,t+1),t+1>=this.MAX_ERROR_COUNT&&console.warn(`é”™è¯¯ç±»å‹ "${e}" å‘ç”Ÿæ¬¡æ•°è¿‡å¤š (${t+1}æ¬¡)ï¼Œè¯·æ£€æŸ¥ä»£ç é€»è¾‘`)}getStats(){const e={};return this.errorCounts.forEach((t,a)=>{e[a]=t}),e}reset(){this.errorCounts.clear()}getTotalErrors(){let e=0;return this.errorCounts.forEach(t=>{e+=t}),e}}class de{currentScale=1;MIN_SCALE=.8;MAX_SCALE=1.5;STEP=.1;STORAGE_KEY='ui-scale';constructor(){this.loadScale(),this.initializeScaleControl()}setScale(e){e=Math.max(this.MIN_SCALE,Math.min(this.MAX_SCALE,e)),e=Math.round(10*e)/10,this.currentScale=e,document.documentElement.style.setProperty('--scale-factor',e.toString()),this.updateSliderProgress(e),this.updateScaleDisplay(e),this.saveScale(),console.log(`ğŸ” ç•Œé¢ç¼©æ”¾å·²è®¾ç½®ä¸º: ${Math.round(100*e)}%`)}getCurrentScale(){return this.currentScale}loadScale(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=parseFloat(e);if(!isNaN(t)&&t>=this.MIN_SCALE&&t<=this.MAX_SCALE)return void this.setScale(t)}}catch(e){console.warn('åŠ è½½ç¼©æ”¾è®¾ç½®å¤±è´¥:',e)}this.setScale(1)}saveScale(){try{localStorage.setItem(this.STORAGE_KEY,this.currentScale.toString())}catch(e){console.warn('ä¿å­˜ç¼©æ”¾è®¾ç½®å¤±è´¥:',e)}}initializeScaleControl(){'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>this.setupScaleControl()):this.setupScaleControl()}setupScaleControl(){const e=document.getElementById('scaleSlider');e?(e.value=this.currentScale.toString(),this.updateSliderProgress(this.currentScale),this.updateScaleDisplay(this.currentScale),e.addEventListener('input',this.handleSliderInput),e.addEventListener('change',this.handleSliderChange)):setTimeout(()=>this.setupScaleControl(),100)}updateSliderProgress(e){const t=(e-this.MIN_SCALE)/(this.MAX_SCALE-this.MIN_SCALE)*100,a=document.getElementById('scaleSlider');a&&a.style.setProperty('--progress',`${t}%`)}updateScaleDisplay(e){const t=document.getElementById('scaleValue');t&&(t.textContent=`${Math.round(100*e)}%`)}resetScale(){this.setScale(1)}destroy(){const e=document.getElementById('scaleSlider');e&&(e.removeEventListener('input',this.handleSliderInput),e.removeEventListener('change',this.handleSliderChange))}handleSliderInput=e=>{const t=e.target,a=parseFloat(t.value);this.setScale(a)};handleSliderChange=()=>{}}class he{sounds=new Map;isEnabled=!0;volume=1;loadingPromises=new Map;transferResponses=new Map;SOUND_CONFIG={click:'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',send:'https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3',emoji:'https://files.catbox.moe/gb0so5.mp3',bubble:'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',avatar:'https://assets.mixkit.co/active_storage/sfx/2575/2575-preview.mp3',notification:'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3',typing:'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',error:'https://assets.mixkit.co/active_storage/sfx/2577/2577-preview.mp3',newMessage:'https://files.catbox.moe/b4amzm.mp3'};constructor(){this.preloadAllSounds(),this.loadUserPreferences()}async preloadAllSounds(){const e=[];for(const[t,a]of Object.entries(this.SOUND_CONFIG)){const s=this.loadSound(t,a);this.loadingPromises.set(t,s),e.push(s)}try{await Promise.all(e),console.log('æ‰€æœ‰éŸ³æ•ˆé¢„åŠ è½½å®Œæˆ')}catch(e){console.warn('éƒ¨åˆ†éŸ³æ•ˆé¢„åŠ è½½å¤±è´¥:',e)}}async loadSound(e,t){return new Promise((a,s)=>{const n=new Audio(t);n.volume=this.volume,n.preload='auto';const r=()=>{this.sounds.set(e,n),n.removeEventListener('canplaythrough',r),n.removeEventListener('error',o),a()},o=s=>{console.warn(`éŸ³æ•ˆåŠ è½½å¤±è´¥: ${e} - ${t}`,s),n.removeEventListener('canplaythrough',r),n.removeEventListener('error',o),a()};n.addEventListener('canplaythrough',r),n.addEventListener('error',o),n.load()})}async playSound(e,t={}){if(this.isEnabled)try{const a=this.loadingPromises.get(e);a&&await a;const s=this.sounds.get(e);if(!s)return void console.warn(`éŸ³æ•ˆä¸å­˜åœ¨: ${e}`);s.currentTime=0,s.volume=void 0!==t.volume?t.volume:this.volume,s.loop=t.loop||!1,await s.play()}catch(t){console.warn(`éŸ³æ•ˆæ’­æ”¾å¤±è´¥: ${e}`,t),this.handlePlaybackError(e,t)}}stopSound(e){const t=this.sounds.get(e);t&&(t.pause(),t.currentTime=0)}stopAllSounds(){for(const e of this.sounds.values())e.pause(),e.currentTime=0}setVolume(e){this.volume=Math.max(0,Math.min(1,e));for(const e of this.sounds.values())e.volume=this.volume;this.saveUserPreferences()}getVolume(){return this.volume}setEnabled(e){this.isEnabled=e,e||this.stopAllSounds(),this.saveUserPreferences()}isEnabledState(){return this.isEnabled}isSoundLoaded(e){return this.sounds.has(e)}getAvailableSounds(){return Object.keys(this.SOUND_CONFIG)}handlePlaybackError(e,t){const a=`sound_error_${e}`,s=parseInt(localStorage.getItem(a)||'0')+1;localStorage.setItem(a,s.toString()),s>5&&console.warn(`éŸ³æ•ˆ ${e} é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œå»ºè®®æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶`)}loadUserPreferences(){try{const e=localStorage.getItem('sound_volume');null!==e&&(this.volume=parseFloat(e));const t=localStorage.getItem('sound_enabled');null!==t&&(this.isEnabled='true'===t)}catch(e){console.warn('åŠ è½½éŸ³æ•ˆåå¥½è®¾ç½®å¤±è´¥:',e)}}saveUserPreferences(){try{localStorage.setItem('sound_volume',this.volume.toString()),localStorage.setItem('sound_enabled',this.isEnabled.toString())}catch(e){console.warn('ä¿å­˜éŸ³æ•ˆåå¥½è®¾ç½®å¤±è´¥:',e)}}destroy(){this.stopAllSounds(),this.sounds.clear(),this.loadingPromises.clear()}}class me{currentSpeed=1;MIN_SPEED=1;MAX_SPEED=4;STORAGE_KEY='typing-speed';SPEED_CONFIG={1:{name:'æ­£å¸¸',typingTime:[1e3,3e3],messageDelay:[500,1500]},2:{name:'å¿«é€Ÿ',typingTime:[200,1e3],messageDelay:[200,500]},3:{name:'ç¬é—´',typingTime:0,messageDelay:[500,1e3],noTyping:!0},4:{name:'å…¨éƒ¨',typingTime:0,messageDelay:0,showAll:!0}};constructor(){this.loadSpeed(),this.initializeSpeedControl()}setSpeed(e){e=Math.max(this.MIN_SPEED,Math.min(this.MAX_SPEED,Math.round(e))),this.currentSpeed=e,this.updateSliderProgress(e),this.updateSpeedDisplay(e),this.saveSpeed(),console.log(`âš¡ æ‰“å­—é€Ÿåº¦å·²è®¾ç½®ä¸º: ${this.SPEED_CONFIG[e].name}`)}getCurrentSpeedConfig(){return this.SPEED_CONFIG[this.currentSpeed]}getCurrentSpeed(){return this.currentSpeed}getTypingTime(){const e=this.SPEED_CONFIG[this.currentSpeed];if(0===e.typingTime)return 0;const[t,a]=e.typingTime;return Math.floor(Math.random()*(a-t+1)+t)}getMessageDelay(){const e=this.SPEED_CONFIG[this.currentSpeed];if(0===e.messageDelay)return 0;const[t,a]=e.messageDelay;return Math.floor(Math.random()*(a-t+1)+t)}shouldShowAll(){return this.SPEED_CONFIG[this.currentSpeed].showAll||!1}shouldSkipTyping(){return this.SPEED_CONFIG[this.currentSpeed].noTyping||!1}loadSpeed(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=parseInt(e,10);if(!isNaN(t)&&t>=this.MIN_SPEED&&t<=this.MAX_SPEED)return void this.setSpeed(t)}}catch(e){console.warn('åŠ è½½æ‰“å­—é€Ÿåº¦è®¾ç½®å¤±è´¥:',e)}this.setSpeed(1)}saveSpeed(){try{localStorage.setItem(this.STORAGE_KEY,this.currentSpeed.toString())}catch(e){console.warn('ä¿å­˜æ‰“å­—é€Ÿåº¦è®¾ç½®å¤±è´¥:',e)}}initializeSpeedControl(){'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>this.setupSpeedControl()):this.setupSpeedControl()}setupSpeedControl(){const e=document.getElementById('typingSpeedSlider');e?(e.value=this.currentSpeed.toString(),this.updateSliderProgress(this.currentSpeed),this.updateSpeedDisplay(this.currentSpeed),e.addEventListener('input',this.handleSpeedSliderInput),e.addEventListener('change',this.handleSpeedSliderChange)):setTimeout(()=>this.setupSpeedControl(),100)}updateSliderProgress(e){const t=(e-this.MIN_SPEED)/(this.MAX_SPEED-this.MIN_SPEED)*100,a=document.getElementById('typingSpeedSlider');a&&a.style.setProperty('--typing-progress',`${t}%`)}updateSpeedDisplay(e){const t=document.getElementById('typingSpeedValue');t&&(t.textContent=this.SPEED_CONFIG[e].name)}handleSpeedSliderInput=e=>{const t=e.target,a=parseInt(t.value,10);this.setSpeed(a)};handleSpeedSliderChange=()=>{};resetSpeed(){this.setSpeed(1)}destroy(){const e=document.getElementById('typingSpeedSlider');e&&(e.removeEventListener('input',this.handleSpeedSliderInput),e.removeEventListener('change',this.handleSpeedSliderChange))}}class ge{static buildDynamicsContainer(e){if(!e||0===e.length)return'';let t='[åŠ¨æ€]\n';const a=[...e].sort((e,t)=>(e.no||0)-(t.no||0));for(const e of a){if(t+=this.buildDynamicsEntry(e),e.comments&&e.comments.length>0)for(const a of e.comments)t+=this.buildCommentEntry(e.no||1,a);if(e.likedBy&&e.likedBy.length>0)for(const a of e.likedBy)t+=this.buildLikeEntry(e.no||1,a,e.timestamp)}return t+='[/åŠ¨æ€]\n',t}static buildDynamicsEntry(e){const t=e.no||1,a=e.authorName||'å¤šäº‘ç†Š',s=e.content||'',n=e.timestamp||this.getCurrentTimestamp();return e.imageDescription?`[åŠ¨æ€_${t}|${a}|${s}|${e.imageDescription}|${n}]\n`:`[åŠ¨æ€_${t}|${a}|${s}|${n}]\n`}static buildCommentEntry(e,t){const a=this.getCurrentTimestamp();let s=t.authorName||'åŒ¿åç”¨æˆ·',n=t.content||'';const r=s.match(/^(.+?)\s+å›å¤\s+(.+)$/);if(r){const[,e,t]=r;s=`${e}@${t}`}return`[è¯„è®º_${e}|${s}|${n}|${a}]\n`}static buildLikeEntry(e,t,a){return`[ç‚¹èµ_${e}|${t}|${a||this.getCurrentTimestamp()}]\n`}static getCurrentTimestamp(){return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}static validateDynamics(e){const t=[];if(!Array.isArray(e))return t.push('åŠ¨æ€æ•°æ®å¿…é¡»æ˜¯æ•°ç»„'),{isValid:!1,errors:t};for(let a=0;a<e.length;a++){const s=e[a];if(s.content&&'string'==typeof s.content||t.push(`åŠ¨æ€ ${a+1}: ç¼ºå°‘æœ‰æ•ˆçš„å†…å®¹`),void 0!==s.no&&('number'!=typeof s.no||s.no<1)&&t.push(`åŠ¨æ€ ${a+1}: ç¼–å·å¿…é¡»æ˜¯æ­£æ•´æ•°`),void 0!==s.authorName&&'string'!=typeof s.authorName&&t.push(`åŠ¨æ€ ${a+1}: ä½œè€…åç§°å¿…é¡»æ˜¯å­—ç¬¦ä¸²`),s.comments&&Array.isArray(s.comments))for(let e=0;e<s.comments.length;e++){const n=s.comments[e];n.content&&'string'==typeof n.content||t.push(`åŠ¨æ€ ${a+1} è¯„è®º ${e+1}: ç¼ºå°‘æœ‰æ•ˆçš„å†…å®¹`)}}return{isValid:0===t.length,errors:t}}}class ue{MAIN_REGEX=/<bear>([\s\S]*?)<\/bear>/g;MESSAGE_REGEX=/\[([SG])_[^|]*\|[^|]*\|[^|]*\|[^\]]*\]/g;CHAT_BLOCK_REGEX=/\[([^/][^\]]*?)\]([\s\S]*?)\[\/\1\]/g;GROUP_CHAT_REGEX=/\[ç¾¤èŠ([^\]]+)\]\s*\n?\s*\[æˆå‘˜[ï¼š:]([^\]]+)\]\s*\n?([\s\S]*?)\n?\s*\[\/ç¾¤èŠ\1\]/g;GROUP_MESSAGE_REGEX=/\[G_[^|]*\|([^|]+)\|([^|]+)\|([^\]]+)\]/g;MEMBER_LIST_REGEX=/\[æˆå‘˜[ï¼š:]([^\]]+)\]/;MESSAGE_TYPE_REGEX=/^([^ï¼š:]+)[ï¼š:](.*)$/;contactManager;errorStats;dynamicsParser;constructor(e){this.contactManager=e,this.errorStats=new le,this.dynamicsParser=new X({enablePartialParsing:!0,enableErrorRecovery:!0,logErrors:!0})}setContactManager(e){this.contactManager=e}normalizeColons(e){return e.replace(/ï¼š/g,':')}parseMessageTypeAndContent(e){const t=e.match(this.MESSAGE_TYPE_REGEX);return t?{type:t[1],content:t[2]}:{type:'text',content:e}}async parseBearContent(e){const t=new Map;(await this.parseGroupChats(e)).forEach(e=>{t.set(e.chatId,e)});return this.parseSingleChats(e).forEach(e=>{t.set(e.chatId,e)}),t}async parseBearContentPlus(e){const t=await this.parseBearContent(e);let a=[];try{const t=this.dynamicsParser.parse(e);t.success&&t.data?(a=t.data,console.log(`âœ… è§£æåˆ° ${a.length} æ¡åŠ¨æ€æ•°æ®`)):t.warnings.length>0&&console.log('âš ï¸ åŠ¨æ€è§£æè­¦å‘Š:',t.warnings),t.errors.length>0&&console.warn('âŒ åŠ¨æ€è§£æé”™è¯¯:',t.errors)}catch(e){console.error('ğŸ’¥ åŠ¨æ€è§£æå¼‚å¸¸:',e)}return{chatMap:t,dynamics:a}}async parseGroupChats(e){const t=[],a=[...e.matchAll(this.GROUP_CHAT_REGEX)];for(const e of a){const a=e[1],s=e[2],n=e[3],r=this.normalizeColons(n),o=await this.buildGroupChatData(a,s,r);o&&t.push(o)}return t}parseSingleChats(e){const t=[];let a=e;const s=[...e.matchAll(this.GROUP_CHAT_REGEX)];for(const e of s)a=a.replace(e[0],'');const n=[...a.matchAll(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/g)];for(const e of n)a=a.replace(e[0],'');const r=[...a.matchAll(this.CHAT_BLOCK_REGEX)];if(0===r.length)return console.warn('æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•èŠå¤©å—'),t;for(let e=0;e<r.length;e++){const a=r[e],s=a[1],n=a[2],o=this.generateChatId(s),i={chatId:o,chatName:s,avatar:this.getDefaultAvatar(s),messages:[]},c=this.parseMessages(n,o);i.messages=c,c.length>0&&(i.lastMessage=c[c.length-1].content),t.push(i)}return t}generateGroupChatId(e){return e.startsWith('ç¾¤èŠ')?e:`ç¾¤èŠ${e}`}async buildGroupChatData(e,t,s){try{const n=this.parseGroupMembers(t),r=this.parseGroupMessages(s,e),o=this.generateGroupChatId(e),{GroupChatStorage:i}=await Promise.resolve().then(a.bind(a,15)),c=i.getDefaultGroupAvatar(e),l={chatId:o,chatName:e,avatar:i.getGroupAvatarWithFallback(o,c),messages:r,lastMessage:r.length>0?this.formatGroupLastMessage(r[r.length-1]):'',type:'group',members:n.map(e=>({id:e,name:e,avatar:this.getDefaultAvatar(e),role:'{{user}}'===e||'user'===e?'owner':'member',joinedAt:(new Date).toISOString()}))};return console.log(`âœ… è§£æç¾¤èŠæˆåŠŸ: ${l.chatName}, chatId: ${o}, æˆå‘˜: ${n.length}, æ¶ˆæ¯: ${r.length}`),l}catch(t){return console.error(`âŒ è§£æç¾¤èŠå¤±è´¥: ${e}`,t),null}}parseGroupMembers(e){return this.normalizeColons(e).split(/[ï¼Œ,]/).map(e=>e.trim()).filter(e=>e.length>0)}parseGroupMessages(e,t){const a=[],s=[...e.matchAll(this.GROUP_MESSAGE_REGEX)];for(const e of s){const s=this.parseGroupMessage(e,t);s&&a.push(s)}return a}parseGroupMessage(e,t){try{const a=e[0],s=a.slice(1,-1).split('|');if(s.length<4)return console.warn('ç¾¤èŠæ¶ˆæ¯æ ¼å¼æ— æ•ˆ (éƒ¨åˆ†å¤ªå°‘):',a),null;s[0].split('_')[0];const n=s[1],r=s[2]||'',o=s[s.length-1],{type:i,content:c}=this.parseMessageTypeAndContent(r);let l=c,d='';if('transfer'===i)5===s.length?(d=s[3],l=`${c}|${d}`):(d='ç­‰å¾…æ¥æ”¶',l=`${c}|ç­‰å¾…æ¥æ”¶`);else if('voice'===i)if(5===s.length){l=`${c}|${s[3]||'0'}`}else l=`${c}|0`;const h=this.buildDeterministicMessageId(this.generateGroupChatId(t),n||'æœªçŸ¥ç”¨æˆ·',l,o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}));return{id:h,type:'G',chatId:this.generateGroupChatId(t),sender:n||'æœªçŸ¥ç”¨æˆ·',avatar:this.getDefaultAvatar(n),messageType:i,content:l,timestamp:o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),senderDisplayName:n,...'transfer'===i?{data:{originalNote:d}}:{}}}catch(t){return console.error('è§£æç¾¤èŠæ¶ˆæ¯æ—¶å‡ºé”™:',t,e),null}}parseMessages(e,t){const a=[],s=[...e.matchAll(this.MESSAGE_REGEX)];if(0===s.length)return console.warn(`æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•æ¶ˆæ¯: ${t}`),a;for(const e of s){const s=this.parseMessage(e,t);s&&a.push(s)}return a}parseMessage(e,t){try{const a=e[0],s=a.slice(1,-1).split('|');if(s.length<4)return console.warn('æ¶ˆæ¯æ ¼å¼æ— æ•ˆ (éƒ¨åˆ†å¤ªå°‘):',a),null;const n=s[0].split('_')[0],r=s[1],o=s[s.length-1],i=5===s.length;let c='text',l='',d='';const h=s[2]||'';if(h.startsWith('transfer:'))if(c='transfer',i){const e=h.substring(9),t=s[3]||'ç­‰å¾…æ¥æ”¶';d=t,l=`${e}|${t}`}else{const e=h.substring(9);d='ç­‰å¾…æ¥æ”¶',l=`${e}|ç­‰å¾…æ¥æ”¶`}else if(h.startsWith('voice:'))if(c='voice',i){const e=h.substring(6);l=`${e}|${s[3]||'0'}`}else{l=`${h.substring(6)}|0`}else if(h.includes(':')){const[e,...t]=h.split(':');c=e,l=t.join(':')}else c='text',l=h;const m=this.buildDeterministicMessageId(t,r||'æœªçŸ¥ç”¨æˆ·',l,o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}));return{id:m,type:n,chatId:t,sender:r||'æœªçŸ¥ç”¨æˆ·',avatar:this.getDefaultAvatar(r),messageType:c,content:l,timestamp:o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),...'transfer'===c?{data:{originalNote:d}}:{}}}catch(t){return console.error('è§£ææ¶ˆæ¯æ—¶å‡ºé”™:',t,e),null}}extractBearContent(e){for(const t of e){const e=(t.message||'').match(this.MAIN_REGEX);if(e&&e[0])return e[0]}return console.warn('æœªæ‰¾åˆ°Bearå†…å®¹'),null}extractBearContentFromText(e){const t=e.match(this.MAIN_REGEX);return t&&t[0]?t[0]:null}extractAllBearContents(e){const t=[];for(const a of e){const e=[...(a.message||'').matchAll(this.MAIN_REGEX)];for(const a of e)a&&a[0]&&t.push(a[0])}return console.log(`ğŸ“¦ æ‰¾åˆ° ${t.length} ä¸ªBearå†…å®¹å—`),t}getDefaultAvatar(e){if('{{user}}'===e||'user'===e)return G();if(this.contactManager){const t=this.contactManager.getAllContacts().find(t=>t.name===e);if(t&&t.avatar)return t.avatar}return'https://files.catbox.moe/u8ccy5.jpg'}processImageUrl(e){if(!e)return'';if(e.startsWith('http://')||e.startsWith('https://'))return e;if(e.startsWith('data:image/'))return e;if(e.startsWith('temp://')){const t=e.replace('temp://',''),a=localStorage.getItem(`temp_image_${t}`);return a||(console.warn('ä¸´æ—¶å›¾ç‰‡æ•°æ®æœªæ‰¾åˆ°:',t),'')}const t=e.match(/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(t){return`https://files.catbox.moe/${t[1]}`}return`https://files.catbox.moe/${e}`}generateMessageId(){return'msg_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}buildDeterministicMessageId(e,t,a,s){const n=`${e}_${t}_${a}_${s}`;let r=0;for(let e=0;e<n.length;e++)r=(r<<5)-r+n.charCodeAt(e),r|=0;return`msg_${Math.abs(r).toString(36)}`}handleParseError(e,t){console.error(`ç¾¤èŠè§£æé”™è¯¯ [${t}]:`,e),this.errorStats.increment(`parse_error_${t}`),document.dispatchEvent(new CustomEvent('groupChatParseError',{detail:{error:e,context:t}}))}getErrorStats(){return this.errorStats.getStats()}resetErrorStats(){this.errorStats.reset()}buildBearContent(e){return this.buildBearContentPlus({chatMap:e,dynamics:[]})}buildBearContentPlus(e){let t='<bear>\n';for(const[,a]of e.chatMap)if('group'===a.type)t+=this.buildGroupChatBlock(a);else{t+=`[${a.chatName}]\n`;for(const e of a.messages){t+=this.buildMessageString(e)+'\n'}t+=`[/${a.chatName}]\n`}if(e.dynamics&&e.dynamics.length>0){const a=ge.buildDynamicsContainer(e.dynamics);a&&(t+=a)}return t+='</bear>',t}buildSingleChatBearContent(e){const t=new Map;t.set(e.chatId,e);const a=this.buildBearContent(t),s=a.match(/<bear>([\s\S]*?)<\/bear>/);return s&&s[1]?`<bear>${s[1]}</bear>`:a}buildGroupChatBlock(e){if('group'!==e.type)return'';const t=e.chatName;let a=`[ç¾¤èŠ${t}]\n`;a+=`[æˆå‘˜ï¼š${(e.members||[]).map(e=>e.name).join('ï¼Œ')}]\n`;for(const t of e.messages){const e=this.buildGroupMessageString(t);e&&(a+=e+'\n')}return a+=`[/ç¾¤èŠ${t}]\n`,a}buildGroupMessageString(e){if('G'!==e.type)return'';const t=e.chatId.replace(/^ç¾¤èŠ/,'');let a='';return a='text'===e.messageType?e.content:`${e.messageType}:${e.content}`,`[G_${t}|${e.sender}|${a}|${e.timestamp}]`}buildMessageString(e){return`[${e.type}_${e.chatId}|${e.sender}|${e.messageType}:${e.content}|${e.timestamp}]`}formatLastMessage(e){const t='{{user}}'===e.sender?'æˆ‘':e.sender;let a='';switch(e.messageType){case'text':default:a=e.content;break;case'image':a='[å›¾ç‰‡]';break;case'voice':a='[è¯­éŸ³]';break;case'sticker':a='[è¡¨æƒ…åŒ…]';break;case'location':a='[ä½ç½®]';break;case'transfer':a='[è½¬è´¦]'}return`${t}: ${a}`}formatGroupLastMessage(e){const t='{{user}}'===e.sender?'æˆ‘':e.senderDisplayName||e.sender;let a='';switch(e.messageType){case'text':default:a=e.content;break;case'image':a='[å›¾ç‰‡]';break;case'voice':a='[è¯­éŸ³]';break;case'sticker':a='[è¡¨æƒ…åŒ…]';break;case'location':a='[ä½ç½®]';break;case'transfer':a='[è½¬è´¦]'}return`${t}: ${a}`}generateChatId(e){return(e??'').trim()}}class pe{currentChat='';chatData=new Map;avatarMixin;sendQueue=[];currentInterface='list';messageParser;soundManager;isMenuVisible=!1;isStickerSelectorVisible=!1;isRenderingMessages=!1;shouldStopRendering=!1;isSending=!1;crossChatSendEnabled=!1;dynamicsData=[];stickerData=[];stickerOrder={};stickerLorebookName='';stickerCache=new Map;stickerSelectorClickOutsideHandler=null;isDeleteMode=!1;selectedStickers=new Set;isBatchDeleteMode=!1;selectedMessages=new Set;batchDeleteToolbar=null;transferDelegationBound=!1;characterChangeTimeout=null;chatStatusBar=null;isSuggestionVisible=!1;suggestionContainer=null;inputChangeTimer=null;lastBearContent='';chatListManager;groupChatManager;profileInterface=null;settingsModal;chatWallpaperManager=null;scaleManager;typingSpeedManager;recentOps=[];dynamicsManager=null;visibleCounts=new Map;INITIAL_VISIBLE_COUNT=50;LOAD_MORE_STEP=20;topScrollHandler=null;lastLoadMoreAt=0;LOAD_MORE_THROTTLE_MS=300;uiImageCache=new Map;cachedUserName=null;getUiImageKey(e){return`${e.chatId}|${e.sender}|${e.timestamp}`}cacheUiImagePreview(e,t){this.uiImageCache.set(this.getUiImageKey(e),t)}getRealUserNameSync(){try{const e=g.GlobalUserManager.getInstance?.(),t=e?.getCurrentUserData?.();if(t?.name)return this.cachedUserName=t.name,t.name;if(this.cachedUserName)return this.cachedUserName}catch(e){return this.cachedUserName}return this.cachedUserName}isUserSender(e){if('{{user}}'===e||'user'===e)return!0;const t=this.getRealUserNameSync();return!!t&&e===t}getCachedUiImage(e){const t=this.uiImageCache.get(this.getUiImageKey(e));if(t)return t;const a=this.getRealUserNameSync(),s=new Set([`${e.chatId}|${e.sender}|`,`${e.chatId}|{{user}}|`,`${e.chatId}|user|`]);a&&s.add(`${e.chatId}|${a}|`);for(const e of s){let t;for(const[a,s]of this.uiImageCache)a.startsWith(e)&&(t=s);if(t)return t}const n=`${e.chatId}|`;let r;for(const[e,t]of this.uiImageCache)e.startsWith(n)&&(r=t);return r}rehydrateUserImageMessages(e){try{e.messages.forEach(e=>{if('image'===e.messageType&&this.isUserSender(e.sender)&&!(e.data?.uploadedFile||e.data?.base64Image||e.data?.imageUrl)){const t=this.getCachedUiImage(e);t&&(e.data={...e.data||{},imageUrl:t})}})}catch(e){console.warn('rehydrateUserImageMessages å¤±è´¥:',e)}}constructor(){this.soundManager=new he,this.scaleManager=new de,this.typingSpeedManager=new me,this.groupChatManager=new O,this.messageParser=new ue,this.chatListManager=new h(this.soundManager,this.groupChatManager,this.messageParser),this.groupChatManager.setContactManager(this.chatListManager.getContactManager()),this.messageParser.setContactManager(this.chatListManager.getContactManager()),this.avatarMixin=new C.SimpleAvatarMixin({debug:!1}),this.dynamicsManager=new ce(this.soundManager),console.log('âœ… åŠ¨æ€ç®¡ç†å™¨å·²åˆ›å»º'),this.initializeApplication().catch(e=>{console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:',e)})}async initializeApplication(){console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å¼€å§‹...'),this.initializeEventListeners(),await g.GlobalUserManager.getInstance().initialize(),await this.initializeProfileModule(),this.initializeExtensionsModule(),this.initializeChatMigrationManager(),await this.initializeChatWallpaperManager(),await this.initializeStickerSystem(),await this.initializeGroupNameOverrideManager(),this.initializeFromExistingData(),this.initializeChatListEvents(),this.initializeAvatarSync(),console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ'),console.log('ğŸ¯ [ä¸»åº”ç”¨] åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡è§¦å‘èŠå¤©è¿ç§»æ£€æŸ¥'),await this.triggerChatMigrationCheck()}initializeAvatarSync(){try{const e=g.GlobalUserManager.getInstance(),t=e.getCurrentUserData();if(t?.isCustom&&t.avatar){console.log('[BearChatManager] å‘ç°è‡ªå®šä¹‰å¤´åƒï¼Œç«‹å³åŒæ­¥:',t.avatar);const{forceUpdateAvatars:e}=a(750);e(t.avatar)}this.avatarMixin.autoRegister(),this.avatarMixin.forceUpdate(),e.addEventListener('avatar',e=>{console.log('[BearChatManager] æ£€æµ‹åˆ°å¤´åƒå˜æ›´ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰åœ°æ–¹:',e.newValue);const{forceUpdateAvatars:t}=a(750);t(e.newValue)}),console.log('[BearChatManager] å¤´åƒåŒæ­¥å·²åˆå§‹åŒ–')}catch(e){console.error('[BearChatManager] å¤´åƒåŒæ­¥åˆå§‹åŒ–å¤±è´¥:',e)}}async getCurrentLorebook(){try{let e=null;console.log('ğŸ“– å°è¯•è·å–è§’è‰²ä¸»è¦ä¸–ç•Œä¹¦...');try{'function'==typeof getCurrentCharPrimaryLorebook?(console.log('âœ… å…¨å±€å‡½æ•° getCurrentCharPrimaryLorebook å¯ç”¨'),e=getCurrentCharPrimaryLorebook(),console.log('ğŸ“– è§’è‰²ä¸»è¦ä¸–ç•Œä¹¦è·å–ç»“æœ:',JSON.stringify(e))):console.log('âŒ å…¨å±€å‡½æ•° getCurrentCharPrimaryLorebook ä¸å¯ç”¨')}catch(e){console.log(`âŒ è·å–è§’è‰²ä¸–ç•Œä¹¦å¼‚å¸¸: ${e}`)}if(e)return console.log('âœ… ä½¿ç”¨è§’è‰²ä¸»è¦ä¸–ç•Œä¹¦:',e),e;console.log('ğŸŒ å°è¯•è·å–å…¨å±€ä¸–ç•Œä¹¦...');try{if('function'==typeof getLorebookSettings){console.log('âœ… å…¨å±€å‡½æ•° getLorebookSettings å¯ç”¨');const e=getLorebookSettings();console.log('ğŸŒ å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®:',e);const t=e.selected_global_lorebooks;if(t&&t.length>0)return console.log('âœ… ä½¿ç”¨å…¨å±€ä¸–ç•Œä¹¦:',t[0]),t[0];console.log('âŒ æ²¡æœ‰å¯ç”¨çš„å…¨å±€ä¸–ç•Œä¹¦')}else console.log('âŒ å…¨å±€å‡½æ•° getLorebookSettings ä¸å¯ç”¨')}catch(e){console.log(`âŒ è·å–å…¨å±€ä¸–ç•Œä¹¦å¼‚å¸¸: ${e}`)}return console.warn('âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ä¸–ç•Œä¹¦'),null}catch(e){return console.error('âŒ è·å–ä¸–ç•Œä¹¦å¤±è´¥:',e),null}}initializeEventListeners(){$(()=>{this.setupEventListeners(),this.initializeTransferClickDelegation()})}setupEventListeners(){const e=document.getElementById('plusBtn'),t=document.getElementById('plusMenu');e&&t&&e.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),this.togglePlusMenu(),this.soundManager.playSound('emoji')});document.querySelectorAll('.menu-item').forEach(e=>{e.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.type;t&&this.handleMenuItemClick(t)})});const a=document.getElementById('inputField');a&&(a.addEventListener('keypress',e=>{'Enter'===e.key&&this.handleEnterKey()}),a.addEventListener('input',e=>{this.handleInputChange(e)}),a.addEventListener('blur',()=>{setTimeout(()=>{this.hideStickerSuggestions()},200)}));const s=document.getElementById('sendBtn');s&&s.addEventListener('click',()=>{this.handleSendClick()});const n=document.querySelector('.home-btn'),r=document.querySelector('.diary-btn'),o=document.querySelector('.call-btn');n&&n.addEventListener('click',()=>{this.showChatList(),this.soundManager.playSound('click')}),r&&r.addEventListener('click',()=>{this.showDiaryInterface(),this.soundManager.playSound('click')}),o&&o.addEventListener('click',()=>{this.showCallInterface(),this.soundManager.playSound('click')});const i=document.getElementById('headerAvatar');i&&i.addEventListener('click',async()=>{await this.handleAvatarClick(),this.soundManager.playSound('avatar')}),document.addEventListener('click',a=>{const s=a.target,n=document.getElementById('stickerSelector');setTimeout(()=>{e?.contains(s)||t?.contains(s)||n?.contains(s)||this.hidePlusMenu()},0)}),document.addEventListener('showProfilePage',e=>{const t=e;console.log('ğŸ“± æ¥æ”¶åˆ°æ˜¾ç¤ºä¸ªäººä¸»é¡µäº‹ä»¶:',t.detail),this.handleShowProfilePage(t.detail)}),document.addEventListener('pageSwitch',e=>{const t=e,{from:a,to:s}=t.detail;console.log(`ğŸ”„ é¡µé¢åˆ‡æ¢: ${a} -> ${s}`),this.soundManager.playSound('click'),'profile'===s?this.switchToProfilePage():'chatList'===s?this.switchToChatListPage():'feed'===s&&this.switchToDynamicsPage()}),this.initializeCharacterChangeListener(),this.initializeSettings().catch(e=>{console.error('è®¾ç½®åˆå§‹åŒ–å¤±è´¥:',e)}),this.dynamicsManager&&(console.log('ğŸ¬ åˆå§‹åŒ–åŠ¨æ€ç®¡ç†å™¨...'),this.dynamicsManager.initialize(),console.log('âœ… åŠ¨æ€ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ'),this.bindRecentOpsListeners())}initializeCharacterChangeListener(){const e=this.getCurrentCharacterId();console.log(`ğŸ”„ è§’è‰²åˆ‡æ¢ç›‘å¬å·²åˆå§‹åŒ–ï¼Œå½“å‰è§’è‰²: ${e}`);try{'undefined'!=typeof eventSource&&eventSource.on&&(eventSource.on('CHARACTER_CHANGED',()=>{console.log('ğŸ”„ æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢äº‹ä»¶ (CHARACTER_CHANGED)'),this.handleCharacterChange()}),console.log('âœ… å·²ç›‘å¬ CHARACTER_CHANGED äº‹ä»¶')),document.addEventListener('characterChanged',()=>{console.log('ğŸ”„ æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢äº‹ä»¶ (characterChanged)'),this.handleCharacterChange()}),document.addEventListener('character_loaded',()=>{console.log('ğŸ”„ æ£€æµ‹åˆ°è§’è‰²åŠ è½½äº‹ä»¶ (character_loaded)'),this.handleCharacterChange()}),console.log('âœ… è§’è‰²åˆ‡æ¢äº‹ä»¶ç›‘å¬å·²è®¾ç½®')}catch(e){console.error('è®¾ç½®è§’è‰²åˆ‡æ¢ç›‘å¬å¤±è´¥:',e)}}getCurrentCharacterId(){try{if('function'==typeof getCharData)try{const e=getCharData('current');if(e)return e.name||e.avatar||'default'}catch(e){console.error('[BearChatManager] getCharData("current") è°ƒç”¨å¤±è´¥:',e)}if(window.TavernHelper&&'function'==typeof window.TavernHelper.getCharData)try{const e=window.TavernHelper.getCharData();if(e)return e.name||e.avatar||'default'}catch(e){console.error('[BearChatManager] window.TavernHelper.getCharData() è°ƒç”¨å¤±è´¥:',e)}if(void 0!==window.this_chid&&void 0!==window.characters){const e=window.this_chid,t=window.characters;if(t[e]){const a=t[e];return a.name||a.avatar||`char_${e}`}}if('function'==typeof getCharData)try{const e=getCharData();if(e)return e.name||e.avatar||'default'}catch(e){console.error('[BearChatManager] getCharData() è°ƒç”¨å¤±è´¥:',e)}return'default'}catch(e){return console.error('è·å–è§’è‰²IDå¤±è´¥:',e),'default'}}handleCharacterChange(){this.characterChangeTimeout&&clearTimeout(this.characterChangeTimeout),this.characterChangeTimeout=setTimeout(async()=>{console.log('ğŸ”„ å¤„ç†è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½è”ç³»äººæ•°æ®...');try{const{clearCharacterIdCache:e}=a(464);e()}catch(e){console.error('æ¸…é™¤è§’è‰²IDç¼“å­˜å¤±è´¥:',e)}await this.chatListManager.reloadContacts();try{const{WallpaperManager:e}=await Promise.resolve().then(a.bind(a,582));e.getInstance().handleCharacterChange(),console.log('ğŸ–¼ï¸ èŠå¤©åˆ—è¡¨å£çº¸è®¾ç½®å·²é‡æ–°åŠ è½½')}catch(e){console.error('é‡æ–°åŠ è½½èŠå¤©åˆ—è¡¨å£çº¸è®¾ç½®å¤±è´¥:',e)}try{this.chatWallpaperManager&&(this.chatWallpaperManager.handleCharacterChange(),console.log('ğŸ–¼ï¸ èŠå¤©çª—å£å£çº¸è®¾ç½®å·²é‡æ–°åŠ è½½'))}catch(e){console.error('é‡æ–°åŠ è½½èŠå¤©çª—å£å£çº¸è®¾ç½®å¤±è´¥:',e)}const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&(console.log('ğŸ“‹ åˆ·æ–°èŠå¤©åˆ—è¡¨æ˜¾ç¤º'),this.chatListManager.refreshChatList());try{$(document).trigger('characterChange')}catch(e){console.warn('è§¦å‘ characterChange äº‹ä»¶å¤±è´¥:',e)}console.log('âœ… è§’è‰²åˆ‡æ¢å¤„ç†å®Œæˆ')},300)}async initializeSettings(){try{const{StorageManager:e}=await Promise.resolve().then(a.bind(a,764)),t=e.getInstance().loadSettings();this.crossChatSendEnabled=t.crossChatSendEnabled,console.log('ğŸ”„ è·¨èŠå¤©å‘é€è®¾ç½®å·²åŠ è½½:',this.crossChatSendEnabled)}catch(e){console.error('åŠ è½½è·¨èŠå¤©å‘é€è®¾ç½®å¤±è´¥:',e),this.crossChatSendEnabled=!1}document.addEventListener('settingsUpdated',e=>{const{crossChatSendEnabled:t}=e.detail;'boolean'==typeof t&&(this.crossChatSendEnabled=t,console.log('ğŸ”„ è·¨èŠå¤©å‘é€è®¾ç½®å·²åŒæ­¥:',t))})}switchToPage(e){switch(console.log(`ğŸ”„ åˆ‡æ¢åˆ°é¡µé¢: ${e}`),this.hideAllInterfaces(),e){case'chat-list':this.showChatList();break;case'dynamics':this.showDynamicsInterface();break;case'profile':this.showProfileInterface();break;default:console.warn(`æœªçŸ¥é¡µé¢: ${e}`)}}switchToChatListPage(){this.hideAllInterfaces(),this.showChatList()}switchToProfilePage(){this.hideAllInterfaces(),this.showProfileInterface()}switchToDynamicsPage(){console.log('ğŸ”„ åˆ‡æ¢åˆ°åŠ¨æ€é¡µé¢'),this.hideAllInterfaces(),this.showDynamicsInterface()}showDynamicsInterface(){if(console.log('ğŸ“± å‡†å¤‡æ˜¾ç¤ºåŠ¨æ€ç•Œé¢...'),this.dynamicsManager)try{this.dynamicsManager.showDynamicsInterface(),console.log('âœ… åŠ¨æ€ç•Œé¢æ˜¾ç¤ºæˆåŠŸ')}catch(e){console.error('æ˜¾ç¤ºåŠ¨æ€ç•Œé¢å¤±è´¥:',e),this.soundManager.playSound('error'),this.switchToPage('chat-list')}else console.error('âŒ åŠ¨æ€é¡µé¢æ¨¡å—æœªåˆå§‹åŒ–'),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('åŠ¨æ€é¡µé¢æ¨¡å—æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'),this.switchToPage('chat-list')}hideAllInterfaces(){const e=document.getElementById('chatInterface');e&&(e.style.display='none'),this.chatListManager.hideChatListInterface(),this.profileInterface&&this.profileInterface.hide(),this.dynamicsManager&&this.dynamicsManager.hideDynamicsInterface()}showProfileInterface(){if(console.log('ğŸ‘¤ å‡†å¤‡æ˜¾ç¤ºä¸ªäººä¸»é¡µç•Œé¢...'),this.profileInterface)try{this.profileInterface.show(),console.log('âœ… ä¸ªäººä¸»é¡µç•Œé¢æ˜¾ç¤ºæˆåŠŸ')}catch(e){console.error('æ˜¾ç¤ºä¸ªäººä¸»é¡µç•Œé¢å¤±è´¥:',e),this.soundManager.playSound('error'),this.switchToPage('chat-list')}else console.error('âŒ æˆ‘çš„é¡µé¢æ¨¡å—æœªåˆå§‹åŒ–'),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('ä¸ªäººä¸»é¡µæ¨¡å—æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'),this.switchToPage('chat-list')}handleShowProfilePage(e){console.log(`ğŸ‘¤ æ˜¾ç¤ºä¸ªäººä¸»é¡µ - æ¥æº: ${e.source}`);try{this.soundManager.playSound('click'),this.switchToPage('profile')}catch(e){console.error('æ˜¾ç¤ºä¸ªäººä¸»é¡µå¤±è´¥:',e),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('æ— æ³•æ‰“å¼€ä¸ªäººä¸»é¡µï¼Œè¯·ç¨åé‡è¯•')}}async clearLorebookCharacterCache(){try{const e=this.chatListManager.getContactManager(),t=await e.clearLorebookCharacterCache();return console.log(`ğŸ—‘ï¸ [BearChatManager] ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜æ¸…é™¤å®Œæˆ: ${t.cleared}/${t.total}`),this.soundManager.playSound('success'),'undefined'!=typeof toastr&&(t.cleared>0?toastr.success(`å·²æ¸…é™¤ ${t.cleared} ä¸ªä¸–ç•Œä¹¦è§’è‰²çš„ç¼“å­˜`):t.total>0?toastr.info(`ä¸–ç•Œä¹¦ä¸­æœ‰ ${t.total} ä¸ªè§’è‰²ï¼Œä½†æ²¡æœ‰è‡ªå®šä¹‰å¤´åƒç¼“å­˜éœ€è¦æ¸…é™¤`):toastr.info('ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº')),t}catch(e){return console.error('âŒ [BearChatManager] æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥:',e),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'),{cleared:0,total:0}}}getLorebookCacheStats(){try{return this.chatListManager.getContactManager().getLorebookCacheStats()}catch(e){return console.error('âŒ [BearChatManager] è·å–ä¸–ç•Œä¹¦ç¼“å­˜ç»Ÿè®¡å¤±è´¥:',e),{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}}initializeFromExistingData(){if('function'==typeof getChatMessages)try{const e=getChatMessages('0-{{lastMessageId}}');this.parseExistingMessages(e)}catch(e){console.error('è·å–ç°æœ‰æ¶ˆæ¯å¤±è´¥:',e),this.initializeDefaultData()}else console.warn('getChatMessageså‡½æ•°ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®'),this.initializeDefaultData()}async parseExistingMessages(e){console.log('ğŸ”„ å¼€å§‹è§£æç°æœ‰æ¶ˆæ¯ï¼Œåˆå¹¶æ‰€æœ‰æ¥¼å±‚...');const t=this.messageParser.extractAllBearContents(e);if(0===t.length)return void console.warn('æœªæ‰¾åˆ°ä»»ä½•Bearå†…å®¹å—');this.chatData=new Map,this.dynamicsData=[];for(const e of t)try{const t=await this.messageParser.parseBearContentPlus(e),a=t.chatMap,s=t.dynamics;for(const[e,t]of a){const a=this.chatData.get(e);if(a){if(a.messages=this.mergeMessages(a.messages,t.messages),a.messages.length>0){const e=a.messages[a.messages.length-1];a.lastMessage='group'===a.type?this.formatGroupLastMessage(e):e.content}}else this.chatData.set(e,t)}s&&s.length>0&&(this.dynamicsData=this.mergeDynamicsData(this.dynamicsData,s),console.log(`ğŸ“ åˆå¹¶åŠ¨æ€æ•°æ®ï¼Œå½“å‰å…± ${this.dynamicsData.length} æ¡åŠ¨æ€`))}catch(e){console.error('è§£æBearå—æ—¶å‡ºé”™:',e)}console.log(`âœ… åˆå¹¶å®Œæˆï¼Œå…±è§£æ ${this.chatData.size} ä¸ªèŠå¤©ï¼Œæ¥è‡ª ${t.length} ä¸ªBearå—`),N.applyOverridesToChatData(this.chatData);const a=Array.from(this.chatData.keys()).filter(e=>'group'===this.chatData.get(e)?.type);if(N.validateAndCleanOverrides(a),this.chatData.size>0){const e=this.chatData.keys().next().value;e&&(this.currentChat=e),this.showChatList()}0===this.chatData.size&&this.initializeDefaultData()}initializeDefaultData(){this.showChatList()}togglePlusMenu(){const e=document.getElementById('plusMenu');e&&(this.hideStickerSelector(),this.isMenuVisible=!this.isMenuVisible,this.isMenuVisible?(e.classList.add('active'),setTimeout(()=>{e.classList.add('show')},10)):this.hidePlusMenu())}hidePlusMenu(){const e=document.getElementById('plusMenu');e&&(e.classList.remove('active','show'),this.isMenuVisible=!1)}handleMenuItemClick(e){switch(this.soundManager.playSound('emoji'),this.hidePlusMenu(),e){case'sticker':this.handleStickerMenuClick();break;case'image':this.handleImageMenuClick();break;case'voice':this.handleVoiceMenuClick();break;case'location':this.handleLocationMenuClick();break;case'transfer':this.handleTransferMenuClick();break;default:console.warn(`æœªçŸ¥çš„èœå•é¡¹ç±»å‹: ${e}`),this.showToast(`åŠŸèƒ½ "${e}" æš‚æœªå®ç°`,'warning')}}handleStickerMenuClick(){this.showStickerSelector()}handleImageMenuClick(){this.showImageInputModal()}handleVoiceMenuClick(){this.showVoiceInputModal()}handleLocationMenuClick(){this.showLocationInputModal()}handleTransferMenuClick(){this.showTransferInputModal()}handleEnterKey(){if(this.isSending)return void console.log('ğŸš« æ­£åœ¨å‘é€ä¸­ï¼Œè¯·ç­‰å¾…å‘é€å®Œæˆ');const e=document.getElementById('inputField'),t={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'text',content:e.value.trim(),timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(t),e.value='',this.addNewMessageToInterface(t),this.soundManager.playSound('send')}updateSendButtonState(e){const t=document.getElementById('sendBtn');t&&(t.disabled=e,e?(t.style.opacity='0.6',t.style.cursor='not-allowed'):(t.style.opacity='1',t.style.cursor='pointer'))}async handleSendClick(){if(this.isSending)return void console.log('ğŸš« æ­£åœ¨å‘é€ä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');console.log('ğŸ”„ è·¨èŠå¤©å‘é€æ¨¡å¼: '+(this.crossChatSendEnabled?'å¼€å¯':'å…³é—­'));const e=this.crossChatSendEnabled?this.sendQueue:this.getPendingMessagesForCurrentChat();if(0!==e.length){if(this.isSending=!0,this.updateSendButtonState(!0),console.log(`ğŸ“¤ å®é™…å‘é€ ${e.length} æ¡æ¶ˆæ¯`),this.crossChatSendEnabled&&this.sendQueue.length>0){const t={};for(const a of e)t[a.chatId]=(t[a.chatId]||0)+1;console.log('ğŸ“Š è·¨èŠå¤©å‘é€ç»Ÿè®¡:',t)}this.soundManager.playSound('send');try{await this.processSendQueue(e),this.isSending=!1,this.updateSendButtonState(!1),console.log('âœ… å‘é€å®Œæˆï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤')}catch(e){throw this.isSending=!1,this.updateSendButtonState(!1),console.error('âŒ å‘é€å¤±è´¥ï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤:',e),e}}else console.log('æ²¡æœ‰å¾…å‘é€çš„æ¶ˆæ¯')}async processSendQueue(e){if(0!==e.length)try{console.log(`ğŸš€ å¼€å§‹æ‰¹é‡å‘é€ ${e.length} æ¡æ¶ˆæ¯`),this.crossChatSendEnabled?await this.processCrossChatSend(e):await this.processSingleChatSend(e),this.clearSentMessages(e),this.crossChatSendEnabled&&this.sendQueue.length>0&&console.log(`ğŸ“ è·¨èŠå¤©å‘é€å®Œæˆï¼Œé˜Ÿåˆ—ä¸­è¿˜æœ‰ ${this.sendQueue.length} æ¡æ¶ˆæ¯`),console.log('âœ… æ‰¹é‡æ¶ˆæ¯å‘é€æˆåŠŸ')}catch(e){console.error('âŒ æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥:',e),this.showErrorToast(`æ¶ˆæ¯å‘é€å¤±è´¥: ${e.message||'æœªçŸ¥é”™è¯¯'}`)}else console.log('ğŸ“­ å‘é€é˜Ÿåˆ—ä¸ºç©º')}async processCrossChatSend(e){const t=new Map;for(const a of e)t.has(a.chatId)||t.set(a.chatId,[]),t.get(a.chatId).push(a);console.log(`ğŸ“¤ è·¨èŠå¤©å‘é€ï¼šå°†å‘ ${t.size} ä¸ªèŠå¤©å‘é€æ¶ˆæ¯`);const a=this.buildCrossChatPrompt(t);console.log('ğŸ“ è·¨èŠå¤©åˆå¹¶æç¤ºè¯:',a);let s=null;try{s=this.showTypingIndicator();let e=null;for(const[_,a]of t)if(e=this.extractImageFileFromMessages(a),e)break;console.log('ğŸ“¡ è°ƒç”¨ generate å‡½æ•°ï¼ˆè·¨èŠå¤©åˆå¹¶å‘é€ï¼‰...');const n={user_input:a,should_stream:!1};e&&(n.image=e,e instanceof File?console.log('ğŸ“· è·¨èŠå¤©åŒ…å«å›¾ç‰‡æ–‡ä»¶:',e.name):console.log('ğŸ“· è·¨èŠå¤©åŒ…å«å›¾ç‰‡æ•°æ®:',e.startsWith('data:image/')?'base64':'url')),console.log('ğŸš€ è·¨èŠå¤©è°ƒç”¨generate');const r=await generate(n);console.log('ğŸ¤– æ”¶åˆ°AIå›å¤:',r),this.hideTypingIndicator(await s),this.flushRecentOps(),await this.handleCrossChatAIResponse(r,t)}catch(e){throw s&&this.hideTypingIndicator(await s),e}}async processSingleChatSend(e){let t=null;try{console.log('ğŸ“¤ å¼€å§‹å¤„ç†å•ä¸ªèŠå¤©å‘é€ï¼Œæ¶ˆæ¯æ•°é‡:',e.length),console.log('ğŸ“¤ å¤„ç†æ¶ˆæ¯:',e.length,'æ¡');const a=this.extractImageFileFromMessages(e);console.log('ğŸ” [DEBUG] æå–åˆ°çš„å›¾ç‰‡æ•°æ®:',a?{type:typeof a,isFile:a instanceof File,isString:'string'==typeof a,fileName:a instanceof File?a.name:void 0,fileSize:a instanceof File?a.size:void 0,isBase64:'string'==typeof a&&a.startsWith('data:image/'),base64Length:'string'==typeof a?a.length:void 0}:null);const s=this.buildCombinedPrompt(e,null!==a);if(console.log('ğŸ“ æ„å»ºæç¤ºè¯å®Œæˆ'),t=this.showTypingIndicator(),console.log('ğŸ“¡ è°ƒç”¨ generate å‡½æ•°...'),'string'!=typeof s)throw console.error('ğŸš¨ [ERROR] combinedPromptä¸æ˜¯å­—ç¬¦ä¸²:',typeof s,s),new Error('combinedPromptå¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ”¶åˆ°äº†: '+typeof s);const n={user_input:s,should_stream:!1};a&&(n.image=a,a instanceof File?console.log('ğŸ“· åŒ…å«å›¾ç‰‡æ–‡ä»¶:',a.name,'ç±»å‹:',a.type):console.log('ğŸ“· åŒ…å«base64å›¾ç‰‡æ•°æ®')),console.log('ğŸ” [DEBUG] æœ€ç»ˆçš„generateé…ç½®:',{user_input:n.user_input.substring(0,200)+(n.user_input.length>200?'...':''),should_stream:n.should_stream,hasImage:!!n.image,imageInfo:n.image?n.image instanceof File?{type:'File',name:n.image.name,size:n.image.size,fileType:n.image.type}:{type:'String',isUrl:n.image.startsWith('http'),isBase64:n.image.startsWith('data:image/'),length:n.image.length}:null}),console.log('ğŸš€ è°ƒç”¨generate');const r=await generate(n);console.log('ğŸ¤– æ”¶åˆ°AIå›å¤:',r),this.hideTypingIndicator(await t),this.flushRecentOps(),this.handleAIResponse(r,e[e.length-1]).catch(e=>{console.error('âŒ å¤„ç†AIå›å¤å¤±è´¥:',e)}),console.log('âœ… generateè°ƒç”¨å®Œæˆï¼ŒprocessSingleChatSendå³å°†è¿”å›')}catch(e){throw t&&this.hideTypingIndicator(await t),e}}clearSentMessages(e){const t=new Set(e.map(e=>e.id));this.sendQueue=this.sendQueue.filter(e=>!t.has(e.id)),console.log(`ğŸ§¹ å·²æ¸…ç©º ${e.length} æ¡æ¶ˆæ¯ï¼Œé˜Ÿåˆ—å‰©ä½™ ${this.sendQueue.length} æ¡`)}extractImageFileFromMessages(e){console.log('ğŸ” [DEBUG] extractImageFileFromMessages å¼€å§‹ï¼Œæ¶ˆæ¯æ•°é‡:',e.length);for(const t of e)if('image'===t.messageType){if(t.data?.uploadedFile){return t.data.uploadedFile}if(t.data?.base64Image){return t.data.base64Image}if(t.data?.imageUrl){return t.data.imageUrl}}return console.log('ğŸ” [DEBUG] æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶æˆ–base64æ•°æ®'),null}processMessageContent(e,t){let a=e.content;if('image'===e.messageType&&t&&(e.data?.uploadedFile||e.data?.base64Image||e.data?.imageUrl)){const t=/^å›¾ç‰‡URLï¼š.*?\nå›¾ç‰‡æè¿°ï¼š(.*?)$/,s=a.match(t);if(s){return s[1]||''}const n=/^å›¾ç‰‡æ–‡ä»¶ï¼š.*?(?:\nå›¾ç‰‡æè¿°ï¼š(.*?))?$/,r=a.match(n);if(r){return r[1]||''}return(e.data?.base64Image||e.data?.imageUrl)&&a&&!a.includes('â•’â•â•â•â•â•')?(console.log('ğŸ” [DEBUG] å›¾ç‰‡æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨å†…å®¹ä½œä¸ºæè¿°:',a),a):''}return'text'!==e.messageType&&(a=`${e.messageType}:${a}`),'string'!=typeof a?(console.error('ğŸš¨ [ERROR] processMessageContentè¿”å›äº†éå­—ç¬¦ä¸²:',typeof a,a),''):a}buildCombinedPrompt(e,t=!1){if(0===e.length)return'';const a=e[0],s=this.chatData.get(a.chatId);let n='';if('group'===s?.type){n=`å›å¤å’Œ${s.chatName||a.chatId}çš„èŠå¤©ï¼š`}else{const e=s?.chatName||a.chatId;n=`å›å¤å’Œ${this.extractCharacterNameFromChatName(e)}çš„èŠå¤©ï¼š`}if(1===e.length){let a=`${n}${this.processMessageContent(e[0],t)}`;const s=this.formatRecentOpsSummary();return s&&(a+=`\n\næˆ‘çš„æœ€è¿‘æ“ä½œï¼š\n${s}`),a}let r=`${n}\n${e.map((e,a)=>`${a+1}. ${this.processMessageContent(e,t)}`).join('\n')}`;const o=this.formatRecentOpsSummary();return o&&(r+=`\n\næˆ‘çš„æœ€è¿‘æ“ä½œï¼š\n${o}`),r}buildCrossChatPrompt(e){const t=[];let a=!1;for(const[_,t]of e)if(this.extractImageFileFromMessages(t)){a=!0;break}for(const[s,n]of e){if(0===n.length)continue;const e=this.chatData.get(s);let r='';if('group'===e?.type){r=`å›å¤å’Œ${e.chatName||s}çš„èŠå¤©ï¼š`}else{const t=e?.chatName||s;r=`å›å¤å’Œ${this.extractCharacterNameFromChatName(t)}çš„èŠå¤©ï¼š`}if(1===n.length){r+=this.processMessageContent(n[0],a)}else{r+=n.map((e,t)=>`${t+1}. ${this.processMessageContent(e,a)}`).join('')}t.push(r)}const s=t.join('\n'),n=this.formatRecentOpsSummary();return n?`${s}\n\næˆ‘çš„æœ€è¿‘æ“ä½œï¼š\n${n}`:s}async handleCrossChatAIResponse(e,t){try{const a=this.cleanAIInternalTags(e);console.log('ğŸ§¹ å·²æ¸…ç†AIå†…éƒ¨æ€è€ƒæ ‡ç­¾');const s=this.extractLastBearContent(a);if(s)console.log('ğŸ» æ£€æµ‹åˆ° Bear æ ‡ç­¾ï¼Œå¼€å§‹è·¨èŠå¤©æ•°æ®å¤„ç†æµç¨‹...'),await this.updateCurrentMessageWithBearContent(s);else{console.log('ğŸ“ æœªæ‰¾åˆ°Bearæ ‡ç­¾ï¼Œä½¿ç”¨/sendasè¾“å‡ºåˆ°æ–°æ¥¼å±‚...');const e=Array.from(t.keys()).pop(),s=t.get(e);s&&s.length>0&&await this.sendAIResponseToNewFloor(a)}}catch(e){throw console.error('âŒ å¤„ç†è·¨èŠå¤©AIå›å¤å¤±è´¥:',e),e}}clearSendQueue(){this.sendQueue=[],console.log('ğŸ§¹ å‘é€é˜Ÿåˆ—å·²æ¸…ç©º')}async handleAIResponse(e,t){try{const t=this.cleanAIInternalTags(e);console.log('ğŸ§¹ å·²æ¸…ç†AIå†…éƒ¨æ€è€ƒæ ‡ç­¾');const a=this.extractLastBearContent(t);a?(console.log('ğŸ» æ£€æµ‹åˆ° Bear æ ‡ç­¾ï¼Œå¼€å§‹å®Œæ•´çš„æ•°æ®å¤„ç†æµç¨‹...'),await this.updateCurrentMessageWithBearContent(a)):(console.log('ğŸ“ æœªæ‰¾åˆ°Bearæ ‡ç­¾ï¼Œä½¿ç”¨/sendasè¾“å‡ºåˆ°æ–°æ¥¼å±‚...'),await this.sendAIResponseToNewFloor(t))}catch(e){throw console.error('âŒ å¤„ç†AIå›å¤å¤±è´¥:',e),e}}async updateCurrentMessageWithBearContent(e){try{console.log('ğŸ“ å¼€å§‹æ›´æ–°Bearå†…å®¹');const t=getChatMessages(-1)[0];if(!t)return void console.error('âŒ æ— æ³•è·å–æœ€æ–°æ¥¼å±‚æ¶ˆæ¯');const a=t.message_id;console.log('ï¿½  [DEBUG] å¼€å§‹æ£€æµ‹æ–°æ¶ˆæ¯...');const s=await this.detectNewMessagesBeforeMerge(e),n=await this.mergeBearContentToExistingData(e),r=t.message||'',o=this.replaceOnlyBearTagContent(r,n);console.log('ğŸ’¾ ä¿å­˜æ•°æ®åˆ°SillyTavern...'),await setChatMessages([{message_id:a,message:o}],{refresh:'none'}),console.log('âœ… å·²ä½¿ç”¨setChatMessagesæ›´æ–°å½“å‰æ¥¼å±‚çš„Bearå†…å®¹ï¼ˆä¿ç•™æ ‡ç­¾å¤–å†…å®¹ï¼‰'),this.clearSendQueue();try{this.chatData.forEach(e=>{e.messages.forEach(e=>{if('image'===e.messageType&&this.isUserSender(e.sender)&&!(e.data?.uploadedFile||e.data?.base64Image||e.data?.imageUrl)){const t=this.getCachedUiImage(e);t&&(e.data={...e.data||{},imageUrl:t})}})})}catch(e){console.warn('UI é¢„è§ˆå›¾ç¼“å­˜å¤æ°´å¤±è´¥:',e)}await this.renderDetectedNewMessages(s),this.lastBearContent=n,this.chatListManager&&this.chatListManager.refreshChatList(this.chatData),console.log('âœ… AIå›å¤å¤„ç†å®Œæˆï¼ˆæ•°æ®å·²å®‰å…¨ä¿å­˜ï¼‰')}catch(e){throw console.error('âŒ æ›´æ–°Bearå†…å®¹å¤±è´¥:',e),e}}replaceOnlyBearTagContent(e,t){const a=e.match(/<bear>([\s\S]*?)<\/bear>/);if(a){const s=a.index??0;return`${e.substring(0,s)}<bear>${t}</bear>${e.substring(s+a[0].length)}`}return console.log('ğŸ“ æœªæ‰¾åˆ°ç°æœ‰bearæ ‡ç­¾ï¼Œç›´æ¥æ·»åŠ æ–°å†…å®¹'),`${e}<bear>${t}</bear>`}async mergeBearContentToExistingData(e){try{console.log('ğŸ”„ å¼€å§‹åˆå¹¶Bearå†…å®¹'),await this.backfillDynamicsFromCurrentMessage();const t=await this.messageParser.parseBearContentPlus(e),a=t.chatMap,s=t.dynamics,n=M.getInstance().isFeatureEnabled(),r=await this.hasMultipleBearFloors();console.log('ğŸ” æ¥¼å±‚çŠ¶æ€åˆ†æ:',{hasMultipleBearFloors:r,isMigrationEnabled:n,existingChatCount:this.chatData.size});if(r&&!n){console.log('ğŸ”„ åˆ†ç¦»æ¨¡å¼ï¼šåœ¨å½“å‰æ¥¼å±‚å†…å®¹åŸºç¡€ä¸Šç´¯ç§¯æ–°æ¶ˆæ¯');const t=getChatMessages(-1)[0],n=this.messageParser.extractBearContentFromText(t?.message||'');let r=new Map,o=[];if(n){const e=await this.messageParser.parseBearContentPlus(n);r=e.chatMap,o=e.dynamics||[]}for(const[e,t]of a){const a=r.get(e);if(a){const s=this.mergeMessages(a.messages,t.messages);a.messages=s,a.lastMessage=s.length>0?this.messageParser.formatLastMessage(s[s.length-1]):'',console.log(`ğŸ“ åˆ†ç¦»æ¨¡å¼ï¼šåˆå¹¶æ¥¼å±‚èŠå¤© ${e}ï¼Œç°æœ‰ ${s.length} æ¡æ¶ˆæ¯`)}else r.set(e,t),console.log(`ğŸ†• åˆ†ç¦»æ¨¡å¼ï¼šæ·»åŠ æ–°èŠå¤© ${e}ï¼ŒåŒ…å« ${t.messages.length} æ¡æ¶ˆæ¯`)}s&&s.length>0&&(o=this.mergeDynamicsData(o,s),console.log(`ğŸ“ åˆ†ç¦»æ¨¡å¼ï¼šåˆå¹¶åŠ¨æ€æ•°æ®ï¼Œå½“å‰æ¥¼å±‚å…± ${o.length} æ¡åŠ¨æ€`)),this.updateInterfaceDataWithNewMessages(a),s&&s.length>0&&(this.dynamicsData=this.mergeDynamicsData(this.dynamicsData,s));const i=this.messageParser.buildBearContentPlus({chatMap:r,dynamics:o}),c=this.mergeSignaturesIntoDynamicsBlock(i,e);return console.log('âœ… Bearå†…å®¹å¤„ç†å®Œæˆï¼ˆåˆ†ç¦»æ¨¡å¼ï¼šå½“å‰æ¥¼å±‚å†…å®¹ + æ–°å†…å®¹ï¼‰'),c.replace('<bear>','').replace('</bear>','')}{console.log('ğŸ”„ ç´¯ç§¯æ¨¡å¼ï¼šåˆå¹¶å†å²æ¶ˆæ¯ + æ–°æ¶ˆæ¯');for(const[e,t]of a){const a=this.chatData.get(e);if(a){const s=this.mergeMessages(a.messages,t.messages);a.messages=s,a.lastMessage=s.length>0?this.messageParser.formatLastMessage(s[s.length-1]):'',console.log(`ğŸ“ ç´¯ç§¯èŠå¤© ${e}ï¼Œç°æœ‰ ${s.length} æ¡æ¶ˆæ¯`)}else this.chatData.set(e,t),console.log(`ğŸ†• æ·»åŠ æ–°èŠå¤© ${e}ï¼ŒåŒ…å« ${t.messages.length} æ¡æ¶ˆæ¯`)}s&&s.length>0&&(this.dynamicsData=this.mergeDynamicsData(this.dynamicsData,s),console.log(`ğŸ“ åˆå¹¶åŠ¨æ€æ•°æ®ï¼Œå½“å‰å…± ${this.dynamicsData.length} æ¡åŠ¨æ€`));const t=this.messageParser.buildBearContentPlus({chatMap:this.chatData,dynamics:this.dynamicsData}),n=this.mergeSignaturesIntoDynamicsBlock(t,e);return console.log('âœ… Bearå†…å®¹å¤„ç†å®Œæˆï¼ˆç´¯ç§¯æ¨¡å¼ï¼šåŒ…å«å†å²æ¶ˆæ¯å’ŒåŠ¨æ€ï¼‰'),n.replace('<bear>','').replace('</bear>','')}}catch(t){return console.error('âŒ åˆå¹¶Bearå†…å®¹å¤±è´¥:',t),e}}mergeSignaturesIntoDynamicsBlock(e,t){try{const a=/<bear>([\s\S]*?)<\/bear>/,s=/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/g,n=/\[ç­¾å\|([^|\]\r\n]+)\|([^|\]\r\n]+)\|((?:[01]\d|2[0-3]):[0-5]\d)\]/g,r=e=>{if(!e)return'';const t=e.match(a);return t?t[1]:e},o=e=>{const t=r(e),a=[];let o;for(s.lastIndex=0;null!==(o=s.exec(t));){const e=o[1]||'';let t;for(n.lastIndex=0;null!==(t=n.exec(e));)a.push({author:(t[1]||'').trim(),text:(t[2]||'').trim(),time:t[3]||'',line:t[0]})}return a},i=r(e),c=(()=>{try{const e=getChatMessages(-1)?.[0];return e?.message||''}catch{return''}})(),l=o(i),d=o(c),h=o(t);if(0===l.length&&0===d.length&&0===h.length)return e;const m=[...l,...d,...h],g={};m.forEach((e,t)=>{g[e.author]=t});const u=m.filter((e,t)=>g[e.author]===t).map(e=>e.line).join('\n');let p=i;const v=[...p.matchAll(s)];if(v.length>0){const e=v[v.length-1],t=e[0],a=(e[1]??'').replace(n,'').replace(/\s+$/,''),s=`[åŠ¨æ€]${[a,u].filter(e=>e&&e.length>0).join('\n')}\n[/åŠ¨æ€]`;p=p.replace(t,s)}else if(u&&u.length>0){const e=`[åŠ¨æ€]\n${u}\n[/åŠ¨æ€]\n`;p=(p.endsWith('\n')?p:p+'\n')+e}return`<bear>${p}</bear>`}catch(t){return console.warn('mergeSignaturesIntoDynamicsBlock å¤±è´¥:',t),e}}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}mergeMessages(e,t){console.log(`ğŸ”„ åˆå¹¶æ¶ˆæ¯: ç°æœ‰ ${e.length}, æ–°å¢ ${t.length}`);const a=new Set;for(const t of e){const e=this.generateMessageFingerprint(t);a.add(e)}const s=[];for(const e of t){const t=this.generateMessageFingerprint(e),n=!a.has(t);console.log(`ğŸ”„ [DEBUG] ${n?'æ·»åŠ æ–°æ¶ˆæ¯':'è·³è¿‡é‡å¤æ¶ˆæ¯'}: "${t}", å‘é€è€…: "${e.sender}", å†…å®¹: "${e.content.substring(0,30)}..."`),n&&s.push(e)}s.sort((e,t)=>this.compareMessageTimestamps(e.timestamp,t.timestamp));const n=[...e,...s];return console.log(`ğŸ”„ åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆæ¶ˆæ¯æ•°é‡: ${n.length}ï¼Œæ–°å¢: ${s.length}`),n}async backfillDynamicsFromCurrentMessage(){try{console.log('ğŸ”„ [å›çŒ] å¼€å§‹ä»å½“å‰æ¥¼å±‚å›çŒåŠ¨æ€æ•°æ®');const e=getChatMessages(-1);if(!e||0===e.length)return void console.log('â„¹ï¸ [å›çŒ] æœªæ‰¾åˆ°å½“å‰æ¥¼å±‚ï¼Œè·³è¿‡å›çŒ');const t=e[0],a=t.message_id,s=t.message||'',n=window.__bearDynBridge;if(n&&'function'==typeof n.upsertFloorFromText)return await n.upsertFloorFromText(a),void console.log('âœ… [å›çŒ] å·²é€šè¿‡ BridgeV2 æ ¡å‡†å½“å‰æ¥¼å±‚åŠ¨æ€ï¼ˆMap å•æºï¼‰');const r=s.match(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/);if(!r)return void console.log('â„¹ï¸ [å›çŒ] å½“å‰æ¥¼å±‚æ—  [åŠ¨æ€] å®¹å™¨ï¼Œè·³è¿‡å›çŒ');const o=`<bear>\n${r[0]}\n</bear>`,i=await this.messageParser.parseBearContentPlus(o),c=Array.isArray(i?.dynamics)?i.dynamics:[],l=window.bearChatManager||this,d=(e,t)=>`${e}_${t}`;l.__dynIndex=l.__dynIndex||new Map;for(const e of c)'number'==typeof e?.no&&(e.messageId=a,l.__dynIndex.set(d(a,e.no),e));const h=new Set(c.map(e=>e.no)),m=l.__dynIndex,g=Array.from(m.keys());for(const e of g){const[t,s]=e.split('_'),n=Number(t),r=Number(s);n!==a||h.has(r)||m.delete(e)}l.dynamicsData=Array.from(l.__dynIndex.values()),console.log(`âœ… [å›çŒ] æˆåŠŸå›çŒ/æ ¡å‡† ${c.length} æ¡åŠ¨æ€åˆ°ç´¢å¼•`)}catch(e){console.error('âŒ [å›çŒ] å›çŒåŠ¨æ€æ•°æ®å¤±è´¥:',e)}}mergeDynamicsData(e,t){console.log(`ğŸ”„ åˆå¹¶åŠ¨æ€æ•°æ®: ç°æœ‰ ${e.length}, æ–°å¢ ${t.length}`);const a=new Map;for(const t of e)void 0!==t.no&&a.set(t.no,t);const s=[];for(const e of t)if(void 0!==e.no&&a.has(e.no)){const t=a.get(e.no);console.log(`ğŸ”„ åˆå¹¶åŠ¨æ€ #${e.no} çš„äº’åŠ¨æ•°æ®`),Z.fillMissingFields(t,e),Z.mergeInteractions(t,e)}else s.push(e),console.log(`ğŸ†• å‘ç°æ–°åŠ¨æ€ #${e.no}`);const n=[...e,...s];return console.log(`ğŸ”„ åŠ¨æ€åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆæ•°é‡: ${n.length}ï¼Œæ–°å¢: ${s.length}`),console.log('ğŸ“ ä¿æŒåŸå§‹æ¥æ”¶é¡ºåºï¼Œæœªè¿›è¡Œè‡ªåŠ¨æ’åº'),n}formatGroupLastMessage(e){return this.messageParser.formatGroupLastMessage(e)}compareMessageTimestamps(e,t){const a=e=>{const[t,a]=e.split(':').map(Number);return{hours:t,minutes:a}},s=a(e),n=a(t),r=new Date,o=new Date(r.getFullYear(),r.getMonth(),r.getDate(),s.hours,s.minutes),i=new Date(r.getFullYear(),r.getMonth(),r.getDate(),n.hours,n.minutes);r.getHours();return s.hours>=20&&n.hours<12?i.setDate(i.getDate()+1):n.hours>=20&&s.hours<12&&o.setDate(o.getDate()+1),o.getTime()-i.getTime()}async detectAndRenderNewMessages(e){try{let t=[];if(this.lastBearContent){console.log('ğŸ” è¿›è¡ŒBearå†…å®¹å·®å¼‚æ£€æµ‹');const a=this.messageParser.parseBearContent(this.lastBearContent),s=this.messageParser.parseBearContent(e);t=this.findNewMessages(await a,await s)}else{console.log('ğŸ” é¦–æ¬¡è§£æBearå†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„AIå›å¤');const a=this.messageParser.parseBearContent(e),s=this.getExistingMessagesFromInterface();console.log('ğŸ” [DEBUG] ç°æœ‰æ¶ˆæ¯æŒ‡çº¹é›†åˆ:',Array.from(s)),console.log('ğŸ” [DEBUG] å½“å‰èŠå¤©ID:',this.currentChat);for(const[e,n]of await a){console.log(`ğŸ” [DEBUG] æ£€æŸ¥èŠå¤© "${e}" çš„æ¶ˆæ¯`);for(const e of n.messages){const a=this.generateMessageFingerprint(e);console.log(`ğŸ” [DEBUG] æ¶ˆæ¯æŒ‡çº¹: "${a}", å‘é€è€…: "${e.sender}", å†…å®¹: "${e.content.substring(0,30)}..."`),'{{user}}'!==e.sender&&'user'!==e.sender?(console.log('ğŸ” [DEBUG] è¿™æ˜¯AIæ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨'),s.has(a)?console.log('ğŸ” [DEBUG] âŒ AIæ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡'):(console.log('ğŸ” [DEBUG] âœ… å‘ç°æ–°AIæ¶ˆæ¯ï¼Œæ·»åŠ åˆ°æ¸²æŸ“é˜Ÿåˆ—'),t.push(e))):console.log('ğŸ” [DEBUG] è¿™æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œè·³è¿‡')}}}if(console.log(`ğŸ” [DEBUG] æœ€ç»ˆæ–°æ¶ˆæ¯æ•°é‡: ${t.length}`),0===t.length)return void console.log('ğŸ” æœªå‘ç°æ–°æ¶ˆæ¯');console.log(`ğŸ†• å‘ç° ${t.length} æ¡æ–°æ¶ˆæ¯`),await this.renderNewMessagesForCurrentChat(t)}catch(e){console.error('âŒ æ£€æµ‹å’Œæ¸²æŸ“æ–°æ¶ˆæ¯å¤±è´¥:',e)}}findNewMessages(e,t){const a=[],s=new Set;for(const[,t]of e)for(const e of t.messages){const t=this.generateMessageFingerprint(e);s.add(t)}for(const[,e]of t)for(const t of e.messages){const e=this.generateMessageFingerprint(t);s.has(e)||'{{user}}'!==t.sender&&'user'!==t.sender&&a.push(t)}return a}generateMessageFingerprint(e){return`${e.chatId}_${e.sender}_${e.content}_${e.timestamp}`}async renderNewMessagesForCurrentChat(e){if(console.log(`ğŸ” ç•Œé¢çŠ¶æ€æ£€æŸ¥: currentInterface = "${this.currentInterface}"`),'chat'!==this.currentInterface)return void console.log('ğŸ” å½“å‰ä¸åœ¨èŠå¤©ç•Œé¢ï¼Œè·³è¿‡æ¶ˆæ¯æ¸²æŸ“');if(this.isRenderingMessages)for(console.log('ğŸ›‘ æ£€æµ‹åˆ°æ–°çš„æ¸²æŸ“è¯·æ±‚ï¼Œä¸­æ–­ä¹‹å‰çš„æ¸²æŸ“'),this.shouldStopRendering=!0;this.isRenderingMessages;)await this.delay(50);console.log(`ğŸ” å½“å‰èŠå¤©ID: "${this.currentChat}"`),console.log('ğŸ” æ–°æ¶ˆæ¯çš„èŠå¤©ID:',e.map(e=>`"${e.chatId}"`));const t=e.filter(e=>{if(e.chatId===this.currentChat)return console.log(`âœ… ç›´æ¥åŒ¹é…: ${e.chatId} === ${this.currentChat}`),!0;const t=this.normalizeChatIdForComparison(e.chatId),a=this.normalizeChatIdForComparison(this.currentChat);if(t===a)return console.log(`âœ… æ ‡å‡†åŒ–åŒ¹é…: "${e.chatId}" -> "${t}" === "${this.currentChat}" -> "${a}"`),!0;if(this.currentChat.startsWith('ç¾¤èŠ')){const e=a===t;return console.log(`ğŸ” ç¾¤èŠåŒ¹é…æ£€æŸ¥: "${a}" === "${t}" = ${e}`),e}return console.log(`âŒ ä¸åŒ¹é…: ${e.chatId} (${t}) !== ${this.currentChat} (${a})`),!1});console.log(`ğŸ” è¿‡æ»¤åçš„å½“å‰èŠå¤©æ¶ˆæ¯æ•°é‡: ${t.length}`),0!==t.length?(console.log(`ğŸ¨ å¼€å§‹æ¸²æŸ“ ${t.length} æ¡å½“å‰èŠå¤©çš„æ–°æ¶ˆæ¯ï¼ˆå¸¦æ‰“å­—åŠ¨ç”»ï¼‰`),await this.showMessagesSequentially(t),console.log('âœ… æ–°æ¶ˆæ¯æ¸²æŸ“å®Œæˆ'),console.log('ğŸ¨ [ä¸»åº”ç”¨] æ–°æ¶ˆæ¯æ¸²æŸ“å®Œæˆï¼Œå‡†å¤‡è§¦å‘èŠå¤©è¿ç§»æ£€æŸ¥'),await this.triggerChatMigrationCheck()):console.log('ğŸ” å½“å‰èŠå¤©æ²¡æœ‰æ–°æ¶ˆæ¯')}async showMessagesSequentially(e){if(this.isRenderingMessages=!0,this.shouldStopRendering=!1,console.log(`ğŸ¨ å¼€å§‹æ¸²æŸ“ ${e.length} æ¡æ¶ˆæ¯`),this.typingSpeedManager.shouldShowAll()){console.log('âš¡ å…¨éƒ¨æ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯');try{for(const t of e)this.addNewMessageToInterface(t);this.soundManager.playSound('newMessage')}finally{this.isRenderingMessages=!1,this.shouldStopRendering=!1}}else try{for(let t=0;t<e.length;t++){if(this.shouldStopRendering){console.log(`ğŸ›‘ æ¸²æŸ“è¢«ä¸­æ–­ï¼Œå·²æ¸²æŸ“ ${t}/${e.length} æ¡æ¶ˆæ¯`);break}const a=e[t];try{this.addNewMessageToInterface(a);const s=document.querySelectorAll('.message'),n=s[s.length-1];if(n&&await this.typeMessage(n,a),this.shouldStopRendering){console.log(`ğŸ›‘ æ¸²æŸ“è¢«ä¸­æ–­ï¼Œå·²æ¸²æŸ“ ${t+1}/${e.length} æ¡æ¶ˆæ¯`);break}t<e.length-1&&await this.delay(this.getRandomDelay())}catch(e){console.error('âŒ æ¸²æŸ“æ¶ˆæ¯å¤±è´¥:',a,e)}}}finally{this.isRenderingMessages=!1,this.shouldStopRendering=!1,console.log('ğŸ¨ æ¶ˆæ¯æ¸²æŸ“æµç¨‹ç»“æŸ')}}async typeMessage(e,t){const a=e.querySelector('.message-content');if(!a)return;const s=a.innerHTML;if(this.shouldStopRendering)return void(a.innerHTML=s);if(this.typingSpeedManager.shouldSkipTyping())return a.innerHTML=s,void this.soundManager.playSound('newMessage');if(this.hasSpecialContent(s))return a.innerHTML=s,void this.soundManager.playSound('newMessage');const n=document.createElement('div');n.className='typing-indicator',n.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>',a.textContent='',a.appendChild(n);const r=this.getRandomTypingTime();return new Promise(e=>{const t=setTimeout(()=>{if(this.shouldStopRendering)return n.remove(),a.innerHTML=s,void e();n.style.transition='opacity 0.5s',n.style.opacity='0';const t=setTimeout(()=>{if(this.shouldStopRendering)return n.remove(),a.innerHTML=s,void e();n.remove(),a.textContent='',this.typeCharacters(a,s,()=>{e()})},500);this.shouldStopRendering&&(clearTimeout(t),n.remove(),a.innerHTML=s,e())},r);this.shouldStopRendering&&(clearTimeout(t),n.remove(),a.innerHTML=s,e())})}typeCharacters(e,t,a){let s=0,n=!1,r=null;if(this.hasSpecialContent(t))return e.innerHTML=t,n||this.soundManager.playSound('newMessage'),void a();const o=document.createElement('div');o.innerHTML=t;const i=o.textContent||o.innerText||t,c=()=>{if(this.shouldStopRendering)return e.innerHTML=t,r&&clearTimeout(r),void a();0!==s||n||(this.soundManager.playSound('newMessage'),n=!0),s<i.length?(e.textContent+=i.charAt(s),s++,r=setTimeout(c,50)):(t!==i&&(e.innerHTML=t),a())};c()}hasSpecialContent(e){return e.includes('random-image-container')||e.includes('typing-indicator')||e.includes('<div')||e.includes('<img')||e.includes('<audio')||e.includes('<video')||e.includes('sticker-container')||e.includes('transfer-container')}getRandomTypingTime(){return this.typingSpeedManager.getTypingTime()}getRandomDelay(){return this.typingSpeedManager.getMessageDelay()}getExistingMessagesFromInterface(){const e=new Set;if(M.getInstance().isFeatureEnabled()){const t=this.chatData.get(this.currentChat);if(t){console.log(`ğŸ” æ‰¾åˆ°å½“å‰èŠå¤©æ•°æ®ï¼ŒåŒ…å« ${t.messages.length} æ¡æ¶ˆæ¯`);for(const a of t.messages){const t=this.generateMessageFingerprint(a);e.add(t)}}}else console.log('ğŸ” è¿ç§»åŠŸèƒ½ç¦ç”¨ï¼Œä¸ä½¿ç”¨å†å²æ¶ˆæ¯');for(const t of this.sendQueue)if(t.chatId===this.currentChat){const a=this.generateMessageFingerprint(t);e.add(a)}return console.log(`ğŸ” æ”¶é›†åˆ° ${e.size} ä¸ªç°æœ‰æ¶ˆæ¯æŒ‡çº¹`),e}delay(e){return new Promise(t=>setTimeout(t,e))}async updateCurrentMessageWithContent(e){try{const t=getChatMessages(-1)[0];if(!t)return void console.error('âŒ æ— æ³•è·å–æœ€æ–°æ¥¼å±‚æ¶ˆæ¯');const a=t.message_id;console.log('ğŸ“ å½“å‰æ¥¼å±‚ID:',a),await setChatMessages([{message_id:a,message:e}],{refresh:'none'}),console.log('âœ… å·²ä½¿ç”¨setChatMessagesæ›´æ–°å½“å‰æ¥¼å±‚çš„æ™®é€šå†…å®¹')}catch(e){throw console.error('âŒ æ›´æ–°æ™®é€šå†…å®¹å¤±è´¥:',e),e}}async sendAIResponseToNewFloor(e){try{const t=`/sendas name="{{char}}" ${e}`;console.log('ğŸ“¤ ä½¿ç”¨/sendaså‘é€AIå›å¤åˆ°æ–°æ¥¼å±‚'),triggerSlash(t),console.log('âœ… å·²ä½¿ç”¨/sendaså‘é€AIå›å¤åˆ°æ–°æ¥¼å±‚'),console.log('ğŸ§¹ æ¸…ç©ºå‘é€é˜Ÿåˆ—...'),this.clearSendQueue(),console.log('âœ… éBearæ ¼å¼AIå›å¤å¤„ç†å®Œæˆ')}catch(t){console.error('âŒ ä½¿ç”¨/sendaså‘é€AIå›å¤å¤±è´¥:',t),console.log('ğŸ”„ å›é€€åˆ°æ›¿æ¢å½“å‰æ¥¼å±‚çš„æ–¹å¼...'),await this.updateCurrentMessageWithContent(e),console.log('ğŸ§¹ æ¸…ç©ºå‘é€é˜Ÿåˆ—ï¼ˆå›é€€æƒ…å†µï¼‰...'),this.clearSendQueue()}}async showTypingIndicator(){const e=document.getElementById('chatMessages');if(!e)return null;let t='https://files.catbox.moe/u8ccy5.jpg';try{const e=this.chatData.get(this.currentChat),s=e?.chatName||this.currentChat;if(this.currentChat&&this.currentChat.startsWith('ç¾¤èŠ'))if(e&&e.avatar)t=e.avatar;else{const{GroupChatStorage:e}=await Promise.resolve().then(a.bind(a,15));t=e.getDefaultGroupAvatar(this.currentChat)}else if(this.currentChat&&!this.currentChat.startsWith('ç¾¤èŠ')){let e=s.replace(/^å’Œ|çš„èŠå¤©$/g,'');if(e&&e!==s||(e=s),e){const a=this.messageParser.getDefaultAvatar(e);if(a&&'https://files.catbox.moe/u8ccy5.jpg'!==a)t=a;else try{if('function'==typeof getCharAvatarPath){const a=getCharAvatarPath(e,!0);a&&(t=a)}}catch(e){}}}}catch(e){}const s=document.createElement('div');s.className='message received typing-message',s.innerHTML=`\n      <img src="${t}" class="avatar" alt="è§’è‰²å¤´åƒ" />\n      <div class="message-wrapper">\n        <div class="message-content">\n          <div class="typing-indicator">\n            <span class="typing-dot"></span>\n            <span class="typing-dot"></span>\n            <span class="typing-dot"></span>\n          </div>\n        </div>\n      </div>\n    `;const n=s.querySelector('.avatar');return n&&(n.onerror=()=>{n.src='https://files.catbox.moe/u8ccy5.jpg'}),e.appendChild(s),e.scrollTop=e.scrollHeight,s}hideTypingIndicator(e){e&&e.parentNode&&e.parentNode.removeChild(e)}extractLastBearContent(e){if(!e)return null;const t=e.lastIndexOf('</bear>');if(-1===t)return console.log('âŒ æœªæ‰¾åˆ° </bear> æ ‡ç­¾'),null;const a=e.substring(0,t).lastIndexOf('<bear>');if(-1===a)return console.log('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„ <bear> æ ‡ç­¾'),null;const s=e.substring(a+6,t);return console.log('ğŸ» æ‰¾åˆ°æœ€åä¸€å¯¹Bearæ ‡ç­¾'),this.hasValidChatContent(s)?(console.log('âœ… Bearæ ‡ç­¾åŒ…å«æœ‰æ•ˆèŠå¤©å†…å®¹'),s):(console.log('âŒ Bearæ ‡ç­¾ä¸åŒ…å«æœ‰æ•ˆèŠå¤©å†…å®¹'),null)}hasValidChatContent(e){if(!e)return!1;const t=e.includes('[å’Œ')&&e.includes('çš„èŠå¤©]'),a=e.includes('[ç¾¤èŠ')&&e.includes('[/ç¾¤èŠ'),s=e.includes('[S_'),n=e.includes('[G_'),r=/\[åŠ¨æ€\][\s\S]*?\[\/åŠ¨æ€\]/.test(e),o=t||a||s||n||r;return o?console.log('âœ… Bearå†…å®¹é€šè¿‡éªŒè¯ï¼ˆæ–¹æ¡ˆAï¼šå­˜åœ¨èŠå¤©/åŠ¨æ€æ ‡è®°å³æœ‰æ•ˆï¼‰'):console.log('ğŸš« æœªæ‰¾åˆ°æœ‰æ•ˆèŠå¤©æˆ–åŠ¨æ€æ ‡è®°'),o}cleanAIInternalTags(e){if(!e)return e;let t=e;const a=['analyze','think','thinking','reasoning','internal','thought','process'];for(const e of a){const a=new RegExp(`<${e}[^>]*>[\\s\\S]*?<\\/${e}>`,'gi');t=t.replace(a,'');const s=new RegExp(`<${e}[^>]*\\/>`,'gi');t=t.replace(s,'')}return t=t.replace(/\n\s*\n\s*\n/g,'\n\n'),t=t.trim(),t.length!==e.length&&console.log(`ğŸ§¹ å·²ç§»é™¤ ${e.length-t.length} ä¸ªå­—ç¬¦çš„AIå†…éƒ¨æ€è€ƒå†…å®¹`),t}showErrorToast(e){'undefined'!=typeof toastr?toastr.error(e,'å‘é€å¤±è´¥'):alert(`å‘é€å¤±è´¥: ${e}`)}showChatList(){this.isRenderingMessages&&(console.log('ğŸ›‘ æ£€æµ‹åˆ°ç•Œé¢åˆ‡æ¢ï¼Œä¸­æ–­æ¶ˆæ¯æ¸²æŸ“'),console.log('ğŸ›‘ å½“å‰æ¸²æŸ“çŠ¶æ€:',{isRenderingMessages:this.isRenderingMessages,shouldStopRendering:this.shouldStopRendering}),this.shouldStopRendering=!0),this.hideChatInterface(),this.currentChat&&this.chatListManager&&(console.log('ğŸ“– è¿”å›èŠå¤©åˆ—è¡¨æ—¶æ ‡è®°å½“å‰èŠå¤©ä¸ºå·²è¯»:',this.currentChat),this.chatListManager.getUnreadMessageManager().markAsRead(this.currentChat,this.chatData)),this.chatListManager.showChatListInterface(this.chatData),this.currentInterface='list'}hideChatInterface(){const e=document.getElementById('chatInterface');e&&(e.style.display='none'),this.detachTopScrollListener(),this.destroyChatStatusBar()}initializeChatListEvents(){document.addEventListener('chatListItemClick',e=>{const t=e,{chatId:a}=t.detail;this.switchToChat(a)}),document.addEventListener('createNewChat',e=>{const t=e,{type:a,contactIds:s}=t.detail;this.handleCreateNewChat(a,s)}),document.addEventListener('contactUpdated',e=>{const t=e,{oldName:a,newName:s,newAvatar:n}=t.detail;this.handleContactUpdated(a,s,n)}),document.addEventListener('refreshChatList',()=>{this.handleRefreshChatList()}),document.addEventListener('chatListChanged',e=>{const t=e;'groupChatCreated'===t.detail?.type&&(console.log('ğŸ‰ æ£€æµ‹åˆ°ç¾¤èŠåˆ›å»ºäº‹ä»¶ï¼Œåˆ›å»ºç¾¤èŠæ¶ˆæ¯æ ‡è®°'),this.handleGroupChatCreated(t.detail?.groupChatData))}),document.addEventListener('deleteChatRequest',e=>{const t=e,{chatId:a}=t.detail;console.log('ğŸ—‘ï¸ æ£€æµ‹åˆ°åˆ é™¤èŠå¤©è¯·æ±‚:',a),this.handleDeleteChatRequest(a)}),document.addEventListener('avatarCacheCleared',e=>{const t=e;console.log('ğŸ”„ [BearChatManager] æ£€æµ‹åˆ°å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶ï¼Œåˆ·æ–°èŠå¤©ç•Œé¢:',t.detail),this.handleAvatarCacheCleared(t.detail)}),document.addEventListener('worldbookAvatarCacheCleared',e=>{const t=e;console.log('ğŸ”„ [BearChatManager] æ”¶åˆ°ä¸–ç•Œä¹¦å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶, detail: ',t.detail),this.handleWorldbookAvatarCacheCleared(t.detail)})}async initializeProfileModule(){try{this.profileInterface=await D(),this.profileInterface&&(this.settingsModal=this.profileInterface.getSettingsModal()),console.log('âœ… æˆ‘çš„é¡µé¢æ¨¡å—åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('âŒ æˆ‘çš„é¡µé¢æ¨¡å—åˆå§‹åŒ–å¤±è´¥:',e)}}initializeExtensionsModule(){try{console.log('[Extensions] æ‰©å±•åŠŸèƒ½æ¨¡å—å·²åˆå§‹åŒ–'),I.getInstance(),console.log('âœ… æ‰©å±•åŠŸèƒ½æ¨¡å—åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('âŒ æ‰©å±•åŠŸèƒ½æ¨¡å—åˆå§‹åŒ–å¤±è´¥:',e)}}initializeChatMigrationManager(){try{M.getInstance().initialize(),console.log('âœ… èŠå¤©è¿ç§»ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('âŒ èŠå¤©è¿ç§»ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',e)}}async triggerChatMigrationCheck(){console.log('ğŸ”” [ä¸»åº”ç”¨] è§¦å‘èŠå¤©è¿ç§»æ£€æŸ¥');try{const e=M.getInstance();console.log('ğŸ“‹ [ä¸»åº”ç”¨] è·å–åˆ° ChatMigrationManager å®ä¾‹'),await e.checkAndMigrate(),console.log('âœ… [ä¸»åº”ç”¨] èŠå¤©è¿ç§»æ£€æŸ¥å®Œæˆ')}catch(e){console.error('âŒ [ä¸»åº”ç”¨] èŠå¤©è¿ç§»æ£€æŸ¥å¤±è´¥:',e)}}async initializeChatWallpaperManager(){try{this.chatWallpaperManager=A.getInstance(),console.log('âœ… èŠå¤©å£çº¸ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ')}catch(e){console.error('âŒ èŠå¤©å£çº¸ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',e)}}switchToChat(e){if(console.log(`ğŸ”„ å°è¯•åˆ‡æ¢åˆ°èŠå¤©: ${e}`),this.chatListManager.hideChatListInterface(),e.startsWith('ç¾¤èŠ'))return void this.switchToGroupChat(e);let t=this.chatData.get(e),a=e;if(!t){console.log('ğŸ” ç›´æ¥æŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼...');const s=this.messageParser.generateGroupChatId(e);if(t=this.chatData.get(s),t)return console.log(`âœ… æ‰¾åˆ°ç¾¤èŠæ•°æ®ï¼Œä½¿ç”¨ID: ${s}`),void this.switchToGroupChat(s);console.log('ğŸ” å°è¯•å¤§å°å†™ä¸æ•æ„ŸåŒ¹é…...');const n=e.toLowerCase();for(const[s,r]of this.chatData.entries())if(s.toLowerCase()===n){console.log(`âœ… æ‰¾åˆ°å¤§å°å†™åŒ¹é…çš„èŠå¤©: ${s} (åŸæŸ¥æ‰¾: ${e})`),t=r,a=s;break}}if(!t)return console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©æ•°æ®:',e),void console.log('ğŸ” å¯ç”¨çš„èŠå¤©æ•°æ®:',Array.from(this.chatData.keys()));this.detachTopScrollListener(),this.showChatInterface(),this.currentChat=a;{const e=this.chatData.get(a)?.messages.length??this.INITIAL_VISIBLE_COUNT;this.visibleCounts.set(a,Math.min(this.INITIAL_VISIBLE_COUNT,e))}this.renderCurrentChat(),this.attachTopScrollListener(),this.chatListManager&&(console.log('ğŸ“– æ ‡è®°èŠå¤©ä¸ºå·²è¯»:',a),this.chatListManager.getUnreadMessageManager().markAsRead(a,this.chatData)),this.chatWallpaperManager&&(console.log('[BearChatManager] é€šçŸ¥å£çº¸ç®¡ç†å™¨èŠå¤©åˆ‡æ¢:',a),this.chatWallpaperManager.setCurrentChatId(a)),this.currentInterface='chat'}switchToGroupChat(e){console.log(`ğŸ”„ åˆ‡æ¢åˆ°ç¾¤èŠ: ${e}`);if(!this.chatData.get(e))return console.error('âŒ ç¾¤èŠæ•°æ®ä¸å­˜åœ¨:',e),console.log('ğŸ” å¯ç”¨çš„èŠå¤©æ•°æ®:',Array.from(this.chatData.keys())),void this.showToast('ç¾¤èŠä¸å­˜åœ¨','error');this.detachTopScrollListener(),this.showChatInterface(),this.currentChat=e;{const t=this.chatData.get(e)?.messages.length??this.INITIAL_VISIBLE_COUNT;this.visibleCounts.set(e,Math.min(this.INITIAL_VISIBLE_COUNT,t))}this.renderCurrentChat(),this.attachTopScrollListener(),this.chatListManager&&(console.log('ğŸ“– æ ‡è®°ç¾¤èŠä¸ºå·²è¯»:',e),this.chatListManager.getUnreadMessageManager().markAsRead(e,this.chatData)),this.chatWallpaperManager&&(console.log('[BearChatManager] é€šçŸ¥å£çº¸ç®¡ç†å™¨ç¾¤èŠåˆ‡æ¢:',e),this.chatWallpaperManager.setCurrentChatId(e)),this.currentInterface='chat',this.ensureGroupSkeletonExists(e)}ensureGroupSkeletonExists(e){try{const t=this.chatData.get(e);if(!t)return;if(!('group'===t.type||e.startsWith('ç¾¤èŠ')))return;const a=getChatMessages(-1)?.[0];if(!a)return;const s=a.message||'',n=s.match(/<bear>([\s\S]*?)<\/bear>/)||s.match(/<bear>([\s\S]*?)<\/bear>/),r=n?n[1]:'',o=t.chatName;if(!o)return;const i=e=>e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),c=new RegExp(`\\[ç¾¤èŠ${i(o)}\\][\\s\\S]*?\\[\\/ç¾¤èŠ${i(o)}\\]`);if(r&&c.test(r))return;const l={chatId:e,chatName:t.chatName,avatar:t.avatar,messages:[],lastMessage:'',type:'group',members:t.members||[]},d=this.messageParser.buildSingleChatBearContent(l),h=d.match(/<bear>([\s\S]*?)<\/bear>/),m=h?h[1]:d,g=(r?r.endsWith('\n')?r:r+'\n':'')+m,u=this.replaceOnlyBearTagContent(s,g);setChatMessages([{message_id:a.message_id,message:u}],{refresh:'none'}).then(()=>{console.log('âœ… å·²åœ¨å½“å‰æ¥¼å±‚è¡¥é½ç¾¤èŠéª¨æ¶:',e)}).catch(e=>{console.error('âŒ è¡¥é½ç¾¤èŠéª¨æ¶å¤±è´¥:',e)})}catch(e){console.error('âŒ ensureGroupSkeletonExists æ‰§è¡Œå¤±è´¥:',e)}}showChatInterface(){this.shouldStopRendering=!1,console.log('ğŸ¨ è¿›å…¥èŠå¤©ç•Œé¢ï¼Œé‡ç½®æ¸²æŸ“ä¸­æ–­æ ‡å¿—');const e=document.getElementById('chatInterface');e&&(e.style.display='flex'),this.initializeChatStatusBar()}initializeChatStatusBar(){const e=document.getElementById('chatStatusBarContainer');e&&(this.chatStatusBar=n.create(e))}destroyChatStatusBar(){this.chatStatusBar&&(this.chatStatusBar.destroy(),this.chatStatusBar=null)}handleCreateNewChat(e,t){console.log(`åˆ›å»ºæ–°èŠå¤©: ${e}, è”ç³»äºº:`,t);const a=this.chatListManager.getContactManager(),s=t.map(e=>a.getContactById(e)).filter(Boolean);if(0===s.length)return void this.showToast('æœªæ‰¾åˆ°æœ‰æ•ˆè”ç³»äºº','error');if('single'===e&&1===s.length){const e=s[0].name,t=this.findExistingChatWithContact(e);if(t)return console.log(`æ‰¾åˆ°å·²å­˜åœ¨çš„èŠå¤©: ${t}`),this.switchToChat(t),void this.showToast(`å·²åˆ‡æ¢åˆ°ä¸${e}çš„èŠå¤©`,'info')}let n,r;if('single'===e&&1===s.length){n=`å’Œ${s[0].name}çš„èŠå¤©`,r=n;const e={chatId:r,chatName:n,avatar:s[0].avatar,messages:[],type:'single'};this.chatData.set(r,e),this.createSingleChatBlock(e).then(()=>{console.log('âœ… å•èŠå—åˆ›å»ºæˆåŠŸï¼Œåˆ‡æ¢åˆ°æ–°èŠå¤©'),this.switchToChat(r),this.showToast('å·²åˆ›å»ºå•èŠ','info')}).catch(e=>{console.error('âŒ åˆ›å»ºå•èŠå—å¤±è´¥:',e),this.chatListManager&&this.chatListManager.refreshChatList(this.chatData),this.switchToChat(r),this.showToast('å·²åˆ›å»ºå•èŠï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰','warning')})}else console.log('ğŸ”„ ä½¿ç”¨GroupChatManageråˆ›å»ºç¾¤èŠ'),this.groupChatManager.createGroupChat(t)}handleContactUpdated(e,t,a){console.log(`ğŸ”„ å¤„ç†è”ç³»äººæ›´æ–°: ${e} -> ${t}`);try{if(this.updateChatDataForContact(e,t,a),this.updateCurrentChatInterface(e,t,a),this.currentChat){const a=this.chatData.get(this.currentChat);a&&this.isChatRelatedToContact(a,e,t)&&this.renderCurrentChat()}console.log(`âœ… è”ç³»äººæ›´æ–°å¤„ç†å®Œæˆ: ${e} -> ${t}`)}catch(e){console.error('âŒ å¤„ç†è”ç³»äººæ›´æ–°å¤±è´¥:',e)}}updateChatDataForContact(e,t,a){this.chatData.forEach((s,n)=>{let r=!1;s.chatName===`å’Œ${e}çš„èŠå¤©`&&(s.chatName=`å’Œ${t}çš„èŠå¤©`,r=!0),s.chatName.includes(t)&&!s.chatName.includes('ç¾¤èŠ')&&(s.avatar=a,r=!0),s.messages.forEach(s=>{s.sender===e&&(s.sender=t,s.avatar=a,r=!0)}),r&&console.log(`ğŸ”„ æ›´æ–°èŠå¤©æ•°æ®: ${n}`)})}updateCurrentChatInterface(e,t,a){const s=document.getElementById('chatTitle');s&&s.textContent===`å’Œ${e}çš„èŠå¤©`&&(s.textContent=`å’Œ${t}çš„èŠå¤©`);const n=document.getElementById('headerAvatar');n&&(n.src='https://files.catbox.moe/u8ccy5.jpg',n.alt='é»˜è®¤å¤´åƒ');document.querySelectorAll('.message').forEach(s=>{const n=s.querySelector('.avatar'),r=s.querySelector('.message-sender, .sender-name');!n||n.alt!==e&&n.alt!==t||(n.src=a,n.alt=t),r&&r.textContent===e&&(r.textContent=t)})}isChatRelatedToContact(e,t,a){return e.chatName===`å’Œ${t}çš„èŠå¤©`||e.chatName===`å’Œ${a}çš„èŠå¤©`||e.messages.some(e=>e.sender===t||e.sender===a)}async createSingleChatBlock(e){try{console.log('ğŸ”„ å¼€å§‹åˆ›å»ºå•èŠå—:',e.chatName),console.log('ğŸ“ å•èŠæ•°æ®:',{chatId:e.chatId,chatName:e.chatName});const t=`[${e.chatName}]\n[/${e.chatName}]`;console.log('ğŸ“ æ„å»ºçš„å•èŠæ ‡è®°:',t);const a=getChatMessages(-1)||[];if(a.length>0){const e=a[0],s=e.message||'';let n;if(s.includes('<bear>')){const a=s.replace('</bear>',`${t}\n</bear>`).replace('<bear>','').replace('</bear>','');n=this.replaceOnlyBearTagContent(e.message||'',a)}else{n=`<bear>\n${t}\n</bear>${e.message||''}`}await setChatMessages([{message_id:e.message_id,message:n}],{refresh:'none'}),console.log('âœ… å·²æ·»åŠ å•èŠå—åˆ°ç°æœ‰bearæ ‡ç­¾å†…')}else{const e=`<bear>\n${t}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:e}],{refresh:'none'}),console.log('âœ… å·²åˆ›å»ºæ–°æ¶ˆæ¯åŒ…å«å•èŠå—')}await this.initializeFromExistingData();const s=this.chatData.get(e.chatId);s&&s.messages.length>0?console.log('âœ… å•èŠå—åˆ›å»ºå®Œæˆï¼ŒåŒ…å«æ¶ˆæ¯:',s.messages.length):console.warn('âš ï¸ å•èŠå—åˆ›å»ºå®Œæˆï¼Œä½†æœªæ£€æµ‹åˆ°æ¶ˆæ¯')}catch(t){console.error('âŒ åˆ›å»ºå•èŠå—å¤±è´¥:',t),this.chatListManager&&(this.chatListManager.refreshChatList(this.chatData),console.log(`âœ… å·²åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œæ–°å¢å•èŠ: ${e.chatName}`))}}async handleDeleteChatRequest(e){try{console.log('ğŸ—‘ï¸ å¼€å§‹å¤„ç†åˆ é™¤èŠå¤©è¯·æ±‚:',e);const t=this.chatData.get(e);t?(this.chatData.delete(e),console.log('âœ… å·²ä»å†…å­˜ä¸­åˆ é™¤èŠå¤©æ•°æ®:',e)):console.warn('âš ï¸ æœªåœ¨å†…å­˜ä¸­æ‰¾åˆ°è¦åˆ é™¤çš„èŠå¤©æ•°æ®:',e),await this.deleteChatBlockFromBear(e,t),this.currentChat===e&&(console.log('ğŸ”„ å½“å‰æ­£åœ¨æŸ¥çœ‹è¢«åˆ é™¤çš„èŠå¤©ï¼Œè¿”å›èŠå¤©åˆ—è¡¨'),this.showChatList()),console.log('âœ… åˆ é™¤èŠå¤©è¯·æ±‚å¤„ç†å®Œæˆ')}catch(e){console.error('âŒ å¤„ç†åˆ é™¤èŠå¤©è¯·æ±‚å¤±è´¥:',e),this.showToast('åˆ é™¤èŠå¤©å¤±è´¥','error')}}async deleteChatBlockFromBear(e,t){try{console.log('ğŸ—‘ï¸ å¼€å§‹ä»bearæ ‡ç­¾ä¸­åˆ é™¤èŠå¤©å—:',e);const a=getChatMessages(-1)||[];if(0===a.length)return void console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å½“å‰æ¶ˆæ¯ï¼Œæ— æ³•åˆ é™¤èŠå¤©å—');const s=a[0],n=s.message||'';if(!n.includes('<bear>'))return void console.log('âš ï¸ å½“å‰æ¶ˆæ¯ä¸åŒ…å«bearæ ‡ç­¾ï¼Œæ— æ³•åˆ é™¤èŠå¤©å—');const r=n.match(/<bear>([\s\S]*?)<\/bear>/);if(!r)return void console.log('âš ï¸ æ— æ³•è§£æbearæ ‡ç­¾å†…å®¹');let o=r[1];console.log('ğŸ“ å¼€å§‹åˆ é™¤èŠå¤©å—');o='group'===t?.type||e.startsWith('ç¾¤èŠ')?this.removeGroupChatBlock(o,e):this.removeSingleChatBlock(o,e),console.log('ğŸ“ èŠå¤©å—åˆ é™¤å®Œæˆ');const i=this.replaceOnlyBearTagContent(n,o);await setChatMessages([{message_id:s.message_id,message:i}],{refresh:'none'}),console.log('âœ… å·²ä»bearæ ‡ç­¾ä¸­åˆ é™¤èŠå¤©å—'),await this.initializeFromExistingData()}catch(e){throw console.error('âŒ ä»bearæ ‡ç­¾ä¸­åˆ é™¤èŠå¤©å—å¤±è´¥:',e),e}}removeSingleChatBlock(e,t){const a=t,s=new RegExp(`\\[${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]([\\s\\S]*?)\\[\\/${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]`,'g'),n=e.length,r=e.replace(s,'');return r.length<n?console.log(`âœ… å·²åˆ é™¤å•èŠå—: ${a}`):console.warn(`âš ï¸ æœªæ‰¾åˆ°è¦åˆ é™¤çš„å•èŠå—: ${a}`),r}removeGroupChatBlock(e,t){const a=t.replace(/^ç¾¤èŠ/,''),s=new RegExp(`\\[ç¾¤èŠ${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]\\s*\\n?\\s*\\[æˆå‘˜[ï¼š:]([^\\]]+)\\]\\s*\\n?([\\s\\S]*?)\\n?\\s*\\[/ç¾¤èŠ${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]`,'g'),n=e.length,r=e.replace(s,'');return r.length<n?console.log(`âœ… å·²åˆ é™¤ç¾¤èŠå—: ${a}`):console.warn(`âš ï¸ æœªæ‰¾åˆ°è¦åˆ é™¤çš„ç¾¤èŠå—: ${a}`),r}async handleGroupChatCreated(e){try{console.log('ğŸ”„ å¼€å§‹å¤„ç†ç¾¤èŠåˆ›å»º');let t=e;if(!t)try{const e=this.groupChatManager.getAllGroupChats();e.length>0&&(t=e.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0])}catch(e){console.warn('âš ï¸ ä»localStorageè·å–ç¾¤èŠæ•°æ®å¤±è´¥:',e)}if(!t){console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç¾¤èŠæ•°æ®ï¼Œåˆ›å»ºé»˜è®¤ç¾¤èŠæ ‡è®°');const e='[ç¾¤èŠæ–°å»ºç¾¤èŠ]\n[æˆå‘˜ï¼šè§’è‰²1ï¼Œè§’è‰²2ï¼Œ{{user}}]\n[/ç¾¤èŠæ–°å»ºç¾¤èŠ]';try{if('function'==typeof setChatMessages){const t=`<bear>\n${e}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:t}],{refresh:'none'}),console.log('âœ… å·²åˆ›å»ºé»˜è®¤ç¾¤èŠæ ‡è®°'),this.initializeFromExistingData()}}catch(e){console.error('âŒ åˆ›å»ºé»˜è®¤ç¾¤èŠæ ‡è®°å¤±è´¥:',e)}return}console.log('ğŸ“Š æœ€æ–°åˆ›å»ºçš„ç¾¤èŠ:',t);const a=this.chatListManager.getContactManager(),s=t.members.map(e=>{if('{{user}}'===e||'user'===e)return'{{user}}';const t=a.getContactById(e);return t?t.name:e}).join('ï¼Œ'),n=`[ç¾¤èŠ${t.name}]\n[æˆå‘˜ï¼š${s}]\n[/ç¾¤èŠ${t.name}]`;console.log('ğŸ“ ç¾¤èŠæ ‡è®°æ¶ˆæ¯:',n);let r=[],o=null;try{'function'==typeof getChatMessages&&(r=getChatMessages(-1)||[],o=r.length>0?r[0]:null)}catch(e){console.warn('âš ï¸ è·å–å½“å‰æ¶ˆæ¯å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°æ¶ˆæ¯:',e)}try{if('function'==typeof setChatMessages)if(o){let e=o.message;if(e.includes('<bear>')&&e.includes('</bear>')){const t=e.lastIndexOf('</bear>');e=e.slice(0,t)+'\n\n'+n+'\n'+e.slice(t)}else e=`<bear>\n${e}\n\n${n}\n</bear>`;await setChatMessages([{message_id:o.message_id,message:e}],{refresh:'none'}),console.log('âœ… å·²æ·»åŠ ç¾¤èŠæ ‡è®°åˆ° bear æ ‡ç­¾å†…')}else{const e=`<bear>\n${n}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:e}],{refresh:'none'}),console.log('âœ… å·²åˆ›å»ºæ–°æ¶ˆæ¯åŒ…å«ç¾¤èŠæ ‡è®°')}else console.warn('âš ï¸ setChatMessages å‡½æ•°ä¸å¯ç”¨')}catch(e){console.error('âŒ å¤„ç†æ¶ˆæ¯å¤±è´¥:',e)}this.initializeFromExistingData(),console.log('âœ… ç¾¤èŠåˆ›å»ºå¤„ç†å®Œæˆ')}catch(e){console.error('âŒ å¤„ç†ç¾¤èŠåˆ›å»ºå¤±è´¥:',e)}}handleRefreshChatList(){console.log('ğŸ”„ åˆ·æ–°èŠå¤©åˆ—è¡¨');try{const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&(this.chatListManager.renderChatList(this.chatData),console.log('âœ… èŠå¤©åˆ—è¡¨å·²åˆ·æ–°'))}catch(e){console.error('âŒ åˆ·æ–°èŠå¤©åˆ—è¡¨å¤±è´¥:',e)}}handleAvatarCacheCleared(e){console.log('ğŸ”„ [BearChatManager] å¤„ç†å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶:',e);try{const t=document.getElementById('chatListInterface');t&&t.classList.contains('active')&&(this.chatListManager.renderChatList(this.chatData),console.log('âœ… èŠå¤©åˆ—è¡¨å¤´åƒå·²åˆ·æ–°')),this.currentChat&&(this.refreshCurrentChatAvatars(e.clearedContacts),console.log('âœ… å½“å‰èŠå¤©ç•Œé¢å¤´åƒå·²åˆ·æ–°')),this.refreshChatHeaderAvatar(e.clearedContacts)}catch(e){console.error('âŒ å¤„ç†å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶å¤±è´¥:',e)}}refreshCurrentChatAvatars(e){try{const t=document.querySelectorAll('.message');let a=0;const s=this.chatListManager.getContactManager();t.forEach(t=>{const n=t.querySelector('.avatar'),r=t.querySelector('.message-sender, .sender-name');if(n&&r){const t=r.textContent?.trim();if(t&&e.includes(t)){const e=s.getContactAvatar(t);e&&n.src!==e&&(n.src=e,a++,console.log(`ğŸ”„ åˆ·æ–°æ¶ˆæ¯å¤´åƒ: ${t} -> ${e}`))}}}),a>0&&console.log(`âœ… åˆ·æ–°äº† ${a} ä¸ªæ¶ˆæ¯å¤´åƒ`)}catch(e){console.error('âŒ åˆ·æ–°å½“å‰èŠå¤©å¤´åƒå¤±è´¥:',e)}}refreshChatHeaderAvatar(e){try{const t=document.getElementById('headerAvatar'),a=document.getElementById('headerTitle'),s=this.chatListManager.getContactManager();if(t&&a&&this.currentChat){const a=this.chatData.get(this.currentChat);if(a){const n=a.chatName,r=this.extractDisplayName(n);if(r&&e.includes(r)){const e=s.getContactAvatar(r);e&&t.src!==e&&(t.src=e,console.log(`ğŸ”„ åˆ·æ–°èŠå¤©å¤´éƒ¨å¤´åƒ: ${r} -> ${e}`))}}}}catch(e){console.error('âŒ åˆ·æ–°èŠå¤©å¤´éƒ¨å¤´åƒå¤±è´¥:',e)}}extractDisplayName(e){const t=e.match(/^å’Œ(.+)çš„èŠå¤©$/);return t?t[1]:e}handleWorldbookAvatarCacheCleared(e){const{clearedCount:t,clearedContactNames:a}=e;if(0===t||!a||0===a.length)return void console.log(`â„¹ï¸ [BearChatManager] ä¸–ç•Œä¹¦å¤´åƒç¼“å­˜æ¸…é™¤äº‹ä»¶: æ¸…é™¤äº† ${t} ä¸ªç¼“å­˜ï¼Œæ— éœ€æ›´æ–°èŠå¤©æ•°æ®`);console.log(`ğŸ”„ [BearChatManager] æ­£åœ¨æ›´æ–° ${a.length} ä¸ªè¢«æ¸…é™¤ç¼“å­˜çš„è§’è‰²å¤´åƒæ•°æ®...`);const s=this.chatListManager.getContactManager();let n=!1;this.chatData.forEach((e,t)=>{let r=!1;if('group'===e.type)e.messages.forEach(t=>{if(a.includes(t.sender)){const a=s.getContactAvatar(t.sender);t.avatar!==a&&(console.log(`  - æ›´æ–°ç¾¤èŠ[${e.chatName}]å†…æ¶ˆæ¯å‘é€è€…[${t.sender}]çš„å¤´åƒ`),t.avatar=a,r=!0)}});else{const t=this.extractDisplayName(e.chatName);if(a.includes(t)){const a=s.getContactAvatar(t);e.avatar!==a&&(console.log(`  - æ›´æ–°å•èŠ: "${e.chatName}", æ—§å¤´åƒ: ${e.avatar}, æ–°å¤´åƒ: ${a}`),e.avatar=a,e.messages.forEach(e=>{e.sender===t&&(e.avatar=a)}),r=!0)}}r&&this.currentChat===t&&(n=!0)}),n&&(console.log('ğŸ¨ å½“å‰èŠå¤©å¤´åƒå·²è¿‡æ—¶ï¼Œæ­£åœ¨é‡æ–°æ¸²æŸ“...'),this.renderCurrentChat()),this.chatListManager.refreshChatList(this.chatData),console.log('âœ… [BearChatManager] ä¸–ç•Œä¹¦è”ç³»äººå¤´åƒæ•°æ®æ›´æ–°å®Œæˆã€‚')}findExistingChatWithContact(e){for(const[t,a]of this.chatData){if(a.chatName===`å’Œ${e}çš„èŠå¤©`)return t;if(a.messages.some(t=>t.sender===e&&'{{user}}'!==t.sender)){const s=new Set(a.messages.filter(e=>'{{user}}'!==e.sender).map(e=>e.sender));if(1===s.size&&s.has(e))return t}}return null}showToast(e,t='info'){'undefined'!=typeof toastr?'success'===t?toastr.success(e):toastr[t](e):console.log(`[${t.toUpperCase()}] ${e}`)}showDiaryInterface(){}showCallInterface(){}async handleAvatarClick(){const e=this.chatData.get(this.currentChat);e?'group'===e.type?await this.showGroupChatModal(e):this.showSingleChatProfile(e):console.warn('å½“å‰èŠå¤©æ•°æ®ä¸å­˜åœ¨')}async showGroupChatModal(e){const t=await this.createGroupManagementModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}showSingleChatProfile(e){console.log('ğŸ‘¤ æ˜¾ç¤ºä¸ªäººèµ„æ–™:',e.chatName),this.showToast(`æŸ¥çœ‹ ${e.chatName} çš„ä¸ªäººèµ„æ–™`,'info')}async createGroupManagementModal(e){const t=document.createElement('div');t.className='modal-overlay group-management-modal',t.id='groupManagementModal';const s=e.members||[],n=s.length,r=s.map(async(e,t)=>{let s=e.avatar,n=e.name,r='{{user}}'===e.name||'user'===e.name||'{{user}}'===e.id;if(!r)try{const{getUserNameAsync:t}=await Promise.resolve().then(a.bind(a,335)),s=await t();r=e.name===s||e.id===s}catch(e){}if(r){const{getUserAvatar:e,getUserNameAsync:t}=await Promise.resolve().then(a.bind(a,335));try{s=e(),n=await t()}catch(e){}}return`\n      <div class="member-item" data-member-id="${e.id}">\n        <img src="${s}" class="member-avatar" alt="${n}">\n        <div class="member-info">\n          <span class="member-name">${n}</span>\n          <span class="member-role">${this.getMemberRoleText(e.role)}</span>\n        </div>\n        <div class="member-actions">\n          ${'owner'!==e.role?`\n            <button class="kick-member-btn" data-member-id="${e.id}" title="ç§»é™¤æˆå‘˜">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n              </svg>\n            </button>\n          `:''}\n        </div>\n      </div>\n    `}),o=(await Promise.all(r)).join('');return t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-header">\n          <h3>ç¾¤èŠè®¾ç½®</h3>\n        </div>\n        \n        <div class="modal-body">\n          \x3c!-- ç¾¤åŸºæœ¬ä¿¡æ¯ --\x3e\n          <div class="group-info-section">\n            <div class="group-avatar-section">\n              <img class="group-avatar-preview" src="${e.avatar}" alt="ç¾¤å¤´åƒ">\n              <button class="change-avatar-btn" data-action="change-avatar">æ›´æ¢å¤´åƒ</button>\n            </div>\n            <div class="group-name-section">\n              <label>ç¾¤åç§°</label>\n              <input type="text" class="group-name-input" value="${e.chatName}" maxlength="20">\n            </div>\n          </div>\n          \n          \x3c!-- ç¾¤æˆå‘˜ç®¡ç† --\x3e\n          <div class="group-members-section">\n            <div class="section-header">\n              <h4>ç¾¤æˆå‘˜ (<span class="member-count">${n}</span>)</h4>\n              <button class="invite-member-btn" data-action="invite-member">é‚€è¯·æˆå‘˜</button>\n            </div>\n            <div class="members-list">\n              ${o}\n            </div>\n          </div>\n          \n          \x3c!-- å±é™©æ“ä½œåŒºåŸŸ --\x3e\n          <div class="danger-section">\n            <button class="disband-btn" data-action="disband">è§£æ•£ç¾¤èŠ</button>\n          </div>\n        </div>\n        \n        <div class="modal-footer">\n          <button class="cancel-btn" data-action="cancel">å–æ¶ˆ</button>\n          <button class="save-btn" data-action="save">ä¿å­˜</button>\n        </div>\n      </div>\n    `,this.bindGroupManagementModalEvents(t,e),this.registerGroupMemberAvatars(t),t}registerGroupMemberAvatars(e){try{e.querySelectorAll('.member-avatar').forEach(e=>{const t=e.closest('.member-item');if(t){const a=t.getAttribute('data-member-id');if('user'===a||'{{user}}'===a){console.log('ğŸ”— æ³¨å†Œç¾¤æˆå‘˜ä¸­çš„ç”¨æˆ·å¤´åƒåˆ°åŒæ­¥ç³»ç»Ÿ'),this.avatarMixin.register(e,'img');const t=G();e.src=t}}})}catch(e){console.warn('æ³¨å†Œç¾¤æˆå‘˜å¤´åƒå¤±è´¥:',e)}}bindGroupManagementModalEvents(e,t){[e.querySelector('[data-action="close"]'),e.querySelector('[data-action="cancel"]')].forEach(e=>{e&&e.addEventListener('click',()=>{this.hideGroupManagementModal()})});const a=e.querySelector('[data-action="save"]');a&&a.addEventListener('click',()=>{this.handleGroupSettingsSave(e,t)});const s=e.querySelector('[data-action="change-avatar"]');s&&s.addEventListener('click',()=>{this.handleGroupAvatarChange(t)});const n=e.querySelector('[data-action="invite-member"]');n&&n.addEventListener('click',()=>{this.handleGroupMemberInvite(t)});const r=e.querySelector('[data-action="disband"]');r&&r.addEventListener('click',()=>{this.handleGroupDisband(t)});e.querySelectorAll('.kick-member-btn').forEach(e=>{e.addEventListener('click',async e=>{const a=e.target.closest('[data-member-id]')?.getAttribute('data-member-id');a&&await this.handleGroupMemberKick(t,a)})}),e.addEventListener('click',t=>{t.target===e&&this.hideGroupManagementModal()})}hideGroupManagementModal(){const e=document.getElementById('groupManagementModal');e&&(this.unregisterGroupMemberAvatars(e),e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}async refreshGroupManagementModal(e){try{const t=document.getElementById('groupManagementModal');if(!t)return void console.warn('âš ï¸ æœªæ‰¾åˆ°ç°æœ‰çš„ç¾¤èŠç®¡ç†æ¨¡æ€æ¡†');const s=t.querySelector('.members-list'),n=t.querySelector('.member-count');if(!s)throw console.warn('âš ï¸ æœªæ‰¾åˆ°æˆå‘˜åˆ—è¡¨å®¹å™¨'),new Error('æˆå‘˜åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');const r=e.members||[],o=r.map(async e=>{let t=e.avatar,s=e.name;if('{{user}}'===e.id||'user'===e.id)try{const{getUserAvatar:e,getUserNameAsync:n}=await Promise.resolve().then(a.bind(a,335));t=e(),s=await n()}catch(e){}return`\n        <div class="member-item" data-member-id="${e.id}">\n          <img src="${t}" class="member-avatar" alt="${s}">\n          <div class="member-info">\n            <span class="member-name">${s}</span>\n            <span class="member-role">${this.getMemberRoleText(e.role)}</span>\n          </div>\n          <div class="member-actions">\n            ${'owner'!==e.role?`\n              <button class="kick-member-btn" data-member-id="${e.id}" title="ç§»é™¤æˆå‘˜">\n                <svg viewBox="0 0 24 24" width="16" height="16">\n                  <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n                </svg>\n              </button>\n            `:''}\n          </div>\n        </div>\n      `}),i=(await Promise.all(o)).join(''),c=r.length;s.innerHTML=i,n&&(n.textContent=c.toString()),this.bindMemberListEvents(s,e),console.log('âœ… ç¾¤èŠæˆå‘˜åˆ—è¡¨åˆ·æ–°å®Œæˆ')}catch(e){console.error('âŒ åˆ·æ–°æˆå‘˜åˆ—è¡¨å¤±è´¥:',e),this.showToast('åˆ·æ–°æˆå‘˜åˆ—è¡¨å¤±è´¥','error')}}bindMemberListEvents(e,t){e.querySelectorAll('.kick-member-btn').forEach(e=>{e.addEventListener('click',async e=>{e.stopPropagation();const a=e.target.closest('[data-member-id]')?.getAttribute('data-member-id');a&&await this.handleGroupMemberKick(t,a)})})}unregisterGroupMemberAvatars(e){try{e.querySelectorAll('.member-avatar').forEach(e=>{const t=e.closest('.member-item');if(t){const a=t.getAttribute('data-member-id');'user'!==a&&'{{user}}'!==a||(console.log('ğŸ”— å–æ¶ˆæ³¨å†Œç¾¤æˆå‘˜ä¸­çš„ç”¨æˆ·å¤´åƒ'),this.avatarMixin.unregister(e))}})}catch(e){console.warn('å–æ¶ˆæ³¨å†Œç¾¤æˆå‘˜å¤´åƒå¤±è´¥:',e)}}async handleGroupSettingsSave(e,t){const a=e.querySelector('.group-name-input'),s=a?.value.trim();if(s){if(s!==t.chatName){const e=t.chatName;N.saveGroupNameOverride(t.chatId,s),t.chatName=s,console.log(`ğŸ“ ç¾¤åç§°å·²æ›´æ–°: ${e} -> ${t.chatName}`),this.updateGroupChatDisplay(t)}this.showToast('ç¾¤ä¿¡æ¯å·²ä¿å­˜','success'),this.hideGroupManagementModal()}else this.showToast('ç¾¤åç§°ä¸èƒ½ä¸ºç©º','error')}handleGroupAvatarChange(e){const t=document.createElement('input');t.type='file',t.accept='image/*',t.style.display='none',document.body.appendChild(t),t.addEventListener('change',async s=>{const n=s.target.files?.[0];if(n)try{if(!n.type.startsWith('image/'))return void this.showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶','error');if(n.size>5242880)return void this.showToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB','error');this.showToast('æ­£åœ¨ä¸Šä¼ å¤´åƒ...','info');const{GroupChatStorage:t}=await Promise.resolve().then(a.bind(a,15)),s=await t.fileToBase64(n);await t.saveGroupAvatar(e.chatId,s),e.avatar=s;const r=document.querySelector('.group-avatar-preview');r&&(r.src=s),this.updateChatListAvatar(e.chatId,s),this.updateChatHeaderAvatar(s),this.showToast('ç¾¤å¤´åƒæ›´æ¢æˆåŠŸ','success')}catch(e){console.error('æ›´æ¢ç¾¤å¤´åƒå¤±è´¥:',e),this.showToast('æ›´æ¢ç¾¤å¤´åƒå¤±è´¥','error')}finally{document.body.removeChild(t)}else document.body.removeChild(t)}),t.click()}updateChatListAvatar(e,t){const a=document.querySelector(`[data-chat-id="${e}"] .chat-avatar`);a&&(a.src=t)}updateChatHeaderAvatar(e){const t=document.getElementById('headerAvatar');t&&(t.src=e)}async saveChatDataToBear(){try{const e=this.messageParser.buildBearContent(this.chatData).replace('<bear>','').replace('</bear>',''),t=await getLastMessageId(),a=getChatMessages(-1)[0],s=a?.message||'',n=this.replaceOnlyBearTagContent(s,e);await setChatMessages([{message_id:t,message:n}],{refresh:'none'})}catch(e){throw console.error('ä¿å­˜èŠå¤©æ•°æ®å¤±è´¥:',e),e}}handleGroupMemberInvite(e){try{const t=this.chatListManager.getContactManager().getAllContacts(),a=e.members||[],s=t.filter(e=>!a.some(t=>t.id===e.id));if(0===s.length)return void this.showToast('æ²¡æœ‰å¯é‚€è¯·çš„è”ç³»äºº','warning');this.showInviteMemberModal(e,s)}catch(e){console.error('å¤„ç†ç¾¤èŠæˆå‘˜é‚€è¯·å¤±è´¥:',e),this.showToast('é‚€è¯·æˆå‘˜å¤±è´¥','error')}}showInviteMemberModal(e,t){const a=document.createElement('div');a.className='invite-member-overlay',a.id='inviteMemberModal';const s=t.map(e=>`\n      <div class="invite-contact-item" data-contact-id="${e.id}">\n        <img class="invite-contact-avatar" src="${e.avatar}" alt="${e.name}">\n        <div class="invite-contact-info">\n          <div class="invite-contact-name">${e.name}</div>\n        </div>\n        <div class="invite-contact-checkbox">\n          <input type="checkbox" id="invite_${e.id}" value="${e.id}">\n          <label for="invite_${e.id}"></label>\n        </div>\n      </div>\n    `).join('');a.innerHTML=`\n      <div class="invite-modal-container">\n        <div class="invite-modal-header">\n          <h3>é‚€è¯·æˆå‘˜</h3>\n          <button class="invite-close-btn" data-action="close">Ã—</button>\n        </div>\n        \n        <div class="invite-modal-body">\n          <div class="invite-contacts-list">\n            ${s}\n          </div>\n        </div>\n        \n        <div class="invite-modal-footer">\n          <button class="invite-cancel-btn" data-action="cancel">å–æ¶ˆ</button>\n          <button class="invite-confirm-btn" data-action="confirm">é‚€è¯·</button>\n        </div>\n      </div>\n    `;const n=document.querySelector('.phone-container');n?n.appendChild(a):document.body.appendChild(a),this.bindInviteMemberModalEvents(a,e)}bindInviteMemberModalEvents(e,t){[e.querySelector('[data-action="close"]'),e.querySelector('[data-action="cancel"]')].forEach(t=>{t&&t.addEventListener('click',()=>{e.parentNode&&e.parentNode.removeChild(e)})});const a=e.querySelector('[data-action="confirm"]');a&&a.addEventListener('click',()=>{this.handleInviteMemberConfirm(e,t)})}async handleInviteMemberConfirm(e,t){try{const a=e.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(a).map(e=>e.value);if(0===s.length)return void this.showToast('è¯·é€‰æ‹©è¦é‚€è¯·çš„æˆå‘˜','warning');const n=this.chatListManager.getContactManager(),r=s.map(e=>{const t=n.getContactById(e);return{id:t.id,name:t.name,avatar:t.avatar}});t.members=[...t.members||[],...r],await this.syncGroupMembersToTavern(t),e.parentNode&&e.parentNode.removeChild(e),await this.refreshGroupManagementModal(t),this.showToast(`æˆåŠŸé‚€è¯· ${s.length} åæˆå‘˜`,'success')}catch(e){console.error('é‚€è¯·æˆå‘˜ç¡®è®¤å¤±è´¥:',e),this.showToast('é‚€è¯·æˆå‘˜å¤±è´¥','error')}}async handleGroupMemberKick(e,t){const a=e.members||[],s=a.find(e=>e.id===t);s?confirm(`ç¡®å®šè¦ç§»é™¤æˆå‘˜ "${s.name}" å—ï¼Ÿ`)&&(e.members=a.filter(e=>e.id!==t),console.log(`ğŸ‘‹ æˆå‘˜å·²ç§»é™¤: ${s.name}`),await this.syncGroupMembersToTavern(e),await this.refreshGroupManagementModal(e),this.showToast(`æˆå‘˜ "${s.name}" å·²ç§»é™¤`,'success')):this.showToast('æˆå‘˜ä¸å­˜åœ¨','error')}async handleGroupDisband(e){try{if(!confirm(`ç¡®å®šè¦è§£æ•£ç¾¤èŠ "${e.chatName}" å—ï¼Ÿ\n\nè§£æ•£åå°†åˆ é™¤æ‰€æœ‰ç¾¤èŠæ¶ˆæ¯ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`))return;console.log('ğŸ—‘ï¸ å¼€å§‹è§£æ•£ç¾¤èŠ:',e.chatName),this.hideGroupManagementModal(),this.groupChatManager&&this.groupChatManager.deleteGroupChat(e.chatId),await this.handleDeleteChatRequest(e.chatId),this.showToast(`ç¾¤èŠ "${e.chatName}" å·²è§£æ•£`,'success'),console.log('âœ… ç¾¤èŠè§£æ•£å®Œæˆ')}catch(e){console.error('è§£æ•£ç¾¤èŠå¤±è´¥:',e),this.showToast('è§£æ•£ç¾¤èŠå¤±è´¥','error')}}getGroupNameById(e){const t=this.chatData.get(e);return t?t.chatName:null}updateGroupChatData(e){try{if(this.chatData.set(e.chatId,e),this.groupChatManager){const t={id:e.chatId,name:e.chatName,avatar:e.avatar,members:(e.members||[]).map(e=>e.id),userParticipation:'member',createdAt:Date.now(),messages:[],type:'group'};a(15).GroupChatStorage.saveGroupChat(t)}console.log('âœ… ç¾¤èŠæ•°æ®å·²æ›´æ–°:',e.chatName)}catch(e){console.error('æ›´æ–°ç¾¤èŠæ•°æ®å¤±è´¥:',e)}}updateGroupChatDisplay(e){const t=document.getElementById('chatTitle');t?(t.textContent=e.chatName,console.log(`ğŸ”„ å·²æ›´æ–°èŠå¤©æ ‡é¢˜: ${e.chatName}`)):console.warn('âš ï¸ æœªæ‰¾åˆ°èŠå¤©æ ‡é¢˜å…ƒç´  #chatTitle'),this.chatListManager&&(this.chatListManager.refreshChatList(this.chatData),console.log('ğŸ”„ å·²åˆ·æ–°èŠå¤©åˆ—è¡¨'))}getMemberRoleText(e){switch(e){case'owner':return'ç¾¤ä¸»';case'admin':return'ç®¡ç†å‘˜';default:return'æˆå‘˜'}}validateBearData(e){const t=[];try{e.includes('<bear>')&&e.includes('</bear>')||t.push('ç¼ºå°‘Bearæ ‡ç­¾');0===[...e.matchAll(/\[([^\]]+)\]([\s\S]*?)\[\/\1\]/g)].length&&t.push('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©å—');const a=[...e.matchAll(/\[ç¾¤èŠ([^\]]+)\]\s*\n?\s*\[æˆå‘˜[ï¼š:]([^\]]+)\]\s*\n?([\s\S]*?)\n?\s*\[\/ç¾¤èŠ\1\]/g)];for(const e of a){const a=e[1],s=e[2];a.trim()||t.push('ç¾¤èŠåç§°ä¸èƒ½ä¸ºç©º'),s.trim()||t.push(`ç¾¤èŠ"${a}"çš„æˆå‘˜åˆ—è¡¨ä¸èƒ½ä¸ºç©º`)}return 0===[...e.matchAll(/\[([SG])_[^\]]*\]/g)].length&&t.push('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ¶ˆæ¯'),{valid:0===t.length,errors:t}}catch(e){return t.push(`éªŒè¯è¿‡ç¨‹å‡ºé”™: ${e}`),{valid:!1,errors:t}}}async syncGroupMembersToTavern(e){try{console.log('ğŸ”„ å¼€å§‹åŒæ­¥ç¾¤æˆå‘˜å˜æ›´åˆ°é…’é¦†èŠå¤©å—'),console.log('ğŸ“Š ç¾¤èŠæ•°æ®:',{chatId:e.chatId,chatName:e.chatName,memberCount:(e.members||[]).length}),this.chatData.set(e.chatId,e),console.log('âš ï¸ æ³¨æ„ï¼šåªèƒ½æ›´æ–°å½“å‰èŠå¤©ä¸­çš„ç¾¤èŠä¿¡æ¯');const t=getChatMessages('0-{{lastMessageId}}');let a=-1;console.log(`ğŸ“ å½“å‰èŠå¤©å…±æœ‰ ${t.length} æ¡æ¶ˆæ¯`);let s=null;const n=[e.chatName];if(N.hasOverride(e.chatId)){console.log('ğŸ” æ£€æµ‹åˆ°ç¾¤åè¦†ç›–ï¼Œå°†åŒæ—¶æœç´¢åŸå§‹åç§°å’Œè¦†ç›–åç§°');for(let e=0;e<t.length;e++){const a=t[e];if(a.message){const e=a.message.matchAll(/\[ç¾¤èŠ([^\]]+)\]/g);for(const t of e){const e=t[1];n.includes(e)||(n.push(e),console.log(`ğŸ“ å‘ç°å¯èƒ½çš„åŸå§‹ç¾¤å: ${e}`))}}}}console.log(`ğŸ” æœç´¢æ¨¡å¼: ${n.join(', ')}`);for(const e of n){const n=`[ç¾¤èŠ${e}]`;for(let r=0;r<t.length;r++){const o=t[r];if(o.message&&o.message.includes(n)){const t=o.message;if(t.includes(`[/ç¾¤èŠ${e}]`)||t.includes('<bear>')&&t.includes(n)){a=o.message_id,s=o,console.log(`ğŸ¯ æ‰¾åˆ°ç›®æ ‡ç¾¤èŠæ¶ˆæ¯: ${e} (æ¶ˆæ¯ID: ${a})`),s.foundGroupName=e;break}}}if(s)break}const r=(e.members||[]).map(e=>e.name).join('ï¼Œ'),o=`[æˆå‘˜ï¼š${r}]`;if(a>=0&&s){let t=s.message;const n=s.foundGroupName||e.chatName,i=new RegExp(`(\\[ç¾¤èŠ${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\][\\s\\S]*?)\\[æˆå‘˜ï¼š[^\\]]*\\]`,'g');if(i.test(t))t=t.replace(i,`$1${o}`),console.log(`ğŸ¯ ç²¾ç¡®æ›¿æ¢ç¾¤èŠå—å†…çš„æˆå‘˜ä¿¡æ¯ (ä½¿ç”¨åç§°: ${n})`);else{const e=`[ç¾¤èŠ${n}]`;t.includes(e)?(t=t.replace(/\[æˆå‘˜ï¼š[^\]]*\]/,o),console.log(`ğŸ“ é™çº§æ›¿æ¢æˆå‘˜ä¿¡æ¯ (ä½¿ç”¨åç§°: ${n})`)):console.warn('âš ï¸ æœªæ‰¾åˆ°åˆé€‚çš„æˆå‘˜ä¿¡æ¯æ›¿æ¢ä½ç½®')}await setChatMessages([{message_id:a,message:t}],{refresh:'none'}),console.log(`âœ… å·²æ›´æ–°ç¾¤èŠæˆå‘˜ä¿¡æ¯åˆ°æ¶ˆæ¯ ${a}`),console.log(`ğŸ“ æ–°æˆå‘˜åˆ—è¡¨: ${r}`)}else{console.log('ğŸ”„ æœªæ‰¾åˆ°ç›®æ ‡ç¾¤èŠæ¶ˆæ¯ï¼Œæ›´æ–°æ•´ä¸ªBearå†…å®¹');const e=this.messageParser.buildBearContent(this.chatData),t=getChatMessages(-1)[0];if(t){const a=t.message||'',s=e.replace('<bear>','').replace('</bear>',''),n=this.replaceOnlyBearTagContent(a,s);await setChatMessages([{message_id:t.message_id,message:n}],{refresh:'none'}),console.log('âœ… å·²æ›´æ–°Bearå†…å®¹åŒ…å«ç¾¤èŠæˆå‘˜ä¿¡æ¯'),console.log(`ğŸ“ æ–°æˆå‘˜åˆ—è¡¨: ${r}`)}else console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯æ›´æ–°çš„æ¶ˆæ¯')}this.updateGroupDataInBear(e),console.log('âœ… ç¾¤æˆå‘˜åŒæ­¥å®Œæˆ')}catch(t){console.error('âŒ åŒæ­¥ç¾¤æˆå‘˜åˆ°é…’é¦†å¤±è´¥:',t),console.error('é”™è¯¯è¯¦æƒ…:',t),this.showToast('åŒæ­¥æˆå‘˜ä¿¡æ¯å¤±è´¥','error'),this.updateGroupDataInBear(e)}}updateGroupDataInBear(e){try{this.chatData.set(e.chatId,e);const t=this.messageParser.buildBearContent(this.chatData),a=this.validateBearData(t);if(!a.valid)return console.error('Bearæ•°æ®éªŒè¯å¤±è´¥:',a.errors),void this.showToast('æ•°æ®éªŒè¯å¤±è´¥: '+a.errors.join(', '),'error');console.log('âœ… ç¾¤èŠæ•°æ®å·²æ›´æ–°åˆ°å†…å­˜')}catch(e){console.error('æ›´æ–°ç¾¤èŠæ•°æ®å¤±è´¥:',e),this.showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•','error')}}renderCurrentChat(){const e=this.chatData.get(this.currentChat);if(!e){console.error('âŒ æ‰¾ä¸åˆ°å½“å‰èŠå¤©æ•°æ®:',this.currentChat);return void Array.from(this.chatData.keys()).filter(e=>e.includes(this.currentChat)||this.currentChat.includes(e)).length}this.rehydrateUserImageMessages(e),this.updateChatHeader(e),this.renderMessages(e)}updateChatHeader(e){const t=document.getElementById('chatTitle'),a=document.getElementById('headerAvatar'),s=document.querySelector('.header-status');if(t){let a=e.chatName;const s=e.chatName.match(/^å’Œ(.+)çš„èŠå¤©$/);s&&(a=s[1]),t.textContent=a}if(a&&(a.src=this.messageParser.processImageUrl(e.avatar),a.alt=e.chatName),s){const t=e.chatId.startsWith('ç¾¤èŠ')||e.chatId.startsWith('G_')||e.chatName.includes('ç¾¤èŠ')||e.messages.some(e=>'G'===e.type);s.style.display=t?'none':'flex'}}renderMessages(e,t){const a=document.getElementById('chatMessages');if(!a)return void console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨ #chatMessages');const s=!!t?.preserveScroll,n=a.scrollTop,r=a.scrollHeight,o=e.messages.length,i=Math.min(o,this.INITIAL_VISIBLE_COUNT);this.visibleCounts.has(e.chatId)||this.visibleCounts.set(e.chatId,i);const c=Math.min(this.visibleCounts.get(e.chatId)||i,o),l=Math.max(o-c,0);a.innerHTML='';for(let t=l;t<o;t++){const s=this.createMessageElement(e.messages[t]);a.appendChild(s)}if(this.sendQueue.filter(e=>e.chatId===this.currentChat).forEach(e=>{const t=this.createMessageElement(e);a.appendChild(t)}),s){if(r>0){a.scrollHeight===r&&(a.scrollTop=n)}}else this.scrollToBottom(a)}prependOlderMessages(e,t,a){const s=document.getElementById('chatMessages');if(!s)return;const n=e.messages.length,r=Math.max(n-t,0),o=Math.max(n-a,0);if(o>=r)return;const i=s.scrollHeight,c=s.querySelector('.load-more-sentinel'),l=c?c.nextSibling:s.firstChild;for(let t=o;t<r;t++){const a=this.createMessageElement(e.messages[t]);l?s.insertBefore(a,l):s.insertBefore(a,s.firstChild)}0===o&&c&&c.remove();const d=s.scrollHeight;s.scrollTop+=d-i}handleTopScrollLoadMore(e){try{if(!document.getElementById('chatMessages'))return;const t=this.chatData.get(e);if(!t)return;const a=t.messages.length,s=Math.min(this.visibleCounts.get(e)??this.INITIAL_VISIBLE_COUNT,a);if(s>=a)return;const n=Math.min(s+this.LOAD_MORE_STEP,a);this.visibleCounts.set(e,n),this.prependOlderMessages(t,s,n)}catch(e){console.warn('handleTopScrollLoadMore å¤±è´¥:',e)}}attachTopScrollListener(){const e=document.getElementById('chatMessages');if(!e)return;this.detachTopScrollListener();const t=e=>{if(e.target.scrollTop<=0){const e=Date.now();if(e-this.lastLoadMoreAt<this.LOAD_MORE_THROTTLE_MS)return;this.lastLoadMoreAt=e,this.handleTopScrollLoadMore(this.currentChat)}};e.addEventListener('scroll',t),this.topScrollHandler=t}detachTopScrollListener(){const e=document.getElementById('chatMessages');e&&this.topScrollHandler&&e.removeEventListener('scroll',this.topScrollHandler),this.topScrollHandler=null}addMessageToChatData(e){const t=this.chatData.get(e.chatId);if(t)t.messages.push(e),t.lastMessage=this.messageParser.formatLastMessage(e);else{const t={chatId:e.chatId,chatName:e.chatId,avatar:e.avatar,messages:[e],lastMessage:this.messageParser.formatLastMessage(e),type:'G'===e.type?'group':'single'};this.chatData.set(e.chatId,t)}}addNewMessageToInterface(e){const t=document.getElementById('chatMessages');if(!t)return;const a=this.createMessageElement(e);t.appendChild(a),requestAnimationFrame(()=>{this.ensureVoiceMessageInteractions(a,e)}),this.scrollToBottom(t)}createMessageElement(e){const t=document.createElement('div'),a=this.isUserSender(e.sender),s='G'===e.type;t.className=`message ${a?'sent':'received'}${s?' group-message':''}`,t.dataset.messageId=e.id,t.dataset.messageFp=this.generateMessageFingerprint(e);const n=this.createAvatar(e,a);t.appendChild(n);const r=this.createMessageWrapper(e,s);return t.appendChild(r),this.addMessageAnimation(t),this.addMessageInteractions(t,e),t}createMessageContent(e){const t=document.createElement('div');switch(t.className='message-content',e.messageType){case'text':default:this.renderTextMessage(t,e);break;case'image':this.renderImageMessage(t,e);break;case'voice':this.renderVoiceMessage(t,e);break;case'sticker':this.renderStickerMessage(t,e);break;case'location':this.renderLocationMessage(t,e);break;case'transfer':this.renderTransferMessage(t,e)}return t}createAvatar(e,t){if(t){const e=document.createElement('div');e.className='user_avatar avatar avatar-hover';const t=G();return e.style.backgroundImage=`url(${t})`,this.avatarMixin.register(e,'background'),e}{const t=document.createElement('img');return t.className='avatar',t.src=this.messageParser.processImageUrl(e.avatar)||'https://files.catbox.moe/u8ccy5.jpg',t.alt=e.sender,t}}createMessageWrapper(e,t=!1){const a=document.createElement('div');if(a.className='message-wrapper',a.dataset.messageId=e.id,t&&!this.isUserSender(e.sender)){const t=document.createElement('div');t.className='message-sender',t.textContent=e.senderDisplayName||e.sender,a.appendChild(t)}const s=this.createMessageContent(e);a.appendChild(s);const n=document.createElement('div');return n.className='message-time',n.textContent=e.timestamp,a.appendChild(n),a}renderTextMessage(e,t){const a=document.createElement('span');a.textContent=t.content,e.appendChild(a)}renderFileImage(e,t,a){const s=URL.createObjectURL(t),n=document.createElement('img');n.src=s,n.className='message-image',n.alt=t.name,n.loading='lazy',n.onload=()=>{URL.revokeObjectURL(s)},n.onerror=()=>{n.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t),URL.revokeObjectURL(s)},e.appendChild(n)}renderImageMessage(e,t){if(!this.isUserSender(t.sender))return void this.renderAttachmentMessage(e,(t.content||'').trim());if(t.data?.uploadedFile)return void this.renderFileImage(e,t.data.uploadedFile,t.content);if(t.data?.base64Image){const a=document.createElement('img');return a.src=t.data.base64Image,a.className='message-image',a.alt=t.content||'å›¾ç‰‡',a.loading='lazy',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},void e.appendChild(a)}if(t.data?.imageUrl){const a=document.createElement('img');return a.src=t.data.imageUrl,a.className='message-image',a.alt=t.content||'å›¾ç‰‡',a.loading='lazy',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},void e.appendChild(a)}const a=t.content.match(/^å›¾ç‰‡URLï¼š(.*?)\nå›¾ç‰‡æè¿°ï¼š(.*?)$/);if(a){const t=a[1].trim(),s=a[2].trim(),n=document.createElement('img');return n.src=this.messageParser.processImageUrl(t),n.className='message-image',n.alt=s,n.loading='lazy',n.onerror=()=>{n.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},void e.appendChild(n)}const s=t.content.match(/â•’â•â•â•â•â•\s*(.*?)\s*â•˜â•â•â•â•â•/);if(s)return void this.renderAttachmentMessage(e,s[1]);const n=!!(t.data?.uploadedFile||t.data?.base64Image||t.data?.imageUrl);if(!n){const a=this.getCachedUiImage(t);if(a){t.data={...t.data||{},imageUrl:a};const s=document.createElement('img');return s.src=a,s.className='message-image',s.alt=t.content||'å›¾ç‰‡',s.loading='lazy',s.onerror=()=>{s.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},void e.appendChild(s)}}if(!n){const a=(t.content||'').trim(),s=a.startsWith('http://')||a.startsWith('https://'),n=a.startsWith('data:'),r=/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/.test(a);if(!s&&!n&&!r)return void this.renderAttachmentMessage(e,a)}const r=document.createElement('img');r.src=this.messageParser.processImageUrl(t.content),r.className='message-image',r.alt='å›¾ç‰‡æ¶ˆæ¯',r.loading='lazy',r.onerror=()=>{r.classList.add('hidden');const t=document.createElement('span');t.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},e.appendChild(r)}renderAttachmentMessage(e,t){const a=['https://files.catbox.moe/0g3kqu.jpg','https://files.catbox.moe/d5b7k6.jpg','https://files.catbox.moe/0yrhh6.jpg','https://files.catbox.moe/8mjvdg.jpg','https://files.catbox.moe/fvidas.jpg','https://files.catbox.moe/q6so2i.jpg','https://files.catbox.moe/5a96cp.jpg','https://files.catbox.moe/0mp6h0.jpg','https://files.catbox.moe/epcn03.jpg','https://files.catbox.moe/7jzdp7.jpg','https://files.catbox.moe/jrmu6w.jpg','https://files.catbox.moe/c0bwhn.jpg','https://files.catbox.moe/0blxme.jpg','https://files.catbox.moe/qicobr.jpg','https://files.catbox.moe/n94ztu.jpg'],s=a[Math.floor(Math.random()*a.length)],n=document.createElement('div');n.className='random-image-container dynamic-bg',n.style.backgroundImage=`url('${s}')`;const r=document.createElement('details'),o=document.createElement('summary'),i=document.createElement('div');i.className='attachment-content';const c=document.createElement('div');c.className='attachment-text';const l=document.createElement('p');l.textContent=t,c.appendChild(l),i.appendChild(c),r.appendChild(o),r.appendChild(i),n.appendChild(r),e.appendChild(n)}renderVoiceMessage(e,t){const a=t.content.split('|'),s=a[0]||'è¯­éŸ³æ¶ˆæ¯',n=a[1]||'0',r=document.createElement('div');r.className='voice-message';const o=document.createElement('div');o.className='voice-icon';const i=document.getElementById('voiceIconTemplate');i?o.innerHTML=i.innerHTML:(console.warn('è¯­éŸ³å›¾æ ‡æ¨¡æ¿æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡'),o.innerHTML='\n        <svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />\n        </svg>\n        <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none">\n          <path d="M14,19H18V5H14M6,19H10V5H6V19Z" />\n        </svg>\n      ');const c=document.createElement('div');c.className='voice-wave-container';for(let e=0;e<5;e++){const t=document.createElement('div');t.className='voice-wave',t.style.animationDelay=.1*e+'s',c.appendChild(t)}const l=document.createElement('span');l.className='voice-duration',l.textContent=`${n}"`,r.appendChild(o),r.appendChild(c),r.appendChild(l),e.appendChild(r);const d=document.createElement('div');d.className='voice-transcript',d.textContent=s,d.style.display='none',r.setAttribute('data-voice-content',s),r.setAttribute('data-duration',n),e.appendChild(d)}addVoiceMessageInteractions(e,t,a,s){let n=!1;e.addEventListener('click',a=>{a.stopPropagation(),n=!n,n?(e.classList.add('expanded'),t.style.display='block',t.classList.add('show')):(e.classList.remove('expanded'),t.style.display='none',t.classList.remove('show')),this.soundManager.playSound('click')})}renderStickerMessage(e,t){const a=document.createElement('img');a.src=this.messageParser.processImageUrl(t.content)||t.content,a.className='message-sticker',a.alt='è¡¨æƒ…åŒ…',a.loading='lazy',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[è¡¨æƒ…åŒ…åŠ è½½å¤±è´¥]',t.className='error-text',e.appendChild(t)},e.appendChild(a)}renderLocationMessage(e,t){const a=document.createElement('div');a.className='location-message';const s=document.createElement('div');s.className='location-icon';const n=document.getElementById('locationIconTemplate');n&&(s.innerHTML=n.innerHTML);const r=document.createElement('span');r.className='location-text',r.textContent=t.content||'ä½ç½®ä¿¡æ¯',a.appendChild(s),a.appendChild(r),e.appendChild(a)}renderTransferMessage(e,t){const a=t.content.split('|'),s=a[0]||'0',n=a[1]||'ç­‰å¾…æ¥æ”¶',r=document.createElement('div');r.className='transfer-bubble';const o=document.createElement('div');o.className='transfer-content';const i=document.createElement('div');i.className='transfer-icon';const c=document.getElementById('transferIconTemplate');c&&(i.innerHTML=c.innerHTML);const l=document.createElement('div');l.className='transfer-info';const d=document.createElement('div');d.className='transfer-amount',d.textContent=`ï¿¥${s}`;const h=document.createElement('div');h.className='transfer-status','å·²æ¥æ”¶'===n?h.classList.add('completed'):'å·²é€€å›'===n||'å·²æ‹’ç»'===n?h.classList.add('failed'):'å¾…æ¥æ”¶'===n&&h.classList.add('pending'),h.textContent=n,l.appendChild(d),l.appendChild(h),o.appendChild(i),o.appendChild(l),r.appendChild(o),this.isUserSender(t.sender)?r.classList.add('user-transfer'):r.addEventListener('click',()=>{this.handleTransferClick(t,h),this.soundManager.playSound('click')}),e.appendChild(r)}addMessageAnimation(e){e.classList.add('message-animation'),requestAnimationFrame(()=>{e.classList.add('show')})}addMessageInteractions(e,t){this.addBubbleInteractions(e,t),this.addAvatarInteractions(e,t),this.addTimestampInteractions(e,t),this.addSpecialMessageInteractions(e,t),t.isPending&&this.addDoubleClickEdit(e,t)}addBubbleInteractions(e,t){e.querySelector('.message-wrapper');const a=e.querySelector('.message-content');a&&'transfer'!==t.messageType&&a.addEventListener('click',e=>{e.stopPropagation(),this.soundManager.playSound('click'),this.addClickFeedback(a)})}addAvatarInteractions(e,t){const a=e.querySelector('.avatar');if(a){a.addEventListener('click',e=>{e.stopPropagation(),this.soundManager.playSound('avatar'),this.addAvatarClickEffect(a)});this.isUserSender(t.sender)&&a.addEventListener('dblclick',a=>{this.isBatchDeleteMode||(a.stopPropagation(),this.showUserMessageContextMenu(a,t,e))}),a.classList.add('avatar-hover')}}addTimestampInteractions(e,t){}addSpecialMessageInteractions(e,t){switch(t.messageType){case'image':case'transfer':break;case'voice':this.addVoiceInteractions(e,t);break;case'sticker':this.addStickerInteractions(e,t)}}initializeTransferClickDelegation(){try{if(this.transferDelegationBound)return;const e=e=>{const t=e.target;if(!t||!('closest'in t))return;const a=t.closest?.('.transfer-bubble');if(!a)return;if(!a.closest('#chatMessages'))return;const s=a.closest('.message'),n=s?.dataset.messageId;if(!n)return;const r=this.chatData.get(this.currentChat),o=r?.messages.find(e=>e.id===n)||this.sendQueue.find(e=>e.id===n);if(!o)return;if(this.isUserSender(o.sender))return;if('transfer'!==o.messageType)return;const i=a.querySelector('.transfer-status');e.stopPropagation(),this.handleTransferClick(o,i||void 0),this.soundManager.playSound('click')};document.addEventListener('click',e,!0),this.transferDelegationBound=!0,console.log('[BearChatManager] è½¬è´¦ç‚¹å‡»äº‹ä»¶å§”æ‰˜å·²å¯ç”¨')}catch(e){console.warn('initializeTransferClickDelegation å¤±è´¥:',e)}}addDoubleClickEdit(e,t){const a=e.querySelector('.message-content');if(!a)return;a.addEventListener('dblclick',e=>{this.handleMessageEdit(t),this.soundManager.playSound('click'),e.stopPropagation(),e.preventDefault()},!0)}addClickFeedback(e){e.classList.add('click-feedback'),setTimeout(()=>{e.classList.remove('click-feedback')},100)}addAvatarClickEffect(e){e.classList.add('avatar-click-effect'),setTimeout(()=>{e.classList.remove('avatar-click-effect')},150)}addVoiceInteractions(e,t){const a=e.querySelector('.voice-message'),s=e.querySelector('.voice-transcript');if(a&&s){let e=!1;const t=a.querySelector('.mic-icon'),n=a.querySelector('.pause-icon');a.addEventListener('click',r=>{r.stopPropagation(),e=!e,e?(a.classList.add('expanded'),s.style.display='block',s.classList.add('show'),t&&(t.style.display='none'),n&&(n.style.display='block')):(a.classList.remove('expanded'),s.style.display='none',s.classList.remove('show'),t&&(t.style.display='block'),n&&(n.style.display='none')),this.soundManager.playSound('click')})}}ensureVoiceMessageInteractions(e,t){if('voice'!==t.messageType)return;const a=e.querySelector('.voice-message'),s=e.querySelector('.voice-transcript');if(a&&!a.hasAttribute('data-voice-bound')){a.setAttribute('data-voice-bound','true');const e=()=>{const t=a.querySelector('.mic-icon'),n=a.querySelector('.pause-icon');if(t&&n&&s){let e=!1;const t=a.cloneNode(!0);a.parentNode?.replaceChild(t,a);const n=t.querySelector('.mic-icon'),r=t.querySelector('.pause-icon');t.addEventListener('click',a=>{a.stopPropagation(),e=!e,e?(t.classList.add('expanded'),s.style.display='block',s.classList.add('show'),n&&(n.style.display='none'),r&&(r.style.display='block')):(t.classList.remove('expanded'),s.style.display='none',s.classList.remove('show'),n&&(n.style.display='block'),r&&(r.style.display='none')),this.soundManager.playSound('click')}),console.log('âœ… è¯­éŸ³æ¶ˆæ¯äº‹ä»¶ç»‘å®šæˆåŠŸ')}else setTimeout(e,50)};e()}}addStickerInteractions(e,t){const a=e.querySelector('.message-sticker');a&&a.addEventListener('click',()=>{this.soundManager.playSound('emoji'),this.addStickerAnimation(a)})}addStickerAnimation(e){e.classList.remove('sticker-animation','reset'),e.offsetHeight,e.classList.add('sticker-animation'),setTimeout(()=>{e.classList.add('reset'),setTimeout(()=>{e.classList.remove('sticker-animation','reset')},100)},300)}scrollToBottom(e){e.scrollTop=e.scrollHeight}createModalOverlay(){const e=document.createElement('div');return e.className='modal-overlay',e.addEventListener('click',t=>{t.target===e&&this.hideModal()}),e}createModalContainer(e,t){const a=document.createElement('div');a.className='modal-container';const s=document.createElement('div');s.className='modal-title',s.textContent=e;const n=document.createElement('div');return n.className='modal-content',n.appendChild(t),a.appendChild(s),a.appendChild(n),a}showModal(e,t,a=!0){const s=this.createModalOverlay(),n=this.createModalContainer(e,t);s.appendChild(n);(document.querySelector('.interface-container')||document.body).appendChild(s),setTimeout(()=>{s.classList.add('show')},10);const r=e=>{'Escape'===e.key&&(this.hideModal(),document.removeEventListener('keydown',r))};return document.addEventListener('keydown',r),a&&this.soundManager.playSound('click'),s}hideModal(){const e=document.querySelector('.modal-overlay');e&&(e.classList.remove('show'),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)),this.soundManager.playSound('click')}handleModalConfirm(e){e&&e(),this.hideModal()}handleModalCancel(e){e&&e(),this.hideModal()}createModalWithButtons(e,t,a,s=!0,n='ç¡®è®¤',r='å–æ¶ˆ'){const o=document.createElement('div');o.appendChild(e);const i=document.createElement('div');i.className='modal-buttons';const c=document.createElement('button');if(c.className='modal-btn cancel-btn',c.textContent=r,c.addEventListener('click',()=>{this.handleModalCancel(a)}),i.appendChild(c),s&&t){const e=document.createElement('button');e.className='modal-btn confirm-btn',e.textContent=n,e.addEventListener('click',()=>{this.handleModalConfirm(t)}),i.appendChild(e)}return o.appendChild(i),o}handleTransferClick(e,t){if('{{user}}'===e.sender||'user'===e.sender)return;const a=e.content.split('|')[0]||'0',s=e.data?.originalNote||'';this.showTransferModal(e.sender,a,s,s=>{const n=s?'å·²æ¥æ”¶':'å·²é€€å›';t&&(t.textContent=n,t.classList.remove('completed','failed'),t.classList.add(s?'completed':'failed')),e.content=`${a}|${n}`,this.sendTransferResponse(e.sender,a,s)})}showTransferModal(e,t,a,s){const n=document.createElement('div');n.className='modal-overlay';const r=document.createElement('div'),o=document.getElementById('transferModalTemplate');if(o){r.innerHTML=o.innerHTML,r.className='transfer-modal';const s=r.querySelector('.sender-name'),n=r.querySelector('.amount-value'),i=r.querySelector('.transfer-note');s&&(s.textContent=e),n&&(n.textContent=t),i&&(i.textContent=a||'è½¬è´¦')}n.appendChild(r),setTimeout(()=>{n.classList.add('show')},10);const i=document.querySelector('.interface-container');if(i)i.appendChild(n);else{const e=document.querySelector('.chat-container');e?e.appendChild(n):document.body.appendChild(n)}const c=r.querySelector('.accept-btn'),l=r.querySelector('.reject-btn'),d=()=>{n.parentNode&&n.parentNode.removeChild(n)};c.addEventListener('click',()=>{s(!0),d(),this.soundManager.playSound('click')}),l.addEventListener('click',()=>{s(!1),d(),this.soundManager.playSound('click')}),n.addEventListener('click',e=>{e.target===n&&d()})}sendTransferResponse(e,t,a){const s=`transfer_response_${e}_${t}`,n=a?'å·²æ¥æ”¶':'å·²é€€å›',r=this.chatData.get(this.currentChat),o='group'===r?.type||this.currentChat.startsWith('ç¾¤èŠ'),i={id:s,type:o?'G':'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'transfer',content:`${t}|${n}`,timestamp:(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})},c=this.sendQueue.findIndex(e=>e.id===s||e.content.includes(t)&&'{{user}}'===e.sender&&'transfer'===e.messageType);-1!==c?(this.sendQueue[c]=i,console.log('æ›¿æ¢è½¬è´¦å“åº”æ¶ˆæ¯:',i)):(this.sendQueue.push(i),console.log('æ·»åŠ è½¬è´¦å“åº”æ¶ˆæ¯:',i)),this.renderCurrentChat()}handleMessageEdit(e){e.isPending?this.showEditDialog(e):console.log('åªèƒ½ç¼–è¾‘å¾…å‘é€çš„æ¶ˆæ¯')}showEditDialog(e){const t=document.createElement('div');t.className='edit-modal-overlay';const a=document.createElement('div');a.className='edit-modal-dialog';const s=document.createElement('h3');s.textContent='ç¼–è¾‘æ¶ˆæ¯',s.className='edit-modal-title';const n=document.createElement('textarea');n.value=e.content,n.className='edit-modal-textarea';const r=document.createElement('div');r.className='edit-modal-buttons';const o=document.createElement('button');o.textContent='å–æ¶ˆ',o.className='edit-modal-cancel-btn';const i=document.createElement('button');i.textContent='ç¡®è®¤',i.className='edit-modal-confirm-btn';const c=()=>{t.parentNode&&t.parentNode.removeChild(t)};o.addEventListener('click',()=>{c(),this.soundManager.playSound('click')}),i.addEventListener('click',()=>{const t=n.value.trim();t&&t!==e.content&&(this.updateMessageInQueue(e.id,t),console.log(`æ¶ˆæ¯å·²æ›´æ–°: ${e.content} -> ${t}`)),c(),this.soundManager.playSound('send')}),r.appendChild(o),r.appendChild(i),a.appendChild(s),a.appendChild(n),a.appendChild(r),t.appendChild(a);const l=document.querySelector('.interface-container');if(l)l.appendChild(t);else{const e=document.querySelector('.chat-interface');e?e.appendChild(t):document.body.appendChild(t)}n.focus(),n.select();t.addEventListener('click',e=>{e.target===t&&(t.parentNode&&t.parentNode.removeChild(t),this.soundManager.playSound('click'))})}updateMessageInQueue(e,t){const a=this.sendQueue.findIndex(t=>t.id===e);-1!==a&&(this.sendQueue[a].content=t,this.updateSingleMessage(e,this.sendQueue[a]),console.log(`é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å·²æ›´æ–°ï¼Œæ¶ˆæ¯ID: ${e}`))}updateSingleMessage(e,t){const a=document.querySelector(`[data-message-id="${e}"]`);if(!a)return void console.warn(`æ‰¾ä¸åˆ°æ¶ˆæ¯å…ƒç´ ï¼ŒID: ${e}`);const s=this.createMessageElement(t);a.parentNode?.replaceChild(s,a),console.log(`å•æ¡æ¶ˆæ¯å·²æ›´æ–°æ˜¾ç¤ºï¼ŒID: ${e}`)}addToSendQueue(e){const t=this.sendQueue.findIndex(t=>t.id===e.id);-1!==t?this.sendQueue[t]=e:this.sendQueue.push(e),console.log(`æ¶ˆæ¯å·²æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œå½“å‰å¾…å‘é€æ¶ˆæ¯: ${this.sendQueue.length}`)}removeFromSendQueue(e){const t=this.sendQueue.findIndex(t=>t.id===e);-1!==t&&(this.sendQueue.splice(t,1),console.log('æ¶ˆæ¯å·²ä»é˜Ÿåˆ—ç§»é™¤'))}getPendingMessagesForCurrentChat(){return this.sendQueue.filter(e=>e.chatId===this.currentChat)}generateMessageId(){return'msg_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}getCurrentTime(){const e=this.chatData.get(this.currentChat);if(e&&e.messages&&e.messages.length>0){const t=e.messages[e.messages.length-1];if(t.timestamp)try{const e=this.parseTimeString(t.timestamp);if(e)return e.setMinutes(e.getMinutes()+1),e.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}catch(e){console.warn('è§£ææœ€æ–°æ¶ˆæ¯æ—¶é—´å¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´:',e)}}return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}parseTimeString(e){try{const t=e.match(/^(\d{1,2}):(\d{2})$/);if(t){const e=parseInt(t[1],10),a=parseInt(t[2],10);if(e>=0&&e<=23&&a>=0&&a<=59){const t=new Date;return t.setHours(e,a,0,0),t}}return null}catch(t){return console.warn('è§£ææ—¶é—´å­—ç¬¦ä¸²å¤±è´¥:',e,t),null}}cleanupTempImages(){try{const e=Object.keys(localStorage).filter(e=>e.startsWith('temp_image_'));if(e.length>50){e.sort((e,t)=>(parseInt(e.split('_')[2])||0)-(parseInt(t.split('_')[2])||0));const t=e.slice(0,Math.floor(e.length/2));t.forEach(e=>{localStorage.removeItem(e)}),console.log(`æ¸…ç†äº† ${t.length} ä¸ªä¸´æ—¶å›¾ç‰‡æ•°æ®`)}}catch(e){console.warn('æ¸…ç†ä¸´æ—¶å›¾ç‰‡æ•°æ®å¤±è´¥:',e)}}createImageInputModal(){const e=document.getElementById('imageInputModalTemplate');if(e){const t=document.createElement('div');t.innerHTML=e.innerHTML;const a=t.firstElementChild;return this.setupImageUploadEvents(a),a}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <div class="image-upload-section">\n        <label class="modal-label">é€‰æ‹©å›¾ç‰‡ï¼š</label>\n        <div class="upload-options">\n          <div class="upload-row">\n            <button type="button" class="upload-btn local-upload-btn" id="localUploadBtn">\n              é€‰æ‹©æœ¬åœ°æ–‡ä»¶\n            </button>\n            <span class="upload-divider">æˆ–</span>\n          </div>\n          <div class="upload-row">\n            <input type="text" class="modal-input url-input" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥..." id="imageUrlInput" />\n          </div>\n        </div>\n        <div class="file-preview" id="filePreview" style="display: none;">\n          <img id="previewImage" alt="é¢„è§ˆå›¾ç‰‡" />\n          <div class="file-info">\n            <span id="fileName"></span>\n            <button type="button" class="remove-file-btn" id="removeFileBtn">âœ•</button>\n          </div>\n        </div>\n      </div>\n      \n      <label class="modal-label modal-label-spaced">å›¾ç‰‡æè¿°ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰..." id="imageDescInput" />\n      \n      <input type="file" id="fileInput" accept="image/*" style="display: none;" />\n    ',this.setupImageUploadEvents(t),t}setupImageUploadEvents(e){const t=e.querySelector('#localUploadBtn'),a=e.querySelector('#fileInput'),s=e.querySelector('#filePreview'),n=e.querySelector('#previewImage'),r=e.querySelector('#fileName'),o=e.querySelector('#removeFileBtn'),i=e.querySelector('#imageUrlInput');t&&a&&t.addEventListener('click',()=>{a.click()}),a&&a.addEventListener('change',e=>{const t=e.target,a=t.files?.[0];a&&this.handleFileSelection(a,s,n,r,i)}),o&&o.addEventListener('click',()=>{this.clearFileSelection(a,s,i)}),i&&i.addEventListener('input',()=>{i.value.trim()&&a&&this.clearFileSelection(a,s,null)})}handleFileSelection(e,t,a,s,n){if(!e.type.startsWith('image/'))return void this.showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶','error');if(e.size>5242880)return void this.showToast('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB','error');const r=new FileReader;r.onload=r=>{const o=r.target?.result;a&&s&&t&&(a.src=o,s.textContent=e.name,t.style.display='flex',n&&(n.value=''))},r.readAsDataURL(e)}clearFileSelection(e,t,a){e&&(e.value=''),t&&(t.style.display='none'),a&&(a.value='')}createVoiceInputModal(){const e=document.getElementById('voiceInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">è¯­éŸ³å†…å®¹ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¯·è¾“å…¥è¯­éŸ³å†…å®¹..." id="voiceContentInput" />\n      \n      <label class="modal-label modal-label-spaced">è¯­éŸ³æ—¶é•¿ï¼š</label>\n      <input type="number" class="modal-input" placeholder="è¯·è¾“å…¥æ—¶é•¿ï¼ˆç§’ï¼‰..." id="voiceDurationInput" min="1" max="300" />\n    ',t}createLocationInputModal(){const e=document.getElementById('locationInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">ä½ç½®æè¿°ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¯·è¾“å…¥ä½ç½®æè¿°..." id="locationDescInput" />\n    ',t}createTransferInputModal(){const e=document.getElementById('transferInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">è½¬è´¦é‡‘é¢ï¼š</label>\n      <input type="number" class="modal-input" placeholder="è¯·è¾“å…¥è½¬è´¦é‡‘é¢..." id="transferAmountInput" min="0.01" step="0.01" />\n      \n      <label class="modal-label modal-label-spaced">è½¬è´¦å¤‡æ³¨ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¯·è¾“å…¥è½¬è´¦å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." id="transferNoteInput" />\n    ',t}showImageInputModal(){const e=this.createImageInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('imageUrlInput'),t=document.getElementById('imageDescInput'),a=document.getElementById('fileInput'),s=document.getElementById('filePreview');if(e&&t&&a){const n=e.value.trim(),r=t.value.trim(),o=a.files&&a.files.length>0,i=s&&'none'!==s.style.display;if(!(n||o||i||r))return void this.showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ã€è¾“å…¥å›¾ç‰‡URLæˆ–å›¾ç‰‡æè¿°','warning');if(o&&a.files){const e=a.files[0];this.createImageMessageFromFile(e,r)}else if(i){const e=document.getElementById('previewImage');e&&e.src&&this.createImageMessage(e.src,r)}else this.createImageMessage(n,r);this.hideModal()}},()=>{this.hideModal()});this.showModal('å‘é€å›¾ç‰‡',t,!1)}showVoiceInputModal(){const e=this.createVoiceInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('voiceContentInput'),t=document.getElementById('voiceDurationInput');if(e&&t){const a=e.value.trim(),s=t.value.trim();if(!a)return void this.showToast('è¯·è¾“å…¥è¯­éŸ³å†…å®¹','warning');if(!s)return void this.showToast('è¯·è¾“å…¥è¯­éŸ³æ—¶é•¿','warning');const n=parseFloat(s);if(isNaN(n)||n<=0||n>300)return void this.showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿ï¼ˆ1-300ç§’ï¼‰','warning');this.createVoiceMessage(a,n),this.hideModal()}},()=>{this.hideModal()});this.showModal('å‘é€è¯­éŸ³',t,!1)}showLocationInputModal(){const e=this.createLocationInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('locationDescInput');if(e){const t=e.value.trim();if(!t)return void this.showToast('è¯·è¾“å…¥ä½ç½®æè¿°','warning');this.createLocationMessage(t),this.hideModal()}},()=>{this.hideModal()});this.showModal('åˆ†äº«ä½ç½®',t,!1)}showTransferInputModal(){const e=this.createTransferInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('transferAmountInput'),t=document.getElementById('transferNoteInput');if(e&&t){const a=e.value.trim(),s=t.value.trim();if(!a)return void this.showToast('è¯·è¾“å…¥è½¬è´¦é‡‘é¢','warning');const n=parseFloat(a);if(isNaN(n)||n<=0)return void this.showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢','warning');this.createTransferMessage(n,s),this.hideModal()}},()=>{this.hideModal()});this.showModal('å‘èµ·è½¬è´¦',t,!1)}createImageMessage(e,t){let a='';const s={};console.log('ğŸ” [DEBUG] createImageMessage è°ƒç”¨:',{url:e.substring(0,100)+(e.length>100?'...':''),description:t,isBase64:!!e&&e.startsWith('data:'),isHttpUrl:!!e&&(e.startsWith('http://')||e.startsWith('https://'))});const n=!!e&&(e.startsWith('http://')||e.startsWith('https://')),r=!!e&&e.startsWith('data:'),o=!(!e||!/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/.test(e));if(r)a=t||'',s.base64Image=e;else if(n)a=t||'',s.imageUrl=e;else if(e)if(o){const n=this.messageParser.processImageUrl(e);s.imageUrl=n,a=t||''}else a=t||e;else a=t||'';const i={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:a,timestamp:this.getCurrentTime(),isPending:!0,data:s};console.log('ğŸ” [DEBUG] åˆ›å»ºå›¾ç‰‡æ¶ˆæ¯:',{id:i.id,content:i.content,hasBase64Image:!!i.data?.base64Image,hasUploadedFile:!!i.data?.uploadedFile,hasImageUrl:!!i.data?.imageUrl}),(r||n)&&this.cacheUiImagePreview(i,e),this.addToSendQueue(i),this.addNewMessageToInterface(i)}createImageMessageFromFile(e,t){if(e.size>5242880)return void this.showToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡','error');const a=new FileReader;a.onload=a=>{const s=a.target?.result,n=`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;this.cleanupTempImages();try{localStorage.setItem(`temp_image_${n}`,s)}catch(a){console.warn('æ— æ³•å­˜å‚¨å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç›´æ¥ä½¿ç”¨Fileå¯¹è±¡:',a);const n={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:t||'',timestamp:this.getCurrentTime(),isPending:!0,data:{uploadedFile:e}};return console.log('ğŸ” [DEBUG] åˆ›å»ºå›¾ç‰‡æ¶ˆæ¯ï¼ˆlocalStorageå¤±è´¥ï¼‰:',{id:n.id,content:n.content,hasUploadedFile:!!n.data?.uploadedFile,uploadedFileName:n.data?.uploadedFile?.name}),this.cacheUiImagePreview(n,s),this.addToSendQueue(n),void this.addNewMessageToInterface(n)}const r=t||'',o={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:r,timestamp:this.getCurrentTime(),isPending:!0,data:{uploadedFile:e,tempFileId:n}};console.log('ğŸ” [DEBUG] åˆ›å»ºå›¾ç‰‡æ¶ˆæ¯:',{id:o.id,content:o.content,hasUploadedFile:!!o.data?.uploadedFile,uploadedFileName:o.data?.uploadedFile?.name,tempFileId:o.data?.tempFileId}),this.cacheUiImagePreview(o,s),this.addToSendQueue(o),this.addNewMessageToInterface(o)},a.onerror=()=>{this.showToast('è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥','error')},a.readAsDataURL(e)}createVoiceMessage(e,t){const a=`${e}|${t}`,s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'voice',content:a,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(s),this.addNewMessageToInterface(s)}createLocationMessage(e){const t={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'location',content:e,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(t),this.addNewMessageToInterface(t)}createTransferMessage(e,t){const a=t?`${e}|${t}`:`${e}|`,s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'transfer',content:a,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(s),this.addNewMessageToInterface(s)}async initializeGroupNameOverrideManager(){try{console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ç¾¤åè¦†ç›–ç®¡ç†å™¨...'),N.initialize(),console.log('âœ… ç¾¤åè¦†ç›–ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');const e=N.getDebugInfo();console.log('ğŸ”§ ç¾¤åè¦†ç›–ç®¡ç†å™¨è°ƒè¯•ä¿¡æ¯:',e)}catch(e){console.error('âŒ ç¾¤åè¦†ç›–ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',e)}}async initializeStickerSystem(){try{const e=await this.getCurrentLorebook();if(!e)return void this.showToast('è°ƒç”¨ä¸–ç•Œä¹¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸–ç•Œä¹¦ç»‘å®š','warning');this.stickerLorebookName=e,console.log(`ğŸ¯ ç¡®å®šä½¿ç”¨ä¸–ç•Œä¹¦: ${e}`),this.loadStickerOrder(),await this.loadStickersFromLorebook(),console.log(`âœ… è¡¨æƒ…åŒ…ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨ä¸–ç•Œä¹¦: ${e}ï¼ŒåŠ è½½äº† ${this.stickerData.length} ä¸ªè¡¨æƒ…åŒ…`)}catch(e){console.error('âŒ åˆå§‹åŒ–è¡¨æƒ…åŒ…ç³»ç»Ÿå¤±è´¥:',e),this.showToast('è°ƒç”¨ä¸–ç•Œä¹¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸–ç•Œä¹¦ç»‘å®š','error')}}async loadStickersFromLorebook(){try{if(console.log('ğŸ¯ å¼€å§‹ä»ä¸–ç•Œä¹¦åŠ è½½è¡¨æƒ…åŒ…æ•°æ®...'),'function'!=typeof window.getLorebookEntries)return console.log('âŒ å…¨å±€getLorebookEntrieså‡½æ•°ä¸å­˜åœ¨ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½...'),void await this.loadStickersFromLocalStorage();let e=null,t='';const a=await this.getCharacterLorebook();if(a){console.log(`ğŸ“– å°è¯•ä»è§’è‰²ä¸–ç•Œä¹¦æœç´¢è¡¨æƒ…åŒ…: ${a}`);try{e=(await window.getLorebookEntries(a)).find(e=>'è¡¨æƒ…åŒ…'===e.comment||e.comment.includes('è¡¨æƒ…åŒ…')),e?(t=`è§’è‰²ä¸–ç•Œä¹¦: ${a}`,console.log('âœ… åœ¨è§’è‰²ä¸–ç•Œä¹¦ä¸­æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®')):console.log('âŒ è§’è‰²ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®')}catch(e){console.warn('âš ï¸ è®¿é—®è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e)}}if(!e){const a=await this.getGlobalLorebooks();for(const s of a){console.log(`ğŸŒ å°è¯•ä»å…¨å±€ä¸–ç•Œä¹¦æœç´¢è¡¨æƒ…åŒ…: ${s}`);try{if(e=(await window.getLorebookEntries(s)).find(e=>'è¡¨æƒ…åŒ…'===e.comment||e.comment.includes('è¡¨æƒ…åŒ…')),e){t=`å…¨å±€ä¸–ç•Œä¹¦: ${s}`,console.log('âœ… åœ¨å…¨å±€ä¸–ç•Œä¹¦ä¸­æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®');break}console.log(`âŒ å…¨å±€ä¸–ç•Œä¹¦ ${s} ä¸­æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®`)}catch(e){console.warn(`âš ï¸ è®¿é—®å…¨å±€ä¸–ç•Œä¹¦ ${s} å¤±è´¥:`,e)}}}e?(console.log(`ğŸ‰ æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œæ¥æº: ${t}`),await this.parseStickerEntry(e)):(console.log('âŒ åœ¨æ‰€æœ‰ä¸–ç•Œä¹¦ä¸­éƒ½æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œä½¿ç”¨ç©ºæ•°æ®'),this.stickerData=[],this.stickerCache.clear()),this.sortStickersByOrder(),console.log(`âœ… è¡¨æƒ…åŒ…æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${this.stickerData.length} ä¸ªè¡¨æƒ…åŒ…`)}catch(e){console.error('âŒ ä»ä¸–ç•Œä¹¦åŠ è½½è¡¨æƒ…åŒ…å¤±è´¥:',e),await this.loadStickersFromLocalStorage()}}async getCharacterLorebook(){try{if('function'==typeof getCurrentCharPrimaryLorebook)return getCurrentCharPrimaryLorebook();console.warn('getCurrentCharPrimaryLorebook å‡½æ•°ä¸å¯ç”¨')}catch(e){console.warn('è·å–è§’è‰²ä¸–ç•Œä¹¦å¤±è´¥:',e)}return null}async getGlobalLorebooks(){try{if('function'==typeof getLorebookSettings){return getLorebookSettings().selected_global_lorebooks||[]}return console.warn('getLorebookSettings å‡½æ•°ä¸å¯ç”¨'),[]}catch(e){console.warn('è·å–å…¨å±€ä¸–ç•Œä¹¦è®¾ç½®å¤±è´¥:',e)}return[]}async parseStickerEntry(e){this.stickerData=[],this.stickerCache.clear();const t=(e.content||'').split('\n').filter(e=>{const t=e.trim();return t&&!t.startsWith('<')});for(let e=0;e<t.length;e++){const a=t[e].trim();if(a){const t=this.parseStickerLine(a,e+1);t&&(this.stickerData.push(t),this.stickerCache.set(t.uid,t))}}console.log(`ğŸ“¦ ä»ä¸–ç•Œä¹¦æ¡ç›®è§£æäº† ${this.stickerData.length} ä¸ªè¡¨æƒ…åŒ…`)}async loadStickersFromLocalStorage(){try{const e=localStorage.getItem('bear_stickers');if(e){this.stickerData=JSON.parse(e),console.log(`ğŸ’¾ ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº† ${this.stickerData.length} ä¸ªè¡¨æƒ…åŒ…`),this.stickerCache.clear();for(const e of this.stickerData)this.stickerCache.set(e.uid,e);this.sortStickersByOrder()}else console.log('ğŸ’¾ æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰è¡¨æƒ…åŒ…æ•°æ®'),this.stickerData=[],this.stickerCache.clear()}catch(e){console.error('âŒ ä»æœ¬åœ°å­˜å‚¨åŠ è½½è¡¨æƒ…åŒ…å¤±è´¥:',e),this.stickerData=[],this.stickerCache.clear()}}parseStickerLine(e,t){try{const a=e.trim();if(!a)return null;if(a.startsWith('<'))return console.log(`è·³è¿‡æ ‡ç­¾å†…å®¹: "${a}"`),null;let s='',n='';const r=a.match(/^(.+?)([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(r&&r[1].trim()&&r[2]){s=r[1].trim();const e=r[2];n=this.messageParser.processImageUrl(e)}else n=this.messageParser.processImageUrl(a),s=`è¡¨æƒ…åŒ…${t}`;return console.log(`è§£æè¡¨æƒ…åŒ…: "${a}" -> å¤‡æ³¨: "${s}", URL: "${n}"`),{uid:t,url:n,note:s,rawContent:a}}catch(t){return console.error('è§£æè¡¨æƒ…åŒ…è¡Œå¤±è´¥:',t,e),null}}parseStickerFromEntry(e){try{const t=e.content?.trim();if(!t)return null;let a=e.comment?.trim()||'',s='';if(s=this.messageParser.processImageUrl(t),!a){const e=t.match(/^(.+?)([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);e&&e[1].trim()&&(a=e[1].trim())}return a||(a='è¡¨æƒ…åŒ…'),{uid:e.uid,url:s,note:a,rawContent:t}}catch(t){return console.error('è§£æè¡¨æƒ…åŒ…æ¡ç›®å¤±è´¥:',t,e),null}}sortStickersByOrder(){this.stickerData.sort((e,t)=>(this.stickerOrder[e.uid]||999999)-(this.stickerOrder[t.uid]||999999))}loadStickerOrder(){try{const e=localStorage.getItem('sticker_order');e&&(this.stickerOrder=JSON.parse(e))}catch(e){console.error('åŠ è½½è¡¨æƒ…åŒ…æ’åºå¤±è´¥:',e),this.stickerOrder={}}}saveStickerOrder(){try{localStorage.setItem('sticker_order',JSON.stringify(this.stickerOrder))}catch(e){console.error('ä¿å­˜è¡¨æƒ…åŒ…æ’åºå¤±è´¥:',e)}}async addStickerToLorebook(e,t){try{if(console.log('å°è¯•æ·»åŠ è¡¨æƒ…åŒ…åˆ°ä¸–ç•Œä¹¦:',e,t),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('ä½¿ç”¨å…¨å±€å‡½æ•°æ“ä½œä¸–ç•Œä¹¦');const t=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'è¡¨æƒ…åŒ…'===e.comment||e.comment.includes('è¡¨æƒ…åŒ…'));if(t){console.log('æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œå‡†å¤‡æ›´æ–°');const a=t.content||'';let s;s=a.includes('<bqb>')&&a.includes('</bqb>')?a.replace('</bqb>',`${e.trim()}\n</bqb>`):a.trim()?`${a}\n${e.trim()}`:`<bqb>\n${e.trim()}\n</bqb>`;const n={...t,content:s};return await window.setLorebookEntries(this.stickerLorebookName,[n]),await this.loadStickersFromLorebook(),console.log('æˆåŠŸæ·»åŠ è¡¨æƒ…åŒ…åˆ°ä¸–ç•Œä¹¦'),!0}return console.log('æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œæ— æ³•æ·»åŠ '),!1}{console.log('ä¸–ç•Œä¹¦APIä¸å¯ç”¨ï¼Œæ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜');const a={uid:Date.now(),comment:t||'',content:e.trim(),enabled:!0,url:'',note:'',rawContent:e.trim()};return this.stickerData.push(a),this.stickerCache.set(a.uid,a),localStorage.setItem('bear_stickers',JSON.stringify(this.stickerData)),console.log('æˆåŠŸæ·»åŠ è¡¨æƒ…åŒ…åˆ°æœ¬åœ°ç¼“å­˜'),!0}}catch(a){console.error('æ·»åŠ è¡¨æƒ…åŒ…å¤±è´¥:',a);try{const a={uid:Date.now(),comment:t||'',content:e.trim(),enabled:!0,url:'',note:'',rawContent:e.trim()};return this.stickerData.push(a),this.stickerCache.set(a.uid,a),localStorage.setItem('bear_stickers',JSON.stringify(this.stickerData)),console.log('å¤‡ç”¨æ–¹æ¡ˆï¼šæˆåŠŸæ·»åŠ è¡¨æƒ…åŒ…åˆ°æœ¬åœ°ç¼“å­˜'),!0}catch(e){return console.error('å¤‡ç”¨æ·»åŠ ä¹Ÿå¤±è´¥:',e),!1}}}async removeStickerFromLorebook(e){try{if(console.log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤è¡¨æƒ…åŒ…ï¼Œuid: ${e}`),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('ä½¿ç”¨å…¨å±€å‡½æ•°æ“ä½œä¸–ç•Œä¹¦');const t=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'è¡¨æƒ…åŒ…'===e.comment||e.comment.includes('è¡¨æƒ…åŒ…'));if(t){console.log('âœ… æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œå‡†å¤‡åˆ é™¤æŒ‡å®šè¡Œ');const a=(t.content||'').split('\n'),s=a.filter(e=>{const t=e.trim();return t&&!t.startsWith('<')});if(console.log(`ğŸ“ å½“å‰è¡¨æƒ…åŒ…æ¡ç›®æ€»è¡Œæ•°: ${a.length}ï¼Œå¯è§£æè¡Œæ•°: ${s.length}`),console.log(`ğŸ¯ è¦åˆ é™¤ç¬¬ ${e} ä¸ªå¯è§£æè¡Œ`),e<=0||e>s.length)return console.error(`âŒ æ— æ•ˆçš„è¡Œå·: ${e}ï¼Œå¯è§£æè¡Œæ•°: ${s.length}`),!1;const n=s[e-1];console.log(`ğŸ¯ ç›®æ ‡è¡Œå†…å®¹: "${n}"`);const r=a.findIndex(e=>e.trim()===n.trim());if(-1===r)return console.error(`âŒ åœ¨åŸå§‹å†…å®¹ä¸­æœªæ‰¾åˆ°ç›®æ ‡è¡Œ: "${n}"`),!1;a.splice(r,1),console.log(`âœ… æˆåŠŸåˆ é™¤ç›®æ ‡è¡Œï¼Œå‰©ä½™æ€»è¡Œæ•°: ${a.length}`);const o=a.join('\n'),i={uid:t.uid,content:o};return await window.setLorebookEntries(this.stickerLorebookName,[i]),await this.loadStickersFromLorebook(),console.log('âœ… æˆåŠŸä»ä¸–ç•Œä¹¦åˆ é™¤è¡¨æƒ…åŒ…'),!0}return console.error('âŒ æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®'),!1}return console.error('âŒ ä¸–ç•Œä¹¦å…¨å±€å‡½æ•°ä¸å¯ç”¨'),!1}catch(e){return console.error('âŒ ä»ä¸–ç•Œä¹¦åˆ é™¤è¡¨æƒ…åŒ…å¤±è´¥:',e),!1}}showStickerEditModal(e){const t=this.stickerCache.get(e);if(!t)return void this.showToast('è¡¨æƒ…åŒ…ä¸å­˜åœ¨','error');const a=document.createElement('div');a.className='modal-overlay';const s=document.createElement('div');s.className='modal-container';const n=document.getElementById('editStickerModalTemplate');if(n){s.innerHTML=n.innerHTML;const e=s.querySelector('#editStickerUrl'),a=s.querySelector('#editStickerNote');e&&(e.value=t.url),a&&(a.value=t.note)}a.appendChild(s);const r=document.querySelector('.interface-container');if(r)r.appendChild(a);else{const e=document.querySelector('.chat-container');e?e.appendChild(a):document.body.appendChild(a)}setTimeout(()=>a.classList.add('show'),10);const o=s.querySelector('#editStickerUrl'),i=s.querySelector('#editStickerNote'),c=s.querySelector('.cancel-btn'),l=s.querySelector('.confirm-btn');c.addEventListener('click',()=>{this.hideModal()}),l.addEventListener('click',async()=>{const t=o.value.trim(),a=i.value.trim();if(t)try{if(await this.updateStickerInLorebook(e,t,a)){this.showToast('è¡¨æƒ…åŒ…æ›´æ–°æˆåŠŸ','success'),this.hideModal();const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e)}else this.showToast('è¡¨æƒ…åŒ…æ›´æ–°å¤±è´¥','error')}catch(e){console.error('æ›´æ–°è¡¨æƒ…åŒ…å¤±è´¥:',e),this.showToast('è¡¨æƒ…åŒ…æ›´æ–°å¤±è´¥','error')}else this.showToast('è¯·è¾“å…¥è¡¨æƒ…åŒ…URL','warning')}),a.addEventListener('click',e=>{e.target===a&&this.hideModal()})}async updateStickerInLorebook(e,t,a){try{if(console.log(`ğŸ”„ å¼€å§‹æ›´æ–°è¡¨æƒ…åŒ…ï¼Œuid: ${e}`),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('âœ… ä½¿ç”¨å…¨å±€å‡½æ•°æ›´æ–°è¡¨æƒ…åŒ…');const s=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'è¡¨æƒ…åŒ…'===e.comment||e.comment.includes('è¡¨æƒ…åŒ…'));if(s){console.log('âœ… æ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®ï¼Œå‡†å¤‡æ›´æ–°æŒ‡å®šè¡Œ');const n=(s.content||'').split('\n'),r=n.filter(e=>{const t=e.trim();return t&&!t.startsWith('<')});if(console.log(`ğŸ“ å½“å‰è¡¨æƒ…åŒ…æ¡ç›®æ€»è¡Œæ•°: ${n.length}ï¼Œå¯è§£æè¡Œæ•°: ${r.length}`),console.log(`ğŸ¯ è¦æ›´æ–°ç¬¬ ${e} ä¸ªå¯è§£æè¡Œ`),e<=0||e>r.length)return console.error(`âŒ æ— æ•ˆçš„è¡Œå·: ${e}ï¼Œå¯è§£æè¡Œæ•°: ${r.length}`),!1;const o=r[e-1];console.log(`ğŸ¯ åŸå§‹è¡Œå†…å®¹: "${o}"`);const i=a?`${a}${t}`:t;console.log(`ğŸ¯ æ–°è¡Œå†…å®¹: "${i}"`);const c=n.findIndex(e=>e.trim()===o.trim());if(-1===c)return console.error(`âŒ åœ¨åŸå§‹å†…å®¹ä¸­æœªæ‰¾åˆ°ç›®æ ‡è¡Œ: "${o}"`),!1;n[c]=i,console.log('âœ… æˆåŠŸæ›´æ–°ç›®æ ‡è¡Œ');const l=n.join('\n'),d={uid:s.uid,content:l};return await window.setLorebookEntries(this.stickerLorebookName,[d]),await this.loadStickersFromLorebook(),console.log('âœ… æˆåŠŸæ›´æ–°ä¸–ç•Œä¹¦ä¸­çš„è¡¨æƒ…åŒ…'),!0}return console.error('âŒ æœªæ‰¾åˆ°è¡¨æƒ…åŒ…æ¡ç›®'),!1}return console.error('âŒ ä¸–ç•Œä¹¦å…¨å±€å‡½æ•°ä¸å¯ç”¨'),!1}catch(e){return console.error('âŒ æ›´æ–°ä¸–ç•Œä¹¦ä¸­çš„è¡¨æƒ…åŒ…å¤±è´¥:',e),!1}}updateStickerOrder(e){e.forEach((e,t)=>{this.stickerOrder[e]=t}),this.saveStickerOrder(),this.sortStickersByOrder()}showStickerSelector(){if(this.isStickerSelectorVisible)return;this.hidePlusMenu();const e=document.getElementById('stickerSelector');e&&(this.renderStickerGrid(e),e.classList.add('active'),this.isStickerSelectorVisible=!0,requestAnimationFrame(()=>{e.classList.add('show')}),setTimeout(()=>{this.setupStickerSelectorClickOutside()},100))}hideStickerSelector(){if(!this.isStickerSelectorVisible)return;const e=document.getElementById('stickerSelector');e&&(this.isDeleteMode=!1,this.selectedStickers.clear(),e.classList.remove('active','show'),this.isStickerSelectorVisible=!1,this.removeStickerSelectorClickOutside())}setupStickerSelectorClickOutside(){this.removeStickerSelectorClickOutside(),this.stickerSelectorClickOutsideHandler=e=>{const t=e.target,a=document.getElementById('stickerSelector'),s=document.getElementById('plusBtn'),n=document.getElementById('plusMenu'),r=document.querySelector('[data-type="sticker"]');!a||a.contains(t)||s?.contains(t)||n?.contains(t)||r?.contains(t)||this.hideStickerSelector()},setTimeout(()=>{this.stickerSelectorClickOutsideHandler&&document.addEventListener('click',this.stickerSelectorClickOutsideHandler)},300)}removeStickerSelectorClickOutside(){this.stickerSelectorClickOutsideHandler&&(document.removeEventListener('click',this.stickerSelectorClickOutsideHandler),this.stickerSelectorClickOutsideHandler=null)}renderStickerGrid(e){const t=e.querySelector('#stickerGrid');if(!t)return;t.innerHTML='';const a=this.createAddStickerButton();t.appendChild(a);const s=this.createDeleteModeButton();if(t.appendChild(s),this.isDeleteMode){const e=this.createDeleteConfirmButton();t.appendChild(e)}if(0===this.stickerData.length){const e=document.createElement('div');e.className='empty-state',e.style.gridColumn='span 2';const a=document.getElementById('stickerEmptyStateTemplate');return a&&(e.innerHTML=a.innerHTML),void t.appendChild(e)}this.stickerData.forEach((e,a)=>{const s=this.createStickerItem(e,a);t.appendChild(s)})}createStickerItem(e,t){const a=document.createElement('div');a.className='sticker-item',a.dataset.uid=e.uid.toString(),a.dataset.index=t.toString(),this.isDeleteMode&&a.classList.add('delete-mode'),this.selectedStickers.has(e.uid)&&a.classList.add('selected');const s=document.createElement('div');s.className='sticker-image';const n=document.createElement('img');n.src=e.url,n.alt=e.note,n.title=e.note;const r=document.createElement('div');r.className='sticker-note',r.textContent=e.note||'è¡¨æƒ…åŒ…';const o=document.createElement('div');return o.className='delete-checkbox',this.selectedStickers.has(e.uid)&&o.classList.add('checked'),a.addEventListener('click',t=>{t.stopPropagation(),this.isDeleteMode?this.toggleStickerSelection(e.uid):this.handleStickerSelection(e)}),this.isDeleteMode||this.addStickerEditEvents(a),s.appendChild(n),a.appendChild(s),a.appendChild(r),a.appendChild(o),a}createAddStickerButton(){const e=document.createElement('button');return e.className='add-sticker-btn',e.id='addStickerBtn',e.innerHTML='<span class="add-icon">+</span>',e.title='æ·»åŠ è¡¨æƒ…åŒ…',e.addEventListener('click',e=>{e.stopPropagation(),this.hideStickerSelector(),this.showAddStickerModal()}),e}createDeleteModeButton(){const e=document.createElement('button');e.className='delete-mode-btn',e.id='deleteModeBtn',this.isDeleteMode&&e.classList.add('active');const t=document.getElementById('deleteModeButtonTemplate');if(t){e.innerHTML=t.innerHTML;const a=e.querySelector('.delete-text');a&&(a.textContent=this.isDeleteMode?'å–æ¶ˆ':'åˆ é™¤')}return e.title=this.isDeleteMode?'å–æ¶ˆåˆ é™¤æ¨¡å¼':'è¿›å…¥åˆ é™¤æ¨¡å¼',e.addEventListener('click',e=>{e.stopPropagation(),this.toggleDeleteMode()}),e}createDeleteConfirmButton(){const e=document.createElement('button');e.className='delete-confirm-btn show';const t=this.selectedStickers.size>0;t||e.classList.add('disabled');const a=document.getElementById('confirmDeleteButtonTemplate');return a&&(e.innerHTML=a.innerHTML),e.title=t?`åˆ é™¤é€‰ä¸­çš„ ${this.selectedStickers.size} ä¸ªè¡¨æƒ…åŒ…`:'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…åŒ…',e.addEventListener('click',e=>{e.stopPropagation(),this.selectedStickers.size>0?this.handleDeleteSelectedStickers():this.showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…åŒ…','warning')}),e}toggleDeleteMode(){this.isDeleteMode=!this.isDeleteMode,this.isDeleteMode||this.selectedStickers.clear();const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e),this.soundManager.playSound('click')}toggleStickerSelection(e){this.selectedStickers.has(e)?this.selectedStickers.delete(e):this.selectedStickers.add(e),this.updateDeleteConfirmButton();const t=document.getElementById('stickerSelector');t&&this.renderStickerGrid(t),this.soundManager.playSound('click')}updateDeleteConfirmButton(){const e=document.querySelector('.delete-confirm-btn');if(!e)return;this.selectedStickers.size>0?(e.classList.remove('disabled'),e.title=`åˆ é™¤é€‰ä¸­çš„ ${this.selectedStickers.size} ä¸ªè¡¨æƒ…åŒ…`):(e.classList.add('disabled'),e.title='è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…åŒ…')}async handleDeleteSelectedStickers(){if(0===this.selectedStickers.size)return;if(confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedStickers.size} ä¸ªè¡¨æƒ…åŒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`))try{const e=Array.from(this.selectedStickers).map(e=>this.removeStickerFromLorebook(e)),t=(await Promise.all(e)).filter(e=>e).length;t===this.selectedStickers.size?this.showToast(`æˆåŠŸåˆ é™¤ ${t} ä¸ªè¡¨æƒ…åŒ…`,'success'):t>0?this.showToast(`åˆ é™¤äº† ${t}/${this.selectedStickers.size} ä¸ªè¡¨æƒ…åŒ…`,'warning'):this.showToast('è¡¨æƒ…åŒ…åˆ é™¤å¤±è´¥','error'),this.selectedStickers.clear(),this.isDeleteMode=!1;const a=document.getElementById('stickerSelector');a&&this.renderStickerGrid(a)}catch(e){console.error('åˆ é™¤é€‰ä¸­è¡¨æƒ…åŒ…å¤±è´¥:',e),this.showToast('åˆ é™¤è¡¨æƒ…åŒ…æ—¶å‘ç”Ÿé”™è¯¯','error')}}showAddStickerModal(){const e=this.createAddStickerModal(),t=this.createModalWithButtons(e,()=>{this.handleAddStickerConfirm()},()=>{this.hideModal(),setTimeout(()=>this.showStickerSelector(),100)});this.showModal('æ·»åŠ è¡¨æƒ…åŒ…',t)}createAddStickerModal(){const e=document.getElementById('addStickerModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">è¡¨æƒ…åŒ…å†…å®¹ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¾“å…¥URLã€æ–‡ä»¶åæˆ–å¤‡æ³¨+æ–‡ä»¶å..." id="stickerContentInput" />\n      \n      <label class="modal-label modal-label-spaced">è¡¨æƒ…åŒ…å¤‡æ³¨ï¼š</label>\n      <input type="text" class="modal-input" placeholder="è¾“å…¥è¡¨æƒ…åŒ…å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." id="stickerNoteInput" />\n      \n      <div class="input-help">\n        <p>æ”¯æŒæ ¼å¼ï¼š</p>\n        <ul>\n          <li>å®Œæ•´URLï¼šhttps://example.com/image.jpg</li>\n          <li>æ–‡ä»¶åï¼šei6coi.jpeg</li>\n          <li>å¤‡æ³¨+æ–‡ä»¶åï¼šæˆ‘æ˜¯è´¥çŠ¬ei6coi.jpeg</li>\n        </ul>\n      </div>\n    ',t}async handleAddStickerConfirm(){const e=document.getElementById('stickerContentInput'),t=document.getElementById('stickerNoteInput');if(!e||!t)return;const a=e.value.trim(),s=t.value.trim();if(a)try{await this.addStickerToLorebook(a,s)?(this.showToast('è¡¨æƒ…åŒ…æ·»åŠ æˆåŠŸ','success'),this.hideModal(),setTimeout(()=>this.showStickerSelector(),100)):this.showToast('è¡¨æƒ…åŒ…æ·»åŠ å¤±è´¥','error')}catch(e){console.error('æ·»åŠ è¡¨æƒ…åŒ…å¤±è´¥:',e),this.showToast('è¡¨æƒ…åŒ…æ·»åŠ å¤±è´¥','error')}else this.showToast('è¯·è¾“å…¥è¡¨æƒ…åŒ…å†…å®¹','warning')}handleStickerSelection(e){this.createStickerMessage(e),this.hideStickerSelector(),this.soundManager.playSound('emoji')}async handleStickerDelete(e){try{if(await this.removeStickerFromLorebook(e)){this.showToast('è¡¨æƒ…åŒ…åˆ é™¤æˆåŠŸ','success');const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e)}else this.showToast('è¡¨æƒ…åŒ…åˆ é™¤å¤±è´¥','error')}catch(e){console.error('åˆ é™¤è¡¨æƒ…åŒ…å¤±è´¥:',e),this.showToast('è¡¨æƒ…åŒ…åˆ é™¤å¤±è´¥','error')}}createStickerMessage(e){const t=this.extractFileNameFromUrl(e.url),a=e.note+t;console.log(`ğŸ“ è¡¨æƒ…åŒ…å‘é€æ ¼å¼: ${a} (åŸURL: ${e.url})`);const s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'sticker',content:a,timestamp:this.getCurrentTime(),isPending:!0,data:{stickerUrl:e.url,stickerNote:e.note,stickerFileName:t}};this.addToSendQueue(s),this.addNewMessageToInterface(s)}extractFileNameFromUrl(e){try{const t=e.split('/'),a=t[t.length-1].split('?')[0];return console.log(`ğŸ” ä»URLæå–æ–‡ä»¶å: ${e} -> ${a}`),a}catch(e){console.warn('æå–æ–‡ä»¶åå¤±è´¥:',e);return`${Math.random().toString(36).substr(2,6)}.jpg`}}addStickerEditEvents(e){let t,a=!1,s=0,n=0;const r=e=>e instanceof TouchEvent&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e instanceof MouseEvent?{x:e.clientX,y:e.clientY}:{x:0,y:0},o=e=>{const t=r(e);Math.sqrt(Math.pow(t.x-s,2)+Math.pow(t.y-n,2))>10&&c()},i=o=>{const i=r(o);s=i.x,n=i.y,t=setTimeout(()=>{a=!0;const t=parseInt(e.dataset.uid||'0');this.showStickerEditModal(t)},500)},c=()=>{t&&clearTimeout(t),a=!1};e.addEventListener('mousedown',i),e.addEventListener('touchstart',i,{passive:!0}),e.addEventListener('mousemove',o),e.addEventListener('touchmove',o,{passive:!0}),e.addEventListener('mouseup',c),e.addEventListener('mouseleave',c),e.addEventListener('touchend',c),e.addEventListener('touchcancel',c),e.addEventListener('click',e=>{a&&(e.preventDefault(),e.stopPropagation(),a=!1)})}handleInputChange(e){if(!this.settingsModal||!this.settingsModal.getCurrentSettings().emojiSuggestionsEnabled)return void this.hideStickerSuggestionsImmediately();const t=e.target.value.trim();this.inputChangeTimer&&clearTimeout(this.inputChangeTimer),t?this.inputChangeTimer=setTimeout(()=>{this.searchAndShowSuggestions(t)},300):this.hideStickerSuggestionsImmediately()}searchAndShowSuggestions(e){const t=this.findMatchingStickers(e);t.length>0?this.showStickerSuggestions(t):this.hideStickerSuggestionsImmediately()}findMatchingStickers(e){if(!e||0===this.stickerData.length)return[];const t=e.toLowerCase(),a=[];for(const e of this.stickerData){const s=e.note.toLowerCase();let n=0;s===t?n=100:s.startsWith(t)?n=80:s.includes(t)?n=60:this.fuzzyMatch(s,t)?n=40:this.pinyinMatch(s,t)&&(n=30),n>0&&a.push({sticker:e,score:n})}return a.sort((e,t)=>t.score-e.score).slice(0,6).map(e=>e.sticker)}fuzzyMatch(e,t){let a=0,s=0;for(;a<e.length&&s<t.length;)e[a]===t[s]&&s++,a++;return s===t.length}pinyinMatch(e,t){const a={a:['å•Š','é˜¿'],b:['ä¸','ç™½','è¢«','æœ¬','æ¯”','åˆ«','æŠŠ'],c:['å‡º','ä»','æ‰','æˆ','é•¿','å¸¸','åƒ'],d:['çš„','åˆ°','éƒ½','å¤§','å¯¹','ä½†','å¾—','æ‰“'],e:['é¢','æ¶'],f:['å‘','æ”¾','é','åˆ†','é£','æœ'],g:['ä¸ª','ç»™','è¿‡','å›½','å…¬','é«˜','æ„Ÿ'],h:['å’Œ','å¾ˆ','å¥½','è¿˜','ä¼š','å','é»‘','çº¢'],j:['å°±','è¿›','è§','å«','å®¶','ä»Š','å‡ '],k:['å¯','çœ‹','å¼€','å¿«','å“­'],l:['äº†','æ¥','é‡Œ','è€','ä¸¤','è·¯','ç»¿'],m:['æ²¡','ä¹ˆ','ä»¬','é¢','ç¾','çŒ«'],n:['ä½ ','é‚£','èƒ½','å¹´','å¥³'],p:['è·‘','æ€•','æœ‹'],q:['å»','å‰','èµ·','è¯·'],r:['äºº','è®©','å¦‚','ç„¶'],s:['æ˜¯','è¯´','æ‰€','ä¸‰','ä¸Š','æ—¶','ç”Ÿ'],t:['ä»–','å¥¹','å®ƒ','å¤ª','å¤©','å¬','å¤´'],w:['æˆ‘','ä¸º','é—®','ç‹','äº”','ä¸‡'],x:['æƒ³','å°','å¿ƒ','æ–°','ç¬‘','ä¸‹'],y:['ä¸€','æœ‰','è¦','ä¹Ÿ','ç”¨','åˆ','çœ¼'],z:['åœ¨','è¿™','ä¸­','è‡ª','èµ°','æœ€','åš']};for(const s of t)if(a[s])for(const t of a[s])if(e.includes(t))return!0;return!1}showStickerSuggestions(e){if(!document.getElementById('inputField'))return;this.suggestionContainer&&this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=document.createElement('div'),this.suggestionContainer.className='sticker-suggestions',this.suggestionContainer.innerHTML=`\n      <div class="suggestions-header">\n        <span class="suggestions-title">è¡¨æƒ…åŒ…å»ºè®®</span>\n        <span class="suggestions-count">${e.length}</span>\n      </div>\n      <div class="suggestions-grid"></div>\n    `;const t=document.querySelector('.chat-input');if(!t)return;t.appendChild(this.suggestionContainer);const a=this.suggestionContainer.querySelector('.suggestions-grid');e.forEach(e=>{const t=document.createElement('div');t.className='suggestion-item',t.title=e.note||'è¡¨æƒ…åŒ…';const s=document.createElement('img');s.src=e.url,s.alt=e.note||'è¡¨æƒ…åŒ…',s.onerror=()=>{t.style.display='none'},t.appendChild(s),a.appendChild(t),t.addEventListener('click',t=>{t.preventDefault(),t.stopPropagation(),this.sendStickerFromSuggestion(e)})}),this.isSuggestionVisible=!0,setTimeout(()=>{this.suggestionContainer&&this.suggestionContainer.classList.add('show')},10)}hideStickerSuggestions(){this.suggestionContainer?(this.suggestionContainer.classList.remove('show'),setTimeout(()=>{this.suggestionContainer&&this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=null,this.isSuggestionVisible=!1},200)):this.isSuggestionVisible=!1}hideStickerSuggestionsImmediately(){this.suggestionContainer?(this.suggestionContainer.classList.remove('show'),this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=null,this.isSuggestionVisible=!1):this.isSuggestionVisible=!1}sendStickerFromSuggestion(e){const t=document.getElementById('inputField');t&&(t.value='');const a=this.extractFileNameFromUrl(e.url),s=e.note?`${e.note}${a}`:a,n={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'sticker',content:s,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(n),this.addNewMessageToInterface(n),this.hideStickerSuggestionsImmediately(),this.soundManager.playSound('click'),console.log('ä»å»ºè®®å‘é€è¡¨æƒ…åŒ…:',e.note,'â†’',s)}showUserMessageContextMenu(e,t,a){const s=document.createElement('div');s.className='modal-overlay user-message-context-modal',s.innerHTML='\n      <div class="modal-container">\n        <div class="modal-header">\n          <h3>æ¶ˆæ¯æ“ä½œ</h3>\n          <button class="modal-close-btn">Ã—</button>\n        </div>\n        <div class="modal-body">\n          <button class="modal-btn delete-btn" data-action="batch-delete">\n            åˆ é™¤æ¶ˆæ¯\n          </button>\n          <button class="modal-btn reroll-btn" data-action="reroll">\n            é‡æ–°ç”Ÿæˆ\n          </button>\n        </div>\n      </div>\n    ';const n=document.querySelector('.phone-container');n?n.appendChild(s):document.body.appendChild(s),setTimeout(()=>{s.classList.add('show')},10);const r=s.querySelector('[data-action="batch-delete"]'),o=s.querySelector('[data-action="reroll"]'),i=s.querySelector('.modal-close-btn');r&&r.addEventListener('click',()=>{this.enterBatchDeleteMode(),s.remove()}),o&&o.addEventListener('click',()=>{this.handleRerollMessage(t,a),s.remove()}),i&&i.addEventListener('click',()=>{s.remove()}),s.addEventListener('click',e=>{e.target===s&&s.remove()})}enterBatchDeleteMode(){this.isBatchDeleteMode=!0,this.selectedMessages.clear(),this.showBatchDeleteToolbar(),this.enableMessageSelection();const e=document.querySelector('.chat-container');e&&e.classList.add('batch-delete-mode')}exitBatchDeleteMode(){this.isBatchDeleteMode=!1,this.selectedMessages.clear(),this.hideBatchDeleteToolbar(),this.disableMessageSelection();const e=document.querySelector('.chat-container');e&&e.classList.remove('batch-delete-mode')}showBatchDeleteToolbar(){this.batchDeleteToolbar&&this.batchDeleteToolbar.remove(),this.batchDeleteToolbar=document.createElement('div'),this.batchDeleteToolbar.className='batch-delete-toolbar',this.batchDeleteToolbar.innerHTML='\n      <div class="toolbar-content">\n        <span class="selected-count">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</span>\n        <div class="toolbar-buttons">\n          <button class="toolbar-btn cancel-btn">å–æ¶ˆ</button>\n          <button class="toolbar-btn delete-btn" disabled>åˆ é™¤</button>\n        </div>\n      </div>\n    ';const e=document.querySelector('.chat-container');e&&e.appendChild(this.batchDeleteToolbar),this.bindBatchDeleteToolbarEvents()}hideBatchDeleteToolbar(){this.batchDeleteToolbar&&(this.batchDeleteToolbar.remove(),this.batchDeleteToolbar=null)}bindBatchDeleteToolbarEvents(){if(!this.batchDeleteToolbar)return;const e=this.batchDeleteToolbar.querySelector('.cancel-btn'),t=this.batchDeleteToolbar.querySelector('.delete-btn');e.addEventListener('click',()=>{this.exitBatchDeleteMode()}),t.addEventListener('click',async()=>{await this.confirmBatchDelete()})}enableMessageSelection(){document.querySelectorAll('.message').forEach(e=>{e.classList.add('selectable');const t=document.createElement('div');t.className='message-checkbox',t.innerHTML='<div class="checkbox-inner"></div>',e.insertBefore(t,e.firstChild);const a=e=>this.handleMessageSelection(e);e.addEventListener('click',a),e._selectionHandler=a})}disableMessageSelection(){document.querySelectorAll('.message').forEach(e=>{e.classList.remove('selectable','selected');const t=e.querySelector('.message-checkbox');t&&t.remove();const a=e._selectionHandler;a&&(e.removeEventListener('click',a),delete e._selectionHandler)})}handleMessageSelection(e){if(!this.isBatchDeleteMode)return;const t=e.currentTarget;this.soundManager.playSound('click');const a=t.dataset.messageId||t.querySelector('[data-message-id]')?.dataset.messageId||'';a?(this.selectedMessages.has(a)?(this.selectedMessages.delete(a),t.classList.remove('selected')):(this.selectedMessages.add(a),t.classList.add('selected')),this.updateBatchDeleteToolbar()):console.warn('âš ï¸ æœªèƒ½ä»æ¶ˆæ¯å…ƒç´ è·å– messageIdï¼Œé€‰æ‹©æ“ä½œè¢«å¿½ç•¥')}updateBatchDeleteToolbar(){if(!this.batchDeleteToolbar)return;const e=this.selectedMessages.size,t=this.batchDeleteToolbar.querySelector('.selected-count'),a=this.batchDeleteToolbar.querySelector('.delete-btn');t.textContent=`å·²é€‰æ‹© ${e} æ¡æ¶ˆæ¯`,a.disabled=0===e}async confirmBatchDelete(){if(0===this.selectedMessages.size)return;const e=this.selectedMessages.size;confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${e} æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)&&await this.executeBatchDelete()}async executeBatchDelete(){console.log('ğŸ—‘ï¸ === å¼€å§‹æ‰¹é‡åˆ é™¤è°ƒè¯• ===');const e=this.chatData.get(this.currentChat);if(e){console.log('ğŸ“‹ æ‰¹é‡åˆ é™¤çŠ¶æ€:'),console.log('  - å½“å‰èŠå¤©:',this.currentChat),console.log('  - é€‰ä¸­çš„æ¶ˆæ¯ID:',Array.from(this.selectedMessages)),console.log('  - æ¶ˆæ¯æ€»æ•°:',e.messages.length);try{const t=Array.from(this.selectedMessages);if(0===t.length)return console.warn('âš ï¸ æ²¡æœ‰é€‰ä¸­è¦åˆ é™¤çš„æ¶ˆæ¯'),void this.showToast('æ²¡æœ‰é€‰ä¸­è¦åˆ é™¤çš„æ¶ˆæ¯','warning');const a=t.map(t=>{const a=e.messages.findIndex(e=>e.id===t);if(-1!==a)return a;const s=document.querySelector(`[data-message-id="${t}"]`),n=s?.dataset?.messageFp;if(n){return e.messages.findIndex(e=>this.generateMessageFingerprint(e)===n)}return-1});console.log('ğŸ“Š ç”±IDæ˜ å°„å¾—åˆ°çš„æ¶ˆæ¯ç´¢å¼•(å«æŒ‡çº¹å›é€€):',a);const s=a.filter(t=>t>=0&&t<e.messages.length),n=t.filter((_,e)=>-1===a[e]);if(n.length>0&&(console.log('ğŸ“ æ£€æµ‹åˆ°å¾…å‘é€(pending)æ¶ˆæ¯ï¼Œå°†ç›´æ¥ä»å‘é€é˜Ÿåˆ—ä¸DOMåˆ é™¤:',n),await this.deletePendingMessagesByIds(n)),s.length>0&&await this.deleteSelectedMessages(s),0===n.length&&0===s.length)return console.warn('âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„æ¶ˆæ¯å¯åˆ é™¤ï¼ˆæ—¢ä¸åœ¨chatDataï¼Œä¹Ÿä¸åœ¨å‘é€é˜Ÿåˆ—ï¼‰'),void this.showToast('é€‰ä¸­çš„æ¶ˆæ¯æ— æ•ˆ','warning');this.exitBatchDeleteMode(),console.log('âœ… æ‰¹é‡åˆ é™¤å®Œæˆï¼ˆchatData:',s.length,'æ¡ï¼›pending:',n.length,'æ¡ï¼‰')}catch(e){console.error('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:',e),this.showToast('æ‰¹é‡åˆ é™¤å¤±è´¥','error')}finally{console.log('ğŸ—‘ï¸ === æ‰¹é‡åˆ é™¤è°ƒè¯•ç»“æŸ ===')}}else console.error('âŒ å½“å‰èŠå¤©æ•°æ®ä¸å­˜åœ¨')}async deleteSelectedMessages(e){console.log('ğŸ—‘ï¸ === å°±åœ°ç¼–è¾‘â€¢åˆ é™¤æ¶ˆæ¯ ===');try{const t=this.chatData.get(this.currentChat);if(!t)return void console.error('âŒ å½“å‰èŠå¤©æ•°æ®ä¸å­˜åœ¨:',this.currentChat);const a=getChatMessages(-1)?.[0];if(!a||!a.message)return void console.error('âŒ æ— æ³•è·å–å½“å‰æ¥¼å±‚æ–‡æœ¬');const s=a.message,n=s.match(/<bear>([\s\S]*?)<\/bear>/);if(!n)return void console.warn('âš ï¸ å½“å‰æ¥¼å±‚æ²¡æœ‰ <bear> å®¹å™¨ï¼Œå–æ¶ˆåˆ é™¤');let r=n[1];const o=[...e].filter(e=>e>=0&&e<t.messages.length).sort((e,t)=>t-e),i=[];for(const e of o){const a=t.messages.splice(e,1)[0];a&&i.push(a)}if(t.messages.length>0){const e=t.messages[t.messages.length-1];t.lastMessage='group'===t.type?this.messageParser.formatGroupLastMessage(e):this.messageParser.formatLastMessage(e)}else t.lastMessage='';const c=e=>this.escapeRegExp(e),l='group'===t.type||this.currentChat.startsWith('ç¾¤èŠ'),d=e=>{const t=c(e.sender||''),a=c(e.content||'');return'G'===e.type?new RegExp(`\\[G_[^|]*\\|${t}\\|(?:[a-zA-Z]+:)?${a}\\|[^\\]]*\\]`,'g'):new RegExp(`\\[S_[^|]*\\|${t}\\|(?:[a-zA-Z]+:)?${a}\\|[^\\]]*\\]`,'g')},h=i.map(d);console.log('ğŸ§¾ å‡†å¤‡å°±åœ°åˆ é™¤çš„å®½æ¾åŒ¹é…æ¨¡å¼:',h.map(e=>e.source));const m=(e,t)=>{let a=e;for(const e of t){const t=new RegExp(`(^|\\n)\\s*${e.source}\\s*(?=\\n|$)`,'g');a=a.replace(t,(e,t)=>t||'')}return a=a.replace(/\n{3,}/g,'\n\n'),a.trimEnd()};if(l){const e=t.chatName||this.currentChat.replace(/^ç¾¤èŠ/,''),a=new RegExp(`\\[ç¾¤èŠ${c(e)}\\]\\s*\\n?\\s*\\[æˆå‘˜[ï¼š:]([^\\]]+)\\]\\s*\\n?([\\s\\S]*?)\\n?\\s*\\[/ç¾¤èŠ${c(e)}\\]`),s=r.match(a);if(s){const t=s[1],a=s[2]||'',n=`[ç¾¤èŠ${e}]\n[æˆå‘˜ï¼š${t}]\n${m(a,h)}\n[/ç¾¤èŠ${e}]`;r=r.replace(s[0],n)}else r=m(r,h)}else{const e=t.chatName||this.currentChat,a=new RegExp(`\\[${c(e)}\\]([\\s\\S]*?)\\[\\/${c(e)}\\]`),s=r.match(a);if(s){const t=s[1]||'',a=`[${e}]\n${m(t,h)}\n[/${e}]`;r=r.replace(s[0],a)}else r=m(r,h)}const g=this.replaceOnlyBearTagContent(s,r);await setChatMessages([{message_id:a.message_id,message:g}],{refresh:'none'}),this.renderCurrentChat(),this.showToast(`å·²åˆ é™¤ ${i.length} æ¡æ¶ˆæ¯`,'success'),console.log('âœ… å°±åœ°ç¼–è¾‘åˆ é™¤å®Œæˆ')}catch(e){console.error('âŒ å°±åœ°ç¼–è¾‘åˆ é™¤å¤±è´¥:',e),this.showToast('åˆ é™¤æ¶ˆæ¯å¤±è´¥','error')}finally{console.log('ğŸ—‘ï¸ === å°±åœ°ç¼–è¾‘â€¢åˆ é™¤æ¶ˆæ¯ ç»“æŸ ===')}}async deletePendingMessagesByIds(e){try{if(!Array.isArray(e)||0===e.length)return void console.log('â„¹ï¸ deletePendingMessagesByIds: æ— å¾…åˆ é™¤ID');const t=new Set(e);console.log('ğŸ—‘ï¸ åˆ é™¤å¾…å‘é€æ¶ˆæ¯ID:',e);const a=this.sendQueue.length;this.sendQueue=this.sendQueue.filter(e=>!t.has(e.id)),console.log(`ğŸ§¹ å¾…å‘é€é˜Ÿåˆ—: ${a} -> ${this.sendQueue.length}`);const s=this.currentChat?this.chatData.get(this.currentChat):null;if(s){const e=s.messages.length;s.messages=s.messages.filter(e=>!(e.isPending&&t.has(e.id))),e!==s.messages.length&&console.log(`ğŸ§¹ å†…å­˜æ¶ˆæ¯: ${e} -> ${s.messages.length}`)}const n=document.getElementById('chatMessages');n&&e.forEach(e=>{const t=n.querySelector(`[data-message-id="${e}"]`);if(t)t.remove();else{const t=Array.from(n.querySelectorAll('[data-message-fp]')).find(t=>t.dataset.messageId===e);t&&t.remove()}}),this.chatListManager&&this.chatListManager.refreshChatList(this.chatData),this.showToast(`å·²åˆ é™¤ ${e.length} æ¡å¾…å‘é€æ¶ˆæ¯`,'success')}catch(e){console.error('âŒ åˆ é™¤å¾…å‘é€æ¶ˆæ¯å¤±è´¥:',e),this.showToast('åˆ é™¤å¾…å‘é€æ¶ˆæ¯å¤±è´¥','error')}}async handleRerollMessage(e,t){try{console.log('ğŸ”„ å¼€å§‹é‡æ–°ç”Ÿæˆæ¶ˆæ¯ï¼Œä»æ¶ˆæ¯:',e);const a=this.chatData.get(this.currentChat);if(!a)return void this.showToast('æœªæ‰¾åˆ°å½“å‰èŠå¤©æ•°æ®','error');let s=a.messages.findIndex(t=>t.id===e.id);if(-1===s&&t){const e=t?.dataset?.messageFp;e&&(s=a.messages.findIndex(t=>this.generateMessageFingerprint(t)===e))}if(-1===s)return console.log('âŒ æ— æ³•å®šä½æ¶ˆæ¯ï¼Œè¯·ä»èŠå¤©åˆ—è¡¨é‡æ–°è¿›å…¥åå†è¯•'),void this.showToast('æ— æ³•å®šä½æ¶ˆæ¯ï¼Œè¯·ä»èŠå¤©åˆ—è¡¨é‡æ–°è¿›å…¥åå†è¯•','warning');const n=[];for(let e=s+1;e<a.messages.length;e++)n.push(e);console.log(`ğŸ—‘ï¸ éœ€è¦å°±åœ°åˆ é™¤ ${n.length} æ¡åç»­æ¶ˆæ¯`),n.length>0&&await this.deleteSelectedMessages(n);const r=this.chatData.get(e.chatId);let o='';if('group'===r?.type){o=`å›å¤å’Œ${r.chatName||e.chatId}çš„èŠå¤©ï¼š`}else{const t=r?.chatName||e.chatId;o=`å›å¤å’Œ${this.extractCharacterNameFromChatName(t)}çš„èŠå¤©ï¼š`}let i=e.content;'text'!==e.messageType&&(i=`${e.messageType}:${e.content}`);const c=`${o}${i}`;console.log('ğŸ“ æ„å»ºçš„æç¤ºè¯:',c),this.showToast('æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...','info');const l=await this.showTypingIndicator(),d=await generate({user_input:c,should_stream:!1});console.log('ğŸ¤– æ”¶åˆ°AIå›å¤:',d),this.hideTypingIndicator(l),await this.handleAIResponse(d,e)}catch(e){console.error('âŒ é‡æ–°ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:',e),this.showToast('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•','error'),this.soundManager.playSound('error')}}removeMessagesFromDOM(e){try{const t=document.getElementById('chatMessages');if(!t)return void console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨ #chatMessages');const a=Array.from(t.children);console.log(`ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤DOMä¸­ç´¢å¼• ${e} ä¹‹åçš„æ¶ˆæ¯å…ƒç´ `),console.log(`  - DOMä¸­æ€»æ¶ˆæ¯å…ƒç´ æ•°: ${a.length}`),console.log('  - éœ€è¦åˆ é™¤çš„å…ƒç´ æ•°: '+(a.length-e));for(let t=a.length-1;t>=e;t--){const e=a[t];e&&(console.log(`  - åˆ é™¤DOMå…ƒç´ ç´¢å¼•: ${t}`),e.remove())}console.log('âœ… DOMæ¶ˆæ¯å…ƒç´ åˆ é™¤å®Œæˆ')}catch(e){console.error('âŒ åˆ é™¤DOMæ¶ˆæ¯å…ƒç´ å¤±è´¥:',e),console.log('ğŸ”„ å›é€€åˆ°é‡æ–°æ¸²æŸ“æ•´ä¸ªç•Œé¢...'),this.renderCurrentChat()}}truncateText(e,t){return e.length<=t?e:e.substring(0,t)+'...'}getScaleManager(){return this.scaleManager}getTypingSpeedManager(){return this.typingSpeedManager}checkCharacterChange(){const e=this.getCurrentCharacterId();console.log(`ğŸ” å½“å‰è§’è‰²ID: ${e}`),this.handleCharacterChange()}normalizeChatIdForComparison(e){return e.trim().replace(/\s+/g,'_').toLowerCase()}extractCharacterNameFromChatName(e){const t=e.match(/^å’Œ(.+)çš„èŠå¤©$/);return t?t[1]:e}async detectNewMessagesBeforeMerge(e){try{let t=[];if(this.lastBearContent){console.log('ğŸ” è¿›è¡ŒBearå†…å®¹å·®å¼‚æ£€æµ‹');const a=this.messageParser.parseBearContent(this.lastBearContent),s=this.messageParser.parseBearContent(e);t=this.findNewMessages(await a,await s)}else{console.log('ğŸ” é¦–æ¬¡è§£æBearå†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„AIå›å¤');const a=this.messageParser.parseBearContent(e),s=this.getExistingMessagesFromInterface();console.log('ğŸ” [DEBUG] ç°æœ‰æ¶ˆæ¯æŒ‡çº¹é›†åˆ:',Array.from(s)),console.log('ğŸ” [DEBUG] å½“å‰èŠå¤©ID:',this.currentChat);for(const[e,n]of await a){console.log(`ğŸ” [DEBUG] æ£€æŸ¥èŠå¤© "${e}" çš„æ¶ˆæ¯`);for(const e of n.messages){const a=this.generateMessageFingerprint(e);console.log(`ğŸ” [DEBUG] æ¶ˆæ¯æŒ‡çº¹: "${a}", å‘é€è€…: "${e.sender}", å†…å®¹: "${e.content.substring(0,30)}..."`),'{{user}}'!==e.sender&&'user'!==e.sender?(console.log('ğŸ” [DEBUG] è¿™æ˜¯AIæ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨'),s.has(a)?console.log('ğŸ” [DEBUG] âŒ AIæ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡'):(console.log('ğŸ” [DEBUG] âœ… å‘ç°æ–°AIæ¶ˆæ¯ï¼Œæ·»åŠ åˆ°æ¸²æŸ“é˜Ÿåˆ—'),t.push(e))):console.log('ğŸ” [DEBUG] è¿™æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œè·³è¿‡')}}}return console.log(`ğŸ” [DEBUG] æœ€ç»ˆæ–°æ¶ˆæ¯æ•°é‡: ${t.length}`),t.length>0&&(console.log(`ğŸ†• å‘ç° ${t.length} æ¡æ–°æ¶ˆæ¯`),t.forEach((e,t)=>{console.log(`ğŸ†• [DEBUG] æ–°æ¶ˆæ¯${t+1}: å‘é€è€…="${e.sender}", å†…å®¹="${e.content.substring(0,50)}..."`)})),t}catch(e){return console.error('âŒ æ£€æµ‹æ–°æ¶ˆæ¯å¤±è´¥:',e),[]}}async renderDetectedNewMessages(e){if(0!==e.length){if(this.chatListManager&&e.length>0){console.log('ğŸ“Š ç«‹å³æ›´æ–°æœªè¯»æ¶ˆæ¯è®¡æ•°...',e.length,'æ¡æ–°æ¶ˆæ¯'),this.chatListManager.updateChatData(this.chatData);const t='chat'===this.currentInterface?this.currentChat:void 0;this.chatListManager.onNewMessages(e,t);const a=[...new Set(e.map(e=>e.chatId))];console.log('ğŸ“Š æ¶‰åŠçš„èŠå¤©:',a),console.log('ğŸ“– å½“å‰èŠå¤©ID:',t)}await this.renderNewMessagesForCurrentChat(e),console.log('ğŸ¨ [ä¸»åº”ç”¨] æ¶ˆæ¯æ¸²æŸ“å®Œæˆï¼Œå‡†å¤‡è§¦å‘èŠå¤©è¿ç§»æ£€æŸ¥'),await this.triggerChatMigrationCheck()}else console.log('ğŸ” æœªå‘ç°æ–°æ¶ˆæ¯')}isEmptyBearContent(){for(const[,e]of this.chatData)if(e.messages&&e.messages.length>0)return!1;return!0}async hasMultipleBearFloors(){try{const e=getChatMessages('0-{{lastMessageId}}');if(!e||0===e.length)return!1;let t=0;for(const a of e)a.message&&a.message.includes('<bear>')&&t++;return console.log(`ğŸ” æ£€æµ‹åˆ° ${t} ä¸ªBearæ¥¼å±‚`),t>1}catch(e){return console.error('âŒ æ£€æŸ¥Bearæ¥¼å±‚æ•°é‡å¤±è´¥:',e),!1}}updateInterfaceDataWithNewMessages(e){console.log('ğŸ”„ æ›´æ–°ç•Œé¢æ•°æ®ä»¥ä¿æŒæ˜¾ç¤ºåŒæ­¥');for(const[t,a]of e){const e=this.chatData.get(t);if(e){const s=this.mergeMessages(e.messages,a.messages);e.messages=s,e.lastMessage=s.length>0?this.messageParser.formatLastMessage(s[s.length-1]):'',console.log(`ğŸ“ ç•Œé¢æ•°æ®ï¼šæ›´æ–°èŠå¤© ${t}ï¼Œç°æœ‰ ${s.length} æ¡æ¶ˆæ¯`)}else this.chatData.set(t,a),console.log(`ğŸ†• ç•Œé¢æ•°æ®ï¼šæ·»åŠ æ–°èŠå¤© ${t}ï¼ŒåŒ…å« ${a.messages.length} æ¡æ¶ˆæ¯`)}console.log('âœ… ç•Œé¢æ•°æ®æ›´æ–°å®Œæˆï¼Œç”¨æˆ·ç•Œé¢å°†æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯')}recordRecentOp(e){try{const t='string'==typeof e.content?e.content.trim():void 0;if(('comment'===e.kind||'post'===e.kind)&&!t)return;this.recentOps.push({...e,ts:Date.now()})}catch{}}formatRecentOpsSummary(){try{if(!Array.isArray(this.recentOps)||0===this.recentOps.length)return'';return this.recentOps.map(e=>{if('comment'===e.kind){return`- è¯„è®ºäº†åŠ¨æ€${'number'==typeof e.postNo?`#${e.postNo}`:''}ï¼š${e.content??''}`}return`- å‘å¸ƒäº†åŠ¨æ€ï¼š${e.content??''}`}).join('\n')}catch{return''}}flushRecentOps(){this.recentOps=[]}bindRecentOpsListeners(){if(this.__recentOpsBound)return;this.__recentOpsBound=!0;const e=e=>{try{const t=e.detail||{};if('comment'!==t?.type||'add'!==t?.action||'user'!==t?.user&&'{{user}}'!==t?.user||this.recordRecentOp({kind:'comment',content:'string'==typeof t.content?t.content:'',postNo:'number'==typeof t.postNo?t.postNo:void 0,messageId:'number'==typeof t.messageId?t.messageId:void 0}),'post'===t?.type&&'remove'===t?.action){const e=Array.isArray(t.postNos)?new Set(t.postNos.filter(e=>'number'==typeof e)):new Set,a='number'==typeof t.messageId?t.messageId:void 0;e.size>0&&(this.recentOps=this.recentOps.filter(t=>'post'!==t.kind||('number'!=typeof t.postNo||!e.has(t.postNo)||void 0!==a&&'number'==typeof t.messageId&&t.messageId!==a)))}if('comment'===t?.type&&'remove'===t?.action){const e='number'==typeof t.postNo?t.postNo:void 0,a='number'==typeof t.messageId?t.messageId:void 0,s='string'==typeof t.content?t.content.trim():void 0;this.recentOps=this.recentOps.filter(t=>'comment'!==t.kind||('number'!=typeof e||'number'!=typeof t.postNo||t.postNo!==e||void 0!==a&&'number'==typeof t.messageId&&t.messageId!==a)&&!(!e&&s&&'string'==typeof t.content&&t.content.trim()===s&&(void 0===a||'number'!=typeof t.messageId||t.messageId===a)))}}catch{}};try{document.addEventListener('dynamicsInteraction',e)}catch{}try{document.addEventListener('dynamicsPublished',e=>{try{const t=e.detail||{};let a=t&&(t.content||t.text||t.body),s='number'==typeof t?.postNo?t.postNo:'number'==typeof t?.no?t.no:void 0,n='number'==typeof t?.messageId?t.messageId:void 0;if(!a||void 0===s||void 0===n){const e=getChatMessages(-1)?.[0],t=(e?.message||'').match(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/);if(t){const e=t[1].split('\n').map(e=>e.trim()).filter(Boolean);for(let t=e.length-1;t>=0;t--){const n=e[t].match(/^\[åŠ¨æ€_(\d+)\|[^|]*\|([^|\]]+)\|/);if(n){a||(a=n[2]),void 0===s&&(s=parseInt(n[1],10));break}}}void 0===n&&e?.message_id&&(n=e.message_id)}a&&this.recordRecentOp({kind:'post',content:a,postNo:s,messageId:n})}catch{}})}catch{}}}let ve=null;$(()=>{if(!ve){try{window.avatarSourceService=R.OK,console.log('âœ… AvatarSourceServiceå·²åˆå§‹åŒ–')}catch(e){console.error('âŒ AvatarSourceServiceåˆå§‹åŒ–å¤±è´¥:',e)}ve=new pe,window.bearChatManager=ve,window.scaleManager=ve.getScaleManager(),window.typingSpeedManager=ve.getTypingSpeedManager(),console.log('å¤šäº‘ç†ŠèŠå¤©ç•Œé¢å·²åˆå§‹åŒ–'),window.debugUnreadMessages=()=>{if(ve&&ve.chatListManager){const e=ve.chatListManager.getUnreadMessageManager();return console.log('ğŸ“Š æœªè¯»æ¶ˆæ¯è°ƒè¯•ä¿¡æ¯:'),console.log('- æ€»æœªè¯»æ•°:',e.getTotalUnreadCount()),console.log('- æ‰€æœ‰æœªè¯»è®¡æ•°:',Object.fromEntries(e.getAllUnreadCounts())),{totalUnread:e.getTotalUnreadCount(),allCounts:Object.fromEntries(e.getAllUnreadCounts())}}console.error('âŒ æœªè¯»æ¶ˆæ¯ç®¡ç†å™¨æœªåˆå§‹åŒ–')},window.checkCharacterChange=()=>{if(ve)return ve.checkCharacterChange();console.error('âŒ BearChatManager æœªåˆå§‹åŒ–')},window.checkCharacter=()=>{console.log('=== ç®€å•è§’è‰²æ£€æŸ¥ ===');const e={'typeof TavernHelper':typeof TavernHelper,getCharDataå‡½æ•°å­˜åœ¨:'function'==typeof getCharData,deleteChatMessageså‡½æ•°å­˜åœ¨:'function'==typeof deleteChatMessages,setChatMessageså‡½æ•°å­˜åœ¨:'function'==typeof setChatMessages,this_chid:window.this_chid,name2:window.name2,characterså­˜åœ¨:void 0!==window.characters};if(console.table(e),'function'==typeof getCharData)try{const e=getCharData();console.log('getCharData() ç»“æœ:',e)}catch(e){console.error('getCharData() é”™è¯¯:',e)}return e}}}),$(window).on('unload',()=>{const e=window.bearChatManager;e&&e.soundManager&&e.soundManager.destroy(),console.log('å¤šäº‘ç†ŠèŠå¤©ç•Œé¢å·²å¸è½½')}),(()=>{if(window.__bearDynamicsIndexV2Ready)return;window.__bearDynamicsIndexV2Ready=!0;const e=(e,t)=>`${e}_${t}`,t=()=>window.bearChatManager,a=()=>{const a=t();if(!a)return null;if(!a.__dynIndex){a.__dynIndex=new Map;const t=Array.isArray(a.dynamicsData)?a.dynamicsData:[];for(const s of t){const t=s?.messageId,n=s?.no;'number'==typeof t&&'number'==typeof n&&a.__dynIndex.set(e(t,n),s)}}return a.__dynIndex},s=()=>{const e=t(),s=a();e&&s&&(e.dynamicsData=Array.from(s.values()))},n=async n=>{try{const r=t(),o=a();if(!r||!o)return;const i=(getChatMessages(n)||[])[0],c=(i?.message||'').match(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/);if(!c)return;const l=`<bear>\n${c[0]}\n</bear>`,d=r.messageParser;if(!d?.parseBearContentPlus)return;const h=await d.parseBearContentPlus(l),m=Array.isArray(h?.dynamics)?h.dynamics:[];for(const t of m)'number'==typeof t?.no&&(t.messageId=n,o.set(e(n,t.no),t));const g=new Set(m.map(e=>e.no));for(const e of Array.from(o.keys())){const[t,a]=e.split('_'),s=Number(t),r=Number(a);s!==n||g.has(r)||o.delete(e)}s()}catch(e){console.warn('[DynamicsIndexBridgeV2] upsertFloorFromText failed',e)}},r=()=>{try{const e=getChatMessages(-1)?.[0];return e&&'number'==typeof e.message_id?e.message_id:null}catch{return null}};document.addEventListener('dynamicsInteraction',o=>{try{const i=o.detail||{},c=i?.type,l=i?.action;if('post'===c&&'remove'===l){const t=i?.messageId,n=Array.isArray(i?.postNos)?i.postNos:[];return void('number'==typeof t&&n.length&&((t,n)=>{try{const r=a();if(!r)return;for(const a of n)r.delete(e(t,a));s()}catch(e){console.warn('[DynamicsIndexBridgeV2] prunePosts failed',e)}})(t,n))}if('post'===c&&'add'===l){const e='number'==typeof i?.messageId?i.messageId:r()??-1;return void(e>=0&&n(e))}if(!('comment'!==c&&'like'!==c||'add'!==l&&'remove'!==l)){const n=i?.messageId,r=i?.postNo??(Array.isArray(i?.postNos)?i.postNos[0]:void 0);return void('number'==typeof n&&'number'==typeof r&&(async(n,r)=>{try{const o=t(),i=a();if(!o||!i)return;const c=(getChatMessages(n)||[])[0],l=(c?.message||'').match(/\[åŠ¨æ€\]([\s\S]*?)\[\/åŠ¨æ€\]/);if(!l)return;const d=`<bear>\n${l[0]}\n</bear>`,h=o.messageParser;if(!h?.parseBearContentPlus)return;const m=await h.parseBearContentPlus(d),g=(Array.isArray(m?.dynamics)?m.dynamics:[]).find(e=>e?.no===r);if(!g)return;g.messageId=n;const u=e(n,r),p=i.get(u)||{};p.no=g.no,p.messageId=g.messageId,p.author=g.author??p.author,p.content=g.content??p.content,p.image=g.image??p.image,p.imageDescription=g.imageDescription??p.imageDescription,p.timestamp=g.timestamp??p.timestamp,p.actions=g.actions??p.actions,p.comments=g.comments||[],p.likedBy=g.likedBy||[],p.likesCount=g.likedBy?.length||0,i.set(u,p),s()}catch(e){console.warn('[DynamicsIndexBridgeV2] calibratePostInteractions failed',e)}})(n,r))}}catch(e){console.warn('[DynamicsIndexBridgeV2] interaction event failed',e)}}),document.addEventListener('dynamicsPublished',()=>{const e=r();'number'==typeof e&&n(e)})})(),(()=>{try{const e=window.bearChatManager;if(!e)return;if(e.__dynIndexUnified)return;const t=(e,t)=>`${e}_${t}`;if(!e.__dynIndex){const a=Array.isArray(e.dynamicsData)?e.dynamicsData:[],s=new Map;for(const e of a){const a=e?.messageId,n=e?.no;'number'==typeof a&&'number'==typeof n&&s.set(t(a,n),e)}e.__dynIndex=s}const a=Object.getOwnPropertyDescriptor(e,'dynamicsData');!(!a||!a.get&&!a.set)||Object.defineProperty(e,'dynamicsData',{configurable:!0,enumerable:!0,get(){const e=this.__dynIndex;return e?Array.from(e.values()):[]},set(e){const a=new Map;if(Array.isArray(e))for(const s of e){const e=s?.messageId,n=s?.no;'number'==typeof e&&'number'==typeof n&&a.set(t(e,n),s)}this.__dynIndex=a}}),e.__dynIndexUnified=!0}catch(e){console.warn('[DynamicsIndexUnify] failed to unify dynamicsData backing Map',e)}})();</script><style>.status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1000;flex-shrink:0}.status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff;flex-shrink:0}.has-status-bar{padding-top:1.5rem}.chat-container .status-bar{position:relative;background:#000}:root{--scale-factor:1;--base-desktop:16px;--base-mobile:14px;--base-small:12px}html{font-size:calc(var(--base-desktop)*var(--scale-factor))}@media (max-width:480px){html{font-size:calc(var(--base-mobile)*var(--scale-factor))}}@media (max-width:360px){html{font-size:calc(var(--base-small)*var(--scale-factor))}}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{display:flex;justify-content:center;align-items:center}.phone-container{width:min(100%,22.5rem);aspect-ratio:9/18.5;border:.75rem solid var(--phone-frame-color,#363636);border-radius:2.25rem;background-image:url("https://files.catbox.moe/kyeqkf.jpg");background-size:cover;position:relative;margin:.9375rem;box-shadow:0 0 20px rgba(0,0,0,.1);display:flex}.phone-charm{position:absolute;top:-0.75rem;right:-2.8125rem;width:10.625rem;height:10.625rem;background-image:url("https://files.catbox.moe/7ozygy.gif");background-size:contain;background-repeat:no-repeat;z-index:1000;pointer-events:none}.phone-notch{position:absolute;top:0;left:50%;transform:translateX(-50%);width:10rem;height:.8125rem;background:#363636;border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem;z-index:999;display:flex;justify-content:center;align-items:center;gap:.5rem}.notch-camera,.notch-sensor{width:.5rem;height:.5rem;background:#222;border-radius:50%;border:2px solid #444}.notch-sensor{width:.375rem;height:.375rem;border:1px solid #444}.notch-speaker{width:2.5rem;height:.25rem;background:#222;border-radius:2px}.interface-container{width:100%;height:100%;border-radius:1.5rem;overflow:hidden;position:relative;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif}.chat-container{width:100%;height:100%;background-image:url("https://files.catbox.moe/ctdr65.jpeg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;display:flex;flex-direction:column}.chat-container .status-bar{position:relative;width:100%;height:1.5rem;background:hsla(0,0%,100%,.95);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#333;font-size:.75rem;z-index:1;flex-shrink:0}.chat-container .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.chat-container .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.chat-container .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#333}.chat-header{height:3.5rem;background:hsla(0,0%,100%,.95);padding:0 1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.05);backdrop-filter:blur(0.625rem)}.chat-header h2{font-size:1rem;color:#333;font-weight:600;margin-bottom:.125rem}.header-info{display:flex;align-items:center;gap:.75rem}.header-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1);cursor:pointer;transition:transform .2s}.header-avatar:hover{transform:scale(1.1)}.header-text{display:flex;flex-direction:column}.header-status{font-size:.75rem;color:#4caf50;display:flex;align-items:center;gap:.25rem}.status-dot{width:.375rem;height:.375rem;background:#4caf50;border-radius:50%}.header-icons{display:flex;gap:1rem;position:relative;z-index:2}.header-icon{width:1.5rem;height:1.5rem;color:#666;cursor:pointer;position:relative;z-index:2;transition:all .2s}.header-icon:hover{color:#6c8cd5;transform:scale(1.1)}.status-bar{height:2.75rem;background:#000;display:flex;justify-content:center;align-items:center;color:#fff;font-size:.875rem;font-weight:600}.nav-bar{height:3.75rem;background:#fff;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between;padding:0 1rem}.nav-bar .nav-title{font-size:1.125rem;font-weight:600;color:#333}.nav-bar .nav-button{width:2rem;height:2rem;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:1rem;transition:background-color .2s}.nav-bar .nav-button:hover{background-color:#f0f0f0}.chat-area{flex:1;overflow-y:auto;padding:1rem;background:#f5f5f5}.input-area{background:#fff;border-top:1px solid #e0e0e0;padding:.75rem 1rem;display:flex;align-items:center;gap:.5rem;min-height:3.75rem}.plus-button{width:2rem;height:2rem;border:none;background:#007aff;color:#fff;border-radius:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.125rem;transition:background-color .2s}.plus-button:hover{background:#0056cc}.message-input{flex:1;border:1px solid #e0e0e0;border-radius:1.25rem;padding:.5rem 1rem;font-size:1rem;outline:none;resize:none;min-height:2.25rem;max-height:6.25rem}.message-input:focus{border-color:#007aff}.send-button{width:2rem;height:2rem;border:none;background:#007aff;color:#fff;border-radius:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.send-button:hover{background:#0056cc}.send-button:disabled{background:#ccc;cursor:not-allowed}.chat-list{width:100%;height:100%;background:#fff;position:absolute;top:0;left:0;z-index:10;display:none}.chat-list.active{display:flex;flex-direction:column}.chat-list-item{padding:1rem;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center;gap:.75rem;transition:background-color .2s}.chat-list-item:hover{background-color:#f8f8f8}.chat-list-item .chat-avatar{width:3.125rem;height:3.125rem;border-radius:1.5625rem;object-fit:cover}.chat-list-item .chat-info{flex:1}.chat-list-item .chat-info .chat-name{font-size:1rem;font-weight:600;color:#333;margin-bottom:.25rem}.chat-list-item .chat-info .chat-preview{font-size:.875rem;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.chat-list-item .chat-time{font-size:.75rem;color:#999}.plus-menu{position:absolute;bottom:3.5rem;left:1rem;transform:translateY(0.5rem) scale(0.9);background:#fff;border-radius:1.25rem;box-shadow:0 3px 15px rgba(0,0,0,.12);padding:.375rem .625rem;z-index:100;opacity:0;transition:all .25s ease-out;display:none;flex-direction:row;align-items:center;gap:.1875rem}.plus-menu.active{display:flex}.plus-menu.show{opacity:1;transform:translateY(0) scale(1)}.menu-item{display:flex;align-items:center;justify-content:center;width:2.375rem;height:2.375rem;cursor:pointer;border-radius:50%;transition:all .2s ease;position:relative;flex-shrink:0}.menu-item:hover{background-color:#f0f0f0;transform:scale(1.1)}.menu-item:active{transform:scale(0.95)}.menu-item .menu-icon{display:flex;align-items:center;justify-content:center;width:auto;height:auto;color:#666;transition:color .2s ease}.menu-item .menu-icon svg{width:1.125rem;height:1.125rem;display:block;margin:0}.menu-item[data-type=sticker] .menu-icon{color:#ff9800}.menu-item[data-type=image] .menu-icon{color:#2dbccf}.menu-item[data-type=voice] .menu-icon{color:#2196f3}.menu-item[data-type=transfer] .menu-icon{color:#f44336}.menu-item[data-type=location] .menu-icon{color:#4caf50}.menu-item:hover[data-type=sticker]{background-color:rgba(255,152,0,.1)}.menu-item:hover[data-type=image]{background-color:rgba(0,188,212,.1)}.menu-item:hover[data-type=voice]{background-color:rgba(33,150,243,.1)}.menu-item:hover[data-type=transfer]{background-color:rgba(244,67,54,.1)}.menu-item:hover[data-type=location]{background-color:rgba(76,175,80,.1)}.transfer-modal{position:relative;background:#fff;border-radius:1rem;padding:1.25rem;width:17.5rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:1000;animation:modalFadeIn .3s ease-out}.modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;display:flex;align-items:center;justify-content:center;border-radius:1.5rem;opacity:0;transition:opacity .3s ease;overflow:hidden;touch-action:none}.modal-overlay.show{opacity:1}.modal-container{background:#fff;border-radius:1rem;padding:1.5rem;width:18.75rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);animation:modalFadeIn .3s ease-out;max-height:80%;overflow:hidden}.modal-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;text-align:center}.modal-content{margin-bottom:1rem}.image-input-modal .modal-content,.voice-input-modal .modal-content,.location-input-modal .modal-content,.transfer-input-modal .modal-content{display:flex;flex-direction:column}.image-upload-section{margin-bottom:1rem}.upload-options{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem}.upload-options .upload-row{display:flex;align-items:center;gap:.5rem}.upload-btn{background:#f0f0f0;color:#666;border:1px solid #ddd;padding:.375rem .75rem;border-radius:.5rem;cursor:pointer;font-size:.75rem;transition:all .2s ease;white-space:nowrap;flex-shrink:0}.upload-btn:hover{background:#e8e8e8;border-color:#ccc;color:#555}.upload-btn:active{background:#ddd;transform:translateY(0.0625rem)}.upload-divider{color:#999;font-size:.75rem;flex-shrink:0}.url-input{flex:1;min-width:7.5rem;font-size:.875rem}.file-preview{margin-top:.75rem;padding:.75rem;border:1px dashed rgba(108,140,213,.2);border-radius:.5rem;background:rgba(108,140,213,.1);display:flex;align-items:center;gap:.75rem}.file-preview img{width:3.125rem;aspect-ratio:1;object-fit:cover;border-radius:.375rem;border:1px solid #ddd}.file-preview .file-info{flex:1;display:flex;align-items:center;justify-content:space-between}.file-preview .file-info span{color:#555;font-size:.8125rem;font-weight:500;word-break:break-all}.file-preview .remove-file-btn{background:#f5f5f5;color:#999;border:1px solid #ddd;width:1.25rem;aspect-ratio:1;border-radius:50%;cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.file-preview .remove-file-btn:hover{background:#ff4757;color:#fff;border-color:#ff4757}#imageInputModalTemplate .modal-label,.image-input-modal .modal-label,.modal-container .modal-label,[id*=imageInput] .modal-label{display:block;margin-bottom:.5rem;font-weight:600;color:#333;font-size:.875rem}#imageInputModalTemplate .modal-label.modal-label-spaced,.image-input-modal .modal-label.modal-label-spaced,.modal-container .modal-label.modal-label-spaced,[id*=imageInput] .modal-label.modal-label-spaced{margin-top:1rem}.modal-input{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;margin-bottom:.75rem;outline:none;transition:border-color .2s}.modal-input:focus{border-color:#6c8cd5;box-shadow:0 0 0 .125rem rgba(108,140,213,.2)}.modal-input::placeholder{color:#999}.modal-input[type=number]{-moz-appearance:textfield}.modal-input[type=number]::-webkit-outer-spin-button,.modal-input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.modal-buttons{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1rem}.modal-btn{padding:.625rem 1.25rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .2s;min-width:5rem}.modal-btn.cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.modal-btn.cancel-btn:hover{background:#e0e0e0}.modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.modal-btn.confirm-btn:hover{background:#5a7bc4}@keyframes modalFadeIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}.chat-area::-webkit-scrollbar{width:4px}.chat-area::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:2px}.chat-area::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.3)}.chat-messages{flex:1;padding:1rem;overflow-y:auto}.chat-messages::-webkit-scrollbar{width:0px}.chat-messages::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-messages::-webkit-scrollbar-thumb{background:rgba(0,0,0,0);border-radius:.1875rem}.chat-messages::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0)}.message{display:flex;margin-bottom:.5rem;align-items:flex-start;position:relative;animation:message-pop .3s ease-out}.message.sent{flex-direction:row-reverse}.message.sent .message-content{background:linear-gradient(135deg,#6c8cd5,#4a6fbf);color:#fff;border-bottom-right-radius:.25rem}.message.sent .message-time{text-align:right}.message.received .message-content{background:#fff;color:#333;box-shadow:0 2px 4px rgba(0,0,0,.05);border-bottom-left-radius:.25rem}.message.group-message.received .message-content{border-bottom-left-radius:1.125rem;border-top-left-radius:.25rem}@keyframes message-pop{0%{transform:translateY(0.625rem);opacity:0}100%{transform:translateY(0);opacity:1}}.avatar{width:2.25rem;height:2.25rem;border-radius:50%;margin-top:.25rem;box-shadow:0 2px 4px rgba(0,0,0,.1);border:2px solid #fff;transition:transform .2s;cursor:pointer;object-fit:cover}.avatar:hover{transform:scale(1.1)}.message-wrapper{max-width:70%;display:flex;flex-direction:column;margin:0 .625rem}.message-content,.message-bubble{padding:.625rem .875rem;border-radius:1.125rem;font-size:.875rem;line-height:1.4;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,.1);position:relative;transition:transform .2s;cursor:pointer;animation:messageSlideIn .3s ease-out}.message-content:hover,.message-bubble:hover{transform:translateY(-0.125rem)}.message-time{font-size:.6875rem;color:#888;margin-top:.25rem;margin-left:.25rem;margin-right:.25rem}.chat-input{height:3.25rem;background:hsla(0,0%,100%,.95);padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;border-top:1px solid rgba(0,0,0,.05);backdrop-filter:blur(0.625rem);position:relative;border-bottom-left-radius:1.5rem;border-bottom-right-radius:1.5rem}.plus-btn{width:2rem;height:2rem;border:none;border-radius:50%;background:#f5f5f5;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;color:#666;flex-shrink:0}.plus-btn:hover{background:#e0e0e0;transform:scale(1.1)}.input-field{flex:1;height:2.25rem;border:1px solid rgba(0,0,0,.1);border-radius:1.125rem;background:#fff;padding:0 1rem;outline:none;font-size:.875rem;color:#333;transition:all .2s;margin-right:.5rem;max-width:calc(100% - 6rem)}.input-field:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}.input-field::placeholder{color:#999}.send-btn{width:2.25rem;height:2.25rem;border:none;border-radius:50%;background:#6c8cd5;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}.send-btn:hover{background:#4a6fbf;transform:scale(1.1)}@keyframes menuSlideUp{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}@media screen and (max-width:25rem){.phone-container{margin:.625rem;border-width:.5rem;width:calc(100% - 1.25rem)}.message-content{font-size:.8125rem}.input-field{max-width:calc(100% - 5.5rem)}}.user_avatar{background-size:cover;background-position:center}.message-image{max-width:9.375rem;max-height:9.375rem;border-radius:.5rem;display:block;margin:0 auto;object-fit:cover}.error-text{color:#999;font-style:italic}.random-image-container{display:inline-block;position:relative;min-width:6.25rem;max-width:100%;min-height:6.25rem;max-height:8.125rem;border:2px solid rgba(0,0,0,0);border-radius:.9375rem;margin:0 0 -0.375rem 0;overflow-y:auto;box-shadow:0 4px 8px rgba(255,182,193,.4);background-color:hsla(0,0%,100%,.8);backdrop-filter:blur(0.3125rem);scrollbar-width:none;-ms-overflow-style:none}.random-image-container .random-image-container::-webkit-scrollbar{display:none}.random-image-container details{position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer}.random-image-container details summary{list-style:none;width:100%;height:100%}.random-image-container details .attachment-content{position:absolute;top:.125rem;left:.125rem;right:.125rem;background:linear-gradient(135deg,rgba(255,192,203,0.4),rgba(255,182,193,0.4));color:#333;padding:.5rem;border-radius:.75rem;text-align:center}.random-image-container details .attachment-content .attachment-text{border:1px solid rgba(255,192,203,.3);padding:.75rem .5rem;width:calc(100% - .1875rem);text-align:center;word-wrap:break-word;border-radius:.625rem;background:hsla(0,0%,100%,.98);box-shadow:inset 0 0 8px rgba(255,192,203,.2)}.random-image-container details .attachment-content .attachment-text p{margin:0;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;font-size:.6875rem}.message-sticker{max-width:6.25rem;max-height:6.25rem;width:auto;height:auto;object-fit:contain;border-radius:.5rem}.transfer-bubble{background:#f8f8f8;border-radius:.75rem;padding:.625rem;width:7.8125rem;cursor:pointer;transition:all .3s}.transfer-bubble:hover{background:#f0f0f0}.transfer-bubble .transfer-content{display:flex;align-items:center;gap:.5rem}.transfer-bubble .transfer-content .transfer-icon{width:1.75rem;height:1.75rem;background:#6c8cd5;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}.transfer-bubble .transfer-content .transfer-icon svg{width:.875rem;height:.875rem;stroke:#fff;stroke-width:2;fill:none}.transfer-bubble .transfer-content .transfer-info{flex:1;min-width:0}.transfer-bubble .transfer-content .transfer-info .transfer-amount{font-size:.9375rem;font-weight:600;color:#333;margin-bottom:.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.transfer-bubble .transfer-content .transfer-info .transfer-status{font-size:.6875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#666}.transfer-bubble .transfer-content .transfer-info .transfer-status.waiting,.transfer-bubble .transfer-content .transfer-info .transfer-status.pending{color:#ff9800}.transfer-bubble .transfer-content .transfer-info .transfer-status.accepted,.transfer-bubble .transfer-content .transfer-info .transfer-status.completed{color:#4caf50}.transfer-bubble .transfer-content .transfer-info .transfer-status.rejected,.transfer-bubble .transfer-content .transfer-info .transfer-status.failed{color:#f44336}.voice-message{display:flex;align-items:center;gap:.5rem;cursor:pointer;transition:all .2s ease}.voice-message:hover{transform:scale(1.02)}.voice-message .voice-icon{width:1.25rem;height:1.25rem;color:#6c8cd5;flex-shrink:0;transition:color .2s ease;position:relative}.voice-message .voice-icon .mic-icon,.voice-message .voice-icon .pause-icon{transition:opacity .2s ease}.voice-message .voice-icon .pause-icon{display:none}.voice-message.expanded .voice-icon .mic-icon{display:none}.voice-message.expanded .voice-icon .pause-icon{display:block}.voice-message .voice-wave-container{display:flex;align-items:center;gap:.125rem;height:1.25rem;margin:0 .25rem}.voice-message .voice-wave{width:.1875rem;background:linear-gradient(to top,#6c8cd5,#8fa4e3);border-radius:2px;transform-origin:bottom}.voice-message .voice-wave:nth-child(1){height:.5rem;animation-delay:0s}.voice-message .voice-wave:nth-child(2){height:.75rem;animation-delay:.1s}.voice-message .voice-wave:nth-child(3){height:1rem;animation-delay:.2s}.voice-message .voice-wave:nth-child(4){height:.75rem;animation-delay:.3s}.voice-message .voice-wave:nth-child(5){height:.5rem;animation-delay:.4s}.voice-message .voice-duration{font-size:.875rem;color:inherit;font-weight:500}.voice-message.expanded .voice-wave{animation:voiceWave 1.5s ease-in-out infinite}.voice-message.expanded .voice-wave:nth-child(1){animation-delay:0s}.voice-message.expanded .voice-wave:nth-child(2){animation-delay:.1s}.voice-message.expanded .voice-wave:nth-child(3){animation-delay:.2s}.voice-message.expanded .voice-wave:nth-child(4){animation-delay:.3s}.voice-message.expanded .voice-wave:nth-child(5){animation-delay:.4s}.message.sent .voice-message .voice-icon{color:#fff}.message.sent .voice-message .voice-wave{background:linear-gradient(to top,#fff,rgba(255,255,255,0.8))}.message.sent .voice-message .voice-duration{color:#fff}@keyframes voiceWave{0%,100%{transform:scaleY(0.3);opacity:.7}50%{transform:scaleY(1);opacity:1}}.voice-transcript{margin-top:.5rem;padding:.5rem .75rem;background:rgba(108,140,213,.1);border-radius:.75rem;font-size:.8125rem;color:#666;font-style:italic;display:none}.voice-transcript.show{display:block;animation:fadeIn .3s ease-out}.message.sent .voice-transcript{background:hsla(0,0%,100%,.2);color:hsla(0,0%,100%,.9)}@keyframes fadeIn{from{opacity:0;transform:translateY(-0.3125rem)}to{opacity:1;transform:translateY(0)}}.location-message{display:flex;align-items:center;gap:.5rem;cursor:pointer}.location-message .location-icon{width:1.25rem;height:1.25rem;color:#4caf50;flex-shrink:0}.location-message .location-text{font-size:.875rem;color:#666}.message.sent .location-message .location-icon{color:#4ac84e}.message.sent .location-message .location-text{color:#fff}.fade-in{animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}.message.editing .message-content{background:rgba(255,235,59,.2) !important;border:2px dashed #ffc107}.message.pending{opacity:.7}.message.pending .message-content{background:rgba(108,140,213,.5) !important}.hidden{display:none !important}.visible{display:block !important}.sticker-suggestions{position:absolute;bottom:3.75rem;right:1rem;width:12.5rem;max-width:calc(100% - 2rem);background:#fff;border-radius:.5rem;box-shadow:0 3px 15px rgba(0,0,0,.12);opacity:0;transform:translateY(0.5rem) scale(0.95);transition:all .2s ease-out;z-index:1000;border:1px solid rgba(0,0,0,.08)}.sticker-suggestions.show{opacity:1;transform:translateY(0) scale(1)}.sticker-suggestions .suggestions-header{display:flex;justify-content:space-between;align-items:center;padding:.375rem .5rem;border-bottom:1px solid #f0f0f0;background:#f8f9fa;border-radius:.5rem .5rem 0 0}.sticker-suggestions .suggestions-header .suggestions-title{font-size:.6875rem;font-weight:600;color:#666}.sticker-suggestions .suggestions-header .suggestions-count{font-size:.625rem;color:#999;background:#e9ecef;padding:.0625rem .25rem;border-radius:.5rem}.sticker-suggestions .suggestions-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.25rem;padding:.375rem;max-height:5rem;overflow-y:auto}.sticker-suggestions .suggestions-grid .suggestion-item{aspect-ratio:1;border-radius:.25rem;overflow:hidden;cursor:pointer;transition:all .2s ease;border:1px solid rgba(0,0,0,0)}.sticker-suggestions .suggestions-grid .suggestion-item:hover{transform:scale(1.1);border-color:#6c8cd5;box-shadow:0 1px 4px rgba(108,140,213,.3)}.sticker-suggestions .suggestions-grid .suggestion-item:active{transform:scale(0.9)}.sticker-suggestions .suggestions-grid .suggestion-item img{width:100%;height:100%;object-fit:cover;display:block}.sticker-suggestions .suggestions-grid::-webkit-scrollbar{width:4px}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:2px}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.3)}@media screen and (max-width:25rem){.sticker-suggestions{width:10rem;right:.5rem}.sticker-suggestions .suggestions-grid{grid-template-columns:repeat(3,1fr);gap:.1875rem}}.transfer-modal .modal-header{text-align:center;margin-bottom:1rem}.transfer-modal .modal-header .modal-title{font-size:1rem;font-weight:600;color:#333;margin-bottom:.25rem}.transfer-modal .modal-header .modal-subtitle{font-size:.8125rem;color:#666}.transfer-modal .modal-amount{text-align:center;font-size:1.75rem;font-weight:600;color:#333;margin:1.25rem 0}.transfer-modal .modal-details{background:#f8f8f8;border-radius:.75rem;padding:.75rem;margin-bottom:1.25rem}.transfer-modal .modal-details .detail-row{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.8125rem}.transfer-modal .modal-details .detail-row:last-child{margin-bottom:0}.transfer-modal .modal-details .detail-row .detail-label{color:#666}.transfer-modal .modal-details .detail-row .detail-value{color:#333;font-weight:500}.transfer-modal .modal-buttons{display:flex;gap:.75rem}.transfer-modal .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .3s}.transfer-modal .modal-buttons .modal-btn.reject-btn{background:#f0f0f0;color:#666}.transfer-modal .modal-buttons .modal-btn.reject-btn:hover{background:#e0e0e0}.transfer-modal .modal-buttons .modal-btn.accept-btn{background:#6c8cd5;color:#fff}.transfer-modal .modal-buttons .modal-btn.accept-btn:hover{background:#4a6fbf}.transfer-bubble.user-transfer{cursor:default}.transfer-bubble.user-transfer:hover{background:#f8f8f8}.dynamic-bg{background-image:var(--bg-image);background-size:cover;background-position:center}.message-entering,.message-animation{opacity:0;transform:translateY(0.625rem);transition:opacity .3s ease,transform .3s ease}.message-entering.message-entered,.message-entering.show,.message-animation.message-entered,.message-animation.show{opacity:1;transform:translateY(0)}.click-feedback,.avatar-click-effect{transform:scale(0.98);transition:transform .1s ease}.avatar-click{transform:scale(0.9);transition:transform .1s ease}.sticker-animate,.sticker-animation{transform:scale(1.2) rotate(10deg);transition:transform .3s ease}.sticker-animate.sticker-animated,.sticker-animate.reset,.sticker-animation.sticker-animated,.sticker-animation.reset{transform:scale(1) rotate(0deg)}.toast-notification,.toast{position:fixed;top:1.25rem;left:50%;transform:translateX(-50%) translateY(-1.25rem);padding:.75rem 1.25rem;border-radius:.5rem;color:#fff;font-size:.875rem;z-index:10000;opacity:0;transition:all .3s ease;pointer-events:none}.toast-notification.show,.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast-notification.toast-error,.toast.toast-error{background:#ff4757}.toast-notification.toast-success,.toast.toast-success{background:#2ed573}.toast-notification.toast-warning,.toast.toast-warning{background:#ffa502}.toast-notification.toast-info,.toast.toast-info{background:#3742fa}.toast-notification,.toast{background:#333}@keyframes toastSlideIn{from{opacity:0;transform:translateX(-50%) translateY(-0.625rem)}to{opacity:1;transform:translateX(-50%) translateY(0)}}@keyframes toastFadeInOut{0%,100%{opacity:0;transform:translate(-50%,-50%) scale(0.9)}10%,90%{opacity:1;transform:translate(-50%,-50%) scale(1)}}.edit-overlay,.edit-modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;border-radius:1.5rem}.edit-dialog,.edit-modal-dialog{background:#fff;border-radius:.75rem;padding:1.25rem;width:18.75rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);animation:modalFadeIn .3s ease-out}.edit-dialog .edit-title,.edit-dialog .edit-modal-title,.edit-modal-dialog .edit-title,.edit-modal-dialog .edit-modal-title{margin:0 0 .9375rem 0;font-size:1.125rem;color:#333;font-weight:600}.edit-dialog .edit-textarea,.edit-dialog .edit-modal-textarea,.edit-modal-dialog .edit-textarea,.edit-modal-dialog .edit-modal-textarea{width:100%;height:6.25rem;border:1px solid #ddd;border-radius:.5rem;padding:.625rem;font-size:.875rem;resize:vertical;outline:none;margin-bottom:.9375rem;font-family:inherit}.edit-dialog .edit-textarea:focus,.edit-dialog .edit-modal-textarea:focus,.edit-modal-dialog .edit-textarea:focus,.edit-modal-dialog .edit-modal-textarea:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}.edit-dialog .edit-buttons,.edit-dialog .edit-modal-buttons,.edit-modal-dialog .edit-buttons,.edit-modal-dialog .edit-modal-buttons{display:flex;gap:.625rem;justify-content:flex-end;margin-top:.9375rem}.edit-dialog .edit-buttons .edit-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn,.edit-dialog .edit-modal-buttons .edit-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-buttons .edit-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn{padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:all .2s}.edit-dialog .edit-buttons .edit-btn.cancel-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.edit-dialog .edit-buttons .edit-btn.cancel-btn:hover,.edit-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn:hover{background:#e0e0e0}.edit-dialog .edit-buttons .edit-btn.save-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn.save-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn{background:#6c8cd5;color:#fff}.edit-dialog .edit-buttons .edit-btn.save-btn:hover,.edit-dialog .edit-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-dialog .edit-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn:hover{background:#4a6fbf}.edit-dialog .edit-buttons .edit-modal-cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.edit-dialog .edit-buttons .edit-modal-cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn:hover{background:#f5f5f5}.edit-dialog .edit-buttons .edit-modal-confirm-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn{background:#6c8cd5;color:#fff}.edit-dialog .edit-buttons .edit-modal-confirm-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn:hover{background:#5a7bc4}.accept-btn:hover{background:#5a7bc4 !important}.reject-btn:hover{background:#e0e0e0 !important}.sticker-selector{position:absolute;bottom:3.5rem;left:1rem;right:1rem;width:auto;background:hsla(0,0%,100%,.95);backdrop-filter:blur(0.625rem);border-radius:1rem;box-shadow:0 8px 32px rgba(0,0,0,.15);border:1px solid hsla(0,0%,100%,.2);padding:.75rem;z-index:1000;opacity:0;transform:translateY(1.25rem) scale(0.95);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);display:none;overflow:hidden;box-sizing:border-box}.sticker-selector.active{display:block}.sticker-selector.show{opacity:1;transform:translateY(0) scale(1)}.sticker-selector .sticker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;width:100%;height:10rem;overflow-y:auto;overflow-x:hidden;box-sizing:border-box}.sticker-selector .sticker-grid>*{min-width:0;max-width:100%;box-sizing:border-box}.sticker-selector .sticker-grid::-webkit-scrollbar{width:4px}.sticker-selector .sticker-grid::-webkit-scrollbar-track{background:rgba(0,0,0,.1);border-radius:.125rem}.sticker-selector .sticker-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.3);border-radius:2px}.sticker-selector .sticker-grid::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.5)}.sticker-selector .sticker-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;cursor:pointer;transition:all .2s ease;border:2px solid rgba(0,0,0,0);border-radius:.5rem;padding:.25rem;position:relative;width:100%;min-width:0;box-sizing:border-box}.sticker-selector .sticker-item:hover{transform:scale(1.05);border-color:#6c8cd5;box-shadow:0 4px 12px rgba(108,140,213,.4);z-index:10}.sticker-selector .sticker-item:active{transform:scale(0.95)}.sticker-selector .sticker-item .sticker-image{width:2.5rem;height:2.5rem;border-radius:.375rem;overflow:hidden;position:relative;flex-shrink:0}.sticker-selector .sticker-item .sticker-image img{width:100%;height:100%;object-fit:cover;display:block}.sticker-selector .sticker-item .sticker-note{font-size:.625rem;color:#666;text-align:center;margin-top:.125rem;line-height:1.2;width:100%;max-width:100%;box-sizing:border-box;height:1.5rem;word-wrap:break-word;word-break:break-all;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;-webkit-box-align:start}.sticker-selector .sticker-item .delete-checkbox{position:absolute;top:-0.125rem;right:-0.125rem;width:1rem;height:1rem;background:#fff;border:2px solid #ff4757;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:5}.sticker-selector .sticker-item .delete-checkbox.checked{background:#ff4757}.sticker-selector .sticker-item .delete-checkbox.checked::after{content:"âœ“";color:#fff;font-size:.625rem;font-weight:bold}.sticker-selector .sticker-item.delete-mode .delete-checkbox{display:flex}.sticker-selector .sticker-item.selected{border-color:#ff4757;background:rgba(255,71,87,.1)}.sticker-selector .sticker-item.dragging{opacity:.5;transform:rotate(5deg)}.sticker-selector .sticker-item.drag-over{border-color:#2ed573;background:rgba(46,213,115,.1)}.sticker-selector .add-sticker-btn{display:flex;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:rgba(108,140,213,.1);color:#6c8cd5;border:1px solid rgba(108,140,213,.2);border-radius:.5rem;cursor:pointer;transition:all .2s;box-sizing:border-box}.sticker-selector .add-sticker-btn:hover{background:rgba(108,140,213,.2);border-color:rgba(108,140,213,.4);transform:scale(1.05)}.sticker-selector .add-sticker-btn:active{transform:scale(0.95)}.sticker-selector .add-sticker-btn .add-icon{font-size:1.125rem;font-weight:bold}.sticker-selector .delete-mode-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:rgba(255,71,87,.1);color:#ff4757;border:1px solid rgba(255,71,87,.2);border-radius:.5rem;cursor:pointer;transition:all .2s;padding:.25rem;box-sizing:border-box}.sticker-selector .delete-mode-btn:hover{background:rgba(255,71,87,.2);border-color:rgba(255,71,87,.4);transform:scale(1.05)}.sticker-selector .delete-mode-btn:active{transform:scale(0.95)}.sticker-selector .delete-mode-btn.active{background:rgba(255,71,87,.2);border-color:#ff4757}.sticker-selector .delete-mode-btn .delete-icon{font-size:1rem;margin-bottom:.125rem}.sticker-selector .delete-mode-btn .delete-text{font-size:.5625rem;line-height:1;text-align:center}.sticker-selector .delete-confirm-btn{display:none;flex-direction:column;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:#ff4757;color:#fff;border:none;border-radius:.5rem;cursor:pointer;transition:all .2s;padding:.25rem;box-sizing:border-box}.sticker-selector .delete-confirm-btn.show{display:flex}.sticker-selector .delete-confirm-btn:hover{background:#ff3742;transform:scale(1.05)}.sticker-selector .delete-confirm-btn:active{transform:scale(0.95)}.sticker-selector .delete-confirm-btn.disabled{background:#ccc;color:#999;cursor:not-allowed}.sticker-selector .delete-confirm-btn.disabled:hover{background:#ccc;transform:none}.sticker-selector .delete-confirm-btn.disabled:active{transform:none}.sticker-selector .delete-confirm-btn .confirm-icon{font-size:.875rem;margin-bottom:.125rem}.sticker-selector .delete-confirm-btn .confirm-text{font-size:.5625rem;line-height:1;text-align:center}.sticker-selector .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:.5rem;color:#666;grid-column:span 2;box-sizing:border-box;width:100%}.sticker-selector .empty-state .empty-icon{font-size:1.5rem;margin-bottom:.25rem;opacity:.5}.sticker-selector .empty-state .empty-text{font-size:.6875rem;line-height:1.2;word-wrap:break-word}@keyframes stickerSelectorSlideUp{from{opacity:0;transform:translateY(1.25rem) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}#addStickerModalTemplate .modal-content,.add-sticker-modal .modal-content,.modal-container:has(.input-help) .modal-content,[id*=addSticker] .modal-content{display:flex;flex-direction:column;max-width:25rem;width:auto}#addStickerModalTemplate .modal-label,.add-sticker-modal .modal-label,.modal-container:has(.input-help) .modal-label,[id*=addSticker] .modal-label{display:block;margin-bottom:.5rem;font-weight:600;color:#333;font-size:.875rem}#addStickerModalTemplate .modal-label.modal-label-spaced,.add-sticker-modal .modal-label.modal-label-spaced,.modal-container:has(.input-help) .modal-label.modal-label-spaced,[id*=addSticker] .modal-label.modal-label-spaced{margin-top:1rem}#addStickerModalTemplate .modal-input,.add-sticker-modal .modal-input,.modal-container:has(.input-help) .modal-input,[id*=addSticker] .modal-input{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;margin-bottom:.75rem;outline:none;transition:border-color .2s}#addStickerModalTemplate .modal-input:focus,.add-sticker-modal .modal-input:focus,.modal-container:has(.input-help) .modal-input:focus,[id*=addSticker] .modal-input:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}#addStickerModalTemplate .modal-input::placeholder,.add-sticker-modal .modal-input::placeholder,.modal-container:has(.input-help) .modal-input::placeholder,[id*=addSticker] .modal-input::placeholder{color:#999}#addStickerModalTemplate .input-help,.add-sticker-modal .input-help,.modal-container:has(.input-help) .input-help,[id*=addSticker] .input-help{background:#f8f9fa;border:1px solid #e9ecef;border-radius:.5rem;padding:.75rem;margin-top:.5rem}#addStickerModalTemplate .input-help p,.add-sticker-modal .input-help p,.modal-container:has(.input-help) .input-help p,[id*=addSticker] .input-help p{margin:0 0 .5rem 0;font-weight:600;color:#495057;font-size:.75rem}#addStickerModalTemplate .input-help ul,.add-sticker-modal .input-help ul,.modal-container:has(.input-help) .input-help ul,[id*=addSticker] .input-help ul{margin:0;padding:0;list-style:none}#addStickerModalTemplate .input-help ul li,.add-sticker-modal .input-help ul li,.modal-container:has(.input-help) .input-help ul li,[id*=addSticker] .input-help ul li{position:relative;font-size:.6875rem;color:#6c757d;margin-bottom:.25rem;line-height:1.4;padding-left:.75rem}#addStickerModalTemplate .input-help ul li:before,.add-sticker-modal .input-help ul li:before,.modal-container:has(.input-help) .input-help ul li:before,[id*=addSticker] .input-help ul li:before{content:"â€¢";color:#ff6b6b;position:absolute;left:0;top:0}#addStickerModalTemplate .input-help ul li:last-child,.add-sticker-modal .input-help ul li:last-child,.modal-container:has(.input-help) .input-help ul li:last-child,[id*=addSticker] .input-help ul li:last-child{margin-bottom:0}.message-sender{font-size:.75rem;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;color:#fff;margin-bottom:.25rem;font-weight:400;line-height:1.2}.group-management-modal .modal-container{width:85%;max-width:20rem;aspect-ratio:3/5;overflow-y:auto}.group-management-modal .modal-container::-webkit-scrollbar{width:4px}.group-management-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,.1);border-radius:.125rem}.group-management-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.3);border-radius:.125rem;-webkit-transition:background .2s;transition:background .2s}.group-management-modal .modal-container::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.5)}.group-management-modal .modal-header{font-size:1rem;font-weight:600;color:#333;margin-bottom:1.25rem;text-align:center}.group-management-modal .group-info-section{margin-bottom:1.5rem}.group-management-modal .group-info-section .group-avatar-section{display:flex;flex-direction:column;align-items:center;margin-bottom:1rem}.group-management-modal .group-info-section .group-avatar-section .group-avatar-preview{width:5rem;height:5rem;border-radius:50%;object-fit:cover;margin-bottom:.75rem;border:.1875rem solid #f0f0f0}.group-management-modal .group-info-section .group-avatar-section .change-avatar-btn{background:#f8f9fa;border:1px solid #dee2e6;border-radius:.375rem;padding:.375rem .75rem;font-size:.75rem;color:#6c757d;cursor:pointer;transition:all .2s}.group-management-modal .group-info-section .group-avatar-section .change-avatar-btn:hover{background:#e9ecef;border-color:#adb5bd}.group-management-modal .group-info-section .group-name-section label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.375rem}.group-management-modal .group-info-section .group-name-section .group-name-input{width:100%;padding:.625rem .75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;outline:none;transition:border-color .2s}.group-management-modal .group-info-section .group-name-section .group-name-input:focus{border-color:#6c8cd5}.group-management-modal .group-members-section{margin-bottom:1.5rem}.group-management-modal .group-members-section .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.group-management-modal .group-members-section .section-header h4{font-size:1rem;font-weight:600;color:#333;margin:0}.group-management-modal .group-members-section .section-header .invite-member-btn{background:#6c8cd5;color:#fff;border:none;border-radius:.375rem;padding:.375rem .75rem;font-size:.75rem;cursor:pointer;transition:background-color .2s}.group-management-modal .group-members-section .section-header .invite-member-btn:hover{background:#5a7bc4}.group-management-modal .group-members-section .members-list{max-height:12.5rem;overflow-y:auto}.group-management-modal .group-members-section .members-list::-webkit-scrollbar{width:3px}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.125rem}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.15)}.group-management-modal .group-members-section .member-item{display:flex;align-items:center;padding:.5rem 0;border-bottom:1px solid #f0f0f0}.group-management-modal .group-members-section .member-item:last-child{border-bottom:none}.group-management-modal .group-members-section .member-item .member-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;margin-right:.75rem}.group-management-modal .group-members-section .member-item .member-info{flex:1}.group-management-modal .group-members-section .member-item .member-info .member-name{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.125rem}.group-management-modal .group-members-section .member-item .member-info .member-role{font-size:.75rem;color:#666}.group-management-modal .group-members-section .member-item .member-actions{display:flex;gap:.5rem}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn{background:#dc3545;color:#fff;border:none;border-radius:.25rem;padding:.25rem .375rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn:hover{background:#c82333}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn svg{width:.875rem;height:.875rem}.group-management-modal .modal-footer{display:flex;gap:.75rem}.group-management-modal .modal-footer .cancel-btn,.group-management-modal .modal-footer .save-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s}.group-management-modal .modal-footer .cancel-btn{background:#f5f5f5;color:#666}.group-management-modal .modal-footer .cancel-btn:hover{background:#e0e0e0}.group-management-modal .modal-footer .save-btn{background:#6c8cd5;color:#fff}.group-management-modal .modal-footer .save-btn:hover{background:#4a6fbf}.group-management-modal .modal-footer .save-btn:disabled{background:#ccc;cursor:not-allowed}@media (max-width:30rem){.group-management-modal .modal-container{width:85%;aspect-ratio:3/5}.group-management-modal .group-info-section .group-avatar-section .group-avatar-preview{width:3.75rem;height:3.75rem}.group-management-modal .group-members-section .members-list{max-height:9.375rem}.group-management-modal .group-members-section .member-item .member-avatar{width:2rem;height:2rem}}.profile-interface{position:absolute;top:0;left:0;width:100%;height:100%;background:#f5f7fa;border-radius:1.5rem;overflow:hidden;z-index:20;opacity:0;visibility:hidden;transition:all .3s ease}.profile-interface.active{opacity:1;visibility:visible}.interface-container .profile-interface.active{z-index:30}.chat-list-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;display:none}.chat-list-interface.active{display:block !important}.typing-indicator{display:inline-flex;gap:.125rem;align-items:center;padding:.125rem .25rem;margin-top:.125rem}.typing-dot{width:.25rem;height:.25rem;background:#666;border-radius:50%;animation:typing-bounce 1.4s infinite}.typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}@keyframes typing-bounce{0%,100%{transform:translateY(0);opacity:.5}50%{transform:translateY(-0.0625rem);opacity:.8}}.typing-message{animation:messageSlideIn .3s ease-out}@keyframes messageSlideIn{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}.danger-section{margin-top:1.5rem;padding:1rem;border:1px solid #ffebee;border-radius:.5rem;background:#fafafa}.danger-section .disband-btn{width:100%;background:#ff4757;color:#fff;border:none;padding:.75rem 1rem;border-radius:.375rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.danger-section .disband-btn:hover{background:#ff3838;transform:translateY(-0.0625rem);box-shadow:0 2px 8px rgba(255,71,87,.3)}.danger-section .disband-btn:active{transform:translateY(0)}.modal-footer{display:flex;justify-content:flex-end;align-items:center;padding:1rem;border-top:1px solid #e0e0e0;gap:.5rem}.modal-footer .cancel-btn{background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6;padding:.5rem 1rem;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:all .2s}.modal-footer .cancel-btn:hover{background:#e9ecef}.modal-footer .save-btn{background:#007bff;color:#fff;border:none;padding:.5rem 1rem;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:background-color .2s}.modal-footer .save-btn:hover{background:#0056b3}.invite-member-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1100;border-radius:1.5rem}.invite-modal-container{background:#fff;border-radius:.5rem;box-shadow:0 4px 20px rgba(0,0,0,.15);width:min(85%,17.5rem);aspect-ratio:3/4;overflow:hidden;display:flex;flex-direction:column;position:relative;margin:1rem}.invite-modal-header{padding:.75rem 1rem;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.invite-modal-header h3{margin:0;font-size:1rem;font-weight:600;color:#333}.invite-close-btn{background:none;border:none;font-size:1.25rem;color:#999;cursor:pointer;padding:0;width:1.75rem;height:1.75rem;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}.invite-close-btn:hover{background:#f0f0f0;color:#666}.invite-modal-body{flex:1;overflow:auto}.invite-modal-footer{padding:.75rem 1rem;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end;gap:.5rem}.invite-cancel-btn,.invite-confirm-btn{padding:.375rem .75rem;border-radius:.375rem;font-size:.8125rem;cursor:pointer;transition:all .2s;min-width:3.125rem}.invite-cancel-btn{background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6}.invite-cancel-btn:hover{background:#e9ecef}.invite-confirm-btn{background:#6c8cd5;color:#fff;border:none}.invite-confirm-btn:hover{background:#6c8cd5}.invite-contacts-list{flex:1;overflow-y:auto;padding:.5rem 0}.invite-contacts-list .invite-contact-item{display:flex;align-items:center;padding:.625rem 1rem;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer;transition:background-color .2s}.invite-contacts-list .invite-contact-item:hover{background:#f8f9fa}.invite-contacts-list .invite-contact-item .invite-contact-avatar{width:2.5rem;height:2.5rem;border-radius:50%;object-fit:cover;margin-right:.75rem;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.invite-contacts-list .invite-contact-item .invite-contact-info{flex:1}.invite-contacts-list .invite-contact-item .invite-contact-info .invite-contact-name{font-size:.875rem;font-weight:500;color:#333}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]{display:none}.invite-contacts-list .invite-contact-item .invite-contact-checkbox label{width:1.25rem;height:1.25rem;border:2px solid #6c8cd5;border-radius:.25rem;display:block;cursor:pointer;position:relative;transition:all .2s}.invite-contacts-list .invite-contact-item .invite-contact-checkbox label::after{content:"";position:absolute;left:.375rem;top:.125rem;width:.375rem;height:.625rem;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);opacity:0;transition:opacity .2s}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]:checked+label{background:#6c8cd5;border-color:#6c8cd5}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]:checked+label::after{opacity:1}.user-message-context-modal .modal-container{width:17.5rem;max-width:90vw}.user-message-context-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-bottom:.0625rem solid #e1e5e9}.user-message-context-modal .modal-header h3{margin:0;font-size:1rem;color:#333}.user-message-context-modal .modal-header .modal-close-btn{background:none;border:none;font-size:1.25rem;color:#666;cursor:pointer;padding:0;width:1.25rem;height:1.25rem;display:flex;align-items:center;justify-content:center}.user-message-context-modal .modal-header .modal-close-btn:hover{color:#333}.user-message-context-modal .modal-body{padding:1rem;display:flex;flex-direction:column;gap:.5rem}.user-message-context-modal .modal-body .modal-btn{width:100%;padding:.75rem 1rem;border-radius:.375rem;border:none;font-size:.875rem;cursor:pointer;transition:all .2s ease;font-weight:500}.user-message-context-modal .modal-body .modal-btn.delete-btn{background:#dc3545;color:#fff}.user-message-context-modal .modal-body .modal-btn.delete-btn:hover{background:#c82333;transform:translateY(-0.0625rem)}.user-message-context-modal .modal-body .modal-btn.reroll-btn{background:#6c8cd5;color:#fff}.user-message-context-modal .modal-body .modal-btn.reroll-btn:hover{background:#5a7bc4;transform:translateY(-0.0625rem)}@media (max-width:30rem){.user-message-context-modal .modal-container{width:16.25rem}.user-message-context-modal .modal-header{padding:.625rem .875rem}.user-message-context-modal .modal-header h3{font-size:.9375rem}.user-message-context-modal .modal-body{padding:.875rem}.user-message-context-modal .modal-body .modal-btn{padding:.625rem .875rem;font-size:.8125rem}}.batch-delete-toolbar{height:3.5rem;position:absolute;top:1.5rem;left:0;right:0;background:#f8f9fa;border-bottom:1px solid #e1e5e9;padding:1rem 1rem .75rem 1rem;z-index:200}.batch-delete-toolbar .toolbar-content{display:flex;justify-content:space-between;align-items:center}.batch-delete-toolbar .selected-count{font-size:.875rem;color:#333;font-weight:500}.batch-delete-toolbar .toolbar-buttons{display:flex;gap:.5rem}.batch-delete-toolbar .toolbar-btn{padding:.25rem .75rem;border-radius:.25rem;border:none;font-size:.8125rem;cursor:pointer;transition:all .2s ease}.batch-delete-toolbar .toolbar-btn.cancel-btn{background:#6c757d;color:#fff}.batch-delete-toolbar .toolbar-btn.cancel-btn:hover{background:#5a6268}.batch-delete-toolbar .toolbar-btn.delete-btn{background:#dc3545;color:#fff}.batch-delete-toolbar .toolbar-btn.delete-btn:hover:not(:disabled){background:#c82333}.batch-delete-toolbar .toolbar-btn.delete-btn:disabled{background:#ccc;cursor:not-allowed}.batch-delete-mode .message.selectable{position:relative;cursor:pointer;transition:all .2s ease;padding-left:1.875rem}.batch-delete-mode .message.selectable:hover{background-color:rgba(108,140,213,.1);border-radius:.5rem}.batch-delete-mode .message.selectable.selected{background-color:rgba(255,107,107,.15);border-left:.1875rem solid #ff6b6b;border-radius:.5rem}.batch-delete-mode .message.selectable .message-checkbox{position:absolute;left:.375rem;top:50%;transform:translateY(-50%);width:1.125rem;height:1.125rem;z-index:10;pointer-events:none}.batch-delete-mode .message.selectable .message-checkbox .checkbox-inner{width:1.125rem;height:1.125rem;border:.125rem solid #ddd;border-radius:.1875rem;background:#fff;position:relative;transition:all .2s ease}.batch-delete-mode .message.selectable .message-checkbox .checkbox-inner::after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.25rem;height:.5rem;border:solid #fff;border-width:0 .125rem .125rem 0;transform:rotate(45deg);opacity:0;transition:opacity .2s ease}.batch-delete-mode .message.selectable.selected .message-checkbox .checkbox-inner{background-color:#ff6b6b;border-color:#ff6b6b}.batch-delete-mode .message.selectable.selected .message-checkbox .checkbox-inner::after{opacity:1}.batch-delete-mode .chat-messages{padding-top:3.75rem}.delete-message-modal .modal-container{width:20rem;max-width:90vw;max-height:80%}.delete-message-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid #e1e5e9}.delete-message-modal .modal-header h3{margin:0;font-size:1.125rem;color:#333}.delete-message-modal .modal-header .modal-close-btn{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:0;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center}.delete-message-modal .modal-header .modal-close-btn:hover{color:#333}.delete-message-modal .modal-body{padding:1.25rem;max-height:50vh;overflow-y:auto}.delete-message-modal .delete-options{margin-bottom:1rem}.delete-message-modal .delete-options .delete-option{display:flex;align-items:center;margin-bottom:.5rem;cursor:pointer}.delete-message-modal .delete-options .delete-option input[type=radio]{margin-right:.5rem}.delete-message-modal .delete-options .delete-option span{font-size:.875rem;color:#333}.delete-message-modal .message-list{border:1px solid #e1e5e9;border-radius:.5rem;max-height:18.75rem;overflow-y:auto}.delete-message-modal .message-item{display:flex;align-items:center;padding:.75rem;border-bottom:1px solid #f0f2f5}.delete-message-modal .message-item:last-child{border-bottom:none}.delete-message-modal .message-item:hover{background-color:#f8f9fa}.delete-message-modal .message-item .message-checkbox{margin-right:.75rem;position:relative;cursor:pointer}.delete-message-modal .message-item .message-checkbox input[type=checkbox]{opacity:0;position:absolute;width:1.125rem;height:1.125rem}.delete-message-modal .message-item .message-checkbox .checkmark{display:inline-block;width:1.125rem;height:1.125rem;border:.125rem solid #ddd;border-radius:.1875rem;position:relative;transition:all .2s ease}.delete-message-modal .message-item .message-checkbox .checkmark::after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.25rem;height:.5rem;border:solid #fff;border-width:0 .125rem .125rem 0;transform:rotate(45deg);opacity:0;transition:opacity .2s ease}.delete-message-modal .message-item .message-checkbox input[type=checkbox]:checked+.checkmark{background-color:#6c8cd5;border-color:#6c8cd5}.delete-message-modal .message-item .message-checkbox input[type=checkbox]:checked+.checkmark::after{opacity:1}.delete-message-modal .message-item .message-preview{flex:1}.delete-message-modal .message-item .message-preview .message-sender{font-size:.75rem;color:#666;margin-bottom:.125rem}.delete-message-modal .message-item .message-preview .message-content-preview{font-size:.875rem;color:#333;margin-bottom:.125rem;line-height:1.4}.delete-message-modal .message-item .message-preview .message-time{font-size:.6875rem;color:#999}.delete-message-modal .modal-footer{display:flex;justify-content:flex-end;gap:.75rem;padding:1rem 1.25rem;border-top:1px solid #e1e5e9}.delete-message-modal .modal-footer .modal-btn{padding:.5rem 1rem;border-radius:.375rem;border:none;font-size:.875rem;cursor:pointer;transition:all .2s ease}.delete-message-modal .modal-footer .modal-btn.cancel-btn{background:#f5f7fa;color:#666}.delete-message-modal .modal-footer .modal-btn.cancel-btn:hover{background:#e9ecef}.delete-message-modal .modal-footer .modal-btn.delete-btn{background:#dc3545;color:#fff}.delete-message-modal .modal-footer .modal-btn.delete-btn:hover{background:#c82333}@media (max-width:30rem){.delete-message-modal .modal-container{width:95%}.delete-message-modal .message-item{padding:.5rem}.delete-message-modal .message-item .message-preview .message-content-preview{font-size:.8125rem}}.scale-control{margin-top:1rem}.scale-control .scale-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.scale-control .scale-info .scale-label{font-size:.875rem;color:#666;font-weight:500}.scale-control .scale-info .scale-value{font-size:.875rem;color:#6c8cd5;font-weight:600;background:#f0f4ff;padding:.25rem .5rem;border-radius:.375rem}.scale-control .scale-slider-container{position:relative}.scale-control .scale-slider-container .scale-slider{width:100%;height:.375rem;border-radius:.1875rem;background:#e0e0e0;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;margin:0;position:relative;z-index:2}.scale-control .scale-slider-container .scale-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;box-shadow:0 2px 4px rgba(108,140,213,.3);-webkit-transition:all .2s ease;transition:all .2s ease}.scale-control .scale-slider-container .scale-slider::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.scale-control .scale-slider-container .scale-slider::-moz-range-thumb{width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(108,140,213,.3);-moz-transition:all .2s ease;transition:all .2s ease}.scale-control .scale-slider-container .scale-slider::-moz-range-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.scale-control .scale-slider-container .scale-slider::-webkit-slider-track{height:.375rem;border-radius:.1875rem;background:linear-gradient(to right,#6c8cd5 0%,#6c8cd5 var(--progress,50%),#e0e0e0 var(--progress,50%),#e0e0e0 100%)}.scale-control .scale-slider-container .scale-slider::-moz-range-track{height:.375rem;border-radius:.1875rem;background:#e0e0e0;border:none}.scale-control .scale-slider-container .scale-slider::-moz-range-progress{height:.375rem;border-radius:.1875rem;background:#6c8cd5}.scale-control .scale-slider-container .scale-marks{position:relative;margin-top:.5rem;height:1rem;margin-left:.625rem;margin-right:.625rem;z-index:1}.scale-control .scale-slider-container .scale-marks .scale-mark{font-size:.75rem;color:#999;position:absolute;transform:translateX(-50%);text-align:center;white-space:nowrap}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(1){left:0%;transform:translateX(0)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(2){left:28.57%;transform:translateX(-50%)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(3){left:57.14%;transform:translateX(-50%)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(4){left:100%;transform:translateX(-100%)}.scale-control .scale-slider-container .scale-marks .scale-mark::before{content:"";position:absolute;top:-0.75rem;left:50%;transform:translateX(-50%);width:1px;height:.25rem;background:#ccc}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(1)::before{left:0;transform:none}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(4)::before{left:auto;right:0;transform:none}.setting-group{margin-bottom:2rem}.setting-group:last-child{margin-bottom:0}.setting-group .group-title{display:flex;align-items:center;gap:.5rem;font-size:1rem;font-weight:600;color:#333;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid #f0f0f0}.setting-group .group-title svg{color:#007aff}.setting-group .setting-item{margin-bottom:1.5rem}.setting-group .setting-item:last-child{margin-bottom:0}.setting-group .setting-item .item-header{margin-bottom:.5rem}.setting-group .setting-item .item-header .item-title{font-size:.9375rem;font-weight:500;color:#333}.setting-group .setting-item .item-description{font-size:.8125rem;color:#666;line-height:1.4;margin-bottom:.75rem}.typing-speed-control{margin-top:1rem}.typing-speed-control .typing-speed-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.typing-speed-control .typing-speed-info .typing-speed-label{font-size:.875rem;color:#666;font-weight:500}.typing-speed-control .typing-speed-info .typing-speed-value{font-size:.875rem;color:#6c8cd5;font-weight:600;background:#f0f4ff;padding:.25rem .5rem;border-radius:.375rem}.typing-speed-control .typing-speed-slider-container{position:relative}.typing-speed-control .typing-speed-slider-container .typing-speed-slider{width:100%;height:.375rem;border-radius:.1875rem;background:#e0e0e0;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;margin:0;position:relative;z-index:2}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;box-shadow:0 2px 4px rgba(108,140,213,.3);-webkit-transition:all .2s ease;transition:all .2s ease}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-thumb{width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(108,140,213,.3);-moz-transition:all .2s ease;transition:all .2s ease}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-track{height:.375rem;border-radius:.1875rem;background:linear-gradient(to right,#6c8cd5 0%,#6c8cd5 var(--typing-progress,33%),#e0e0e0 var(--typing-progress,33%),#e0e0e0 100%)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-track{height:.375rem;border-radius:.1875rem;background:#e0e0e0;border:none}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-progress{height:.375rem;border-radius:.1875rem;background:#6c8cd5}.typing-speed-control .typing-speed-slider-container .typing-speed-marks{position:relative;margin-top:.5rem;height:1rem;margin-left:.625rem;margin-right:.625rem;z-index:1}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark{font-size:.75rem;color:#999;position:absolute;transform:translateX(-50%);text-align:center;white-space:nowrap}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(1){left:0%;transform:translateX(0)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(2){left:33.33%;transform:translateX(-50%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(3){left:66.67%;transform:translateX(-50%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(4){left:100%;transform:translateX(-100%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark::before{content:"";position:absolute;top:-0.75rem;left:50%;transform:translateX(-50%);width:1px;height:.25rem;background:#ccc}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(1)::before{left:0;transform:none}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(4)::before{left:auto;right:0;transform:none}
.chat-list-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;display:none;background-image:url("https://files.catbox.moe/o84j4n.jpg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden}.chat-list-interface.active{display:block}.chat-list-interface .status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1}.chat-list-interface .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.chat-list-interface .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.chat-list-interface .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff}.chat-list-interface .chat-list-content{width:100%;height:calc(100% - 1.5rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;overflow-y:auto;position:relative;top:1.5rem}.chat-list-interface .chat-list-content::-webkit-scrollbar{width:6px}.chat-list-interface .chat-list-content::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-list-interface .chat-list-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.chat-list-interface .chat-list-item{padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer;transition:background .2s ease;position:relative;-webkit-user-select:none;user-select:none}.chat-list-interface .chat-list-item:hover{background:rgba(108,140,213,.1)}.chat-list-interface .chat-list-item.pinned{background:rgba(108,140,213,.1)}.chat-list-interface .chat-list-item.pinned::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(to bottom,#6c8cd5,#4a6fbf);z-index:1}.chat-list-interface .chat-list-item.long-press-detecting{background:rgba(108,140,213,.15)}.chat-list-interface .chat-list-item.long-press-detecting::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(108,140,213,.1);animation:longPressRipple .8s ease-out;pointer-events:none}.chat-list-interface .chat-list-item.long-pressed{background:rgba(108,140,213,.2);transform:scale(0.98);box-shadow:0 .125rem .5rem rgba(0,0,0,.1)}.chat-list-interface .chat-avatar{width:3rem;height:3rem;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.chat-list-interface .chat-info{flex:1;min-width:0}.chat-list-interface .chat-info .chat-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem}.chat-list-interface .chat-info .chat-list-header .chat-name{font-size:1rem;font-weight:600;color:#333}.chat-list-interface .chat-info .chat-list-header .chat-time{font-size:.75rem;color:#999}.chat-list-interface .chat-info .chat-preview{font-size:.875rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.chat-list-interface .unread-badge{min-width:1.25rem;height:1.25rem;padding:0 .375rem;background:#6c8cd5;color:#fff;font-size:.75rem;border-radius:.625rem;display:flex;align-items:center;justify-content:center;margin-left:.5rem}.chat-list-interface .unread-badge.show{display:flex}@keyframes longPressRipple{0%{opacity:.3;transform:scale(1)}50%{opacity:.1;transform:scale(1.02)}100%{opacity:0;transform:scale(1)}}.context-menu-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;background:rgba(0,0,0,0);pointer-events:auto}.context-menu{position:absolute;background:#fff;border-radius:.375rem;box-shadow:0 .125rem .5rem rgba(0,0,0,.12),0 .0625rem .1875rem rgba(0,0,0,.08);padding:0;min-width:auto;max-width:6rem;height:2rem;width:-moz-fit-content;width:fit-content;opacity:0;transform:scale(0.95);transition:all .12s ease-out;border:1px solid rgba(0,0,0,.05);display:flex;align-items:center}.context-menu.show{transform:scale(1);opacity:1}.context-menu.hiding{transform:scale(0.95);opacity:0}.context-menu .menu-arrow{position:absolute;width:.375rem;height:.375rem;background:#fff;border:1px solid rgba(0,0,0,.05);transform:rotate(45deg);z-index:-1}.context-menu .menu-arrow.arrow-right{left:-0.1875rem;top:50%;margin-top:-0.1875rem;border-right:none;border-bottom:none}.context-menu .menu-arrow.arrow-left{right:-0.1875rem;top:50%;margin-top:-0.1875rem;border-left:none;border-top:none}.context-menu .menu-arrow.arrow-bottom{bottom:-0.1875rem;left:50%;margin-left:-0.1875rem;border-top:none;border-left:none}.context-menu .menu-arrow.arrow-top{bottom:-0.1875rem;left:50%;margin-left:-0.1875rem;border-top:none;border-left:none}.context-menu .menu-content{display:flex;flex-direction:column;gap:.02rem;height:100%;padding:.05rem}.context-menu .menu-content.horizontal{flex-direction:row;gap:.05rem;align-items:stretch}.context-menu .menu-item{display:flex;align-items:center;gap:.15rem;padding:.1rem .35rem;border:none;background:rgba(0,0,0,0);border-radius:.2rem;cursor:pointer;transition:all .15s ease;font-size:.65rem;color:#333;text-align:left;height:100%;min-height:auto;white-space:nowrap}.context-menu .menu-item:hover{background:rgba(108,140,213,.1);transform:translateY(-0.0625rem)}.context-menu .menu-item:active{background:rgba(108,140,213,.2);transform:translateY(0) scale(0.98)}.context-menu .menu-item .menu-icon{font-size:.75rem;line-height:1;flex-shrink:0;width:.8rem;text-align:center}.context-menu .menu-item .menu-text{font-weight:600;line-height:1.1;flex:1;font-size:.65rem}.context-menu .menu-item.pin-item .menu-icon{color:#6c8cd5}.context-menu .menu-item.pin-item:hover{background:rgba(108,140,213,.15)}.context-menu .menu-item.pin-item:hover .menu-text{color:#4a6fbf}.context-menu .menu-item.delete-item .menu-icon{color:#e74c3c}.context-menu .menu-item.delete-item:hover{background:rgba(231,76,60,.1)}.context-menu .menu-item.delete-item:hover .menu-text{color:#c0392b}.context-menu .menu-content.horizontal .menu-item{flex:1;justify-content:center;min-width:0;padding:.2rem .3rem;max-width:2.5rem}.context-menu .menu-content.horizontal .menu-item .menu-text{text-align:center;font-size:.65rem;font-weight:600}@keyframes menuFadeIn{0%{opacity:0;transform:scale(0.8) translateY(-0.625rem)}100%{opacity:1;transform:scale(1) translateY(0)}}@keyframes menuFadeOut{0%{opacity:1;transform:scale(1) translateY(0)}100%{opacity:0;transform:scale(0.8) translateY(-0.625rem)}}@media (max-width:30rem){.context-menu .menu-item{padding:.875rem 1.125rem;font-size:.9375rem}.context-menu .menu-item .menu-icon{font-size:1.125rem;width:1.375rem}}@media (prefers-contrast:high){.context-menu{border:2px solid #000;box-shadow:0 .25rem .75rem rgba(0,0,0,.3)}.context-menu .menu-arrow{border-color:#000}.context-menu .menu-item{border:1px solid rgba(0,0,0,0)}.context-menu .menu-item:hover{border-color:#000;background:#f0f0f0}}@media (prefers-reduced-motion:reduce){.context-menu{transition:opacity .1s ease}.context-menu.show{transform:scale(1) translateY(0)}.context-menu .menu-item{transition:background-color .1s ease}.context-menu .menu-item:hover{transform:none}.context-menu .menu-item:active{transform:none}}.bottom-nav{position:absolute;bottom:0;left:0;width:100%;height:3.125rem;background:#fff;border-top:1px solid rgba(255,105,180,.1);display:flex;justify-content:space-around;align-items:center;z-index:10;border-bottom-left-radius:1.5rem;border-bottom-right-radius:1.5rem}.bottom-nav .bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;color:#666;font-size:.75rem;cursor:pointer;transition:all .3s ease;padding:.3125rem 0;flex:1}.bottom-nav .bottom-nav-item.active{color:hotpink}.bottom-nav .bottom-nav-item:hover{color:hotpink;transform:translateY(-0.125rem)}.bottom-nav .bottom-nav-item .nav-icon{width:1.6875rem;height:1.6875rem;background-size:contain;background-repeat:no-repeat;background-position:center;background-image:url("https://files.catbox.moe/zilfqn.png");transition:filter .3s ease}.bottom-nav .bottom-nav-item .bottom-nav-text{font-weight:500;transition:color .3s ease}.chat-list-content{width:100%;height:calc(100% - 1.5rem - 3.125rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;overflow-y:auto;position:relative;top:1.5rem}.chat-list-content::-webkit-scrollbar{width:6px}.chat-list-content::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-list-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.new-chat-btn{position:absolute;bottom:4.625rem;right:1.5rem;width:3rem;height:3rem;border-radius:50%;background:#6c8cd5;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 .25rem .5rem rgba(0,0,0,.2);transition:transform .2s;z-index:100}.new-chat-btn:hover{transform:scale(1.1)}.new-chat-btn svg{width:1.25rem;height:1.25rem}.empty-chat-list{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:2.5rem 1.25rem;text-align:center}.empty-chat-list .empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.6}.empty-chat-list .empty-text{font-size:1.125rem;font-weight:600;color:#666;margin-bottom:.5rem}.empty-chat-list .empty-hint{font-size:.875rem;color:#999;line-height:1.4}.new-chat-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.new-chat-modal.show{opacity:1}.new-chat-modal .modal-container{width:18.75rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.new-chat-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.new-chat-modal .modal-container .chat-type-options{display:flex;gap:.75rem;margin-bottom:1.5rem}.new-chat-modal .modal-container .chat-type-options .chat-type-option{flex:1;padding:.75rem;border:2px solid #6c8cd5;border-radius:.75rem;text-align:center;cursor:pointer;color:#6c8cd5;font-weight:500;transition:all .2s}.new-chat-modal .modal-container .chat-type-options .chat-type-option:hover,.new-chat-modal .modal-container .chat-type-options .chat-type-option.selected{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .contact-list{max-height:12.5rem;overflow-y:auto}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar{width:6px}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.new-chat-modal .modal-container .contact-list .contact-item{display:flex;align-items:center;gap:.75rem;padding:.5rem;cursor:pointer;border-radius:.5rem;transition:background .2s;position:relative}.new-chat-modal .modal-container .contact-list .contact-item:hover{background:rgba(108,140,213,.1)}.new-chat-modal .modal-container .contact-list .contact-item.selected{background:rgba(108,140,213,.2)}.new-chat-modal .modal-container .contact-list .contact-item .contact-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover}.new-chat-modal .modal-container .contact-list .contact-item .contact-name{font-size:.875rem;color:#333;flex:1}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions{display:flex;gap:.375rem;margin-left:auto;margin-right:.5rem}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn{width:1.75rem;height:1.75rem;border:none;border-radius:.375rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;opacity:.7}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn:hover,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn:hover{opacity:1;transform:scale(1.05)}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn svg,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn svg{width:.875rem;height:.875rem}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn{background:#f0f4ff;color:#6c8cd5}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn:hover{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn{background:#ffeaea;color:#e74c3c}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn:hover{background:#e74c3c;color:#fff}.new-chat-modal .modal-container .contact-list .contact-item .checkbox{width:1.125rem;height:1.125rem;border:2px solid #6c8cd5;border-radius:4px;display:none;position:absolute;right:.75rem;transition:all .2s}.new-chat-modal .modal-container .contact-list .contact-item .checkbox:after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.3125rem;height:.625rem;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);opacity:0}.new-chat-modal .modal-container .contact-list .contact-item.selected .checkbox{background:#6c8cd5}.new-chat-modal .modal-container .contact-list .contact-item.selected .checkbox:after{opacity:1}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item{margin-bottom:.5rem;color:#6c8cd5;font-weight:500}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item:hover{background:rgba(108,140,213,.1)}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon{width:2.25rem;height:2.25rem;border-radius:50%;background:#6c8cd5;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:bold;line-height:1 !important;text-align:center;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:0;vertical-align:baseline;position:relative}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon::before{content:none}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon::after{content:none}.new-chat-modal .modal-container .contact-list .empty-contacts-hint{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:1.25rem;color:#666}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-icon{font-size:2rem;margin-bottom:.5rem;opacity:.6}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-text{font-size:.875rem;font-weight:500;color:#666;margin-bottom:.25rem}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-hint{font-size:.75rem;color:#999;line-height:1.4}.new-chat-modal .modal-container.group-mode .contact-item .checkbox{display:block}.new-chat-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.new-chat-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.new-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.new-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.new-chat-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.new-chat-modal.group-mode .contact-actions .edit-btn,.new-chat-modal.group-mode .contact-actions .delete-btn{display:none !important}.add-friend-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.add-friend-modal.show{opacity:1}.add-friend-modal .modal-container{width:17.5rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.add-friend-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.add-friend-modal .modal-container .add-friend-form .form-group{margin-bottom:1rem}.add-friend-modal .modal-container .add-friend-form .form-group label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.5rem}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text],.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]{width:100%;padding:.75rem;border:.125rem solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text]:focus,.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]:focus{outline:none;border-color:#6c8cd5}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text]::placeholder,.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]::placeholder{color:#999}.add-friend-modal .modal-container .add-friend-form .form-group input[type=file]{width:100%;padding:.5rem;border:.125rem dashed #e0e0e0;border-radius:.5rem;background:#f9f9f9;cursor:pointer}.add-friend-modal .modal-container .add-friend-form .form-group input[type=file]:hover{border-color:#6c8cd5;background:#f0f4ff}.add-friend-modal .modal-container .add-friend-form .form-group .error-message{color:#e74c3c;font-size:.75rem;margin-top:.25rem;display:none}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn{width:100%;padding:.75rem 1rem;border:.125rem solid #6c8cd5;border-radius:.5rem;background:#fff;color:#6c8cd5;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn:hover{background:#6c8cd5;color:#fff;transform:translateY(-0.0625rem);box-shadow:0 .125rem .5rem rgba(108,140,213,.3)}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn:active{transform:translateY(0)}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn svg{flex-shrink:0}.add-friend-modal .modal-container .add-friend-form .avatar-options{display:flex;gap:1rem;margin-bottom:.5rem}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option{display:flex;align-items:center;gap:.375rem}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option input[type=radio]{margin:0}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option label{margin:0;font-size:.875rem;cursor:pointer}.add-friend-modal .modal-container .add-friend-form .avatar-preview{display:flex;justify-content:center;align-items:center;margin-top:1rem}.add-friend-modal .modal-container .add-friend-form .avatar-preview img{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:.1875rem solid #6c8cd5;box-shadow:0 .125rem .5rem rgba(0,0,0,.1);display:block}.add-friend-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.add-friend-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.add-friend-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.add-friend-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.add-friend-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.add-friend-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.edit-contact-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.edit-contact-modal.show{opacity:1}.edit-contact-modal .modal-container{width:17.5rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.edit-contact-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.edit-contact-modal .modal-container .edit-contact-form .form-group{margin-bottom:1rem}.edit-contact-modal .modal-container .edit-contact-form .form-group label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.5rem}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text],.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]{width:100%;padding:.75rem;border:.125rem solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text]:focus,.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]:focus{outline:none;border-color:#6c8cd5}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text]::placeholder,.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]::placeholder{color:#999}.edit-contact-modal .modal-container .edit-contact-form .form-group .error-message{color:#e74c3c;font-size:.75rem;margin-top:.25rem;display:none}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn{width:100%;padding:.75rem 1rem;border:.125rem solid #6c8cd5;border-radius:.5rem;background:#fff;color:#6c8cd5;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn:hover{background:#6c8cd5;color:#fff;transform:translateY(-0.0625rem);box-shadow:0 .125rem .5rem rgba(108,140,213,.3)}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn:active{transform:translateY(0)}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn svg{flex-shrink:0}.edit-contact-modal .modal-container .edit-contact-form .avatar-options{display:flex;gap:1rem;margin-bottom:.5rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option{display:flex;align-items:center;gap:.375rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option input[type=radio]{margin:0}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option label{margin:0;font-size:.875rem;cursor:pointer}.edit-contact-modal .modal-container .edit-contact-form .avatar-preview{display:flex;justify-content:center;align-items:center;margin-top:1rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-preview img{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:.1875rem solid #6c8cd5;box-shadow:0 .125rem .5rem rgba(0,0,0,.1);display:block}.edit-contact-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.edit-contact-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.edit-contact-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.edit-contact-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.edit-contact-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.edit-contact-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.delete-confirm-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.delete-confirm-modal.show{opacity:1}.delete-confirm-modal .modal-container{width:18.75rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.delete-confirm-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333;text-align:center}.delete-confirm-modal .modal-container .delete-confirm-content{text-align:center;margin-bottom:1.5rem}.delete-confirm-modal .modal-container .delete-confirm-content .warning-icon{font-size:3rem;margin-bottom:1rem}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message{margin-bottom:1.25rem}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message p{margin:0 0 .5rem 0;color:#333;line-height:1.4}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message .delete-note{font-size:.75rem;color:#666;font-style:italic}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message strong{color:#e74c3c}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:.75rem;background:#f8f9fa;border-radius:.5rem;border:1px solid #e0e0e0}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview .preview-avatar{width:2.5rem;height:2.5rem;border-radius:50%;object-fit:cover}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview .preview-name{font-size:.875rem;font-weight:500;color:#333}.delete-confirm-modal .modal-container .modal-buttons{display:flex;gap:.75rem}.delete-confirm-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.delete-btn{background:#e74c3c;color:#fff}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.delete-btn:hover{background:#c0392b}
.chat-time-container{position:relative;display:flex;flex-direction:column;align-items:flex-end;gap:.375rem}.unread-badge{position:absolute;top:1.375rem;right:.125rem;width:18px;height:18px;min-width:18px;background:linear-gradient(135deg,#ff4757,#ff3742);border-radius:50%;opacity:0;transform:scale(0.8);transition:all .2s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 1px 3px rgba(255,71,87,.4);color:#fff;font-size:.625rem;font-weight:600;display:flex;align-items:center;justify-content:center;line-height:1;padding:0}.unread-badge.show{opacity:1;transform:scale(1)}.unread-badge.bounce{animation:unreadBadgeBounce .6s cubic-bezier(0.68,-0.55,0.265,1.55)}.unread-badge.pulse{animation:unreadBadgePulse 1s ease-in-out}@media (prefers-color-scheme:dark){.unread-badge{box-shadow:0 1px 3px rgba(255,71,87,.5)}}@media (max-width:768px){.unread-badge{width:16px;height:16px;min-width:16px;font-size:9px}}@keyframes unreadBadgeBounce{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}@keyframes unreadBadgePulse{0%,100%{transform:scale(1);box-shadow:0 1px 3px rgba(255,71,87,.4)}50%{transform:scale(1.1);box-shadow:0 2px 6px rgba(255,71,87,.6)}}.chat-list-item{position:relative}.chat-list-item:has(.unread-badge.show) .chat-name{font-weight:600;color:#2c3e50}.chat-list-item:has(.unread-badge.show) .chat-preview{color:#34495e}@media (prefers-color-scheme:dark){.chat-list-item:has(.unread-badge.show) .chat-name{color:#ecf0f1}.chat-list-item:has(.unread-badge.show) .chat-preview{color:#bdc3c7}}
.profile-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;display:none;background-image:url("https://files.catbox.moe/o84j4n.jpg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden}.profile-interface.active{display:block}.profile-interface .status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1}.profile-interface .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.profile-interface .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.profile-interface .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff}.profile-interface .profile-content{width:100%;height:calc(100% - 1.5rem - 3.125rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;position:relative;top:1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 1.25rem;gap:2.5rem}.profile-interface .user-info-section{display:flex;flex-direction:column;align-items:center;gap:1.25rem;width:100%;max-width:18.75rem}.profile-interface .user-info-section .user-avatar{position:relative;width:7.5rem;height:7.5rem;border-radius:50%;overflow:hidden;border:4px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;transition:all .3s ease}.profile-interface .user-info-section .user-avatar:hover{transform:scale(1.05);box-shadow:0 .375rem 1rem rgba(0,0,0,.2)}.profile-interface .user-info-section .user-avatar img{width:100%;height:100%;object-fit:cover}.profile-interface .user-info-section .user-avatar .avatar-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s ease;color:#fff;font-size:.875rem;font-weight:500}.profile-interface .user-info-section .user-avatar .avatar-overlay svg{width:1.5rem;height:1.5rem;margin-bottom:.25rem}.profile-interface .user-info-section .user-avatar:hover .avatar-overlay{opacity:1}.profile-interface .user-info-section .user-avatar.loading .avatar-overlay{opacity:1;background:rgba(108,140,213,.8)}.profile-interface .user-info-section .user-name{position:relative;text-align:center}.profile-interface .user-info-section .user-name .name-display{font-size:1.5rem;font-weight:600;color:#333;cursor:pointer;padding:.5rem 1rem;border-radius:.5rem;transition:all .2s ease;min-width:7.5rem;display:inline-block}.profile-interface .user-info-section .user-name .name-display:hover{background:rgba(108,140,213,.1)}.profile-interface .user-info-section .user-name .name-edit{display:none;flex-direction:column;gap:.75rem;align-items:center}.profile-interface .user-info-section .user-name .name-edit.active{display:flex}.profile-interface .user-info-section .user-name .name-edit input{font-size:1.125rem;font-weight:600;color:#333;text-align:center;border:2px solid #6c8cd5;border-radius:.5rem;padding:.5rem 1rem;background:#fff;width:100%;outline:none}.profile-interface .user-info-section .user-name .name-edit input:focus{border-color:#4a6fbf;box-shadow:0 0 0 .1875rem rgba(108,140,213,.1)}.profile-interface .user-info-section .user-name .name-edit .edit-buttons{display:flex;gap:.75rem}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn{padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.confirm-btn{background:#6c8cd5;color:#fff}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.confirm-btn:hover{background:#4a6fbf;transform:translateY(-0.0625rem)}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.cancel-btn{background:#f5f5f5;color:#666}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.cancel-btn:hover{background:#e0e0e0}.profile-interface .settings-section{width:100%;max-width:18.75rem;display:flex;flex-direction:column;gap:.75rem}.profile-interface .settings-section .settings-button{width:100%;padding:1rem 1.5rem;background:#fff;border:2px solid #6c8cd5;border-radius:.75rem;color:#6c8cd5;font-size:1.125rem;font-weight:600;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:.75rem;box-shadow:0 .125rem .5rem rgba(0,0,0,.1)}.profile-interface .settings-section .settings-button:hover:not(:disabled){background:#6c8cd5;color:#fff;transform:translateY(-0.125rem);box-shadow:0 .25rem .75rem rgba(108,140,213,.3)}.profile-interface .settings-section .settings-button:disabled{opacity:.6;cursor:not-allowed;transform:none}.profile-interface .settings-section .settings-button svg{width:1.5rem;height:1.5rem}.profile-interface .settings-section .settings-button#extensionSettingsButton{border-color:#48bb78;color:#48bb78}.profile-interface .settings-section .settings-button#extensionSettingsButton:hover:not(:disabled){background:#48bb78;color:#fff;box-shadow:0 .25rem .75rem rgba(72,187,120,.3)}.settings-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;visibility:hidden;transition:all .3s ease}.settings-modal.show{opacity:1;visibility:visible}.settings-modal .modal-container{width:90%;max-width:25rem;max-height:80%;background:#fff;border-radius:1rem;padding:1.5rem;position:relative;overflow-y:auto;transform:scale(0.9) translateY(1.25rem);transition:transform .3s ease}.settings-modal .modal-container::-webkit-scrollbar{width:6px}.settings-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.settings-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:3px}.settings-modal.show .modal-container{transform:scale(1) translateY(0)}.settings-modal .modal-header{position:relative;text-align:center;margin-bottom:1.5rem;border-bottom:1px solid #f0f0f0}.settings-modal .modal-header .modal-title{font-size:1.125rem;font-weight:600;color:#333;line-height:1.5}.settings-modal .modal-header .close-btn{position:absolute;top:-0.75rem;right:-0.75rem;width:2rem;height:2rem;border:none;background:rgba(0,0,0,0);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.settings-modal .modal-header .close-btn:hover{background:rgba(0,0,0,.05)}.settings-modal .modal-header .close-btn svg{width:1.25rem;height:1.25rem;color:#888}.settings-modal .modal-content .setting-group{margin-bottom:2rem}.settings-modal .modal-content .setting-group:last-child{margin-bottom:0}.settings-modal .modal-content .setting-group .group-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}.settings-modal .modal-content .setting-group .group-title svg{width:1.25rem;height:1.25rem;color:#6c8cd5}.settings-modal .modal-content .setting-group .setting-item{margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.settings-modal .modal-content .setting-group .setting-item:last-child{margin-bottom:0}.settings-modal .modal-content .setting-group .setting-item .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.settings-modal .modal-content .setting-group .setting-item .item-header .item-title{font-size:1rem;font-weight:500;color:#333}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch{position:relative;width:3rem;height:1.5rem;background:#ccc;border-radius:.75rem;cursor:pointer;transition:background .3s ease}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch.active{background:#6c8cd5}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch .toggle-handle{position:absolute;top:.125rem;left:.125rem;width:1.25rem;height:1.25rem;background:#fff;border-radius:50%;transition:transform .3s ease;box-shadow:0 .125rem .25rem rgba(0,0,0,.2)}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch.active .toggle-handle{transform:translateX(1.5rem)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn{display:flex;align-items:center;gap:.25rem;padding:.375rem .75rem;border:none;border-radius:.375rem;font-size:.75rem;font-weight:500;cursor:pointer;transition:all .2s ease;background:#6c8cd5;color:#fff;min-width:auto;height:auto}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn:hover{background:#5a7bc4;transform:translateY(-0.0625rem)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn:active{transform:translateY(0)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn.danger-btn{background:#e74c3c;color:#fff}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn.danger-btn:hover{background:#c0392b}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn svg{width:.875rem;height:.875rem;flex-shrink:0}.settings-modal .modal-content .setting-group .setting-item .item-description{font-size:.875rem;color:#666;line-height:1.4}.settings-modal .modal-content .setting-group .setting-item .upload-area{border:2px dashed #d9dde4;border-radius:8px;padding:1rem;cursor:pointer;transition:all .2s ease;background:linear-gradient(135deg,#fdfdff 0%,#f8faff 100%);display:flex !important;align-items:center;justify-content:center;gap:.75rem;height:5rem;margin-top:.75rem;position:relative;overflow:hidden}.settings-modal .modal-content .setting-group .setting-item .upload-area::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 30%,rgba(108,140,213,0.05) 50%,transparent 70%);opacity:0;transition:opacity .3s ease}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover{border-color:#6c8cd5;background:linear-gradient(135deg,#f7f9ff 0%,#f0f4ff 100%);transform:translateY(-1px);box-shadow:0 6px 20px rgba(108,140,213,.15)}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover::before{opacity:1}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-icon{transform:scale(1.1);color:#5a7bc8}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-text{color:#333}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-icon{width:1.5rem;height:1.5rem;color:#6c8cd5;flex-shrink:0;transition:all .2s ease;filter:drop-shadow(0 1px 2px rgba(108,140,213,0.2))}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-info{display:flex;flex-direction:column;align-items:flex-start;gap:.125rem}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-text{font-size:.875rem;color:#555;font-weight:600;transition:color .2s ease;letter-spacing:.01em;line-height:1.2}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-hint{font-size:.75rem;color:#888;line-height:1.3;opacity:.8;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-hint{opacity:1}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview{margin-top:.75rem;border-radius:8px;overflow:hidden;position:relative;transition:all .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview img{width:100%;height:5rem;object-fit:cover;display:block}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay{position:absolute;top:0;right:0;padding:4px;display:flex;gap:4px;opacity:0;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn,.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn{width:24px;height:24px;border:none;color:#fff;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn svg,.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn svg{width:12px;height:12px}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn{background:rgba(0,0,0,.6)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn:hover{background:rgba(231,76,60,.8)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn{background:rgba(46,204,113,.6)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn:hover{background:rgba(46,204,113,.8)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover .preview-overlay{opacity:1}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview::after{content:"ç‚¹å‡»æ›´æ¢å£çº¸";position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);color:#fff;text-align:center;padding:4px;font-size:12px;opacity:0;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover::after{opacity:1}.confirm-dialog-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10;border-radius:1.5rem}.confirm-dialog-overlay .confirm-dialog{background:#fff;border-radius:.75rem;padding:1.5rem;max-width:20rem;width:90%;box-shadow:0 .5rem 2rem rgba(0,0,0,.3);position:relative;z-index:11;animation:dialogFadeIn .3s ease}.confirm-dialog-overlay .confirm-dialog .dialog-header{margin-bottom:1rem;text-align:center}.confirm-dialog-overlay .confirm-dialog .dialog-header h3{margin:0;font-size:1.125rem;font-weight:600;color:#e74c3c}.confirm-dialog-overlay .confirm-dialog .dialog-content{margin-bottom:1.5rem}.confirm-dialog-overlay .confirm-dialog .dialog-content p{margin:0;font-size:.875rem;line-height:1.5;color:#333;text-align:center}.confirm-dialog-overlay .confirm-dialog .dialog-buttons{display:flex;gap:.75rem;justify-content:center}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button{padding:.625rem 1.25rem;border:none;border-radius:.375rem;font-size:.875rem;cursor:pointer;font-weight:500;transition:all .2s}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.cancel-btn{background:#f0f0f0;color:#666}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.cancel-btn:hover{background:#e0e0e0}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn{background:#e74c3c;color:#fff}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn:hover{background:#c0392b}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn.danger{background:#e74c3c}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn.danger:hover{background:#c0392b}@keyframes dialogFadeIn{from{opacity:0;transform:scale(0.9) translateY(-1.25rem)}to{opacity:1;transform:scale(1) translateY(0)}}@media (max-width:30rem){.profile-interface .profile-content{padding:1.25rem 1rem;gap:1.875rem}.profile-interface .user-info-section .user-avatar{width:6.25rem;height:6.25rem}.profile-interface .user-info-section .user-name .name-display{font-size:1.25rem}.profile-interface .settings-section{gap:.5rem}.profile-interface .settings-section .settings-button{font-size:1rem;padding:.875rem 1.25rem}.settings-modal .modal-container{width:95%;padding:1.25rem}}@keyframes fadeIn{from{opacity:0;transform:translateY(1.25rem)}to{opacity:1;transform:translateY(0)}}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}.loading-spinner{width:1.25rem;height:1.25rem;border:2px solid #f3f3f3;border-top:2px solid #6c8cd5;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.extension-settings-modal .migration-btn{position:relative}.extension-settings-modal .migration-btn .btn-status{position:absolute;top:1rem;right:1.25rem;font-size:.75rem;font-weight:500;padding:.25rem .5rem;border-radius:.375rem;transition:all .3s ease}.extension-settings-modal .migration-btn.enabled{background:linear-gradient(135deg,rgba(72,187,120,0.1),rgba(56,161,105,0.1));border-color:rgba(72,187,120,.3)}.extension-settings-modal .migration-btn.enabled:hover:not(:disabled){background:linear-gradient(135deg,rgba(72,187,120,0.15),rgba(56,161,105,0.15));border-color:rgba(72,187,120,.5);transform:translateY(-2px);box-shadow:0 8px 25px rgba(72,187,120,.2)}.extension-settings-modal .migration-btn.enabled .btn-text{color:#2f855a}.extension-settings-modal .migration-btn.enabled .btn-status{background:rgba(72,187,120,.2);color:#2f855a}.extension-settings-modal .migration-btn.disabled{background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(248,250,252,0.9));border-color:rgba(0,0,0,.1)}.extension-settings-modal .migration-btn.disabled:hover:not(:disabled){background:linear-gradient(135deg,rgba(255,255,255,0.95),rgba(248,250,252,0.95));border-color:rgba(0,0,0,.15);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.extension-settings-modal .migration-btn.disabled .btn-text{color:#2d3748}.extension-settings-modal .migration-btn.disabled .btn-status{background:rgba(0,0,0,.1);color:#718096}
.extension-settings-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;visibility:hidden;transition:all .3s ease}.extension-settings-modal.show{opacity:1;visibility:visible}.extension-settings-modal .modal-container{width:90%;max-width:25rem;max-height:80%;background:#fff;border-radius:1rem;padding:1.5rem;position:relative;overflow-y:auto;transform:scale(0.9) translateY(1.25rem);transition:transform .3s ease}.extension-settings-modal .modal-container::-webkit-scrollbar{width:6px}.extension-settings-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.extension-settings-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:3px}.extension-settings-modal.show .modal-container{transform:scale(1) translateY(0)}.extension-settings-modal .modal-header{position:relative;text-align:center;margin-bottom:1.5rem;border-bottom:1px solid #f0f0f0}.extension-settings-modal .modal-header .modal-title{font-size:1.125rem;font-weight:600;color:#333;line-height:1.5}.extension-settings-modal .modal-header .close-btn{position:absolute;top:-0.75rem;right:-0.75rem;width:2rem;height:2rem;border:none;background:rgba(0,0,0,0);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.extension-settings-modal .modal-header .close-btn:hover{background:rgba(0,0,0,.05)}.extension-settings-modal .modal-header .close-btn svg{width:1.25rem;height:1.25rem;color:#888}.extension-settings-modal .modal-content .setting-group{margin-bottom:2rem}.extension-settings-modal .modal-content .setting-group:last-child{margin-bottom:0}.extension-settings-modal .modal-content .setting-group .group-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}.extension-settings-modal .modal-content .setting-group .group-title svg{width:1.25rem;height:1.25rem;color:#6c8cd5}.extension-settings-modal .modal-content .setting-group .setting-item{margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.extension-settings-modal .modal-content .setting-group .setting-item:last-child{margin-bottom:0}.extension-settings-modal .extension-btn{width:100%;background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(248,250,252,0.9));border:1px solid rgba(0,0,0,.1);border-radius:.75rem;padding:1rem 1.25rem;cursor:pointer;transition:all .3s ease;display:flex;flex-direction:column;align-items:flex-start;text-align:left;position:relative;overflow:hidden}.extension-settings-modal .extension-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15);border-color:rgba(0,0,0,.2)}.extension-settings-modal .extension-btn:active:not(:disabled){transform:translateY(0)}.extension-settings-modal .extension-btn:disabled{opacity:.6;cursor:not-allowed}.extension-settings-modal .extension-btn .btn-text{font-size:1rem;font-weight:600;color:#2d3748;margin-bottom:.25rem;display:block}.extension-settings-modal .extension-btn .btn-desc{font-size:.875rem;color:#718096;line-height:1.4;display:block}.extension-settings-modal .extension-btn.summary-btn{background:linear-gradient(135deg,rgba(66,153,225,0.1),rgba(49,130,206,0.1));border-color:rgba(66,153,225,.3)}.extension-settings-modal .extension-btn.summary-btn:hover:not(:disabled){background:linear-gradient(135deg,rgba(66,153,225,0.15),rgba(49,130,206,0.15));border-color:rgba(66,153,225,.5);transform:translateY(-2px);box-shadow:0 8px 25px rgba(66,153,225,.2)}.extension-settings-modal .extension-btn.summary-btn .btn-text{color:#2b6cb0}.extension-settings-modal .coming-soon{text-align:center;padding:1.25rem;color:#999;font-style:italic;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.extension-confirm-dialog-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);display:flex;justify-content:center;align-items:center;z-index:1}.extension-confirm-dialog{background:#fff;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.2);width:90%;max-width:25rem;overflow:hidden}.extension-confirm-dialog .dialog-header{padding:1.25rem 1.5rem 1rem;border-bottom:1px solid #f0f0f0}.extension-confirm-dialog .dialog-header h3{margin:0;font-size:1rem;font-weight:600;color:#333}.extension-confirm-dialog .dialog-content{padding:1rem 1.5rem 1.25rem}.extension-confirm-dialog .dialog-content p{margin:0;color:#666;line-height:1.5}.extension-confirm-dialog .dialog-buttons{display:flex;gap:.75rem;padding:0 1.5rem 1.25rem;justify-content:flex-end}.extension-confirm-dialog .dialog-buttons button{padding:.5rem 1rem;border-radius:.375rem;border:1px solid rgba(0,0,0,0);font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease;min-width:5rem}.extension-confirm-dialog .dialog-buttons button.cancel-btn{background:#f8f9fa;color:#666;border-color:rgba(0,0,0,.1)}.extension-confirm-dialog .dialog-buttons button.cancel-btn:hover{background:#e9ecef;border-color:rgba(0,0,0,.2)}.extension-confirm-dialog .dialog-buttons button.confirm-btn{background:#6c8cd5;color:#fff}.extension-confirm-dialog .dialog-buttons button.confirm-btn:hover{background:#5a7bc4}.extension-confirm-dialog .dialog-buttons button.confirm-btn.primary{background:#48bb78}.extension-confirm-dialog .dialog-buttons button.confirm-btn.primary:hover{background:#38a169}.extension-confirm-dialog .dialog-buttons button.confirm-btn.danger{background:#f56565}.extension-confirm-dialog .dialog-buttons button.confirm-btn.danger:hover{background:#e53e3e}@media screen and (max-width:25rem){.extension-settings-modal .modal-container{width:calc(100% - 1.25rem);margin:.625rem}.extension-settings-modal .extension-btn{padding:.875rem}.extension-settings-modal .extension-btn .btn-text{font-size:.9375rem}.extension-settings-modal .extension-btn .btn-desc{font-size:.8125rem}.extension-confirm-dialog{width:calc(100% - 1.25rem);margin:.625rem}.extension-confirm-dialog .dialog-header{padding:1rem 1.25rem .75rem}.extension-confirm-dialog .dialog-header h3{font-size:.9375rem}.extension-confirm-dialog .dialog-content{padding:.75rem 1.25rem 1rem}.extension-confirm-dialog .dialog-content p{font-size:.875rem}.extension-confirm-dialog .dialog-buttons{padding:0 1.25rem 1rem}.extension-confirm-dialog .dialog-buttons button{padding:.375rem .75rem;font-size:.8125rem;min-width:4.375rem}}
.group-chat-modal{position:absolute;top:0;left:0;width:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1001;opacity:0;visibility:hidden;transition:all .3s ease}.group-chat-modal.show{opacity:1;visibility:visible}.group-chat-modal .modal-container{width:20rem;max-width:90%;background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 .5rem 2rem rgba(0,0,0,.3);position:relative;transform:scale(0.9);transition:transform .3s ease;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#c1c1c1 rgba(0,0,0,0)}.group-chat-modal .modal-container::-webkit-scrollbar{width:8px}.group-chat-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.group-chat-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(193,193,193,.8);border-radius:4px;border:1px solid rgba(0,0,0,0);background-clip:content-box}.group-chat-modal .modal-container::-webkit-scrollbar-thumb:hover{background:rgba(168,168,168,.9);background-clip:content-box}.group-chat-modal .modal-container::-webkit-scrollbar-corner{background:rgba(0,0,0,0)}.group-chat-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1.25rem;text-align:center}.group-chat-modal .modal-container .selected-members{margin-bottom:1.25rem}.group-chat-modal .modal-container .selected-members .members-label{font-size:.875rem;color:#666;margin-bottom:.5rem}.group-chat-modal .modal-container .selected-members .members-list{display:flex;flex-wrap:wrap;gap:.5rem}.group-chat-modal .modal-container .selected-members .members-list .member-tag{display:flex;align-items:center;gap:.375rem;background:#f0f4ff;color:#6c8cd5;padding:.25rem .5rem;border-radius:1rem;font-size:.75rem}.group-chat-modal .modal-container .selected-members .members-list .member-tag .member-avatar{width:1.25rem;height:1.25rem;border-radius:50%;object-fit:cover}.group-chat-modal .modal-container .form-group{margin-bottom:1.25rem}.group-chat-modal .modal-container .form-group .form-label{display:block;font-size:.875rem;color:#333;margin-bottom:.5rem;font-weight:500}.group-chat-modal .modal-container .form-group .form-input{width:100%;padding:.75rem;border:1px solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s;box-sizing:border-box}.group-chat-modal .modal-container .form-group .form-input:focus{outline:none;border-color:#6c8cd5}.group-chat-modal .modal-container .form-group .form-input::placeholder{color:#999}.group-chat-modal .modal-container .form-group .avatar-input-container{position:relative}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group{display:flex;gap:.5rem;margin-bottom:.75rem}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .form-input{flex:1}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .upload-btn{padding:.75rem 1rem;background:#f0f4ff;color:#6c8cd5;border:none;border-radius:.5rem;cursor:pointer;font-size:.75rem;transition:all .2s}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .upload-btn:hover{background:#6c8cd5;color:#fff}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-preview{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:1px solid #e0e0e0;display:block;margin:0 auto}.group-chat-modal .modal-container .participation-group{margin-bottom:1.5rem}.group-chat-modal .modal-container .participation-group .participation-options{display:flex;gap:.75rem}.group-chat-modal .modal-container .participation-group .participation-options .participation-option{flex:1;padding:.5rem .75rem;border:1px solid #e0e0e0;border-radius:.5rem;text-align:center;cursor:pointer;transition:all .2s;background:#fff;min-width:0}.group-chat-modal .modal-container .participation-group .participation-options .participation-option.selected{border-color:#6c8cd5;background:#f0f4ff;color:#6c8cd5}.group-chat-modal .modal-container .participation-group .participation-options .participation-option:hover:not(.selected){border-color:#ccc}.group-chat-modal .modal-container .participation-group .participation-options .participation-option .option-title{font-weight:500;margin-bottom:.125rem;font-size:.875rem}.group-chat-modal .modal-container .participation-group .participation-options .participation-option .option-desc{font-size:.6875rem;color:#666;line-height:1.2;word-wrap:break-word;overflow-wrap:break-word}.group-chat-modal .modal-container .modal-buttons{display:flex;gap:.75rem}.group-chat-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s}.group-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.group-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn{background:#6c8cd5;color:#fff}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn:hover{background:#4a6fbf}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn:disabled{background:#ccc;cursor:not-allowed}.group-chat-modal.show .modal-container{transform:scale(1)}
.dynamic-island-container{position:absolute;top:0;left:0;right:0;z-index:999;pointer-events:auto;display:flex;justify-content:center;align-items:flex-start}.dynamic-island{background:#1c1c1e;border-radius:.75rem;cursor:pointer;transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94);overflow:hidden;position:relative;transform-origin:center top;width:6rem;height:1.5rem}.dynamic-island:hover{background:#2c2c2e;box-shadow:0 4px 12px rgba(0,0,0,.3)}.dynamic-island.expanded{width:90%;height:9rem;border-radius:1.5rem;transform-origin:center top;overflow:hidden}.dynamic-island.expanded .island-compact{opacity:0;pointer-events:none}.dynamic-island.expanded .island-expanded{opacity:1;pointer-events:auto}.dynamic-island[data-state=playing] .wave-bars .wave-bar{animation:waveAnimation 1.5s ease-in-out infinite}.dynamic-island[data-state=playing] .wave-bars .wave-bar:nth-child(1){animation-delay:0s}.dynamic-island[data-state=playing] .wave-bars .wave-bar:nth-child(2){animation-delay:.2s}.dynamic-island[data-state=playing] .wave-bars .wave-bar:nth-child(3){animation-delay:.4s}.dynamic-island[data-state=loading] .music-indicator::after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1rem;height:1rem;border:2px solid hsla(0,0%,100%,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}.dynamic-island[data-state=loading] .wave-bars{opacity:0}.island-compact{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;gap:3rem;opacity:1;transition:opacity .3s ease;pointer-events:auto}.compact-album-cover{position:relative;width:1rem;height:1rem;border-radius:.25rem;overflow:hidden;background:hsla(0,0%,100%,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}.compact-cover-image{width:100%;height:100%;object-fit:cover;display:none}.compact-cover-placeholder{color:hsla(0,0%,100%,.4);font-size:.625rem;font-weight:300}.music-indicator{position:relative;display:flex;align-items:center;justify-content:center;height:100%}.wave-bars{display:flex;align-items:center;gap:.125rem;height:.75rem}.wave-bar{width:.125rem;height:.25rem;background:var(--visualizer-color,linear-gradient(to top,#ff6b9d,#c44569));border-radius:1px;transition:height .1s ease}.island-expanded{position:absolute;top:0;left:0;right:0;bottom:0;opacity:0;transition:opacity .3s ease;pointer-events:none;padding:.75rem;display:flex;flex-direction:column;gap:.375rem;justify-content:space-between}.top-section{display:flex;align-items:center;gap:.75rem;flex:1;min-height:2.75rem}.music-info{display:flex;flex-direction:column;flex:1;min-width:0}.album-cover{position:relative;width:2.75rem;height:2.75rem;border-radius:.75rem;overflow:hidden;background:hsla(0,0%,100%,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.2)}.cover-image{width:100%;height:100%;object-fit:cover;display:none}.cover-placeholder{color:hsla(0,0%,100%,.6);font-size:1.25rem;font-weight:300}.track-info{flex:1;min-width:0;color:#fff}.track-title{font-size:.9375rem;font-weight:600;color:#fff;margin-bottom:.125rem;white-space:nowrap;overflow:hidden;position:relative}.track-title.scrollable .track-text{animation:marquee 15s linear infinite}.track-title .track-text{display:inline-block;transition:transform .3s ease}.track-artist{font-size:.8125rem;color:hsla(0,0%,100%,.7);white-space:nowrap;overflow:hidden;position:relative}.track-artist.scrollable .track-text{animation:marquee 15s linear infinite}.track-artist .track-text{display:inline-block;transition:transform .3s ease}@keyframes marquee{0%{transform:translateX(0)}10%{transform:translateX(0)}45%{transform:translateX(var(--scroll-distance))}55%{transform:translateX(var(--scroll-distance))}90%{transform:translateX(0)}100%{transform:translateX(0)}}.audio-visualizer{display:flex;align-items:center;gap:.1rem;height:1.2rem;flex-shrink:0;margin-right:.3rem}.visualizer-bar{width:.15rem;background:var(--visualizer-color,linear-gradient(to top,#ff6b9d,#c44569));border-radius:2px;transition:height .1s ease}.visualizer-bar:nth-child(1){height:.4rem}.visualizer-bar:nth-child(2){height:.6rem}.visualizer-bar:nth-child(3){height:.8rem}.visualizer-bar:nth-child(4){height:.6rem}.visualizer-bar:nth-child(5){height:.4rem}.dynamic-island[data-state=playing] .visualizer-bar:nth-child(1){animation:visualizerWave1 1.5s ease-in-out infinite;animation-delay:0s}.dynamic-island[data-state=playing] .visualizer-bar:nth-child(2){animation:visualizerWave2 1.5s ease-in-out infinite;animation-delay:.12s}.dynamic-island[data-state=playing] .visualizer-bar:nth-child(3){animation:visualizerWave3 1.5s ease-in-out infinite;animation-delay:.24s}.dynamic-island[data-state=playing] .visualizer-bar:nth-child(4){animation:visualizerWave4 1.5s ease-in-out infinite;animation-delay:.36s}.dynamic-island[data-state=playing] .visualizer-bar:nth-child(5){animation:visualizerWave5 1.5s ease-in-out infinite;animation-delay:.48s}@keyframes visualizerWave1{0%,100%{height:.2rem;opacity:.6}50%{height:.9rem;opacity:1}}@keyframes visualizerWave2{0%,100%{height:.3rem;opacity:.7}50%{height:1.1rem;opacity:1}}@keyframes visualizerWave3{0%,100%{height:.25rem;opacity:.65}50%{height:1.2rem;opacity:1}}@keyframes visualizerWave4{0%,100%{height:.35rem;opacity:.75}50%{height:1rem;opacity:1}}@keyframes visualizerWave5{0%,100%{height:.2rem;opacity:.6}50%{height:.85rem;opacity:1}}.bottom-section{display:flex;align-items:center;justify-content:center;gap:1.5rem;flex-shrink:0;height:2rem}.control-btn{background:rgba(0,0,0,0) !important;border:none !important;padding:0 !important;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;box-shadow:none !important;outline:none !important}.control-btn:hover{transform:scale(1.1);background:rgba(0,0,0,0) !important}.control-btn:active{transform:scale(0.9);opacity:.7;background:rgba(0,0,0,0) !important}.control-btn:focus{background:rgba(0,0,0,0) !important;outline:none !important}.prev-btn,.next-btn{font-size:.9rem;color:hsla(0,0%,100%,.9);font-weight:bold;line-height:1}.play-btn{width:2.2rem;height:2.2rem;position:relative}.play-btn .play-icon{width:0;height:0;border-left:.75rem solid #fff;border-top:.5rem solid rgba(0,0,0,0);border-bottom:.5rem solid rgba(0,0,0,0);position:absolute;top:50%;left:50%;transform:translate(-40%,-50%)}.play-btn .pause-icon{width:.75rem;height:.75rem;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:none}.play-btn .pause-icon::before,.play-btn .pause-icon::after{content:"";position:absolute;top:0;width:30%;height:100%;background:#fff}.play-btn .pause-icon::before{left:0}.play-btn .pause-icon::after{right:0}.play-btn.paused .play-icon{display:none}.play-btn.paused .pause-icon{display:block}.playlist-btn,.mode-btn{width:1.5rem;height:1.5rem;color:hsla(0,0%,100%,.8);background:rgba(0,0,0,0) !important;border:none !important;box-shadow:none !important}.playlist-btn svg,.mode-btn svg{width:1.5rem;height:1.5rem;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}.playlist-btn:hover,.mode-btn:hover{color:#fff}.playlist-btn:active,.mode-btn:active{background:rgba(0,0,0,0) !important}.playlist-btn:focus,.mode-btn:focus{background:rgba(0,0,0,0) !important;outline:none !important}.playlist-btn{background:hsla(0,0%,100%,.1)}.playlist-btn:hover{background:hsla(0,0%,100%,.18)}.playlist-btn{background:hsla(0,0%,100%,.15)}.playlist-btn:hover{background:hsla(0,0%,100%,.25)}.progress-section{display:flex;flex-direction:column;gap:.25rem;flex-shrink:0}.time-display{display:flex;justify-content:space-between;align-items:center;font-size:.6875rem;color:hsla(0,0%,100%,.7);font-variant-numeric:tabular-nums}.progress-bar{width:100%}.progress-track{position:relative;width:100%;height:.25rem;background:hsla(0,0%,100%,.2);border-radius:.125rem;cursor:pointer;overflow:hidden}.progress-fill{position:absolute;top:0;left:0;height:100%;background:var(--visualizer-color,linear-gradient(90deg,#007aff,#5ac8fa));border-radius:.125rem;width:0%;transition:width .1s ease}.progress-thumb{position:absolute;top:50%;left:0%;transform:translate(-50%,-50%);width:.75rem;height:.75rem;background:#fff;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.2);opacity:0;transition:all .2s ease}.progress-track:hover .progress-thumb{opacity:1}@keyframes waveAnimation{0%,100%{height:.25rem;opacity:.7}50%{height:.75rem;opacity:1}}@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}@media screen and (max-width:25rem){.dynamic-island.expanded{width:95%;height:8rem}.island-expanded{padding:.625rem;gap:.375rem}.album-cover{width:2.25rem;height:2.25rem}.track-title{font-size:.8125rem}.track-artist{font-size:.6875rem}.prev-btn,.next-btn{width:1.25rem;height:1.25rem}.prev-btn::before,.prev-btn::after,.next-btn::before,.next-btn::after{border-left-width:.3125rem;border-right-width:.3125rem;border-top-width:.1875rem;border-bottom-width:.1875rem}.play-btn{width:2rem;height:2rem}.play-btn::before{border-left-width:.625rem;border-top-width:.4375rem;border-bottom-width:.4375rem}.play-btn.paused::after{width:.625rem;height:.625rem}.playlist-btn{width:1.25rem;height:1.25rem}.playlist-btn svg{width:1.25rem;height:1.25rem}.bottom-section{height:1.75rem;gap:1.25rem}}@media (prefers-color-scheme:dark){.dynamic-island{background:#1c1c1e}.dynamic-island:hover{background:#2c2c2e}}@media (prefers-color-scheme:light){.dynamic-island{background:rgba(0,0,0,.8);backdrop-filter:blur(10px)}.dynamic-island:hover{background:rgba(0,0,0,.9)}}@media (prefers-contrast:high){.dynamic-island{border:1px solid hsla(0,0%,100%,.3)}.control-btn{border:1px solid hsla(0,0%,100%,.2)}}@media (prefers-reduced-motion:reduce){.dynamic-island,.island-compact,.island-expanded,.control-btn,.progress-fill,.progress-thumb{transition:none}.wave-bar{animation:none}@keyframes waveAnimation{0%,100%{height:.5rem}}}@media screen and (max-width:25rem){.dynamic-island.expanded{width:95%;height:8.5rem}.island-expanded{padding:.75rem;gap:.5rem}.top-section{gap:.5rem;min-height:2.5rem}.album-cover{width:2.25rem;height:2.25rem}.track-title{font-size:.8125rem}.track-artist{font-size:.6875rem}.audio-visualizer{height:1.25rem}.visualizer-bar{width:.125rem}.control-btn{width:2rem;height:2rem}.control-btn svg{width:1rem;height:1rem}.play-btn{width:2.75rem;height:2.75rem}.play-btn svg{width:1.375rem;height:1.375rem}.bottom-section{gap:1rem;min-height:2.75rem}}@media (prefers-color-scheme:dark){.dynamic-island{background:#1c1c1e}.dynamic-island:hover{background:#2c2c2e}}@media (prefers-color-scheme:light){.dynamic-island{background:rgba(0,0,0,.8);backdrop-filter:blur(10px)}.dynamic-island:hover{background:rgba(0,0,0,.9)}}@media (prefers-contrast:high){.dynamic-island{border:1px solid hsla(0,0%,100%,.3)}.control-btn{border:1px solid hsla(0,0%,100%,.2)}}@media (prefers-reduced-motion:reduce){.dynamic-island,.island-compact,.island-expanded,.control-btn,.progress-fill,.progress-thumb,.visualizer-bar{transition:none}.wave-bar,.visualizer-bar{animation:none}@keyframes waveAnimation{0%,100%{height:.5rem}}@keyframes visualizerWave{0%,100%{transform:scaleY(1)}}}.playlist-btn,.mode-btn{width:1.25rem;height:1.25rem}.playlist-btn svg,.mode-btn svg{width:1.25rem;height:1.25rem}.prev-btn:hover::before,.prev-btn:hover::after{border-right-color:#fff}.next-btn:hover::before,.next-btn:hover::after{border-left-color:#fff}.play-btn:hover::before{border-left-color:#fff}.play-btn.paused:hover::after{background:linear-gradient(to right,rgb(255,255,255) 0%,rgb(255,255,255) 30%,transparent 30%,transparent 70%,rgb(255,255,255) 70%,rgb(255,255,255) 100%)}
.di-playlist-overlay{position:absolute;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;pointer-events:auto}.di-playlist-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);border-radius:1.5rem;overflow:hidden;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px)}.di-playlist-panel{position:relative;width:min(90%,24rem);max-height:75%;height:28rem;background:#121212;border:1px solid hsla(0,0%,100%,.1);border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 0 1px hsla(0,0%,100%,.05) inset;color:#fff;display:flex;flex-direction:column;overflow:hidden;transform:scale(0.95) translateY(10px);opacity:0;animation:di-panel-enter .3s cubic-bezier(0.25,0.46,0.45,0.94) forwards}@keyframes di-panel-enter{from{opacity:0;transform:scale(0.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}.di-playlist-header{height:4rem;min-height:4rem;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;background:linear-gradient(to bottom,rgba(255,255,255,0.05),transparent)}.di-playlist-header .title{font-size:1.5rem;font-weight:700;letter-spacing:-0.02em;background:linear-gradient(135deg,#fff 0%,rgba(255,255,255,0.8) 100%);-webkit-background-clip:text;-webkit-text-fill-color:rgba(0,0,0,0);background-clip:text}.di-playlist-header .actions{display:flex;align-items:center;gap:.75rem}.di-playlist-header .actions button{background:rgba(0,0,0,0);color:hsla(0,0%,100%,.7);border:none;width:2rem;height:2rem;border-radius:50%;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center}.di-playlist-header .actions button:hover{background:hsla(0,0%,100%,.1);color:#fff;transform:scale(1.05)}.di-playlist-header .actions button:active{transform:scale(0.95)}.di-playlist-header .actions .btn-close{font-size:1.25rem;font-weight:300}.di-playlist-toolbar{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem}.di-playlist-toolbar button{background:hsla(0,0%,100%,.05);color:hsla(0,0%,100%,.9);border:1px solid hsla(0,0%,100%,.1);border-radius:2rem;height:2.25rem;padding:0 1.25rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:.5rem;white-space:nowrap}.di-playlist-toolbar button.btn-import::before{content:"+";font-size:1.1rem;font-weight:400}.di-playlist-toolbar button:hover{background:hsla(0,0%,100%,.1);border-color:hsla(0,0%,100%,.2);transform:translateY(-1px)}.di-playlist-toolbar button:active{transform:translateY(0)}.di-playlist-toolbar .btn-sort.active{background:rgba(30,215,96,.2);border-color:#1ed760;color:#1ed760}.di-playlist-toolbar .btn-clear{background:rgba(0,0,0,0);border:none;color:hsla(0,0%,100%,.5);padding:0 .75rem}.di-playlist-toolbar .btn-clear:hover{color:hsla(0,0%,100%,.8);background:rgba(255,107,107,.1)}.di-playlist-list{flex:1;overflow-y:auto;padding:0 1rem 1rem}.di-playlist-list::-webkit-scrollbar{width:12px}.di-playlist-list::-webkit-scrollbar-thumb{background:hsla(0,0%,100%,.2);border-radius:6px;border:3px solid rgba(0,0,0,0);background-clip:padding-box}.di-playlist-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.di-track{display:flex;align-items:center;gap:.75rem;padding:.5rem .75rem;margin-bottom:.125rem;border-radius:.375rem;transition:all .15s ease;position:relative;cursor:pointer}.di-track:hover{background:hsla(0,0%,100%,.08)}.di-track:hover .ops{opacity:1}.di-track.sortable-mode{cursor:default}.di-track.sortable-mode .drag-handle{display:flex !important;opacity:1 !important}.di-track.now-playing .meta .title{color:#1ed760}.di-track .drag-handle{width:1.5rem;color:hsla(0,0%,100%,.4);cursor:grab;-webkit-user-select:none;user-select:none;text-align:center;font-size:.75rem;display:none;align-items:center;justify-content:center;transition:opacity .2s ease}.di-track .drag-handle:active{cursor:grabbing}.di-track .track-cover{width:2.5rem;height:2.5rem;border-radius:.25rem;overflow:hidden;background:hsla(0,0%,100%,.05);display:flex;align-items:center;justify-content:center;flex-shrink:0}.di-track .track-cover img{width:100%;height:100%;object-fit:cover}.di-track .track-cover .cover-placeholder{font-size:1.25rem;color:hsla(0,0%,100%,.3)}.di-track .meta{flex:1;min-width:0}.di-track .meta .title{font-size:.875rem;font-weight:500;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3}.di-track .meta .subtitle{font-size:.75rem;color:hsla(0,0%,100%,.6);margin-top:.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.di-track .meta .subtitle.invalid{color:#ff6b6b}.di-track .ops{display:flex;align-items:center;gap:.5rem;opacity:0;transition:opacity .2s ease}.di-track .ops button{width:1.75rem;height:1.75rem;background:rgba(0,0,0,0);color:hsla(0,0%,100%,.7);border:none;border-radius:50%;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:.875rem}.di-track .ops button:hover{background:hsla(0,0%,100%,.1);color:#fff;transform:scale(1.1)}.di-track .ops button:active{transform:scale(0.95)}.di-track .ops .op-remove:hover{background:rgba(255,107,107,.2);color:#ff6b6b}#di-import-modal{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:2001}#di-import-modal .box{width:min(85%,22rem);background:#181818;border:1px solid hsla(0,0%,100%,.1);border-radius:1rem;box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 0 1px hsla(0,0%,100%,.05) inset;padding:1.5rem}#di-import-modal .box .title{font-size:1.25rem;font-weight:700;margin-bottom:1rem;color:#fff}#di-import-modal .box textarea.text{width:100%;min-height:10rem;background:#282828;color:#fff;border:1px solid hsla(0,0%,100%,.1);border-radius:.75rem;padding:1rem;resize:vertical;outline:none;transition:all .2s ease;font-family:"SF Mono","Monaco","Inconsolata","Fira Code",monospace;font-size:.875rem;line-height:1.5}#di-import-modal .box textarea.text:focus{border-color:hsla(0,0%,100%,.3);background:#333}#di-import-modal .box textarea.text::placeholder{color:hsla(0,0%,100%,.4)}#di-import-modal .box .actions{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1.25rem}#di-import-modal .box .actions button{background:hsla(0,0%,100%,.1);color:#fff;border:none;border-radius:2rem;height:2.5rem;padding:0 1.5rem;font-weight:500;cursor:pointer;transition:all .2s ease}#di-import-modal .box .actions button:hover{transform:translateY(-1px);background:hsla(0,0%,100%,.15)}#di-import-modal .box .actions button:active{transform:translateY(0)}#di-import-modal .box .actions .ok{background:#1ed760;color:#000}#di-import-modal .box .actions .ok:hover{background:#1fdf64;transform:translateY(-1px) scale(1.02)}#di-import-modal .box .actions .ok:active{background:#1ed760}@media screen and (max-width:25rem){.di-playlist-panel{width:95%;aspect-ratio:13/10;border-radius:.9rem}.di-playlist-header{height:3rem;min-height:3rem}.di-playlist-header .title{font-size:1.25rem}.di-playlist-header .actions button{height:1.6rem;padding:0 .5rem}.di-playlist-toolbar{gap:.5rem;padding:.75rem 1rem}.di-playlist-toolbar button{height:2rem;padding:0 .75rem;font-size:.75rem}.di-track{padding:.45rem .5rem}.di-track .track-cover{width:2rem;height:2rem}.di-track .meta .title{font-size:.8rem}.di-track .meta .subtitle{font-size:.7rem}.di-track .ops button{width:1.6rem;height:1.6rem}#di-import-modal .box{width:92%}}@media (prefers-reduced-motion:reduce){.di-playlist-panel,.di-track,.di-playlist-header .actions button,.di-playlist-toolbar button,.di-track .ops button{animation:none;transition:none}}
.dynamics-composer-interface{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:4;background:rgba(0,0,0,0);border-radius:1.5rem;overflow:hidden}.dynamics-composer-interface.active{display:block}.dynamics-composer-interface .composer-nav-bar{position:relative;width:100%;height:2.75rem;margin-top:1.5rem;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 1rem;border-top-left-radius:1rem;border-top-right-radius:1rem}.dynamics-composer-interface .composer-nav-bar .composer-back-btn{width:2rem;height:2rem;border:none;background:rgba(0,0,0,0);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s;color:#333}.dynamics-composer-interface .composer-nav-bar .composer-back-btn:hover{background:rgba(0,0,0,.05)}.dynamics-composer-interface .composer-nav-bar .composer-back-btn svg{width:1.25rem;height:1.25rem}.dynamics-composer-interface .composer-nav-bar .composer-nav-title{font-size:1rem;font-weight:600;color:#333;position:absolute;left:50%;transform:translateX(-50%)}.dynamics-composer-interface .composer-nav-bar .composer-post-btn{padding:.4rem 1rem;border:none;border-radius:1rem;background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff;font-size:.8125rem;font-weight:600;cursor:pointer;transition:all .2s}.dynamics-composer-interface .composer-nav-bar .composer-post-btn:hover:not(:disabled){background:linear-gradient(135deg,#ff91cc,#ff69b4);transform:translateY(-1px);box-shadow:0 2px 8px rgba(255,105,180,.3)}.dynamics-composer-interface .composer-nav-bar .composer-post-btn:active:not(:disabled){transform:translateY(0)}.dynamics-composer-interface .composer-nav-bar .composer-post-btn:disabled{opacity:.5;cursor:not-allowed}.dynamics-composer-interface .composer-content-area{width:100%;height:calc(100% - 1.5rem - 2.75rem);background:#fff;overflow-y:auto;padding:1rem}.dynamics-composer-interface .composer-content-area::-webkit-scrollbar{width:6px}.dynamics-composer-interface .composer-content-area::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.dynamics-composer-interface .composer-content-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:3px}.dynamics-composer-interface .composer-main-area{display:flex;gap:.75rem;margin-bottom:1rem;padding-bottom:1rem;align-items:flex-start}.dynamics-composer-interface .composer-main-area .composer-user-avatar-small{width:2.5rem;height:2.5rem;border-radius:50%;background-image:url("https://files.catbox.moe/bpqrv2.jpg");background-size:cover;background-position:center;border:2px solid #ff9ebb;box-shadow:0 0 8px rgba(255,158,187,.2);flex-shrink:0;margin-top:.125rem}.dynamics-composer-interface .composer-main-area .composer-input-wrapper{flex:1;position:relative}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-textarea{width:100%;min-height:8rem;max-height:20rem;border:none;outline:none;font-size:1.1rem;line-height:1.5;resize:none;font-family:inherit;color:#333;background:rgba(0,0,0,0)}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-textarea::placeholder{color:#999;font-size:inherit}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-textarea.shake{animation:shake .5s;border:2px solid #ff4757;border-radius:.5rem}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count{position:absolute;bottom:.5rem;right:.5rem;width:1.5rem;height:1.5rem}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count svg{width:100%;height:100%;transform:rotate(-90deg)}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count svg .circle-bg{fill:none;stroke:#e8e8e8;stroke-width:2}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count svg .circle-progress{fill:none;stroke:#1da1f2;stroke-width:2;stroke-linecap:round;transition:stroke .3s,stroke-dashoffset .3s}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count svg .circle-progress.warning{stroke:#ffad1f}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count svg .circle-progress.danger{stroke:#e0245e}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count .char-count-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.625rem;color:#666;font-weight:500}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count .char-count-text.warning{color:#ffad1f}.dynamics-composer-interface .composer-main-area .composer-input-wrapper .composer-char-count .char-count-text.danger{color:#e0245e}.dynamics-composer-interface .composer-image-description{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;padding:.75rem;background:#f8f8f8;border-radius:.75rem;border:1px solid pink}.dynamics-composer-interface .composer-image-description .image-description-input{flex:1;padding:.5rem;border:none;background:#fff;border-radius:.5rem;font-size:.875rem;outline:none;transition:box-shadow .2s}.dynamics-composer-interface .composer-image-description .image-description-input:focus{box-shadow:0 0 0 2px rgba(255,105,180,.2)}.dynamics-composer-interface .composer-image-description .image-description-input::placeholder{color:#999}.dynamics-composer-interface .composer-image-description .remove-image-btn{width:1.75rem;height:1.75rem;border:none;border-radius:50%;background:rgba(255,105,180,.2);color:hotpink;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}.dynamics-composer-interface .composer-image-description .remove-image-btn:hover{background:rgba(255,105,180,.3);transform:scale(1.1)}.dynamics-composer-interface .composer-image-description .remove-image-btn svg{width:1rem;height:1rem}.dynamics-composer-interface .composer-toolbar{display:flex;justify-content:flex-start;padding:.75rem 0}.dynamics-composer-interface .composer-toolbar .toolbar-btn{display:flex;align-items:center;justify-content:center;width:2.5rem;height:2.5rem;border:none;background:rgba(0,0,0,0);cursor:pointer;border-radius:50%;transition:all .2s;color:hotpink}.dynamics-composer-interface .composer-toolbar .toolbar-btn:hover{background:rgba(255,105,180,.1)}.dynamics-composer-interface .composer-toolbar .toolbar-btn:active{transform:scale(0.95)}.dynamics-composer-interface .composer-toolbar .toolbar-btn.active{color:#ff1493}.dynamics-composer-interface .composer-toolbar .toolbar-btn svg{width:1.25rem;height:1.25rem}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}.new-dynamic-btn{position:absolute;bottom:4.625rem;right:1.5rem;width:3rem;height:3rem;border-radius:50%;background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 .25rem .75rem rgba(255,105,180,.3);z-index:100;opacity:1;visibility:visible;transition:opacity .3s ease,visibility .3s ease,transform .3s ease,box-shadow .3s ease}.new-dynamic-btn.hidden{opacity:0;visibility:hidden;transform:scale(0.8);pointer-events:none}.new-dynamic-btn.showing{animation:fadeInBounce .3s ease forwards}.new-dynamic-btn.hiding{animation:fadeOutScale .3s ease forwards}.new-dynamic-btn:hover{transform:scale(1.1);box-shadow:0 .375rem 1rem rgba(255,105,180,.4)}.new-dynamic-btn:active{transform:scale(0.95)}.new-dynamic-btn svg{width:1.5rem;height:1.5rem}@keyframes fadeInBounce{0%{opacity:0;visibility:hidden;transform:scale(0.3)}50%{transform:scale(1.05)}100%{opacity:1;visibility:visible;transform:scale(1)}}@keyframes fadeOutScale{0%{opacity:1;visibility:visible;transform:scale(1)}100%{opacity:0;visibility:hidden;transform:scale(0.8)}}
#dynamicsInterface{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;background-image:url("https://files.catbox.moe/o84j4n.jpg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden}#dynamicsInterface.active{display:block}#dynamicsInterface #dynamicsStatusBarContainer .status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1}#dynamicsInterface #dynamicsStatusBarContainer .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}#dynamicsInterface #dynamicsStatusBarContainer .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}#dynamicsInterface #dynamicsStatusBarContainer .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff}.dynamics-back-btn{position:absolute;top:2rem;left:1rem;width:2rem;height:2rem;background:hsla(0,0%,100%,.9);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:all .3s ease}.dynamics-back-btn:hover{background:#fff;transform:scale(1.1)}.dynamics-back-btn:active{transform:scale(0.95)}.dynamics-back-btn svg{color:#666}.dynamics-app-container{position:relative;width:100%;height:calc(100% - 1.5rem);top:1.5rem;background:hsla(0,0%,100%,.95);display:flex;flex-direction:column;overflow:hidden}.dynamics-nav-bar{width:100%;height:3.125rem;background:hsla(0,0%,100%,.98);border-bottom:1px solid #ffd1dc;display:flex;justify-content:space-between;align-items:center;padding:0 1rem}.dynamics-nav-bar .dynamics-nav-profile{width:2rem;height:2rem;border-radius:50%;background-image:url("https://files.catbox.moe/bpqrv2.jpg");background-size:cover;background-position:center;border:2px solid #ff9ebb;box-shadow:0 0 10px rgba(255,158,187,.5);transition:transform .3s ease}.dynamics-nav-bar .dynamics-nav-profile:hover{transform:scale(1.1)}.dynamics-nav-bar .dynamics-nav-logo{font-size:1.25rem;font-weight:bold;background:linear-gradient(45deg,#ff69b4,#ff1493);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:rgba(0,0,0,0);text-shadow:0 0 10px rgba(255,105,180,.3);cursor:pointer;transition:transform .2s ease;-webkit-user-select:none;user-select:none}.dynamics-nav-bar .dynamics-nav-logo:hover{transform:scale(1.05)}.dynamics-nav-bar .dynamics-nav-logo:active{transform:scale(0.95)}.dynamics-nav-bar .dynamics-nav-settings{width:2rem;height:2rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:hotpink;transition:transform .3s ease}.dynamics-nav-bar .dynamics-nav-settings:hover{transform:rotate(90deg)}.dynamics-timeline{flex:1;overflow-y:auto;padding:10px;padding-bottom:3.125rem;background:linear-gradient(135deg,#fff5f7 0%,#fff 100%)}.dynamics-timeline::-webkit-scrollbar{width:6px}.dynamics-timeline::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.dynamics-timeline::-webkit-scrollbar-thumb{background:rgba(255,105,180,.2);border-radius:3px}.dynamics-timeline::-webkit-scrollbar-thumb:hover{background:rgba(255,105,180,.4)}.dynamics-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:2.5rem 1.25rem;text-align:center}.dynamics-empty .dynamics-empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.6}.dynamics-empty .dynamics-empty-text{font-size:1.125rem;font-weight:600;color:#666;margin-bottom:.5rem}.dynamics-empty .dynamics-empty-subtext{font-size:.875rem;color:#999;line-height:1.4}.dynamics-post{background:#fff;border-radius:.9375rem;margin-bottom:.9375rem;padding:.9375rem;box-shadow:0 2px 20px rgba(255,182,193,.15);border:1px solid #ffe4e1;transition:transform .3s ease;animation:fadeIn .3s ease-in-out}.dynamics-post:hover{transform:translateY(-2px);box-shadow:0 5px 25px rgba(255,182,193,.25)}.dynamics-post-header{display:flex;align-items:center;gap:.625rem;margin-bottom:.625rem}.dynamics-post-avatar{width:2.5rem;height:2.5rem;border-radius:50%;background-size:cover;background-position:center;border:2px solid #ff9ebb;box-shadow:0 0 10px rgba(255,158,187,.3);transition:transform .2s ease,box-shadow .2s ease;cursor:pointer}.dynamics-post-avatar:hover{transform:scale(1.08);box-shadow:0 0 12px rgba(255,158,187,.45)}.dynamics-post-avatar:active{transform:scale(0.95)}.dynamics-post-avatar.avatar-click-effect{transform:scale(0.98)}.dynamics-post-info{flex:1}.dynamics-post-name{font-weight:bold;font-size:.875rem;color:#333;text-shadow:0 0 1px rgba(255,105,180,.3)}.dynamics-post-time{font-size:.75rem;color:#999;margin-top:2px}.dynamics-post-content{font-size:.875rem;line-height:1.5;color:#333;margin-bottom:.625rem}.dynamics-post-image{width:100%;height:12.5rem;border-radius:.75rem;background-size:cover;background-position:center;margin-bottom:.625rem;border:1px solid #ffe4e1;transition:transform .3s ease}.dynamics-post-image:hover{transform:scale(1.02)}.dynamics-liked-by{display:flex;align-items:center;flex-wrap:wrap;font-size:.75rem;color:#666;padding:6px 10px;background:#f8f8f8;border-radius:6px}.dynamics-liked-by .liked-heart-icon{width:.75rem;height:.75rem;fill:hotpink;margin-right:5px}.dynamics-liked-by .liked-user{color:#576b95;cursor:pointer}.dynamics-liked-by .liked-user:hover{text-decoration:underline}.dynamics-post-actions{display:flex;justify-content:flex-end;align-items:center;padding:8px 0;gap:10px}.dynamics-post-action{display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s ease;padding:6px 12px;border-radius:15px}.dynamics-post-action:hover{background:rgba(0,0,0,.05)}.dynamics-post-action:hover .action-svg{transform:scale(1.1)}.dynamics-post-action:active{transform:scale(0.95)}.dynamics-post-action .action-icon{display:flex;align-items:center}.dynamics-post-action .action-svg{width:1.125rem;height:1.125rem;fill:#8a8a8a;transition:all .2s ease}.dynamics-post-action[data-action=like]:hover .action-svg{fill:#ff4757}.dynamics-post-action[data-action=like].liked .action-svg{fill:#ff4757;animation:heartBeat .5s}.dynamics-post-action[data-action=comment]:hover .action-svg{fill:#3498db}@keyframes heartBeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}.dynamics-comments{margin-top:.625rem;padding-top:.625rem;border-top:1px dashed #ffe4e1}.dynamics-comment{margin-bottom:.5rem;font-size:.8125rem;line-height:1.5}.dynamics-comment.comment-long-pressing{position:relative}.dynamics-comment.comment-long-pressing::before{content:"";position:absolute;top:-0.25rem;left:-0.5rem;right:-0.5rem;bottom:-0.25rem;background:rgba(135,206,250,.2);box-shadow:0 0 0 2px rgba(135,206,250,.4);border-radius:.75rem;z-index:-1;pointer-events:none}.dynamics-comment-qq .dynamics-comment-content{background:rgba(0,0,0,0);border-radius:0;color:#333}.dynamics-comment-qq .dynamics-comment-content .dynamics-comment-name{font-weight:600;color:#576b95;cursor:pointer}.dynamics-comment-qq .dynamics-comment-content .dynamics-comment-name:hover{text-decoration:underline}.dynamics-comment-qq .dynamics-comment-content .dynamics-comment-text{color:#333;word-break:break-word}.dynamics-comment:not(.dynamics-comment-qq){display:flex;gap:.5rem}.dynamics-comment:not(.dynamics-comment-qq) .dynamics-comment-avatar{width:1.5rem;height:1.5rem;border-radius:50%;background-size:cover;border:1px solid #ff9ebb}.dynamics-comment:not(.dynamics-comment-qq) .dynamics-comment-content{flex:1;background:#fff5f7;padding:.5rem;border-radius:.625rem;color:#666}.dynamics-comment:not(.dynamics-comment-qq) .dynamics-comment-name{font-weight:bold;color:hotpink;margin-right:5px}.clickable{cursor:pointer;transition:transform .2s ease,filter .2s ease}.clickable:hover{transform:scale(1.05);filter:brightness(1.1)}.clickable:active{transform:scale(0.95)}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes sparkleAnim{0%{transform:scale(0) rotate(0deg);opacity:0}50%{transform:scale(1) rotate(180deg);opacity:.8}100%{transform:scale(0) rotate(360deg);opacity:0}}@keyframes floatHeart{0%{transform:translateY(0) rotate(0deg);opacity:0}50%{opacity:.8}100%{transform:translateY(-100px) rotate(360deg);opacity:0}}.dynamics-image-description{position:absolute;top:0;left:0;width:100%;height:100%;background:hsla(0,0%,100%,.9);padding:1.25rem;color:hotpink;font-size:.875rem;line-height:1.6;white-space:pre-wrap;display:flex;align-items:center;justify-content:center;text-align:center;animation:fadeIn .3s ease;border-radius:.75rem}.dynamics-loading-animation{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:3.75rem;height:3.75rem;display:none}.dynamics-loading-animation::after{content:"âœ§";font-size:1.5rem;color:hotpink;animation:loadingRotate 1s linear infinite;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}@keyframes loadingRotate{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(360deg)}}.dynamics-comment-modal{position:absolute;top:0;left:0;width:100%;height:100%;z-index:100}.dynamics-comment-modal .dynamics-comment-backdrop{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}.dynamics-comment-modal .dynamics-comment-dialog{position:absolute;bottom:0;left:0;width:100%;background:#fff;border-radius:1rem 1rem 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.15);animation:slideUp .3s ease-out;max-height:60%;display:flex;flex-direction:column}.dynamics-comment-modal .dynamics-comment-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #f0f0f0}.dynamics-comment-modal .dynamics-comment-header .dynamics-comment-title{font-size:1rem;font-weight:600;color:#333}.dynamics-comment-modal .dynamics-comment-header .dynamics-comment-close{background:none;border:none;font-size:1.25rem;color:#999;cursor:pointer;padding:0;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}.dynamics-comment-modal .dynamics-comment-header .dynamics-comment-close:hover{background:#f0f0f0;color:#666}.dynamics-comment-modal .dynamics-comment-body{flex:1;padding:1rem;overflow-y:auto}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-reply-info{font-size:.875rem;color:hotpink;margin-bottom:.75rem;padding:.5rem;background:#fff5f7;border-radius:.5rem}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-reply-info .dynamics-comment-reply-name{font-weight:600}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-input{width:100%;min-height:5rem;padding:.75rem;border:1px solid pink;border-radius:.5rem;font-size:.9375rem;resize:vertical;outline:none;transition:border-color .2s}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-input:focus{border-color:hotpink;box-shadow:0 0 0 2px rgba(255,105,180,.1)}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-input::placeholder{color:#ccc}.dynamics-comment-modal .dynamics-comment-body .dynamics-comment-input.shake{animation:shake .5s;border-color:#ff4757}.dynamics-comment-modal .dynamics-comment-footer{display:flex;gap:.75rem;padding:1rem;border-top:1px solid #f0f0f0}.dynamics-comment-modal .dynamics-comment-footer button{flex:1;padding:.75rem;border-radius:1.5rem;font-size:.9375rem;font-weight:500;cursor:pointer;transition:all .2s;border:none}.dynamics-comment-modal .dynamics-comment-footer button:active{transform:scale(0.95)}.dynamics-comment-modal .dynamics-comment-footer .dynamics-comment-cancel{background:#f0f0f0;color:#666}.dynamics-comment-modal .dynamics-comment-footer .dynamics-comment-cancel:hover{background:#e0e0e0}.dynamics-comment-modal .dynamics-comment-footer .dynamics-comment-submit{background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff}.dynamics-comment-modal .dynamics-comment-footer .dynamics-comment-submit:hover{background:linear-gradient(135deg,#ff91cc,#ff69b4)}.dynamics-comment-modal .dynamics-comment-footer .dynamics-comment-submit:disabled{opacity:.6;cursor:not-allowed}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}.new-dynamic-btn{position:absolute;bottom:4.625rem;right:1.5rem;width:3rem;height:3rem;border-radius:50%;background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 .25rem .75rem rgba(255,105,180,.3);transition:all .3s ease;z-index:100}.new-dynamic-btn:hover{transform:scale(1.1);box-shadow:0 .375rem 1rem rgba(255,105,180,.4)}.new-dynamic-btn:active{transform:scale(0.95)}.new-dynamic-btn svg{width:1.5rem;height:1.5rem}.new-dynamic-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease;pointer-events:none}.new-dynamic-modal.show{opacity:1;pointer-events:auto}.new-dynamic-modal .modal-container{width:100%;background:#fff;border-radius:1.5rem 1.5rem 0 0;padding:1.25rem;position:relative;transform:translateY(100%);transition:transform .3s ease;max-height:80%;display:flex;flex-direction:column}.new-dynamic-modal.show .modal-container{transform:translateY(0)}.new-dynamic-modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.new-dynamic-modal .modal-header .modal-title{font-size:1.125rem;font-weight:600;color:#333}.new-dynamic-modal .modal-header .modal-close{background:none;border:none;font-size:1.5rem;color:#999;cursor:pointer;padding:0;width:2rem;height:2rem;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}.new-dynamic-modal .modal-header .modal-close:hover{background:#f0f0f0;color:#666}.new-dynamic-modal .dynamic-form{flex:1;overflow-y:auto}.new-dynamic-modal .dynamic-form .form-group{margin-bottom:1rem}.new-dynamic-modal .dynamic-form .form-group textarea{width:100%;min-height:8rem;padding:.75rem;border:2px solid pink;border-radius:.75rem;font-size:.9375rem;resize:vertical;outline:none;transition:border-color .2s;font-family:inherit}.new-dynamic-modal .dynamic-form .form-group textarea:focus{border-color:hotpink;box-shadow:0 0 0 3px rgba(255,105,180,.1)}.new-dynamic-modal .dynamic-form .form-group textarea::placeholder{color:#ccc}.new-dynamic-modal .dynamic-form .form-group .image-upload-area{border:2px dashed pink;border-radius:.75rem;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;background:#fff5f7}.new-dynamic-modal .dynamic-form .form-group .image-upload-area:hover{border-color:hotpink;background:#ffe4e9}.new-dynamic-modal .dynamic-form .form-group .image-upload-area .upload-icon{font-size:2rem;margin-bottom:.5rem;color:hotpink}.new-dynamic-modal .dynamic-form .form-group .image-upload-area .upload-text{color:#666;font-size:.875rem}.new-dynamic-modal .dynamic-form .form-group .image-upload-area.has-image{padding:0;border:none;background:rgba(0,0,0,0)}.new-dynamic-modal .dynamic-form .form-group .image-upload-area.has-image .image-preview{width:100%;height:12rem;border-radius:.75rem;background-size:cover;background-position:center;position:relative}.new-dynamic-modal .dynamic-form .form-group .image-upload-area.has-image .image-preview .remove-image{position:absolute;top:.5rem;right:.5rem;width:1.75rem;height:1.75rem;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}.new-dynamic-modal .dynamic-form .form-group .image-upload-area.has-image .image-preview .remove-image:hover{background:rgba(0,0,0,.7)}.new-dynamic-modal .modal-footer{display:flex;gap:.75rem;padding-top:1rem;border-top:1px solid #f0f0f0}.new-dynamic-modal .modal-footer button{flex:1;padding:.875rem;border-radius:1.5rem;font-size:.9375rem;font-weight:500;cursor:pointer;transition:all .2s;border:none}.new-dynamic-modal .modal-footer button:active{transform:scale(0.95)}.new-dynamic-modal .modal-footer .cancel-btn{background:#f0f0f0;color:#666}.new-dynamic-modal .modal-footer .cancel-btn:hover{background:#e0e0e0}.new-dynamic-modal .modal-footer .publish-btn{background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff}.new-dynamic-modal .modal-footer .publish-btn:hover{background:linear-gradient(135deg,#ff91cc,#ff69b4)}.new-dynamic-modal .modal-footer .publish-btn:disabled{opacity:.6;cursor:not-allowed}.dynamics-app-container .dynamics-delete-toolbar{position:absolute;top:0;left:0;right:0;height:3.125rem;background:linear-gradient(135deg,rgba(255,255,255,0.98),rgba(255,238,242,0.98));border-bottom:1px solid rgba(255,105,180,.2);display:flex;align-items:center;justify-content:center;gap:1rem;padding:0 1rem;z-index:1000;box-shadow:0 2px 8px rgba(255,105,180,.15);animation:fadeInToolbar .3s ease-out;backdrop-filter:blur(10px)}.dynamics-app-container .dynamics-delete-toolbar button{padding:.5rem 1.25rem;border:none;border-radius:1.5rem;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .2s ease;letter-spacing:.3px;white-space:nowrap}.dynamics-app-container .dynamics-delete-toolbar button.select-all-btn{background:linear-gradient(135deg,#ff69b4,#ff91cc);color:#fff;box-shadow:0 2px 6px rgba(255,105,180,.3)}.dynamics-app-container .dynamics-delete-toolbar button.select-all-btn:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(255,105,180,.4)}.dynamics-app-container .dynamics-delete-toolbar button.select-all-btn:active{transform:translateY(0)}.dynamics-app-container .dynamics-delete-toolbar button.delete-selected-btn{background:linear-gradient(135deg,#ff6b7a,#ff4757);color:#fff;box-shadow:0 2px 6px rgba(255,71,87,.3)}.dynamics-app-container .dynamics-delete-toolbar button.delete-selected-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 10px rgba(255,71,87,.4)}.dynamics-app-container .dynamics-delete-toolbar button.delete-selected-btn:active{transform:translateY(0)}.dynamics-app-container .dynamics-delete-toolbar button.delete-selected-btn:disabled{opacity:.4;cursor:not-allowed;background:#ddd;box-shadow:none}.dynamics-app-container .dynamics-delete-toolbar button.cancel-delete-btn{background:hsla(0,0%,100%,.9);border:1px solid rgba(255,105,180,.3);color:hotpink}.dynamics-app-container .dynamics-delete-toolbar button.cancel-delete-btn:hover{background:#fff;border-color:rgba(255,105,180,.5);transform:translateY(-1px);box-shadow:0 2px 6px rgba(255,105,180,.2)}.dynamics-app-container .dynamics-delete-toolbar button.cancel-delete-btn:active{transform:translateY(0)}@keyframes fadeInToolbar{from{opacity:0}to{opacity:1}}#dynamicsInterface.delete-mode .dynamics-nav-settings.delete-mode-active{background:linear-gradient(135deg,#ff69b4,#ff91cc);border-radius:50%;transform:rotate(45deg)}#dynamicsInterface.delete-mode .dynamics-nav-settings.delete-mode-active svg{fill:#fff}#dynamicsInterface.delete-mode .dynamics-post{position:relative;transition:all .2s ease;cursor:pointer}#dynamicsInterface.delete-mode .dynamics-post.selected{background:linear-gradient(135deg,rgba(255,105,180,0.05),rgba(255,182,193,0.05));border:2px solid rgba(255,105,180,.3);box-shadow:0 2px 10px rgba(255,105,180,.15);transform:translateX(-2px)}#dynamicsInterface.delete-mode .dynamics-post:hover:not(.selected){background:rgba(255,182,193,.03);border-color:rgba(255,105,180,.15)}.dynamics-selection-checkbox{position:absolute;right:.625rem;top:1.125rem;width:1.25rem;height:1.25rem;cursor:pointer;z-index:10;animation:fadeInCheckbox .3s ease-out;display:flex;align-items:center;justify-content:center}.dynamics-selection-checkbox .checkbox-circle{width:100%;height:100%;transition:all .2s ease}.dynamics-selection-checkbox .checkbox-circle svg{width:100%;height:100%}.dynamics-selection-checkbox .checkbox-circle.unchecked{color:rgba(255,105,180,.4)}.dynamics-selection-checkbox .checkbox-circle.unchecked:hover{color:rgba(255,105,180,.6);transform:scale(1.1)}.dynamics-selection-checkbox .checkbox-circle.checked{animation:checkPop .3s ease-out}.dynamics-selection-checkbox .checkbox-circle.checked svg circle{fill:hotpink}.dynamics-selection-checkbox .checkbox-circle.checked:hover{transform:scale(1.1)}@keyframes fadeInCheckbox{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}@keyframes checkPop{0%{transform:scale(0.6);opacity:0}50%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}@keyframes selectShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
#characterProfileInterface.character-profile-interface{position:absolute;inset:0;z-index:5;background:#fff;border-radius:1.5rem;overflow-y:auto;overflow-x:hidden;clip-path:inset(0 round 1.5rem);isolation:isolate;backface-visibility:hidden}#characterProfileInterface.character-profile-interface .cp-status-bar{position:absolute;top:0;left:0;right:0;height:1.5rem;display:flex;justify-content:space-between;align-items:center;padding:0 1rem;z-index:100;background:rgba(0,0,0,0);transition:color .3s ease}#characterProfileInterface.character-profile-interface .cp-status-bar.light-theme{color:#fff}#characterProfileInterface.character-profile-interface .cp-status-bar.light-theme .status-icon-svg{fill:#fff}#characterProfileInterface.character-profile-interface .cp-status-bar.dark-theme{color:#000}#characterProfileInterface.character-profile-interface .cp-status-bar.dark-theme .status-icon-svg{fill:#000}#characterProfileInterface.character-profile-interface .cp-status-bar{color:#fff;font-size:.75rem}#characterProfileInterface.character-profile-interface .cp-status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}#characterProfileInterface.character-profile-interface .cp-status-bar .status-bar-left .status-time{font-size:.75rem;font-weight:500}#characterProfileInterface.character-profile-interface .cp-status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}#characterProfileInterface.character-profile-interface .cp-status-bar .status-bar-right .status-icon-svg{width:1rem;height:1rem;fill:currentColor}#characterProfileInterface.character-profile-interface::-webkit-scrollbar{display:none}#characterProfileInterface.character-profile-interface{scrollbar-width:none;-ms-overflow-style:none}#characterProfileInterface.character-profile-interface .cp-hero-wrapper{position:relative;width:100%;flex-shrink:0}#characterProfileInterface.character-profile-interface .cp-hero{position:relative;width:100%;aspect-ratio:16/9;min-height:8rem;background:#f7f7f7;overflow:hidden;backface-visibility:hidden;cursor:pointer;-webkit-user-select:none;user-select:none}#characterProfileInterface.character-profile-interface .cp-hero .cp-hero-bg{position:absolute;inset:0;background-size:cover;background-position:center;backface-visibility:hidden}#characterProfileInterface.character-profile-interface .cp-hero .cp-hero-overlay{position:absolute;bottom:0;left:0;width:100%;height:50%;background:linear-gradient(transparent,rgba(255,255,255,0.95));pointer-events:none;z-index:1}#characterProfileInterface.character-profile-interface .cp-hero.default-blur .cp-hero-bg{filter:blur(8px);transform:translateZ(0) scale(1.1)}#characterProfileInterface.character-profile-interface .cp-hero.default-blur::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.1),rgba(255,255,255,0.3));pointer-events:none;z-index:0}#characterProfileInterface.character-profile-interface .cp-hero .cp-back-btn{position:absolute;top:2.25rem;left:.75rem;width:2rem;height:2rem;border:none;border-radius:50%;background:hsla(0,0%,100%,.9);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12);transition:all .2s ease;z-index:2}#characterProfileInterface.character-profile-interface .cp-hero .cp-back-btn:hover{transform:scale(1.06);background:#fff}#characterProfileInterface.character-profile-interface .cp-hero .cp-back-btn:active{transform:scale(0.96)}#characterProfileInterface.character-profile-interface .cp-hero .cp-back-btn svg{color:#666}#characterProfileInterface.character-profile-interface .cp-hero .cp-hero-info{position:absolute;left:0;right:0;bottom:-2.25rem;padding:0 1rem 0 5.5rem;display:flex;align-items:flex-start;justify-content:space-between;z-index:2;height:4.5rem}#characterProfileInterface.character-profile-interface .cp-hero .cp-hero-info .cp-name{font-size:1.25rem;font-weight:700;color:#222;text-shadow:0 1px 2px hsla(0,0%,100%,.8);margin-left:.5rem;line-height:1.2}#characterProfileInterface.character-profile-interface .cp-hero .cp-hero-info .cp-stats{font-size:.875rem;color:#555;background:hsla(0,0%,100%,.85);padding:.25rem .5rem;border-radius:.5rem;box-shadow:0 1px 3px rgba(0,0,0,.1);line-height:1.2}#characterProfileInterface.character-profile-interface .cp-avatar-container{position:absolute;bottom:-2.25rem;left:1rem;z-index:10}#characterProfileInterface.character-profile-interface .cp-avatar-container .cp-avatar{width:4.5rem;height:4.5rem;border-radius:50%;background-size:cover;background-position:center;background-color:#fff;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.15);transition:transform .3s ease}#characterProfileInterface.character-profile-interface .cp-avatar-container .cp-avatar:hover{transform:scale(1.05)}#characterProfileInterface.character-profile-interface .cp-signature{position:absolute;bottom:-2.25rem;left:6rem;right:1rem;height:4.5rem;z-index:10;display:flex;align-items:flex-end;padding-bottom:.5rem}#characterProfileInterface.character-profile-interface .cp-signature>span{display:block;width:100%;text-align:left;font-size:.9375rem;color:#666;font-style:normal;font-family:inherit;opacity:.9;white-space:normal;word-wrap:break-word;word-break:break-word;line-height:1.25;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;text-shadow:0 1px 2px rgba(0,0,0,.08)}#characterProfileInterface.character-profile-interface .cp-signature.multiline>span{font-size:.8125rem;line-height:1.3}#characterProfileInterface.character-profile-interface .cp-signature.editable .signature-placeholder{color:#999;font-style:normal;opacity:.8}#characterProfileInterface.character-profile-interface .cp-signature .signature-input{display:inline-block;width:100%;background:rgba(0,0,0,0);border:none;border-bottom:1px solid #ff9ebb;padding:0;margin:0;font-size:.9375rem;font-family:inherit;color:#666;outline:none;line-height:1.25}#characterProfileInterface.character-profile-interface .cp-signature .signature-input:focus{border-bottom-color:#ff7eaa}#characterProfileInterface.character-profile-interface .cp-signature .signature-input::placeholder{color:#999;opacity:.8;font-style:normal}#characterProfileInterface.character-profile-interface .cp-timeline{padding:.75rem;padding-top:3rem;padding-bottom:3.5rem;background:rgba(0,0,0,0);position:relative}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post{background:#fff;border-radius:.9375rem;margin-bottom:.9375rem;padding:.9375rem;box-shadow:0 2px 20px rgba(255,182,193,.12);border:1px solid #ffe4e1;transition:transform .2s ease;animation:cpFadeIn .25s ease-in}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post:hover{transform:translateY(-2px);box-shadow:0 5px 22px rgba(255,182,193,.22)}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-header{display:flex;align-items:center;gap:.625rem;margin-bottom:.625rem}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-header .dynamics-post-avatar{width:2.5rem;height:2.5rem;border-radius:50%;background-size:cover;background-position:center;border:2px solid #ff9ebb;box-shadow:0 0 10px rgba(255,158,187,.3);cursor:default}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-header .dynamics-post-info{flex:1}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-header .dynamics-post-info .dynamics-post-name{font-weight:bold;font-size:.9rem;color:#333;text-shadow:0 0 1px rgba(255,105,180,.25);cursor:default}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-header .dynamics-post-info .dynamics-post-time{font-size:.75rem;color:#999;margin-top:2px}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-content{font-size:.9rem;line-height:1.55;color:#333;margin-bottom:.625rem}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-content .dynamics-link{color:#1a73e8;text-decoration:none}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-content .dynamics-link:hover{text-decoration:underline}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-content .dynamics-mention{color:#e91e63;font-weight:600}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-content .dynamics-hashtag{color:#7b1fa2;font-weight:600}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-image{width:100%;aspect-ratio:16/9;border-radius:.75rem;background-size:cover;background-position:center;margin-bottom:.625rem;border:1px solid #ffe4e1;transition:transform .2s ease}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-image:hover{transform:scale(1.015)}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions{display:flex;justify-content:flex-end;align-items:center;padding:6px 0;gap:10px}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action{display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s ease;padding:6px 12px;border-radius:15px}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action:hover{background:rgba(0,0,0,.05)}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action:hover .action-svg{transform:scale(1.08)}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action:active{transform:scale(0.96)}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action .action-icon{display:flex;align-items:center}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action .action-svg{width:1.125rem;height:1.125rem;fill:#8a8a8a;transition:all .2s ease}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action[data-action=like]:hover .action-svg{fill:#ff4757}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action[data-action=like].liked .action-svg{fill:#ff4757;animation:cpHeartBeat .45s}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-post-actions .dynamics-post-action[data-action=comment]:hover .action-svg{fill:#3498db}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-liked-by{display:flex;align-items:center;flex-wrap:wrap;font-size:.75rem;color:#666;padding:6px 10px;background:#f8f8f8;border-radius:6px}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-liked-by .liked-heart-icon{width:.75rem;height:.75rem;fill:hotpink;margin-right:5px}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-liked-by .liked-user{color:#576b95;cursor:pointer}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-liked-by .liked-user:hover{text-decoration:underline}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-comments{margin-top:.625rem;padding-top:.625rem;border-top:1px dashed #ffe4e1}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-comments .dynamics-comment-qq .dynamics-comment-content{background:rgba(0,0,0,0);border-radius:0;color:#333}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-comments .dynamics-comment-qq .dynamics-comment-content .dynamics-comment-name{font-weight:600;color:#576b95;cursor:pointer}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-comments .dynamics-comment-qq .dynamics-comment-content .dynamics-comment-name:hover{text-decoration:underline}#characterProfileInterface.character-profile-interface .cp-timeline .dynamics-comments .dynamics-comment-qq .dynamics-comment-content .dynamics-comment-text{color:#333;word-break:break-word}@keyframes cpFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}@keyframes cpHeartBeat{0%,100%{transform:scale(1)}40%{transform:scale(1.18)}}#dynamicsInterface{position:relative}#dynamicsInterface #cpCropperOverlay{position:absolute;inset:0;z-index:9999;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:.75rem;border-radius:1.5rem;clip-path:inset(0 round 1.5rem);-webkit-clip-path:inset(0 round 1.5rem)}#dynamicsInterface .cp-cropper-dialog{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:.75rem;box-shadow:0 .625rem 2.5rem rgba(0,0,0,.3);padding:1rem;width:calc(100% - 1.5rem);max-width:100%}#dynamicsInterface .cp-cropper-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}#dynamicsInterface .cp-cropper-header .cp-cropper-title{font-weight:600;font-size:1rem;color:#333}#dynamicsInterface .cp-cropper-header .cp-reset-btn{padding:.25rem .625rem;font-size:.75rem;border:1px solid #e0e0e0;border-radius:.375rem;background:#fff;color:#666;cursor:pointer;transition:all .2s ease}#dynamicsInterface .cp-cropper-header .cp-reset-btn:hover{background:#f5f5f5;border-color:#ccc;color:#333}#dynamicsInterface .cp-cropper-header .cp-reset-btn:active{transform:scale(0.95)}#dynamicsInterface .cp-cropper-viewport{position:relative;width:100%;max-width:100%;aspect-ratio:16/9;overflow:hidden;border-radius:.5rem;touch-action:none;border:1px solid #e0e0e0}#dynamicsInterface .cp-cropper-image{position:absolute;top:0;left:0;transform-origin:0 0;-webkit-user-select:none;user-select:none;cursor:grab;max-width:none;max-height:none;width:auto;height:auto;will-change:transform}#dynamicsInterface .cp-cropper-frame{position:absolute;inset:0;box-shadow:0 0 0 20000px rgba(0,0,0,.35);border:2px solid #fff;border-radius:.5rem;pointer-events:none}#dynamicsInterface .cp-cropper-toolbar{display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:.5rem;margin-top:.75rem}#dynamicsInterface .cp-cropper-toolbar .cp-btn{flex:1;padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem;cursor:pointer;transition:all .15s ease;border:1px solid #e0e0e0;outline:none;white-space:nowrap}#dynamicsInterface .cp-cropper-toolbar .cp-btn:hover{transform:translateY(-1px)}#dynamicsInterface .cp-cropper-toolbar .cp-btn:active{transform:translateY(0)}#dynamicsInterface .cp-cropper-toolbar .cp-btn-cancel{background:#fff;color:#666}#dynamicsInterface .cp-cropper-toolbar .cp-btn-cancel:hover{background:#f8f8f8}#dynamicsInterface .cp-cropper-toolbar .cp-btn-upload{background:#fff;color:#7b68ee;border-color:#7b68ee}#dynamicsInterface .cp-cropper-toolbar .cp-btn-upload:hover{background:#f8f6ff}#dynamicsInterface .cp-cropper-toolbar .cp-btn-primary{background:#ff9ebb;color:#fff;border-color:#ff9ebb}#dynamicsInterface .cp-cropper-toolbar .cp-btn-primary:hover{background:#ff7eaa}
</style></head><body><div class="phone-container"><div class="phone-charm"></div><div class="phone-notch"><div class="notch-sensor"></div><div class="notch-camera"></div><div class="notch-speaker"></div><div class="notch-sensor"></div></div><div class="interface-container"><div class="chat-list-interface" id="chatListInterface"><div class="chat-list-header"><div class="chat-list-title">èŠå¤©åˆ—è¡¨</div></div><div class="chat-list-content" id="chatListContent"></div></div><div class="profile-interface" id="profileInterface"><div class="status-bar-container"></div><div class="profile-content"><div class="user-info-section"><div class="user-avatar" id="userAvatar"><img id="avatarImage" src="https://files.catbox.moe/u8ccy5.jpg" alt="ç”¨æˆ·å¤´åƒ"/><div class="avatar-overlay"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div>æ›´æ¢å¤´åƒ</div></div></div><div class="user-name"><div class="name-display" id="nameDisplay">ç”¨æˆ·å</div><div class="name-edit" id="nameEdit"><input id="nameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"/><div class="edit-buttons"><button class="btn confirm-btn" id="nameConfirmBtn">ç¡®è®¤</button> <button class="btn cancel-btn" id="nameCancelBtn">å–æ¶ˆ</button></div></div></div></div><div class="settings-section"><button class="settings-button" id="extensionSettingsButton"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.22,15.05 2.27,14.78 2.46,14.63L4.57,12.97C4.53,12.65 4.5,12.33 4.5,12C4.5,11.67 4.53,11.34 4.57,11L2.46,9.37C2.27,9.22 2.22,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.78,8.95 21.73,9.22 21.54,9.37L19.43,11C19.47,11.34 19.5,11.67 19.5,12C19.5,12.33 19.47,12.65 19.43,12.97L21.54,14.63C21.73,14.78 21.78,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.03 19.05,18.95L16.56,17.94C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.64L7.85,15.61C8.62,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.64L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z"/></svg> æ‰©å±•è®¾ç½®</button> <button class="settings-button" id="settingsButton"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg> è®¾ç½®</button></div></div><div class="bottom-nav"></div><div class="settings-modal" id="settingsModal"><div class="modal-container"><div class="modal-header"><div class="modal-title">è®¾ç½®</div><button class="close-btn" id="settingsCloseBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button></div><div class="modal-content"><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/></svg> ç•Œé¢è®¾ç½®</div><div class="setting-item"><div class="item-header"><div class="item-title">ç•Œé¢ç¼©æ”¾</div></div><div class="scale-control"><div class="scale-info"><span class="scale-label">ç¼©æ”¾æ¯”ä¾‹</span> <span class="scale-value" id="scaleValue">100%</span></div><div class="scale-slider-container"><input type="range" class="scale-slider" id="scaleSlider" min="0.8" max="1.5" step="0.1" value="1.0"><div class="scale-marks"><span class="scale-mark">80%</span> <span class="scale-mark">100%</span> <span class="scale-mark">120%</span> <span class="scale-mark">150%</span></div></div></div></div><div class="setting-item"><div class="item-header"><div class="item-title">æ¶ˆæ¯æ˜¾ç¤ºé€Ÿåº¦</div></div><div class="typing-speed-control"><div class="typing-speed-info"><span class="typing-speed-label">æ˜¾ç¤ºé€Ÿåº¦</span> <span class="typing-speed-value" id="typingSpeedValue">æ­£å¸¸</span></div><div class="typing-speed-slider-container"><input type="range" class="typing-speed-slider" id="typingSpeedSlider" min="1" max="4" step="1" value="1"><div class="typing-speed-marks"><span class="typing-speed-mark">æ­£å¸¸</span> <span class="typing-speed-mark">å¿«é€Ÿ</span> <span class="typing-speed-mark">ç¬é—´</span> <span class="typing-speed-mark">å…¨éƒ¨</span></div></div></div></div></div><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/></svg> å£çº¸è®¾ç½®</div><div class="setting-item"><div class="item-header"><div class="item-title">èŠå¤©åˆ—è¡¨å£çº¸</div></div><div class="item-description">è®¾ç½®èŠå¤©åˆ—è¡¨é¡µé¢çš„èƒŒæ™¯å£çº¸</div><div class="upload-area" id="chatListWallpaperUpload"><svg class="upload-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div class="upload-info"><div class="upload-text">ç‚¹å‡»ä¸Šä¼ å£çº¸</div><div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ 2MB</div></div></div><div class="wallpaper-preview" id="chatListWallpaperPreview" style="display:none"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="å£çº¸é¢„è§ˆ"/><div class="preview-overlay"><button class="remove-btn" id="removeChatListWallpaper"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button></div></div></div><div class="setting-item"><div class="item-header"><div class="item-title">å…¨å±€èŠå¤©å£çº¸</div></div><div class="item-description">è®¾ç½®æ‰€æœ‰èŠå¤©çš„é»˜è®¤èƒŒæ™¯å£çº¸</div><div class="upload-area" id="globalChatWallpaperUpload"><svg class="upload-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div class="upload-info"><div class="upload-text">ç‚¹å‡»ä¸Šä¼ å£çº¸</div><div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ 2MB</div></div></div><div class="wallpaper-preview" id="globalChatWallpaperPreview" style="display:none"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="å£çº¸é¢„è§ˆ"/><div class="preview-overlay"><button class="remove-btn" id="removeGlobalChatWallpaper"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button> <button class="apply-all-btn" id="applyToAllChatsBtn" title="å°†æ­¤å£çº¸åº”ç”¨åˆ°æ‰€æœ‰èŠå¤©æ¡†"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/></svg></button></div></div></div></div><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C6.477,2,2,6.477,2,12c0,5.523,4.477,10,10,10s10-4.477,10-10C22,6.477,17.523,2,12,2z M12,20c-4.418,0-8-3.582-8-8 s3.582-8,8-8s8,3.582,8,8S16.418,20,12,20z M15.5,11c0.828,0,1.5-0.672,1.5-1.5S16.328,8,15.5,8S14,8.672,14,9.5S14.672,11,15.5,11z M8.5,11c0.828,0,1.5-0.672,1.5-1.5S9.328,8,8.5,8S7,8.672,7,9.5S7.672,11,8.5,11z M12,17.5c2.33,0,4.31-1.46,5.11-3.5H6.89 C7.69,16.04,9.67,17.5,12,17.5z"/></svg> åŠŸèƒ½è®¾ç½®</div><div class="setting-item"><div class="item-header"><div class="item-title">è¡¨æƒ…åŒ…å»ºè®®</div><div class="toggle-switch" id="emojiSuggestionsToggle"><div class="toggle-handle"></div></div></div><div class="item-description">åœ¨è¾“å…¥æ—¶æ˜¾ç¤ºç›¸å…³çš„è¡¨æƒ…åŒ…å»ºè®®</div></div><div class="setting-item"><div class="item-header"><div class="item-title">è·¨èŠå¤©å‘é€</div><div class="toggle-switch" id="crossChatSendToggle"><div class="toggle-handle"></div></div></div><div class="item-description">å‘é€æ—¶åŒ…å«æ‰€æœ‰èŠå¤©çš„å¾…å‘é€æ¶ˆæ¯ï¼Œè€Œä¸ä»…é™äºå½“å‰èŠå¤©</div></div><div class="setting-item"><div class="item-header"><div class="item-title">æ¸…é™¤ç”¨æˆ·ç¼“å­˜</div><button class="action-btn danger-btn" id="clearUserCacheBtn"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg> æ¸…é™¤</button></div><div class="item-description">æ¢å¤å¤´åƒå’Œåå­—ä¸ºé»˜è®¤è®¾ç½®</div></div><div class="setting-item"><div class="item-header"><div class="item-title">æ¸…é™¤ä¸–ç•Œä¹¦è§’è‰²ç¼“å­˜</div><button class="action-btn danger-btn" id="clearLorebookCacheBtn"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M10,8H14V10H10V8M10,12H14V16H10V12Z"/></svg> æ¸…é™¤</button></div><div class="item-description">æ¸…é™¤ä¸–ç•Œä¹¦ä¸­è§’è‰²çš„è‡ªå®šä¹‰å¤´åƒç¼“å­˜</div></div></div></div></div></div></div><div id="dynamicsInterface" style="display:none"><div id="dynamicsStatusBarContainer"></div><div class="dynamics-app-container"><div class="dynamics-nav-bar"><div class="dynamics-nav-profile"></div><div class="dynamics-nav-logo">âœ§ å¥½å‹åŠ¨æ€ âœ§</div><div class="dynamics-nav-settings">âš™ï¸</div></div><div class="dynamics-timeline" id="dynamicsTimeline"></div></div><div class="bottom-nav"></div></div><div class="chat-container" id="chatInterface"><div id="chatStatusBarContainer"></div><div class="chat-header"><div class="header-info"><img src="https://files.catbox.moe/u8ccy5.jpg" class="header-avatar" id="headerAvatar"/><div class="header-text"><h2 id="chatTitle">å¤šäº‘ç†Š</h2><div class="header-status"><div class="status-dot"></div>åœ¨çº¿</div></div></div><div class="header-icons"><svg class="header-icon diary-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M12,3C12.55,3 13,3.45 13,4C13,4.55 12.55,5 12,5C11.45,5 11,4.55 11,4C11,3.45 11.45,3 12,3M7,7H17V5H19V19H5V5H7V7Z"/></svg> <svg class="header-icon home-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg> <svg class="header-icon call-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg></div></div><div class="chat-messages" id="chatMessages"></div><div class="chat-input"><button class="plus-btn" id="plusBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg></button><div class="plus-menu" id="plusMenu"><div class="menu-item" data-type="sticker"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C6.477,2,2,6.477,2,12c0,5.523,4.477,10,10,10s10-4.477,10-10C22,6.477,17.523,2,12,2z M12,20c-4.418,0-8-3.582-8-8 s3.582-8,8-8s8,3.582,8,8S16.418,20,12,20z M15.5,11c0.828,0,1.5-0.672,1.5-1.5S16.328,8,15.5,8S14,8.672,14,9.5S14.672,11,15.5,11z M8.5,11c0.828,0,1.5-0.672,1.5-1.5S9.328,8,8.5,8S7,8.672,7,9.5S7.672,11,8.5,11z M12,17.5c2.33,0,4.31-1.46,5.11-3.5H6.89 C7.69,16.04,9.67,17.5,12,17.5z"/></svg></div></div><div class="menu-item" data-type="image"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/></svg></div></div><div class="menu-item" data-type="voice"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg></div></div><div class="menu-item" data-type="transfer"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg></div></div><div class="menu-item" data-type="location"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C15.31,2 18,4.66 18,7.95C18,12.41 12,19 12,19S6,12.41 6,7.95C6,4.66 8.69,2 12,2M12,6A2,2 0 0,0 10,8A2,2 0 0,0 12,10A2,2 0 0,0 14,8A2,2 0 0,0 12,6Z"/></svg></div></div></div><div class="sticker-selector" id="stickerSelector"><div class="sticker-grid" id="stickerGrid"></div></div><input class="input-field" id="inputField" placeholder="è¯·è¾“å…¥..."/> <button class="send-btn" id="sendBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div></div></div></div><input type="file" id="avatarFileInput" accept="image/*" style="display:none"/> <input type="file" id="chatListWallpaperInput" accept="image/*" style="display:none"/> <input type="file" id="globalChatWallpaperInput" accept="image/*" style="display:none"/><div id="iconTemplates" style="display:none"><div id="voiceIconTemplate"><svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg> <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg></div><div id="locationIconTemplate"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C15.31,2 18,4.66 18,7.95C18,12.41 12,19 12,19S6,12.41 6,7.95C6,4.66 8.69,2 12,2M12,6A2,2 0 0,0 10,8A2,2 0 0,0 12,10A2,2 0 0,0 14,8A2,2 0 0,0 12,6Z"/></svg></div><div id="transferIconTemplate"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg></div></div><div id="transferModalTemplate" class="transfer-modal" style="display:none"><div class="modal-header"><div class="modal-title">æ”¶åˆ°è½¬è´¦</div><div class="modal-subtitle">æ¥è‡ª <span class="sender-name"></span></div></div><div class="modal-amount">ï¿¥<span class="amount-value"></span></div><div class="modal-details"><div class="detail-row"><span class="detail-label">è½¬è´¦æ–¹å¼</span> <span class="detail-value">é›¶é’±</span></div><div class="detail-row"><span class="detail-label">è½¬è´¦ç•™è¨€</span> <span class="detail-value transfer-note"></span></div></div><div class="modal-buttons"><button class="modal-btn reject-btn">é€€å›</button> <button class="modal-btn accept-btn">æ¥æ”¶</button></div></div><div id="imageInputModalTemplate" class="image-input-modal" style="display:none"><div class="modal-content"><div class="image-upload-section"><label class="modal-label">é€‰æ‹©å›¾ç‰‡ï¼š</label><div class="upload-options"><div class="upload-row"><button type="button" class="upload-btn local-upload-btn" id="localUploadBtn">é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button> <span class="upload-divider">æˆ–</span></div><div class="upload-row"><input class="modal-input url-input" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰..." id="imageUrlInput"/></div></div><div class="file-preview" id="filePreview" style="display:none"><img id="previewImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="é¢„è§ˆå›¾ç‰‡"/><div class="file-info"><span id="fileName"></span> <button type="button" class="remove-file-btn" id="removeFileBtn">âœ•</button></div></div></div><label class="modal-label modal-label-spaced">å›¾ç‰‡æè¿°ï¼š</label> <input class="modal-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°..." id="imageDescInput"/> <input type="file" id="fileInput" accept="image/*" style="display:none"/></div></div><div id="voiceInputModalTemplate" class="voice-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">è¯­éŸ³å†…å®¹ï¼š</label> <input class="modal-input" placeholder="è¯·è¾“å…¥è¯­éŸ³å†…å®¹..." id="voiceContentInput"/> <label class="modal-label modal-label-spaced">è¯­éŸ³æ—¶é•¿ï¼š</label> <input type="number" class="modal-input" placeholder="è¯·è¾“å…¥æ—¶é•¿ï¼ˆç§’ï¼‰..." id="voiceDurationInput" min="1" max="300"/></div></div><div id="locationInputModalTemplate" class="location-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">ä½ç½®æè¿°ï¼š</label> <input class="modal-input" placeholder="è¯·è¾“å…¥ä½ç½®æè¿°..." id="locationDescInput"/></div></div><div id="transferInputModalTemplate" class="transfer-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">è½¬è´¦é‡‘é¢ï¼š</label> <input type="number" class="modal-input" placeholder="è¯·è¾“å…¥è½¬è´¦é‡‘é¢..." id="transferAmountInput" min="0.01" step="0.01"/> <label class="modal-label modal-label-spaced">è½¬è´¦å¤‡æ³¨ï¼š</label> <input class="modal-input" placeholder="è¯·è¾“å…¥è½¬è´¦å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." id="transferNoteInput"/></div></div><div id="editStickerModalTemplate" style="display:none"><div class="modal-title">ç¼–è¾‘è¡¨æƒ…åŒ…</div><div class="modal-content"><label class="modal-label">è¡¨æƒ…åŒ…URLï¼š</label> <input class="modal-input" id="editStickerUrl" placeholder="è¯·è¾“å…¥è¡¨æƒ…åŒ…é“¾æ¥..."/> <label class="modal-label modal-label-spaced">è¡¨æƒ…åŒ…å¤‡æ³¨ï¼š</label> <input class="modal-input" id="editStickerNote" placeholder="è¯·è¾“å…¥è¡¨æƒ…åŒ…å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..."/></div><div class="modal-buttons"><button class="modal-btn cancel-btn">å–æ¶ˆ</button> <button class="modal-btn confirm-btn">ä¿å­˜</button></div></div><div id="addStickerModalTemplate" style="display:none"><div class="modal-content"><label class="modal-label">è¡¨æƒ…åŒ…å†…å®¹ï¼š</label> <input class="modal-input" placeholder="è¾“å…¥URLã€æ–‡ä»¶åæˆ–å¤‡æ³¨+æ–‡ä»¶å..." id="stickerContentInput"/> <label class="modal-label modal-label-spaced">è¡¨æƒ…åŒ…å¤‡æ³¨ï¼š</label> <input class="modal-input" placeholder="è¾“å…¥è¡¨æƒ…åŒ…å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." id="stickerNoteInput"/><div class="input-help"><p>æ”¯æŒæ ¼å¼ï¼š</p><ul><li>å®Œæ•´URLï¼šhttps://example.com/image.jpg</li><li>æ–‡ä»¶åï¼šei6coi.jpeg</li><li>å¤‡æ³¨+æ–‡ä»¶åï¼šæˆ‘æ˜¯è´¥çŠ¬ei6coi.jpeg</li></ul></div></div></div><div id="stickerEmptyStateTemplate" style="display:none"><div class="empty-icon">ğŸ˜Š</div><div class="empty-text">è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…</div></div><div id="deleteModeButtonTemplate" style="display:none"><span class="delete-icon">ğŸ—‘</span> <span class="delete-text"></span></div><div id="confirmDeleteButtonTemplate" style="display:none"><span class="confirm-icon">âœ“</span> <span class="confirm-text">ç¡®è®¤</span></div><div id="addStickerModalTemplate" class="add-sticker-modal" style="display:none"><div class="modal-content"><label class="modal-label">è¡¨æƒ…åŒ…å†…å®¹ï¼š</label> <input class="modal-input" placeholder="è¾“å…¥URLã€æ–‡ä»¶åæˆ–å¤‡æ³¨+æ–‡ä»¶å..." id="stickerContentInput"/> <label class="modal-label modal-label-spaced">è¡¨æƒ…åŒ…å¤‡æ³¨ï¼š</label> <input class="modal-input" placeholder="è¾“å…¥è¡¨æƒ…åŒ…å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..." id="stickerNoteInput"/><div class="input-help"><p>æ”¯æŒæ ¼å¼ï¼š</p><ul><li>å®Œæ•´URLï¼šhttps://example.com/image.jpg</li><li>æ–‡ä»¶åï¼šei6coi.jpeg</li><li>å¤‡æ³¨+æ–‡ä»¶åï¼šæˆ‘æ˜¯è´¥çŠ¬ei6coi.jpeg</li></ul></div></div></div><div id="messageTemplates" style="display:none"><template id="messageTemplate"><div class="message"><div class="avatar-container"></div><div class="message-wrapper"><div class="message-content"></div><div class="message-time"></div></div></div></template><template id="voiceMessageTemplate"><div class="voice-message"><div class="voice-icon"></div><div class="voice-wave-container"><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div></div><span class="voice-duration"></span></div><div class="voice-transcript" style="display:none"></div></template><template id="locationMessageTemplate"><div class="location-message"><div class="location-icon"></div><span class="location-text"></span></div></template><template id="transferMessageTemplate"><div class="transfer-bubble"><div class="transfer-content"><div class="transfer-icon"></div><div class="transfer-info"><div class="transfer-amount"></div><div class="transfer-status"></div></div></div></div></template><template id="attachmentMessageTemplate"><div class="random-image-container dynamic-bg"><details><summary></summary><div class="attachment-content"><div class="attachment-text"><p></p></div></div></details></div></template></div></body></html>